[00:07:54] *** flaper87 is now known as flaper87|afk
[00:12:55] *** Joins: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP)
[00:15:04] *** Quits: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP) (Ping timeout)
[00:19:04] <nrc> nmatsakis: ping
[00:20:19] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[00:21:35] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[00:21:35] *** ChanServ sets mode: +o tjc
[00:22:37] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[00:23:39] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[00:25:40] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[00:27:22] *** Joins: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP)
[00:27:23] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/3GQHSw
[00:27:23] *** Parts: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP) ()
[00:29:32] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[00:32:02] *** Joins: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP)
[00:32:02] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/j4q4qg
[00:32:02] *** Parts: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP) ()
[00:32:03] *** Joins: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP)
[00:32:03] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/AhIklg
[00:32:03] <ghrust> 13rust/06auto 14968633b 15Flavio Percoco: Replace `crate` usage with `krate`...
[00:32:03] <ghrust> 13rust/06auto 149a6d92c 15Flavio Percoco: Replace `extern mod` with `extern crate`...
[00:32:03] <ghrust> 13rust/06auto 145deb3c9 15Flavio Percoco: Remove obsolete warnings for `extern mod`...
[00:32:05] *** Parts: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP) ()
[00:33:00] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[00:33:00] *** ChanServ sets mode: +ao pcwalton pcwalton
[00:33:06] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[00:45:53] <nrc> brson: ping re #9309 - do you have a preference for which ABI should be used?
[00:46:04] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[00:50:53] *** Joins: whitglint (uid15486@moz-31ABA2C0.irccloud.com)
[00:55:55] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[00:57:55] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[00:58:51] *** Quits: japaric (japaric@8C26A633.8C2993CE.5C7588CA.IP) (Ping timeout)
[00:59:32] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[00:59:56] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[01:00:12] *** Joins: japaric (japaric@8465B6C3.31BF4ADA.BFC118EE.IP)
[01:02:56] <nmatsakis> nrc: pong
[01:05:05] <nrc> nmatsakis: was going to ask about #9243 because I didn't know flaper87|afk was Flavio or the issue number for the static/destructor stuff discussed in the meeting. But Huon pointed me to both via the issue.
[01:05:27] <nrc> nmatsakis: do you know if 9243 is subsumed by 11979?
[01:06:04] * nmatsakis investigates
[01:06:32] <nrc> nmatsakis: also, re #9309 - do you have a preference for which ABI should be used?
[01:07:02] <nmatsakis> nrc: they seem to me to be the same issue yes
[01:07:26] <nmatsakis> nrc: I think that it should be like this: fn() ==> extern "Rust" fn
[01:07:33] <nmatsakis> extern fn() ==> extern "C" fn()
[01:07:47] <nmatsakis> in other words, if they write extern, the default should be "C"
[01:08:25] <nrc> and fn foo() in an extern block should behave the same way as extern fn foo() ?
[01:09:28] <nmatsakis> it confuses me how PRs and issues in github are identical
[01:09:41] <nmatsakis> nrc: yes
[01:09:51] <nrc> nmatsakis: thanks!
[01:13:20] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[01:13:41] *** Joins: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP)
[01:15:43] *** Quits: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP) (Ping timeout)
[01:19:45] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[01:23:32] *** Joins: jdm (jdm@E595D12E.1196002C.7DBB297B.IP)
[01:27:45] *** Quits: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net) (Quit: Leaving.)
[01:30:12] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Quit: It's a joke, it's all a joke.)
[01:32:43] <Diamond> would something like '#[cfg(not(target_os = "nacl"))] #[crate_type = "dylib"];' work with a recent checkout of rust?
[01:32:51] <cmr> Diamond: no.
[01:32:53] <cmr> well
[01:32:56] <cmr> what?
[01:33:02] <cmr> you want to apply an attribute to an attribute?
[01:33:09] <Diamond> lol yeah.
[01:33:20] <cmr> yeah no.
[01:33:23] <cmr> attributes go on items.
[01:33:29] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[01:34:27] <Diamond> #[crate_type = ""] does go on an item though.
[01:34:30] <brson> nrc: "C"
[01:35:04] <Diamond> (I'm not refering to the current impl when I say that)
[01:35:19] <cmr> sure, it goes on the crate.
[01:35:41] <Diamond> so why shouldn't that work?
[01:36:02] <cmr> well #[cfg(not(target_os="nacl"))]; is going to conditionally compile out the entire crate, no?
[01:36:24] <Diamond> just for dylib
[01:36:31] <Diamond> it that example
[01:36:33] <Diamond> in*
[01:36:57] <Diamond>  there are other crate type attrs
[01:37:06] <cmr> yes, they're all additive...
[01:41:05] *** Joins: aurynj (Eon@BF507CFB.1CEEC774.4C51A5AE.IP)
[01:41:25] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[01:41:54] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[01:41:55] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/AhIklg
[01:41:55] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[01:42:59] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[01:43:53] *** Joins: zimbabao (rajaram@5219B01C.32AF4EDF.D2D1FAF0.IP)
[01:46:59] *** Joins: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP)
[01:46:59] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/mhxKbQ
[01:46:59] *** Parts: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP) ()
[01:52:00] *** Joins: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP)
[01:52:00] <ghrust> 01[13rust01] 15bors pushed 5 new commits to 06auto: 02http://git.io/I31MAA
[01:52:00] <ghrust> 13rust/06auto 1444317ed 15Alex Crichton: Fix a bug where cached stacks weren't re-used...
[01:52:00] <ghrust> 13rust/06auto 14379c73f 15Alex Crichton: Don't allocate in LocalHeap::new()...
[01:52:00] <ghrust> 13rust/06auto 1476b1755 15Alex Crichton: Don't require an allocation for on_exit messages...
[01:52:02] *** Parts: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP) ()
[02:02:38] <acrichto> flaper87|afk: it landed!
[02:07:33] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[02:09:27] *** Quits: aurynj (Eon@BF507CFB.1CEEC774.4C51A5AE.IP) (Quit: Leaving)
[02:10:33] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[02:13:21] <Eridius> what causes 'note: ld: library not found for -lcompiler-rt'? Second time I've seen this while building rust in the past few days. `make clean` fixed it last time, but that shouldn't be necessary
[02:13:21] *** Quits: sunfish (chatzilla@moz-C06D9702.mtv1.mozilla.com) (Ping timeout)
[02:14:26] *** Joins: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP)
[02:14:36] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[02:14:38] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[02:14:39] *** ChanServ sets mode: +ao pcwalton pcwalton
[02:14:47] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[02:14:49] <aatch> Eridius, compiler-rt was added to the repo recently
[02:14:52] <aatch> Which would do it.
[02:16:08] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[02:16:28] *** Quits: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP) (Ping timeout)
[02:18:32] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[02:28:26] <Eridius> aatch: ok, but this is the second time it's been missing when I ran make
[02:28:38] <Eridius> once I get, dependencies aren't always set up properly when modifying the Makefiles. But twice?
[02:28:54] <aatch> Eridius, I dunno, I didn't even hit it once.
[02:33:03] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[02:36:18] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[02:37:39] <nrc> brson: thanks
[02:37:51] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Client exited)
[02:39:53] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[02:40:46] <erickt> yay! I got rustc to compile with my new hash framework! now all thats left is to see if it actually works
[02:44:24] <brson> erickt: :thumbsup:
[02:46:06] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Quit: leaving)
[02:46:18] *** Joins: sunfish (chatzilla@moz-BBE3ABD.mv.mozilla.com)
[02:46:23] *** Joins: brson (brson@981AA104.E81F12CD.76F66111.IP)
[02:46:23] *** ChanServ sets mode: +qo brson brson
[02:46:38] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[02:48:53] <Eridius> erickt: yay
[02:49:43] *** Joins: cgaebel (clark@moz-B2624B52.nycmny.east.verizon.net)
[02:50:04] *** Joins: huon (Thunderbir@2702835C.D5A1DCF.37681C44.IP)
[02:51:29] *** Quits: cgaebel (clark@moz-B2624B52.nycmny.east.verizon.net) (Ping timeout)
[02:52:54] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Connection reset by peer)
[02:57:46] *** Joins: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca)
[03:03:54] <enix> is there some way to rebuild just the last rust stage without re-bootstrapping everything? i'm trying to figure out how some stuff works and my first attempt was to use gdb, but, it seems that that isn't giving me all that much useful information even without optimizations
[03:04:21] <enix> so, my next thought is to add in debugs to hopefully make it clearer to me how things work, but, i'd like to avoid building as much as possible when doing that
[03:04:30] <enix> since a build take 20 mins on my tiny little netbook
[03:05:07] <brson> enix: if you can do your testing with stdtest then you can e.g. `make check-stage1-std NO_REBUILD=1` to short-circuit the bootstrap and just retest std
[03:05:22] <brson> otherwise I don't think there is any help in the makefiles for avoiding the bootstrap
[03:05:31] <brson> could be a useful addition though
[03:05:37] <enix> i'm actually trying to figure out vtable in rustc
[03:05:37] <huon> enix: I've got a scrip taht just rebuilds the libraries
[03:05:38] <huon> sec
[03:05:45] <acrichto> brson: hm the android bot has timed out on 2 of the past 4 builds
[03:05:57] <acrichto> http://buildbot.rust-lang.org/builders/auto-linux-64-x-android-t/builds/1168/steps/test/logs/stdio
[03:06:21] <enix> so, its librustc i'm trying to rebuild without re-bootstrapping
[03:06:32] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[03:06:44] <huon> ah
[03:06:58] <brson> acrichto: maybe native tests?
[03:07:05] <brson> i think native tests were timing out before
[03:07:06] <huon> well, https://gist.github.com/huonw/abf1aad98b99e132118b for completeness
[03:07:14] <brson> acrichto: some have succeeded
[03:07:15] <brson> since
[03:07:18] <brson> http://buildbot.rust-lang.org/buildslaves/linux-64-x-android-t
[03:07:23] <acrichto> it's true
[03:07:31] <acrichto> it's just the benches...
[03:07:50] <brson> i only see one timeout
[03:08:16] <enix> cool, thanks, maybe I can use something based on that
[03:08:21] <acrichto> brson: the current PR is going to time out
[03:08:28] <brson> maybe one of the benches is swapping?
[03:08:34] <huon> enix: I got that by editing the output of `make -n VERBOSE=1`
[03:08:41] <huon> (it's rather verbose though...)
[03:09:02] <acrichto> hmm..
[03:09:13] <acrichto> I should figure out which bench didn't exit
[03:09:24] <brson> acrichto: i don't see any rust processes running on the emu
[03:09:47] <acrichto> that makes me sad :(
[03:09:48] <brson> though I do see a lot of /system/bin/sleep ...
[03:09:50] <acrichto> why is it hung?
[03:09:53] *** Quits: Jesse (jruderman@moz-BBE3ABD.mv.mozilla.com) (Quit: Jesse)
[03:09:57] <acrichto> sleep?!
[03:09:58] <brson> could be a problem with the shell script that manages the tests
[03:10:02] <brson> yeah, the script runs sleep
[03:10:05] *** Joins: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP)
[03:10:12] <brson> adb_run_wrapper.sh
[03:10:37] <brson> i see a bunch of /system/bin/sh and /system/bin/sleep
[03:10:42] <brson> could all be test timeouts
[03:10:44] <acrichto> whoa
[03:10:51] <brson> in fact 8 of each
[03:10:54] *** Quits: zimbabao (rajaram@5219B01C.32AF4EDF.D2D1FAF0.IP) (Connection reset by peer)
[03:10:58] <acrichto> but you just restarted the emulator?
[03:11:06] <brson> yes
[03:11:09] <brson> well, today
[03:11:32] <brson> we haven't had 8 timeouts today i gather
[03:11:33] <acrichto> can you see the arguments to sh?
[03:11:41] <acrichto> not yet
[03:11:48] <acrichto> this'll be our second since the restart I believe
[03:12:15] <brson> perhaps we leave orphan processes for each set of compiletests
[03:12:30] <acrichto> surely this isn't something new though?
[03:12:52] <acrichto> ugh I just want that PR to merge ;_;
[03:12:53] <brson> now i don't see any sh or sleeps
[03:13:01] <brson> so something happened
[03:13:10] <acrichto> it just ended
[03:13:16] <acrichto> I got the email that bors timed it out
[03:13:24] <acrichto> http://buildbot.rust-lang.org/builders/auto-linux-64-x-android-t/builds/1171/steps/test/logs/stdio
[03:13:29] <acrichto> different timeout than before...
[03:15:11] <brson> i can't imagine why there are 8 sh/sleep instances
[03:15:37] <acrichto> why does it sleep in the wrapper?
[03:16:03] <brson> a hack to workaround an unexpected exit code
[03:16:28] <brson> adb_run_wrapper.sh is a bit cryptic
[03:16:31] <acrichto> what if it legitimately failed?
[03:16:37] <acrichto> via like a signal?
[03:17:02] *** Joins: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP)
[03:17:02] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 140b00591 to 1489b1686: 02http://git.io/N3iJvQ
[03:17:02] *** Parts: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP) ()
[03:17:04] *** Joins: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP)
[03:17:04] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/lDXQwQ
[03:17:04] <ghrust> 13rust/06auto 14bf1464c 15Michael Darakananda: Removed num::Orderable
[03:17:04] <ghrust> 13rust/06auto 1468129d2 15bors: auto merge of #12061 : pongad/rust/delorderable, r=cmr...
[03:17:05] *** Parts: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP) ()
[03:17:17] <brson> TEST_EXEC_ENV=22...
[03:17:21] <brson> have no idea what that means
[03:17:36] <acrichto> looks like one test uses that?
[03:17:43] <acrichto> this is... interesting
[03:17:48] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[03:18:17] <brson> ah, i think adb_run_wrapper.sh is run a single time for every test, and since compiletest runs n (8) tests in parallel that's why there were 8 instancese here
[03:18:35] <acrichto> and the wrappers were all spinning in sleep
[03:18:51] <acrichto> which looks like it means that all executables were exiting with error code 1
[03:18:56] <cmr> strcat, ping
[03:19:03] <strcat> cmr: pong
[03:19:22] <cmr> strcat: do you know what we need to do to get accurate asan/tsan?
[03:19:35] <strcat> add support to code generation all over the place
[03:19:36] <cmr> it seems emitting the sanitize_thread attributes and soforth is not enough, and just affects the optimizers
[03:19:37] <acrichto> brson: this seems really sketchy to always loop on an exit code of 1...
[03:19:44] <brson> acrichto: yeah :)
[03:19:51] <cmr> do we just need to call into the asan/tsan runtimes etc?
[03:19:55] <cmr> do you know of any docs?
[03:19:58] <strcat> cmr: our code generation needs to generate asan/tsan stuff, yes
[03:20:01] <strcat> no, don't know of any docs
[03:20:06] <strcat> look at what clang does to the IR
[03:20:12] <cmr> ok, I didn't find any.
[03:20:14] <acrichto> brson: did you add this script?
[03:20:21] <cmr> strcat: thanks!
[03:20:25] <brson> acrichto: no
[03:20:49] <acrichto> brson: can we try turning down the concurrency to 1 on the android bots?
[03:21:09] <acrichto> if it's this "Text File Busy" error perhaps two processes are racing for one of the dylibs or something like that
[03:21:25] <acrichto> TEST_EXEC_ENV <- super sketch
[03:21:32] <strcat> cmr: http://ix.io/auD no asan, http://ix.io/auE asan
[03:21:34] <strcat> looks fun
[03:21:44] <brson> acrichto: yeah, that TEST_EXEC_ENV is baffling
[03:21:50] <brson> surely that's not the only test using exec-env
[03:21:57] <cmr> eugh
[03:21:59] <cmr> miserable more like it
[03:22:00] <acrichto> and somehow everything is still passing?
[03:22:18] <cmr> what is it even doing
[03:22:32] <strcat> cmr: setting up and managing asan shadow stack/heap stuff
[03:22:41] <strcat> maybe there are IR builder things for it
[03:22:50] <strcat> would not be surprised if you had to do it all yourself
[03:23:12] <brson> acrichto: hm, there must be something more at work here
[03:23:25] <brson> can we really not be setting the test environment on android?
[03:24:21] <acrichto> brson: that can't be, other tests that rely on exec-env are passing
[03:24:29] <acrichto> I think this TEST_EXEC_ENV is just a relic of the ancient past
[03:24:43] <brson> runtest.rs has code for android environments
[03:24:46] <brson> yeah, probably
[03:25:12] <acrichto> brson: f7ee7d09
[03:25:17] <acrichto> that was the commit that added it
[03:25:49] <brson> interesting
[03:25:53] *** Quits: huon (Thunderbir@2702835C.D5A1DCF.37681C44.IP) (Ping timeout)
[03:26:34] *** Quits: brson (brson@981AA104.E81F12CD.76F66111.IP) (Quit: leaving)
[03:26:47] *** Joins: brson (brson@moz-BBE3ABD.mv.mozilla.com)
[03:26:47] *** ChanServ sets mode: +qo brson brson
[03:27:13] *** Joins: huon (Thunderbir@2702835C.D5A1DCF.37681C44.IP)
[03:27:20] <acrichto> brson: ok this makes no sense, the runtest.rs runner is *always* passing in an empty environment
[03:28:19] <acrichto> yet something like run-pass/logging-enabled.rs is passing
[03:28:22] *** Joins: zimbabao (rajaram@FEC515EC.BBF14D1D.D2D1FAF0.IP)
[03:28:36] <brson> acrichto: it sets the enviroment in a roundabout way
[03:28:59] <brson> at line 953
[03:29:08] <acrichto> ah
[03:29:13] <brson> it's using FOO=bar arguments to the shell on the emu
[03:29:21] <acrichto> ok so TEST_EXEC_ENV should not be necessary
[03:29:24] <brson> no
[03:29:33] <brson> looking into setting RUST_TEST_TASKS on the bot
[03:29:49] <acrichto> so it sounds like the only reason this wrapper truly exists is this "Text File Busy" error
[03:30:32] <brson> acrichto: oh look at this https://github.com/mozilla/rust/blob/master/src/compiletest/compiletest.rs#L224
[03:30:41] <brson> compiletest even tries to limit the parallelism but fails
[03:30:56] <acrichto> that's only debug-info tests though?
[03:30:58] <brson> wait, that should work
[03:31:08] <brson> yeah
[03:31:15] <brson> should just do that for all test types
[03:31:18] <acrichto> yeah
[03:31:25] <brson> i'll make that pr
[03:31:28] <acrichto> could we remove that wrapper entirely?
[03:31:33] <acrichto> the adb_wrapper_script.sh
[03:31:40] <brson> maybe?
[03:31:43] <brson> shall i try?
[03:31:49] <acrichto> I wouldn't
[03:31:53] <acrichto> it's creating like 8 files
[03:32:12] <brson> creating 8 files?
[03:32:20] <acrichto> foo.stderr
[03:32:26] <acrichto> foo.stdout
[03:32:28] <acrichto> foo.exitcode
[03:32:33] <acrichto> ok maybe only 3
[03:32:38] <acrichto> but something else may depend on those being there
[03:32:52] *** Quits: rca (rcatolino@moz-7FACA309.adsl.proxad.net) (Ping timeout)
[03:32:59] <acrichto> brson: actually are those files present on the bot right now?
[03:33:24] <brson> acrichto: yes
[03:33:31] <acrichto> do they have suspicious contents?
[03:33:42] <acrichto> apparently ssh'ing across the country is slow for m
[03:33:50] <strcat> use mosh
[03:34:12] <brson> acrichto: stderr looks like CANNOT LINK EXECUTABLE: could not load library "libstd-966edb7e-0.10-pre.so" needed by "/data/tmp/argument-passing.stage2-arm-linux-androideabi"; caused by cannot locate symbol "get_sp_limit" referenced by "libstd-966edb7e-0.10-pre.so"...
[03:34:16] <brson> so yes
[03:34:19] <acrichto> hahaha
[03:34:41] <acrichto> get_sp_limit?!
[03:35:12] *** Quits: zz_kimundi (kimundi@moz-7D8AC97.dip0.t-ipconnect.de) (Ping timeout)
[03:35:26] <acrichto> no
[03:35:33] <acrichto> something just cleared the emulator
[03:35:34] <acrichto> argh
[03:36:38] <brson> i hate it when my shell history doesn't include the configure invocation for android
[03:36:44] *** Quits: zimbabao (rajaram@FEC515EC.BBF14D1D.D2D1FAF0.IP) (Ping timeout)
[03:37:10] <acrichto> ok there are many things in /data/tmp right now
[03:37:17] <acrichto> so I presume that android is making process
[03:37:26] <brson> looks like it yes
[03:38:17] <acrichto> how did you get a process list?
[03:38:21] <acrichto> top prints horribly for me
[03:38:28] <brson> ps and top
[03:38:31] <brson> and they are bad
[03:38:34] <brson> busybox
[03:38:37] *** Joins: zz_kimundi (kimundi@moz-B28844C0.dip0.t-ipconnect.de)
[03:38:38] *** zz_kimundi is now known as kimundi
[03:38:52] <acrichto> busybox?
[03:39:01] <brson> android doesn't run the gnu userspace
[03:39:04] <brson> but busybox
[03:39:06] <acrichto> ah
[03:39:54] <acrichto> argh now I wan tto look at those files
[03:39:55] <brson> i'm going to start by limiting concurrent android tests to 1 and removing the error loop in the script
[03:40:02] <acrichto> mk
[03:40:11] * strcat hates busybox :(
[03:40:17] <acrichto> what does it mean it couldn't find get_sp_limit...
[03:40:29] <acrichto> which we should rename to rust_get_sp_limit ...
[03:40:34] <strcat> top prints properly for me though
[03:40:36] *** Quits: jdm (jdm@E595D12E.1196002C.7DBB297B.IP) (Quit: Lost terminal)
[03:41:09] *** Quits: sunfish (chatzilla@moz-BBE3ABD.mv.mozilla.com) (Ping timeout)
[03:41:31] <acrichto> brson: in rewriting makefiles, I could have messed up uploading the libraries to the emulator
[03:41:38] <acrichto> perhaps it's the wrong libstd?
[03:43:30] *** Quits: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca) (Quit: canhtak)
[03:43:52] <brson> acrichto: i don't see how get_sp_limit specifically could go missing ...
[03:44:14] <acrichto> brson: was that the entire contents of those files?
[03:44:26] <brson> yes
[03:45:00] <acrichto> argh I want to inspect those libraries
[03:45:10] <acrichto> but now it's another few hours until it deadlocks again :\
[03:47:23] *** Joins: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca)
[03:47:27] <nrc> anything changed with the build system in the last couple of days? It's not noticing that files have changed and so needs to rebuild :-s
[03:47:49] <acrichto> nrc: for which rule?
[03:47:53] <cmr> huon: ^ could your NO_REBUILD have affected that?
[03:48:29] <huon> cmr: maybe... but it seemed detect things correctly in my testing
[03:48:58] <huon> theoretically it changed nothing when NO_REBUILD is not set
[03:49:36] <nrc> acrichto: tried plain make and make rustc-stage1
[03:49:54] <acrichto> nrc: what'd you change?
[03:51:08] <nrc> rs file in libsyntax
[03:51:26] <acrichto> that should get picked up...
[03:51:27] <huon> which? it used to be that very deep files weren't detected properly
[03:51:32] <acrichto> unless you changed it while libsyntax was building
[03:51:45] *** Joins: zimbabao (rajaram@B9C85FA4.7BC2CC3C.D2D1FAF0.IP)
[03:52:48] *** Joins: Jesse (jruderman@moz-9754CB0.hsd1.ca.comcast.net)
[03:53:22] <nrc> no, defintely afterwards. I think my build might have just gone weird - I noticed it couldn't link a header on the last build. Trying make clean and start again...
[03:58:16] <nrc> oh, yeah something is really borked, it can't find an llvm header
[03:59:16] <nrc> which is weird, because I can see it
[03:59:38] <huon> do you need to reconfigure?
[04:01:05] <nrc> I just have :-(
[04:08:41] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[04:16:05] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[04:18:24] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[04:25:14] <brson> acrichto: testing changes to adb_run_wrapper.sh now
[04:25:23] <brson> not sure how much this will help the bot problems though
[04:25:27] <brson> should at least prevent the iloops
[04:25:29] *** Quits: nate (pinkeh@moz-A3C418FF.hcs.harvard.edu) (Quit: ...)
[04:25:37] <acrichto> it sounds like it won't fix the weird symbol issue
[04:25:40] <brson> nah
[04:25:56] <acrichto> hm I wonder if it was trying to run tests before the upload finished...
[04:26:02] <acrichto> b/c it died at the very beginning
[04:26:22] <acrichto> the next PR upcoming has failed a bunch of times in an iloop on android
[04:26:29] <acrichto> so it should hopefully show up something at least
[04:26:46] *** Quits: zimbabao (rajaram@B9C85FA4.7BC2CC3C.D2D1FAF0.IP) (Ping timeout)
[04:27:00] *** Joins: ghrust (ghrust@C95C9FF.6A2AE50.F3114085.IP)
[04:27:00] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/lDXQwQ
[04:27:00] *** Parts: ghrust (ghrust@C95C9FF.6A2AE50.F3114085.IP) ()
[04:27:02] <nrc> anyone seen this before?
[04:27:02] <acrichto> oh augh wait of course
[04:27:03] <nrc> In file included from /home/nick/rust2/src/rustllvm/RustWrapper.cpp:11:0:
[04:27:05] <nrc> /home/nick/rust2/src/rustllvm/rustllvm.h:11:31: fatal error: llvm/IR/IRBuilder.h: No such file or directory
[04:27:07] <nrc>  #include "llvm/IR/IRBuilder.h"
[04:27:16] <brson> :thumbsup:
[04:27:21] * nrc is going a little bit crazy
[04:27:36] <acrichto> brson: of course, I moved get_sp_limit to libgreen so it's not in libstd, not sure why it didn't show up until runtime
[04:27:47] <acrichto> nrc: is that picking up a system llvm install?
[04:28:16] <nrc> acrichto: could be? There is one, so it is possible, I guess
[04:28:35] <brson> acrichto: why would that error be looking for get_sp_limit in std?
[04:28:37] <acrichto> nrc: that could cause weirdness perhaps
[04:28:50] <acrichto> brson: get_sp_limit is called from std as part of some stack bounds management
[04:28:53] <nrc> acrichto: do you know what env vars to check?
[04:29:26] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[04:29:26] <acrichto> nrc: hm, to see if there's an existing install?
[04:29:32] <acrichto> or whether the new install is getting picked up
[04:29:57] <brson> opinions about 'oxidize: foo'?
[04:30:06] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: Textual IRC Client: www.textualapp.com)
[04:30:14] <nrc> acrichto: the latter (there is definitely an existing instal)
[04:30:23] <huon> brson: it's cuter than "compile_and_link: ..."
[04:31:08] <acrichto> nrc: hm I suppose we may be passing some -I wrong to gcc, although I'm not sure how to check that
[04:31:57] *** Joins: ghrust (ghrust@4089EBDC.6A2AE50.F3114085.IP)
[04:31:57] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/a5xxwQ
[04:31:57] *** Parts: ghrust (ghrust@4089EBDC.6A2AE50.F3114085.IP) ()
[04:32:01] <nrc> make --verbose logs I guess
[04:32:15] <acrichto> nrc: make VERBOSE=1 will print out commands that are run
[04:32:36] <acrichto> brson: ok so this explains the weirdness of the get_sp_limit symbol, but it doesn't explain the deadlocking in benchmarks
[04:32:48] <acrichto> brson: sounds like the timeouts are legit though, so I'll think about it some more
[04:32:59] <acrichto> not infinite looping will be nice
[04:35:01] <eddyb> great, tons of merge conflicts... what happened?
[04:35:18] <eddyb> pcwalton munched all the ~[T]?
[04:35:47] <huon> eddyb: http://huonw.github.io/isrustfastyet/pull_requests/
[04:35:57] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[04:36:06] <huon> probably the crate one
[04:36:57] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[04:36:57] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/a5xxwQ
[04:36:57] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[04:36:57] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[04:36:57] <ghrust> 01[13rust01] 15bors pushed 5 new commits to 06auto: 02http://git.io/y-Lb7w
[04:36:57] <ghrust> 13rust/06auto 14d5e0622 15Alex Crichton: Fix a bug where cached stacks weren't re-used...
[04:36:57] <ghrust> 13rust/06auto 14aaead93 15Alex Crichton: Don't allocate in LocalHeap::new()...
[04:36:58] <ghrust> 13rust/06auto 1421a064d 15Alex Crichton: Don't require an allocation for on_exit messages...
[04:37:00] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[04:39:13] <eddyb> huon: crate was added in the wrong place...
[04:39:25] <eddyb> they should be alphabetically ordered AFAIK
[04:41:07] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[04:41:15] <nrc> acrichto: this -iquote business - should I see that in the build commands or should it have been subst'ed back into -I ?
[04:41:29] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[04:42:04] <huon> eddyb: eh?
[04:42:10] <huon> "they"?
[04:42:13] <eddyb> huon: in the token list
[04:42:24] <huon> oh
[04:42:53] <huon> eddyb: ermm, we've got a special alphabet.rs
[04:42:54] <huon> ;P
[04:45:49] <eddyb> krate feels so krusty :S
[04:46:00] <huon> sfackler: is there any difference in the timing of expansion in, say, `rustc -Z time-passes --pretty expanded libstd/lib.rs > /dev/null` for you item decorator patch?
[04:46:36] <sfackler> not sure, it's compiling now
[04:46:50] <sfackler> it seems like a reasonable change in any case
[04:49:17] <sfackler> I kind of doubt it'll be noticeable
[04:50:07] <huon> maybe in a crate with a million derivings, but yeah, I agree
[04:50:19] <huon> (maybe libsyntax with the ast?)
[05:00:46] <eddyb> r=nmatsakis? https://github.com/mozilla/rust/pull/12162
[05:03:20] <eddyb> wait, I didn't push?
[05:03:54] <sfackler> huon: no noticable change on libsyntax
[05:04:12] <eddyb> this is what I get for waking up early
[05:04:46] <eddyb> huon: pushed: ^^?
[05:05:38] <huon> sfackler: drat :'(
[05:05:49] <huon> eddyb: just fixing the merge conflicts, right/
[05:05:50] <huon> ?
[05:05:55] <eddyb> yupp
[05:06:14] <eddyb> -j4 makes libsyntax compile twice, wtf?
[05:06:17] <huon> Nice, how'd you managed to kill 700 lines?! o_O
[05:06:17] <eddyb> huon: wait
[05:06:24] <eddyb> something is silly here
[05:06:34] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[05:06:54] <sfackler> eddyb: the rust makefile structure is very broken during parallel builds
[05:07:00] <eddyb> no kidding
[05:07:25] <eddyb> huon: pushed again
[05:07:48] <eddyb> broken makefile misled me to believe I fixed all the errors :/
[05:08:05] <eddyb> also, I wish there was an easy way to get rid of comments and strings so I can grep just the code
[05:08:26] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[05:08:39] <eddyb> --pretty parse,strip-comments,strip-strings
[05:09:52] <eddyb> this is taking waay too long :/
[05:10:04] <eddyb> what's after expansion, configuration 2?
[05:10:14] <eddyb> time: 61.396 s  configuration 2
[05:10:50] <eddyb> you know, I've tried to find whatever is causing that to take so much time...
[05:11:19] <eddyb> and there's nothing obvious, other than allocating new structures during folding
[05:12:22] <huon> woah,woah?
[05:12:28] <huon> run it under perf?
[05:12:46] <aatch> eddyb, I'm pretty sure that allocating the new structures *is* what is taking the time...
[05:12:54] <huon> eddyb: so, is #12162 ready?
[05:13:24] <eddyb> yupp
[05:14:01] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Client exited)
[05:14:11] <eddyb> aatch: but what changed recently?
[05:14:15] <eddyb> it used to take less than a minute
[05:14:22] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[05:15:24] <eddyb> huon: I don't have -g rustc to use perf properly
[05:15:25] *** Joins: zimbabao (rajaram@47769425.AE842F9B.81C3DAA1.IP)
[05:15:57] <eddyb> cmr does, though. I wonder if he can reproduce the same cfg2 nonsense
[05:15:59] *** Quits: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca) (Quit: canhtak)
[05:16:03] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Ping timeout)
[05:16:08] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[05:18:02] <huon> eddyb: the symbol names are still there
[05:18:05] *** Quits: luzie (lucy@moz-CD18B14B.customer.cdi.no) (Input/output error)
[05:18:06] <huon> if a little harder to read
[05:18:12] *** Joins: luz (lucy@moz-CD18B14B.customer.cdi.no)
[05:18:32] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[05:24:22] <brson> acrichto: r? https://github.com/mozilla/rust/pull/12256
[05:26:39] <eddyb> my two cents https://github.com/mozilla/rust/pull/12253#issuecomment-35057075
[05:26:52] <eddyb> though it's probably known and not interesting
[05:27:18] <eddyb> yeah, nevermind, removed that comment
[05:27:53] <eddyb> huon: rustc profiles are hardly meaningful without callgraphs and those require DWARF
[05:28:20] <huon> eddyb: well... how long do the phases before cfg2 take?
[05:28:55] <eddyb> time: 2.532 s   expansion
[05:30:22] <acrichto> nrc: I always wondered why it was -iquote instead of -I
[05:30:28] <acrichto> nrc: maybe it's causing the problems
[05:30:51] <eddyb> huon: no r=nmatsakis?
[05:30:55] <huon> eddyb: oh, sorry forgot
[05:31:12] <eddyb> np. I wonder if I'm distracting him every time I do that :P
[05:31:24] <huon> eddyb: but yeah, `perf rustc ... -Z time-passes` ^C when it prints cfg2
[05:31:35] <huon> since cfg2 take far and away the most time
[05:32:21] <eddyb> env CFG_{VERSION,PREFIX,LIBDIR_RELATIVE,RUSTLIBDIR,COMPILER}= perf record -g fp ./x*/stage0/bin/rustc src/librustc/lib.rs -Z time-passes --cfg stage0
[05:32:28] <eddyb> it's that kind of fun
[05:32:46] <eddyb> I should remove -g fp, our frame pointers don't help much
[05:32:48] *** Joins: edwardw (Mibbit@E6E87FA7.354F6412.B9C6B12A.IP)
[05:33:01] <edwardw> r? https://github.com/mozilla/rust/pull/12257
[05:33:09] <edwardw> a very straightforward one
[05:35:22] <eddyb> huon:  89,10%  rustc  libc-2.18.so         [.] memset
[05:35:23] <eddyb> LOL
[05:35:30] <eddyb> see why I want call graphs?
[05:36:29] <huon> eddyb: why Type.Trait::method, btw?
[05:36:50] <eddyb> I have to give the impl a name
[05:37:22] <eddyb> I have path_to_impl1::path_to_impl2::impl_name::method_name::...
[05:37:24] <huon> yeah, but that's seems slightly backward
[05:37:35] <huon> eh, whatever
[05:37:36] <eddyb> impl_name has to contain both the trait and the type
[05:37:44] <huon> anyway, how do I get dwarf in a compiler?
[05:37:50] <eddyb> -g
[05:37:54] <huon> `RUSTFLAGS=-g`?
[05:37:59] <eddyb> I guess
[05:38:15] <eddyb> my problem was scoping
[05:38:25] <sfackler> huon: iirc it ICEs at some point if you try to build rustc with debug info
[05:38:50] <Luqman> sfackler: nope, works fine
[05:38:57] <huon> eddyb: you're seeing cfg2 take 60 seconds?!? o_O
[05:39:06] <huon> time: 0.267 s   configuration 2
[05:39:09] <huon> for librustc
[05:39:19] <eddyb> are you on master?
[05:39:21] <huon> yes
[05:39:50] <eddyb> I doubt my changes could ever affect it, I didn't add new #[cfg] directives, and I removed 600 lines of code per total...
[05:40:01] <sfackler> eddyb: are you swapping or something?
[05:40:05] <eddyb> huon: if I put trait first then you could end up with std::vec_ng::std::ImmutableVector<for Vec<T>> which feels ridiculous
[05:40:12] <eddyb> sfackler: nope, plenty of RAM
[05:40:17] <huon> why is that ridiculous?
[05:40:27] <eddyb> the scoping is wrong
[05:40:30] <huon> eddyb: sounds like your changes might be a huge pessimisation
[05:40:41] *** Quits: jyyou (jyyou@moz-47B052FA.cs.nctu.edu.tw) (Ping timeout)
[05:40:50] <eddyb> if my changes affect it, then there's something very wrong going on
[05:40:50] * huon removes the r= for now
[05:41:07] <eddyb> very very wrong
[05:41:19] <huon> wait, you're using the stage0 compiler?
[05:41:28] <huon> isn't that the snapshot?
[05:41:28] <eddyb> yeah
[05:41:36] <eddyb> that's how the first librustc is built
[05:42:02] <eddyb> sfackler: (at least until type checking)
[05:42:06] <huon> can you compare against a master compiler built without your changes please?
[05:42:34] <eddyb> even better, I can compare it to stage1 building stage2
[05:42:40] <huon> because making a phase of a compiler take 100x longer is not acceptable, so we need to work out what's causing it.
[05:42:58] <eddyb> it's the snapshot
[05:43:21] <eddyb> I wonder why the snapshot itself would be so slow at doing cfg2
[05:43:39] <eddyb> huon: you can put that r=niko back now :)
[05:44:07] <huon> i haven't heard a good explanation for cfg2 taking 100x longer...
[05:44:11] *** Joins: jyyou (jyyou@moz-47B052FA.cs.nctu.edu.tw)
[05:44:24] <eddyb> just test stage0 rustc building stage1 librustc
[05:44:37] <eddyb> there's a complete perf command-line above
[05:44:57] <huon> time: 0.255 s   configuration 2
[05:44:59] <eddyb> but there's no DWARF in the snapshot, sadly
[05:45:18] <huon> CFG_COMPILER= CFG_RUSTLIBDIR= CFG_LIBDIR_RELATIVE= CFG_PREFIX= CFG_VERSION= build/x86_64-unknown-linux-gnu/stage0/bin/rustc src/librustc/lib.rs -Z time-passes
[05:45:37] <eddyb> hah
[05:45:43] <huon> with 89b1686bd7db25b5dd948b1a4d9dfd0c68084c29 checked out
[05:46:05] <eddyb> I'm on top of 68129d299b54806b6aa4ec9f3a0755854db7b491
[05:46:26] <eddyb> your HEAD + "Removed num::Orderable"
[05:47:00] *** Joins: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP)
[05:47:00] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/y-Lb7w
[05:47:00] *** Parts: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP) ()
[05:47:02] <huon> I'm trying it on your source now
[05:47:14] *** Quits: jyyou (jyyou@moz-47B052FA.cs.nctu.edu.tw) (Ping timeout)
[05:47:36] <huon> time: 0.234 s   configuration 2
[05:47:47] <huon> looks like it might just be your computer.. very weird
[05:48:08] <eddyb> my snapshot is 2014-02-12-c62f6ce-linux-x86_64-8f5fdf9f07b2afbc55d8d8c06c60aeb532b5ea83.tar.bz2
[05:48:41] <huon> same (since I've got your branch checked out)
[05:49:18] <eddyb> anyways, it's not my fault :)
[05:49:57] <sfackler> huon: r? https://github.com/mozilla/rust/pull/12234
[05:51:54] *** Joins: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP)
[05:51:54] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/FdserQ
[05:51:54] *** Parts: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP) ()
[05:51:57] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[05:51:57] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/SGD7ww
[05:51:57] <ghrust> 13rust/06auto 14a06ce0c 15Brian Anderson: compiletest: Run all android tests serially...
[05:51:57] <ghrust> 13rust/06auto 146784179 15Brian Anderson: Stop looping on error waiting for android test results...
[05:51:58] <ghrust> 13rust/06auto 148d6fef6 15bors: auto merge of #12256 : brson/rust/android, r=alexcrichton...
[05:52:00] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[05:52:21] <eddyb> huon: you were a bit too late :(
[05:52:26] <huon> eddyb: sorry :(
[05:52:45] <huon> eddyb: wait... no
[05:52:49] <huon> that one has p=1
[05:52:55] <eddyb> ahh, okay :)
[05:53:23] <huon> sfackler: commented
[05:53:29] <eddyb> anyways, one more IR nuissance to fix. or should I remove __log_level?
[05:54:39] <sfackler> huon: updated and r'd, thanks
[05:55:34] <brson> it hurts us pretty bad these days when we have automation downtime
[05:55:49] <sfackler> I think I'm actually going to restructure it so the expansion happens in expand_item, which'll allow #deriving on things in functions and allow for expansion of generated items
[05:55:58] <eddyb> brson: long term solution: develop an AI
[05:56:06] <acrichto> hm, perhaps another rollup is in order
[05:56:09] <huon> yeah, I saw the queue at 70 before acrichto landed the rollup PR o_O
[05:56:18] <acrichto> and it's still at 55 :(
[05:56:29] <acrichto> 17 approved though
[05:56:35] <sfackler> and only 4 stale or bad!
[05:56:36] * huon does his bit and closes old PRs
[05:56:56] <aatch> brson, I guess that proves the utility of the automation
[05:57:13] *** Joins: mankyKitty (Instantbir@325B2C60.E2538F64.BC02889B.IP)
[05:57:24] <brson> aatch: it makes me panic just thinking about not having good automation
[05:57:41] <brson> it's amazing having an always green tree
[05:57:54] <acrichto> I find that amazingly convenient
[05:58:05] <acrichto> I'm a big fan of our automation setup
[05:58:09] <acrichto> even if it is a little slow
[05:58:29] <brson> i'm very curious to find out about *any* other projects doing full pre-commit testing like this
[05:58:48] <huon> firefox?
[05:58:52] <mankyKitty> acrichto: sorry about not being active on that issue for the extern fn type checking. :( have been between continents.. 
[05:59:03] <huon> mankyKitty: swimming?
[05:59:04] <brson> huon: firefox does not check before commit
[05:59:04] <eddyb> nmatsakis: are typeck vtables an optimization to trait lookup?
[05:59:12] <acrichto> mankyKitty: no worries! we're just trying to slim down the queue (it's quite large right now)
[05:59:12] <brson> huon: they have constant firefighting
[05:59:14] <sfackler> there are plenty of projects that run tests before merging, but I'm not sure if there are any that actually serialize PRs like bors does
[05:59:15] <huon> brson: oh, really? weird.
[05:59:21] <acrichto> mankyKitty: but please feel free to reopen when you get a chance!
[05:59:28] *** Quits: enix (enix@moz-A50569DD.c3-0.slvr-ubr1.lnh-slvr.md.cable.rcn.com) (Ping timeout)
[05:59:34] <mankyKitty> huon: hah! not quite, but a 36 hour travel is going to ruin anyone for a few days
[05:59:43] <huon> mankyKitty: yup :)
[05:59:52] <acrichto> if our PR rate were like 4x higher I don't think serializing bors could sustain the load
[06:00:21] <sfackler> yeah
[06:00:26] <brson> we would need to expand our strategy
[06:00:31] <brson> and complexity
[06:00:33] <huon> bors often gets downtime during the US night
[06:00:34] <mankyKitty> acrichto: Yeah I really want to, the parse_ty fn is a little terrifying though. >< I really want to refactor the whole thing. :\
[06:00:38] <huon> (fwiw)
[06:01:38] <brson> i'm very curious what percentage of pushes to auto fail
[06:01:52] <brson> there's probably a lot we can do to just reduce the proportion of failures
[06:02:20] <huon> https://github.com/mozilla/rust/issues/7085 would make some failures super-fast
[06:02:25] <acrichto> it would be nice to have a second bors
[06:02:32] <acrichto> which just ran on PRs and said what happened
[06:02:40] <sfackler> you could try having an extra bot that runs make-check-stage1-* to catch test failures earlier
[06:02:57] <huon> sfackler: what about stage1 specific failures?
[06:03:04] <huon> (i.e. that don't fail in stage2)
[06:03:11] <sfackler> sounds broken to me!
[06:03:14] <sfackler> :D
[06:03:15] <brson> our bots are horribly unreproducable atm so it's impossible to create a system that can make identical builds to divide the work
[06:03:23] <eddyb> huon: xfail-stage0?
[06:03:30] <huon> eddyb: stage1 ;)
[06:03:38] <sfackler> yeah, and xfail-stage1 is a thing now
[06:03:47] <brson> acrichto: what do you mean 'just ran on PRs and said what happened'?
[06:03:48] <huon> oh, really?
[06:04:13] <huon> a try bot that responds to github comments?
[06:04:20] <acrichto> brson: we have a lot of churn by a few volatile PRs at the top of the queue, but during that time we could have another bors testing all PRs sequentially just saying what it think will happen
[06:04:30] <acrichto> the make check-stage1 is not a bad idea
[06:04:31] <sfackler> huon: that's now most projects do unbreakable builds
[06:04:37] <acrichto> it would help weed out a lot of churn at the top in theory
[06:04:45] <sfackler> *how
[06:04:57] <acrichto> if we could hook up to travis-ci that'd be amazing
[06:05:05] <acrichto> but I don't think we could do that very easily
[06:05:08] <sfackler> travis-ci will check new PRs automatically
[06:05:26] <huon> how much CPU time does a travis build get?
[06:05:34] <sfackler> the free travis tier doesn't have nearly enough ram to build rustc
[06:05:40] <sfackler> it gets like 20 or 30 minutes iirc
[06:05:51] <sfackler> but only like 512 MB of RAM
[06:05:51] <acrichto> I think we'd have to donate our own hardware to run our builds on for travis
[06:06:04] <acrichto> I also think that travis doesn't do many-platform builds right now
[06:06:26] <sfackler> they do linux and osx iirc
[06:06:32] <acrichto> we could have travis building linux64 though, especially if it's just opportunistic
[06:06:39] <acrichto> I'm not sure that you can simultaneously do osx and linux though
[06:06:45] <acrichto> may have changed recently though?
[06:07:02] <eddyb> 512MB... hmm. challenge accepted :)
[06:07:14] <eddyb> I doubt we actually need all that RAM
[06:07:48] <huon> how many nodes does librustc have?
[06:07:56] <eddyb> does anyone know?
[06:08:11] <huon> ah, sec...
[06:08:14] <eddyb> there's a lot of fragmentation because our heap abuse
[06:08:39] <eddyb> on the irsy graphs, you see memory usage constantly increasing, while massif reports spikes, dropping down to essentially nothing in between
[06:08:47] <huon> "The AST map has 426347 entries with a maximum of 539506: occupancy 79.0%"
[06:09:16] <huon> so not *that* many.
[06:09:33] <eddyb> I wonder if we should restrict the node IDs to 20 bits
[06:09:37] <eddyb> that's twice librustc
[06:10:00] <huon> and save 12 bits per ID?
[06:10:01] <eddyb> then we still have 12 bits for the crate ID
[06:10:18] <huon> also, twice librustc doesn't seem like much...
[06:10:41] <eddyb> 2^22 nodes and 2^10 crates? that's still a lot
[06:10:47] <huon> especially when it's only getting us at most 4MB (and probably less due to alignment)
[06:11:08] <eddyb> ast_map usage?
[06:12:15] <eddyb> hmm, with my changes, the ast_map will only use 8MB for rustc, previously holding *at least* 32MB + paths (heap vectors)
[06:12:50] <eddyb> a bit sad that the parent IDs have to be interior to the enum variants
[06:12:51] *** kimundi is now known as zz_kimundi
[06:15:10] <eddyb> ohh, making log_level an intrinsic is quite simple
[06:15:53] <eddyb> but the bootstrapping will be a nightmare
[06:16:22] <huon> just leave them both defined for now until the intrinsic is in stage0
[06:16:47] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[06:17:07] <eddyb> I think the stage0 compiler is solely responsible for having the log level macro work
[06:18:35] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[06:20:09] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Ping timeout)
[06:20:40] *** Quits: edwardw (Mibbit@E6E87FA7.354F6412.B9C6B12A.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[06:21:02] *** Joins: edwardw (Mibbit@E761717E.1B2F6624.7F41E82D.IP)
[06:21:35] <eddyb> if_ok!(word(&mut s.s, "__volatile__ asm!")); lol, the pretty printer is silly
[06:22:10] *** Joins: brson (brson@moz-BBE3ABD.mv.mozilla.com)
[06:22:10] *** ChanServ sets mode: +qo brson brson
[06:24:38] <eddyb> huon: lol, what, Mac(ro)Result uses ExprLogLevel as a dummy expression
[06:25:04] <sfackler> sounds legit
[06:25:12] <huon> eddyb: it doesn't take any args or anything... i.e. super simple and perfect as a dummy expression
[06:25:40] *** Joins: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP)
[06:25:50] <eddyb> ExprTup(~[@Expr]) if that were using Vec<@Expr> instead, ExprTup([]) would be just as cheap
[06:27:16] <huon> it doesn't actually matter... the dummy expressions are only used when an error has been hit
[06:27:30] <huon> so it's not like efficiency matters much
[06:27:49] <huon> (and ExprTup([]) would require zeroing 3 words, so not *exactly* as cheap :P )
[06:32:14] *** Joins: jyyou (jyyou@moz-B061DB92.cs.nctu.edu.tw)
[06:38:35] *** Quits: fredy (fredy@moz-E7647C0E.vm.okeanos.grnet.gr) (Ping timeout)
[06:46:26] *** Quits: aatch (James@moz-B437F499.pocketrent.com) (Client exited)
[06:48:52] *** Quits: edwardw (Mibbit@E761717E.1B2F6624.7F41E82D.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[06:49:00] <eddyb> huon: rebased, mind giving another r=? https://github.com/mozilla/rust/pull/12162
[06:49:01] *** Joins: fredy (fredy@moz-E7647C0E.vm.okeanos.grnet.gr)
[06:49:09] <eddyb> (before bors merges, that is)
[06:49:36] <huon> another rebase?
[06:49:38] *** Joins: edwardw (Mibbit@E761717E.1B2F6624.7F41E82D.IP)
[06:49:50] <huon> did it conflict with green task spawning?
[06:49:57] <eddyb> I had to rebase because I found out I needed those changes in my new branch
[06:50:35] <eddyb> I guess I didn't have to, but I'm not a git ninja, I only know a few safe things
[06:55:48] <sfackler> woo! #[deriving] inside of functions works!
[06:56:01] * huon hugs sfackler 
[06:56:24] <eddyb> sfackler: rusti (users worldwide) thank(s) you
[06:56:54] <sfackler> hmm, it depends on the other libsyntax PR that I have pending. should I just push it with that commit under it or what?
[06:57:24] <huon> you can just open a new PR and then GH will automatically work out that the other commit was merged
[06:57:29] <sfackler> cool
[06:57:39] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[06:58:42] <eddyb> sfackler: git rebase --onto is your friend
[06:59:02] <ChrisMorgan> sfackler: but make sure that you use a different branch name, or it'll update the first PR.
[06:59:33] <huon> (The other option is to just use that PR and update the description etc.)
[07:01:42] <sfackler> https://github.com/mozilla/rust/pull/12258
[07:01:47] *** Joins: ghrust (ghrust@7BEB6F9D.6A2AE50.F3114085.IP)
[07:01:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/SGD7ww
[07:01:47] *** Parts: ghrust (ghrust@7BEB6F9D.6A2AE50.F3114085.IP) ()
[07:04:28] <huon> sfackler: simple enough
[07:05:22] <sfackler> huon: updated
[07:06:47] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[07:06:47] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/YPgAsA
[07:06:47] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[07:06:47] *** Joins: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP)
[07:06:47] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/xMCWKA
[07:06:47] <ghrust> 13rust/06auto 14a02b10a 15Eduard Burtescu: Refactored ast_map and friends, mainly to have Paths without storing them.
[07:06:47] <ghrust> 13rust/06auto 142fe7bfe 15bors: auto merge of #12162 : eddyb/rust/ast-map-cheap-path, r=nikomatsakis
[07:06:48] *** Parts: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP) ()
[07:07:01] <huon> sfackler: you're missing the closing ) for .push_all(
[07:07:24] <huon> sfackler: r=me
[07:07:53] <huon> (after the ( is closed)
[07:07:58] <sfackler> yep, just fixed it
[07:08:11] <sfackler> should I wait on the r+ until the other PR merges or just do it now?
[07:08:20] <huon> just do it now
[07:08:38] <sfackler> cool, done
[07:08:39] <huon> you could even close the other one as subsumed by this one, if you felt like conserving bors time
[07:08:50] <huon> (and think the first one is likely to land)
[07:09:05] <sfackler> it shouldn't have a problem
[07:15:53] <eddyb> huon: huh... tcx has a "destructor_for_type" map...
[07:16:08] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[07:16:48] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[07:17:00] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Input/output error)
[07:17:16] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[07:17:18] <huon> eddyb: i'm missing the context for why this is worth of comment?
[07:17:47] * huon -> home
[07:17:51] <eddyb> typeck actually inserts the Drop::drop implementations for each type in that map
[07:18:28] <huon> ignoring trait bounds/monomorphisation of generics, though, right?
[07:18:30] <eddyb> it could just as well store vtables
[07:18:31] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[07:18:43] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[07:19:07] <eddyb> the comment in trans::base about this issue assumes typeck cannot link actual values and/or their types to the drop impl
[07:19:15] <eddyb> but it already does
[07:19:20] <eddyb> huon: yupp
[07:19:59] *** Quits: huon (Thunderbir@2702835C.D5A1DCF.37681C44.IP) (Quit: huon)
[07:20:17] *** Quits: edwardw (Mibbit@E761717E.1B2F6624.7F41E82D.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[07:21:05] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Quit: Leaving...)
[07:24:27] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[07:28:15] <eddyb> ohh, it's not type -> impl :(
[07:28:24] <eddyb> it's type definition -> impl
[07:28:51] <Eridius> I just got "note: ld: library not found for -lcompiler-rt" again
[07:28:55] <Eridius> this is turning out to be a common thing
[07:29:04] <Eridius> I'm guessing at this point it's a race condition with -j4
[07:29:20] <strcat> hm
[07:29:28] <strcat> my rust nightly has been successful lately though
[07:30:11] <Eridius> I don't see any indication of it trying to cp libcompiler-rt.a in the failure run, but a subsequent `make -j4` cp's it as the very first step
[07:30:22] *** Quits: fredy (fredy@moz-E7647C0E.vm.okeanos.grnet.gr) (Ping timeout)
[07:30:39] <strcat> when did rust start using compiler-rt? last LLVM upgrade?
[07:31:05] <eddyb> strcat: I was getting excited earlier, but what I found wasn't good enough...
[07:31:27] *** Joins: eibwen (kvirc@moz-DBA0490C.dip0.t-ipconnect.de)
[07:32:49] <sfackler> strcat: does the rust nightly build symlink over the second copy of lib* just to save space?
[07:32:55] <strcat> sfackler: yes
[07:33:08] <strcat> it doesn't make the pkg much smaller but it makes the install a lot smaller
[07:33:14] <strcat> might as well, same ABI
[07:33:19] <sfackler> has it ever caused problems?
[07:33:21] <strcat> nope
[07:33:31] <sfackler> cool
[07:33:41] <strcat> if it did, it'd be either a rust bug or a very weird bootstrapping cfg() situation
[07:33:50] <strcat> I've never actually seen anything but stage0 and not(stage0)
[07:33:52] <strcat> so it's not a problem
[07:33:56] <sfackler> if it works, we should probably rejigger the build infrastructure to do that by default
[07:34:24] <strcat> it could be a problem if we had stage1 cfg markers
[07:37:01] *** Joins: fredy (fredy@moz-E7647C0E.vm.okeanos.grnet.gr)
[07:38:58] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[07:40:25] *** Joins: jdm_ (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[07:40:54] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[07:44:57] <eddyb> / Check the arguments. We do this in a pretty awful way: first we typecheck any arguments that are not anonymous functions, then we typecheck the anonymous functions.
[07:45:00] <eddyb> lol
[07:47:00] *** Quits: jdm_ (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[07:47:54] <eddyb> fn_inputs.map(|a| *a) eww
[07:48:15] <eddyb> that's a clone
[07:59:03] *** Joins: enix (enix@moz-A50569DD.c3-0.slvr-ubr1.lnh-slvr.md.cable.rcn.com)
[08:06:24] *** Joins: Zr40 (zr40@EE4BB9F5.926C319A.BE2F4011.IP)
[08:09:27] *** Quits: Jesse (jruderman@moz-9754CB0.hsd1.ca.comcast.net) (Quit: Jesse)
[08:11:50] *** Joins: Jesse (jruderman@moz-9754CB0.hsd1.ca.comcast.net)
[08:16:47] *** Joins: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP)
[08:16:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/xMCWKA
[08:16:47] *** Parts: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP) ()
[08:18:10] *** flaper87|afk is now known as flaper87
[08:19:57] *** Joins: doener (doener@moz-C68F600D.unity-media.net)
[08:21:51] *** Joins: ghrust (ghrust@C95C9FF.6A2AE50.F3114085.IP)
[08:21:52] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/8D_EfQ
[08:21:52] *** Parts: ghrust (ghrust@C95C9FF.6A2AE50.F3114085.IP) ()
[08:23:33] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Ping timeout)
[08:24:38] <flaper87> w00000000000000000000t the crate patch landed!
[08:25:07] <eddyb> flaper87: and my PR
[08:25:38] <flaper87> eddyb: yeah, your's is HEAD now, I was like: "mmhh eddyb's patch landed, I bet mine conflicted with his" 
[08:25:41] <flaper87> :D
[08:25:55] <flaper87> anyway, no more conflicts there
[08:26:09] <eddyb> I had to rebase
[08:26:12] <flaper87> now, I need a snapshot and then replace the every usage of `extern mod`
[08:26:16] <flaper87> eddyb: ah see
[08:26:40] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:26:43] *** Joins: huon (Thunderbir@moz-826BD85A.lns20.syd6.internode.on.net)
[08:26:44] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:26:47] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:26:49] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[08:26:49] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/exYjrw
[08:26:49] <ghrust> 13rust/06auto 14cc34dbb 15Alex Crichton: Expose whether event loops have active I/O...
[08:26:49] <ghrust> 13rust/06auto 144256d24 15Alex Crichton: Percolate the (Scheduler, GreenTask) pair upwards...
[08:26:49] <ghrust> 13rust/06auto 142650b61 15Alex Crichton: Don't hit epoll unless a scheduler absolutely must...
[08:26:51] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[08:27:14] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:29:31] <eddyb> it's amazing what window layout can do to productivity
[08:29:43] <eddyb> manually tiled, for now
[08:30:36] <eddyb> strcat, cmr: r? https://github.com/mozilla/rust/pull/12259
[08:30:40] <strcat> use i3
[08:30:43] <strcat> ;p
[08:31:10] <eddyb> I was poking at vtable resolution when I saw that mess
[08:31:26] <eddyb> strcat: can you bring rusti in here?
[08:31:34] <strcat> it was
[08:31:37] <strcat> it was dced
[08:31:50] <eddyb> there's a testcase I want to show off
[08:31:55] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:31:56] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:33:20] <eddyb> rusti: fn foo<T>(x: T, _y: T) -> T {x} foo(0, 1, 2)
[08:33:24] * flaper87 is an awesomewm lover
[08:33:27] -rusti- pastebinned 11 lines of output: http://ix.io/auP
[08:34:40] <eddyb> hmm, weird... I was expecting something worse
[08:34:42] <flaper87> eddyb: o_0
[08:35:36] *** Joins: aurynj (Eon@2C265A5F.5D40BDF3.6B2FAB37.IP)
[08:35:48] <eddyb> rusti: fn foo<T>(x: T, f: |T| -> T) -> T {f(x)} foo(0, |x| x + 1, 2)
[08:35:51] -rusti- pastebinned 14 lines of output: http://ix.io/auQ
[08:36:18] *** Joins: bytbox (s@moz-AA99B23F.washdc.fios.verizon.net)
[08:36:31] <eddyb> that's odd. I don't know how to trigger this error
[08:36:50] <eddyb> I guess it's "error: the type of this value must be known in this context"
[08:37:17] * flaper87 back to day job
[08:37:56] <eddyb> strcat: for arity mismatches, the typeck code assigns ty_err to all arguments, having to always clone the arguments vector because of that
[08:38:10] <eddyb> do we benefit at all from errors like that?
[08:38:38] <eddyb> rusti: fn foo<T>(x: T, f: |T| -> T) -> T {f(x)} foo(0, 1.bar(4), 2)
[08:38:40] -rusti- pastebinned 8 lines of output: http://ix.io/auR
[08:42:01] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[08:43:23] <strcat> someone should probably implement the language benchmarks game things in a way that's not so terrible
[08:43:26] <strcat> going to make rust look bad
[08:43:53] <huon> strcat: there's at least one that's not horrible
[08:44:04] <huon> but yeah... the rest :/
[08:44:48] <strcat> can fix them in-tree too
[08:44:50] * strcat shrugs
[08:45:39] <eddyb> strcat: ouch, I forgot to rebase after the ast_map PR landed https://github.com/mozilla/rust/pull/12259
[08:46:23] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[08:47:30] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[08:48:39] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Input/output error)
[08:48:50] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[08:49:19] <nrc> can someone give me a history lesson? Did `extern fn` (as a type, not an item definition) use to mean something different to `fn`? Does it now?
[08:49:57] <eddyb> fn should be a shorthand for extern "Rust" fn
[08:50:16] <huon> eddyb: it is
[08:50:33] <huon> nrc: previously `fn` didn't exist
[08:50:39] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Input/output error)
[08:50:46] <eddyb> we used to have all sorts of weird fn's, now there's only fn(..Args) -> Ret (fn pointer), |..Args| -> Ret (closure) and proc(..Args) -> Ret (procedure)
[08:50:48] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[08:50:50] <huon> (at least, not referring to a bare function: closures used to be &fn, ~fn and @fn)
[08:51:07] <eddyb> &fn -> ||, ~fn -> proc
[08:51:11] <huon> and a bare Rust function would be written as extern "Rust" fn always
[08:51:28] <huon> (and that may or may not have been equivalent to `extern fn` in type signatures)
[08:51:33] <huon> can't remember
[08:51:56] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Input/output error)
[08:52:13] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[08:52:42] <huon> (to be clear, fn foo() {} was valid. the extern "Rust" fn was just for things like `fn foo(f: extern "Rust" fn()) {}`)
[08:52:47] * huon -> dinner
[08:54:00] <huon> rusti: fn foo() {} let _: extern fn() = foo;
[08:54:03] -rusti- pastebinned 7 lines of output: http://ix.io/a6T
[08:54:13] <huon> rusti: fn foo() {} let _: extern fn() = foo; 1
[08:54:15] -rusti- 1
[08:56:33] <eddyb> lol, we visit the x in (x) twice for vtable resolution
[08:57:22] <eddyb> rusti: ((((((((&0 as &mut Clone)))))))); 1
[08:57:25] -rusti- pastebinned 29 lines of output: http://ix.io/auT
[08:57:36] <eddyb> huon: ^^
[08:57:48] <eddyb> well, he's having dinner. someone else take a look at that
[08:58:18] <eddyb> rusti: ((((((((((((((((&0 as &mut Clone))))))))))))))));
[08:58:20] -rusti- pastebinned 53 lines of output: http://ix.io/auU
[09:02:27] <eddyb> rusti: drop((((((((((((((((&0 as &mut Clone))))))))))))))));
[09:02:30] -rusti- pastebinned 50 lines of output: http://ix.io/auV
[09:02:39] <nrc> cool, thanks!
[09:02:52] <eddyb> rusti: drop(&0 as &mut Clone);
[09:02:53] -rusti- <anon>:10:14: 10:30 error: types differ in mutability
[09:02:53] -rusti- <anon>:10         drop(&0 as &mut Clone);
[09:02:53] -rusti-                        ^~~~~~~~~~~~~~~~
[09:02:53] -rusti- error: aborting due to previous error
[09:02:53] -rusti- application terminated with error code 101
[09:03:24] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[09:03:51] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[09:06:49] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[09:11:59] *** Joins: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP)
[09:16:04] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[09:17:52] *** Quits: jdm (jdm@DFC6E2EA.EDD2F557.D938BA7F.IP) (Ping timeout)
[09:18:32] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[09:36:51] *** Joins: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP)
[09:36:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/exYjrw
[09:36:51] *** Parts: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP) ()
[09:39:53] <eddyb> hmm, I sure hope nobody does <T: Drop>...
[09:40:57] <eddyb> because drop calls are otherwise typeck::method_static(known_did)
[09:41:48] *** Joins: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP)
[09:41:48] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/qgZeqw
[09:41:48] <ghrust> 13rust/06auto 14ffdda22 15Luqman Aden: mk: Fix non-android cross builds.
[09:41:48] <ghrust> 13rust/06auto 14d40b537 15bors: auto merge of #12192 : luqmana/rust/fix-cross, r=alexcrichton...
[09:41:48] *** Parts: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP) ()
[09:43:42] *** Quits: nrc (nrc@7BE24E90.A5032A01.3CFC199D.IP) (Quit: ChatZilla 0.9.90.1 [Firefox 30.0a1/20140213030201])
[09:45:15] <eddyb> strcat: good news, typeck::vtable should be callable from trans :)
[09:45:38] <eddyb> bad news, typeck::populate_implementations_for_trait_if_necessary sounds like it might need to run early
[09:47:08] <eddyb> oh, that's cross-crate, so I can start without it :D
[09:51:30] *** Joins: jyyou_ (jyyou@moz-47B052FA.cs.nctu.edu.tw)
[09:55:08] *** Quits: jyyou (jyyou@moz-B061DB92.cs.nctu.edu.tw) (Quit: leaving)
[09:55:33] *** jyyou_ is now known as jyyou
[09:58:44] *** Quits: aurynj (Eon@2C265A5F.5D40BDF3.6B2FAB37.IP) (Quit: Leaving)
[10:01:25] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Client exited)
[10:01:46] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[10:03:01] *** Joins: rca (rcatolino@moz-7FACA309.adsl.proxad.net)
[10:03:33] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Ping timeout)
[10:10:41] <flaper87> eddyb: what are you working on?
[10:10:55] <flaper87> and `populate_implementations_for_trait_if_necessary` is kind a verbose name
[10:10:57] <flaper87> :D
[10:16:43] *** zz_kimundi is now known as kimundi
[10:24:20] *** Quits: rca (rcatolino@moz-7FACA309.adsl.proxad.net) (Ping timeout)
[10:28:43] *** Joins: rca (rcatolino@moz-FE9F045F.adsl.proxad.net)
[10:30:18] *** Quits: dbussink (dbussink@moz-E0A5568C.bussink.me) (Ping timeout)
[10:36:01] <huon> eddyb: there was a problem with const_eval that evaluated the interior of () twice too
[10:36:08] <huon> (leading to exponential blowup)
[10:36:20] *** Joins: pnkfelix (pnkfelix@87C1F78E.1DE10CA8.D8E68FF6.IP)
[10:36:28] <eddyb> I'm removing that extra call as part of my new PR, cba to make the tiniest PR ever
[10:36:44] *** Joins: doomlord_ (servitor@moz-9B2006BF.range109-151.btcentralplus.com)
[10:36:50] <huon> make sure this one is multiple commits please
[10:36:52] <eddyb> especially with the current bors situation
[10:37:13] <eddyb> huon: hmm, that I can, it's a rather simple change
[10:38:48] *** Quits: rca (rcatolino@moz-FE9F045F.adsl.proxad.net) (Ping timeout)
[10:41:08] *** Joins: dbussink (dbussink@moz-E0A5568C.bussink.me)
[10:42:12] *** Joins: rca (rcatolino@moz-A8A930D.adsl.proxad.net)
[10:48:47] <pnkfelix> huon: when you looked at BDW back in Dec/Jan, you didn't get further than "can I do thread-local gc out-of-the-box?  no?  then i'm moving on."?  Is that right?
[10:49:20] <pnkfelix> (not to put words in your mouth.  though i guess my using quotation marks, I guess that's exactly what I'm doing...)
[10:51:48] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[10:51:48] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/qgZeqw
[10:51:48] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[10:56:45] *** Joins: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP)
[10:56:45] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/poTdnQ
[10:56:45] *** Parts: ghrust (ghrust@99CAE845.6A2AE50.F3114085.IP) ()
[10:57:38] <huon> pnkfelix: yeah, basically (and I've surmised that it uses far to much global state to do thread-local gc without a lot of effort)
[10:57:42] <huon> *too
[11:01:46] *** Joins: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP)
[11:01:47] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/poTdnQ
[11:01:47] *** Parts: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP) ()
[11:01:48] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[11:01:48] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/rtEXsQ
[11:01:48] <ghrust> 13rust/06auto 14b37700c 15Alex Crichton: Invoke gcc with -nodefaultlibs...
[11:01:48] <ghrust> 13rust/06auto 14ee27543 15bors: auto merge of #12205 : alexcrichton/rust/nodefaultlibs, r=brson...
[11:01:48] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[11:02:47] <nmatsakis> eddyb: why are you trying to move vtable calculation to trans?
[11:03:08] <eddyb> not all of it, just for generic drop impls with bounds
[11:03:30] <eddyb> pretty sure I can do it, modulo current body temperature
[11:04:22] <eddyb> typeck::check::vtable::resolve_impl only needs a tcx to do its job, I can have something similar for dtors, that can be called from trans
[11:05:00] <huon> pnkfelix: (although I did write some bindings, as I think you know)
[11:05:06] <nmatsakis> eddyb: it seems likely, is there a bug you're trying to fix?
[11:05:17] <pnkfelix> huon: yes, yes.  Just checking.
[11:05:27] <huon> nmatsakis: https://github.com/mozilla/rust/issues/4252
[11:05:30] <eddyb> nmatsakis: give me a second (unless strcat knows it by heart)
[11:05:33] <eddyb> of course :)
[11:05:45] <pnkfelix> huon: I've been working on integrating it into the runtime anyway, not for an actual release, but rather for comparison purposes while working on a proper GC
[11:06:07] <huon> nmatsakis: (it's required for allocators, to be able to call free in the destructors, aiui)
[11:06:26] <pnkfelix> huon: and I was wondering if you'd be interested in looking at that or not.  (I haven't tried tearing out the ref-counting in @T yet in that branch, so it doesn't buy one anything yet.)
[11:06:28] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Quit: WeeChat 0.4.3)
[11:06:42] <nmatsakis> there are lots of complications with bounds on destructors,
[11:06:59] <huon> pnkfelix: sure, if you've got the code around
[11:07:01] <pnkfelix> huon: But I'd be happy to have you continue to play with / focus on the "real GC" itself rather than worry about a distraction like this
[11:07:02] <nmatsakis> eddyb: but i'm not sure this is the right fix, to move it to trans
[11:07:09] <eddyb> nmatsakis: it isn't anywhere
[11:07:22] <eddyb> I'm adding it to vtable and calling it from trans
[11:07:48] <nmatsakis> what is "it" that you are adding to vtable?
[11:07:55] <pnkfelix> huon: The most recent checkpoint is in https://github.com/pnkfelix/rust/tree/bdw-bootstrapped-fixups-rebasing-2014feb11
[11:08:00] <nmatsakis> my problem is that trans has too many one-off paths where things are different
[11:08:06] <eddyb> hmm, true
[11:08:11] <huon> pnkfelix: (guilty secret: I haven't actually spent any more effort into the GC recently than keeping up with your and gabor's discussion on the issue :) )
[11:08:15] <huon> pnkfelix: looking
[11:08:32] <nmatsakis> eddyb: and so my pref would be to treat this as much like other method calls as possible
[11:08:34] <pnkfelix> huon: It gets stuck during `make check` on my system with the default RUST_TASKS (i.e. the env var unset)
[11:09:01] <eddyb> nmatsakis: what are vtables for, anyway?
[11:09:04] <pnkfelix> huon: so I have tried on-and-off to debug that, I assume it is some race condition in our tests and/or runtime rather than an actual bug in my integration
[11:09:53] <eddyb> nmatsakis: they look like an optimization for me, and I'm not sure of the extent of their reach
[11:09:58] <nmatsakis> eddyb: I'm not sure I understand the quesiton
[11:10:00] <pnkfelix> huon: (in case it is not clear, the supposed deadlock during `make check` goes away for various other choices for RUST_TASKS.  Or whatever the env var is, I'm sure I got it wrong...)
[11:10:09] <nmatsakis> eddyb: telling you what method to call?
[11:10:20] <nmatsakis> eddyb: I'm wondering if we're discussing the same thing
[11:10:28] <huon> pnkfelix: RUST_THREADS maybe?
[11:10:36] <eddyb> nmatsakis: not virtual vtables, but typeck vtables
[11:10:36] * huon can't remember the various env-var names
[11:10:47] <pnkfelix> huon: I have to look it up each time I need it.
[11:11:36] <huon> pnkfelix: does make check normally deadlock on your system?
[11:11:42] <pnkfelix> huon: no
[11:11:48] <pnkfelix> huon: that's why this is semi-interesting
[11:11:53] <huon> (I'm building the branch now)
[11:12:19] <pnkfelix> huon: so my assumption about it being a latent timing-dependent bug in the runtime (rather than in my integration) could be bogus
[11:12:27] <eddyb> nmatsakis: they seem to serve the purpose of optimizing the lookup of a trait method callee for a type that implements the trait
[11:12:28] <nmatsakis> eddyb: "to tell you what method is called"?
[11:12:30] <huon> "cc1: error: -Werror=incompatible-pointer-types: no option -Wincompatible-pointer-types"
[11:12:31] <pnkfelix> huon: but there have been other timing-dependent bugs masked in the past
[11:12:35] <huon> pnkfelix: do I need clang?
[11:12:45] <pnkfelix> huon: ... hm
[11:12:50] <nmatsakis> eddyb: well, they store the result of that lookup, I guess you can call that an optimization
[11:13:00] <pnkfelix> huon: I probably need to fix the configure script to handle non-clang
[11:13:02] <huon> (i'm configuring with --enable-clang, let's see if this helps)
[11:13:34] <huon> pnkfelix: but yeah, I wouldn't be surprised that there's race conditions in the runtime still
[11:13:37] <pnkfelix> huon: it will probably help.  I had to put copy some magic in configure that I saw for libuv (i think) to not die on build errors.
[11:13:42] <pnkfelix> or sorry, build warnings
[11:14:26] <pnkfelix> huon: anyway, so far I have found that if I run on gdb
[11:14:35] <huon> pnkfelix: `ln: failed to access â€˜x86_64-unknown-linux-gnu/rt/bdw/.libs/libgc.aâ€™: No such file or directory`
[11:14:37] <eddyb> nmatsakis: and the data is computed per call to a function that calls a method on a generic type with a bound, and from what I've seen, not cached between calls to the same function instantiated with the same generic type params
[11:14:52] <pnkfelix> huon: mrrh.
[11:14:57] <huon> pnkfelix: (that's with clang)
[11:15:10] <pnkfelix> huon: Okay, somethings wrong with how I integrated it into the makefile infrastructure
[11:15:36] <nmatsakis> eddyb: right.
[11:15:46] <pnkfelix> huon: don't worry about it in the short term.  I will try to fix it over the weekend when I have a Linux machine in front of me.
[11:16:02] <nmatsakis> eddyb: such caching ... probably makes sense, though it's not clear that it's semantically valid,
[11:16:04] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[11:16:05] <huon> pnkfelix: ok; can you give me a high-level overview of the code?
[11:16:10] <nmatsakis> eddyb: since we've never formally defined the limits of our trait system,
[11:16:18] <pnkfelix> huon: All it essentially is, is:
[11:16:31] <pnkfelix> huon: 1. Add a bdw git submodule, and (attempt to) integrate it into our makefiles
[11:16:51] <nmatsakis> eddyb: so the types of the methods can (in principle, at least) influence the result,
[11:16:52] <pnkfelix> huon: 2. revise all of the runtime's malloc calls to go through bdw's malloc.
[11:17:00] <nmatsakis> eddyb: though the current implementation doesn't really support that
[11:17:22] <eddyb> nmatsakis: so is there a problem with doing such a lookup from within trans?
[11:17:35] <pnkfelix> huon: (choosing the different bdw malloc variants according to what kind of allocation it is.   E.g. ~T is not collectable by BDW.  and @[u8] does not get scanned in its interior.  Etc.)
[11:17:37] <eddyb> it doesn't change anything for code that compiles today
[11:17:59] <nmatsakis> eddyb: so what you want to do is do the lookup from within the glue::trans_drop() fn, basically, so as to get the set of vtables for each param
[11:18:02] <nmatsakis> eddyb: ?
[11:18:16] <eddyb> yeah, well, the entire set of vtables at once
[11:18:30] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[11:18:30] <pnkfelix> huon: though I tried to make it easy to swap in different choices for that dispatching, for debugging purposes, since the worst that happens from scanning a @[u8] is that you might do extra-work  and retain some floating dead garbage.
[11:18:46] <huon> pnkfelix: for 2., that includes ~, yes?
[11:19:23] <pnkfelix> huon: yes, really should have said @T and ~T for T that is Pod or something along those lines
[11:19:23] <huon> pnkfelix: i.e. you're allocating with BDW, but using the non-collectable alloctor
[11:19:31] <eddyb> nmatsakis: vtable::early_resolve_expr's handling of method calls is pretty modular
[11:19:53] <nmatsakis> eddyb: yeah that seems ok :) at first I thought you meant a more extensive mod
[11:19:56] <pnkfelix> huon: right.  Well, its not binary, there are a couple different combinations of variations here.
[11:20:22] <huon> pnkfelix: where's the logic? (it's probably easier to read the code itself)
[11:20:48] <pnkfelix> huon: but the essential idea is there.  The main thing is that the malloc_noncollectable (or whatever it is called) tells BDW: 1. you do not get to reclaim this storage, I will free it, and 2. These are actually roots as well, regardless of whether you happen to see them on the stack or not. 
[11:20:59] <pnkfelix> huon: Let me find it
[11:21:28] <huon> pnkfelix: ah, std::rt::global_heap
[11:22:00] <pnkfelix> huon: right.  See also: https://github.com/pnkfelix/rust/blob/bdw-bootstrapped-fixups-rebasing-2014feb11/src/libstd/rt/bdwgc.rs
[11:23:08] <pnkfelix> huon: where e.g. I hooked in distinct entry points for exchange_malloc_uncollectable vs proc_malloc, managed_malloc, "other_malloc" (sorry, sometimes life demands a catch-all...)
[11:23:43] <huon> haha, what's under other?
[11:24:30] <pnkfelix> huon: at one point I think the character buffers behind strings were...
[11:24:45] <pnkfelix> huon: but now I'm not sure, my `ack` run is taking ...
[11:25:08] <pnkfelix> (ah, I acked for 'malloc_other' rather than 'other_malloc' ...)
[11:25:52] *** Quits: mankyKitty (Instantbir@325B2C60.E2538F64.BC02889B.IP) (Ping timeout)
[11:26:06] <huon> pnkfelix: you added the GC_exchange_malloc etc. to bdwgc, right?
[11:26:13] <pnkfelix> huon: yeah
[11:26:37] <pnkfelix> huon: Oh yes, I remember now
[11:26:55] <pnkfelix> huon: I was hitting bugs where some calls to free were going to the system's `free` rather than bdw's
[11:27:16] *** Joins: rca_ (rcatolino@6405C1A3.4B0D2AD2.2CE09D78.IP)
[11:27:54] <pnkfelix> huon: so to try to track down the source, I wanted to instrument the calls to malloc/free, but I didn't want to do it globally.  So I introduced that distinction so that I could do, mmm, "sliced" observation
[11:27:54] *** Quits: rca (rcatolino@moz-A8A930D.adsl.proxad.net) (Ping timeout)
[11:28:22] <pnkfelix> huon: something along those lines.  Anyway, *that* bug was in my own code, and I fixed that.  :)  
[11:28:46] <huon> pnkfelix: ah, ok
[11:29:31] <pnkfelix> huon: okay, so I *think* that other_malloc is used for two things right now: 1. the backing character buffer for strings, and 2. libuv malloc'ed data (stuff in librustuv::uvll )
[11:29:51] <pnkfelix> huon: oh, a third thing, the std::sync::dequeue buffer
[11:30:03] <pnkfelix> huon: I guess you could just ack `other_malloc` too.  :)
[11:31:07] <pnkfelix> huon: (I exposed the ability for arbitrary code to choose between these combinations by passing an enum to global_heap::malloc_raw, but I do not think anything passes any Uncollectable(Other, _) variant of that mode enum.)
[11:31:07] <huon> c_str, rustuv and the deque, yeah
[11:32:17] <pnkfelix> huon: Anyway, this is just something I've been playing with while also trying to get a task-local mostly-copying GC off the ground
[11:32:41] <huon> pnkfelix: in Rust?
[11:32:43] <pnkfelix> huon: Ideally we could come up with a unified API that would let us "easily" toggle a build between different choices here
[11:32:50] <pnkfelix> huon: yeah.  It hasn't gotten too far yet.
[11:33:29] <huon> pnkfelix: (is it correct to just call an arbitrary realloc on a BDW pointer, rather than get the correct combination of uncollectable and atomic?)
[11:33:31] *** Quits: rca_ (rcatolino@6405C1A3.4B0D2AD2.2CE09D78.IP) (Quit: leaving)
[11:33:50] <pnkfelix> huon: That is a good question
[11:34:08] <pnkfelix> huon: let me check
[11:34:32] *** Quits: zimbabao (rajaram@47769425.AE842F9B.81C3DAA1.IP) (Ping timeout)
[11:35:09] <huon> pnkfelix: "The resulting object has the same kind as the original." on the comment for GC_realloc so seems like it is
[11:36:44] *** Joins: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP)
[11:36:44] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14ee27543 to 14d40b537: 02http://git.io/N3iJvQ
[11:36:44] *** Parts: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP) ()
[11:36:44] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[11:36:44] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/36BSEg
[11:36:44] <ghrust> 13rust/06auto 141e4cb03 15Alex Crichton: Upgrade LLVM...
[11:36:44] <ghrust> 13rust/06auto 141431d52 15bors: auto merge of #12207 : alexcrichton/rust/up-llvm, r=sfackler...
[11:36:44] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[11:37:19] <pnkfelix> huon: I guess it shouldn't cost anything more to support propogating the kind
[11:37:48] <nmatsakis> eddyb: so I'm on vacation today :) but https://github.com/mozilla/rust/issues/7141#issuecomment-35076357
[11:37:48] <pnkfelix> huon: (though Boehm clearly is not a fan of realloc.  At least, I recall seeing some negative comments about it in the code somewhere.)
[11:37:57] <nmatsakis> eddyb: that is a rough dump of my thoughts about the deref trait
[11:38:09] <huon> pnkfelix: yeah, I assume so; I just saw that you were calling other_realloc for vec_ng and wanted to double check that it didn't have to be exchange_realloc
[11:38:28] <huon> pnkfelix: (yeah, there's a few sentences about how it's a design mistake blahblah in that comment too)
[11:38:46] <huon> pnkfelix: oh, just looking at the overall diff now... essentially no compiler changes!
[11:39:00] <eddyb> nmatsakis: thanks :)
[11:39:10] <pnkfelix> huon: yeah, not yet at least.  :)
[11:39:36] <pnkfelix> huon: but obviously once its working then one might like to e.g. removing ref-count maintenance.  :)
[11:40:05] <pnkfelix> huon: also, I have not attempt to integrate finalization support at all yet
[11:40:20] <pnkfelix> huon: since I'm still letting the ref-count infrastructure run and take care of that
[11:41:11] <pnkfelix> huon: BTW good catch on vec_ng.rs.  While it may hobble along calling other_realloc, that code should probably be revised to do something else
[11:42:01] <huon> pnkfelix: what would be the change?
[11:42:13] <huon> to use exchange_realloc?
[11:42:47] <pnkfelix> huon: hmm, I don't think I have exposed that variant
[11:43:03] <pnkfelix> huon: maybe add a mode param to realloc_raw
[11:43:23] <pnkfelix> huon: I'm just thinking in terms of cleanliness when one sets breakpoints on the underlying routines or does other instrumentation
[11:43:38] <huon> pnkfelix: ah, right
[11:43:58] <pnkfelix> huon: (its probably not a good long term solution w.r.t efficiency.  And of course, since the mode param will be ignored by realloc itself, maybe this is not the right call.)
[11:44:00] <huon> pnkfelix: btw, what's the #[cfg(bdw_pristine_api)] doing?
[11:45:48] <pnkfelix> huon: I think I put that in to essentially ifdef out the origin-less malloc entry points
[11:46:08] <pnkfelix> huon: to ensure that every call to a GC_malloc variant had a variant encoded in its function name
[11:46:33] <huon> pnkfelix: ah ok
[11:47:03] <huon> pnkfelix: and why gcollect_from vs. gcollect (looking at the bdwgc source indicates that the number parameter is ignored)
[11:47:10] <pnkfelix> huon: I guess I could have deleted the code outright, not sure why I didn't, maybe I just wanted to make it clear that eventually we would go back to using *just* the bdw_pristine_api variants
[11:47:23] <huon> (to get the number in a gdb backtrace?)
[11:47:27] <pnkfelix> huon: yeah that's so in the debugger I could tell where we were coming from
[11:47:29] <pnkfelix> huon: yes
[11:47:43] <huon> neat trick :)
[11:47:49] <pnkfelix> huon: and maybe to set conditional breakpoints, I cannot remember now
[11:48:46] <pnkfelix> huon: I think I was doing bisection to figure out what line of code caused a subsuquent GC to fail
[11:49:40] <pnkfelix> huon: (at one point i had peppered the various init methods with many explicit calls to bdwgc::collect_from(..) )
[11:50:37] <huon> pnkfelix: they're still in the diff :)
[11:50:53] <pnkfelix> huon: ah. but now we get *past* them.  :)
[11:51:05] * huon just read through the diff to master
[11:51:25] <huon> other than the questions I just asked you nothing seems wildly crazy (not that they were wildly crazy either)
[11:52:11] <pnkfelix> huon: yeah my hope is that this will just be a "trivially correct but terrible option"
[11:52:16] <huon> although there's a lot of code in the extern block in bdwgc.rs... seems like you copied the doc comments in too?
[11:52:34] <pnkfelix> huon: yes, I propogated the doc comments
[11:53:29] <pnkfelix> huon: I think the only uncommented fns are the ones I added for debugging, e.g. all the categorized malloc variants
[11:55:04] <huon> pnkfelix: yeah, seems so
[11:55:24] *** Joins: mrmonday (mrmonday@moz-C7DC1A73.lin.openzula.org)
[11:55:33] <huon> pnkfelix: btw, I've got libgc.so's but no libgc.a's so it seems to not be building a static lib?
[11:56:39] <pnkfelix> huon: possibly.  I have a libgc.a on my build, but I don't know if it got there due to some manual intervention on my part, or if there's something OS X specific in my changes to the configure/makefiles.
[11:56:53] <pnkfelix> huon: there's a rule somewhere to copy the libgc.a 
[11:56:55] <pnkfelix> huon: wait
[11:57:16] <pnkfelix> huon: are you saying you see no `libgc.a` just in build-dir/<triple>/rt/ ?
[11:57:27] <pnkfelix> huon: or you don't have one anywhere underneath the build-dir/ ?
[11:57:52] <huon> pnkfelix: yes nothing in rt/
[11:57:54] <pnkfelix> huon: because my libgc.a starts out in build-dir/<triple>/rt/bdw/.libs/ 
[11:57:58] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[11:58:03] <huon> pnkfelix: and not in .libs either
[11:58:06] <pnkfelix> huon: and then there's a rule somewhere to copy that to ../..
[11:58:10] <huon> pnkfelix: only .so's there
[11:58:30] <pnkfelix> huon: my bet is that I'm not invoking configure correctly for bdw on linux
[11:58:30] <huon> (iirc it was failing on the copying-from-.libs step)
[11:58:32] * huon runs make again
[11:59:18] <pnkfelix> huon: I was largely cut-and-pasting the libuv and/or LLVM sub-configure invocations, and then trying to readapt them to bdwgc's needs, as I recall...
[12:00:12] <huon> pnkfelix: yep, it builds bdwgc fine, but then fails "ln: failed to access â€˜x86_64-unknown-linux-gnu/rt/bdw/.libs/libgc.aâ€™: No such file or directory" 
[12:00:36] <pnkfelix> huon: hmm.  Is it not going to *need* a libgc.a to build the rest of the runtime for you?
[12:01:09] <pnkfelix> huon: maybe the mistake I actually made was in assuming that all platforms would want a statically built library and thus unconditionally attempting to copy that file out of bdw/.libs/ ...
[12:01:25] <huon> pnkfelix: I'll just edit the make files and source to use dynamic linking for now
[12:01:30] <pnkfelix> huon: Sounds good
[12:05:57] <pnkfelix> huon: by the way, in case you do get to the point of attempting to run `make check` yourself: I had to relearn that gdb has different default settings for how to reacts to different signals
[12:06:05] <huon> pnkfelix: ok, changing a few things to .so seems to have worked (at least, it's onto librustc now)
[12:06:17] <huon> hm?
[12:06:51] <pnkfelix> huon: our test suite tests that signals are raised and caught properly internally
[12:07:03] <pnkfelix> huon: and gdb will often stop the program when a signal is raised
[12:07:51] <pnkfelix> huon: so the thing I had to relearn is that for some signals, all you need to do is use `continue` and gdb will pass the signal along.  But for other signals, namely SIGINT, you need to re-issue the signal explicitly.
[12:08:32] <pnkfelix> huon: by re-issue the signal I mean type `signal SIGINT` at the (gdb) prompt.
[12:09:00] <pnkfelix> huon: this may be old-hat to you.  I don't do signal programming often enough for details like this to stay in my mental cache.
[12:09:40] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[12:09:40] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[12:09:56] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[12:09:57] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[12:10:06] <pnkfelix> huon: (another reasonable option is to tell gdb not to actually stop the program on certain signals that are used in the test suite.  BUt I typically want to keep SIGINT as the way to break back into gdb...)
[12:10:09] <huon> pnkfelix: I didn't even know about `signal`
[12:10:12] *** Quits: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au) (Ping timeout)
[12:10:21] <pnkfelix> huon: ah, okay, good, then I'm not wasting your time.
[12:10:48] <pnkfelix> huon: https://sourceware.org/gdb/onlinedocs/gdb/Signals.html
[12:10:57] <huon> I guess `continue` not reissuing SIGINT is what makes ^C work for interrupting, as you say.
[12:10:58] <pnkfelix> huon: That link is actually a pretty good summary
[12:11:03] <pnkfelix> huon: exactly
[12:11:26] <pnkfelix> huon: I was just now wondering if I should "work around this" by choosing some other signal as my way to break into the debugger
[12:11:27] <huon> hm, the build failed with linkage errors :(
[12:11:31] <pnkfelix> doh
[12:11:43] <pnkfelix> hopefully obvious ones all with `GC_` prefixes.
[12:11:55] <huon> oh, I guess it doesn't try to link until it gets to actually building the rustc binary
[12:12:11] <huon> yeah, all of those...
[12:12:22] <huon> hm, they're all the new ones... maybe it's trying to link to my system libgc
[12:12:35] <pnkfelix> huon: That sounds plausible.
[12:13:06] <pnkfelix> huon: probably should try to fix the build script not to do that...
[12:13:39] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[12:13:39] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[12:13:39] <pnkfelix> (though... is that even possible in general?  I guess we could give the library a more locally-unique name.)
[12:13:49] <pnkfelix> libbdwkgc
[12:13:57] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[12:13:57] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[12:14:16] <pnkfelix> (as if my hackery deserved a fourth letter...)
[12:15:06] <huon> heh
[12:16:46] *** Joins: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP)
[12:16:46] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/Z64WdA
[12:16:46] <ghrust> 13rust/06auto 144c3698e 15lpy: return value/use extra::test::black_box in benchmarks
[12:16:46] <ghrust> 13rust/06auto 14d2e0e4b 15bors: auto merge of #12212 : lpy/rust/issue12118, r=alexcrichton...
[12:16:46] *** Parts: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP) ()
[12:17:52] <huon> pnkfelix: having hidden/renamed my global libgc's seems to indicate that the makefile isn't setting things up for rustc correctly (i.e. it's not finding -lgc now)
[12:18:40] <pnkfelix> huon: hmm.  Okay, maybe I'll fire up a VM
[12:18:45] <pnkfelix> huon: do you use Arch or Ubuntu ?
[12:18:50] <pnkfelix> huon: (or something else...?)
[12:18:52] <huon> pnkfelix: debian
[12:20:03] <pnkfelix> huon: Hmm.  So do I learn how to setup a debian VM, or do I trust that Arch or Ubuntu (which are debian derivatives, no?) will suffice...
[12:20:58] <huon> pnkfelix: I think ubuntu is
[12:21:19] <huon> pnkfelix: but.. it looks like this problems is because I didn't edit the make file completely
[12:21:36] <huon> it's still naming the link libgc.a rather than libgc.so
[12:21:43] <huon> anyway fixed and rerunning...
[12:22:16] <pnkfelix> huon: okay.  BTW, it looks like I didn't put up a checkpoint that actually even built on my system (e.g. the outdated raw_malloc in global_heap.rs), sorry about that.
[12:22:48] <pnkfelix> huon: I think it was the result of a late-night rebase that I didn't get a chance to build.  There are older checkpoints in my repo that should build, but I thought it best to focus on getting more up-to-date.
[12:23:07] <pnkfelix> huon: Still, I should have checked that it at least built on my system before sharing.  :(
[12:25:11] <huon> pnkfelix: ok, can't seem to wrangle the makefiles correctly just now :/ I think I'll leave that to you (or come back to it later).
[12:25:25] <huon> pnkfelix: but yeah, it doesn't build here either
[12:25:29] <pnkfelix> huon: sure, thanks for poking at it in the meantime
[12:25:35] *** Joins: zimbabao (rajaram@B730DBAC.15BE4F73.D2D1FAF0.IP)
[12:25:35] <pnkfelix> huon: I'll give a Linux VM a whirl 
[12:28:14] <pnkfelix> huon: you're on 64-bit host, BTW, right?
[12:32:35] <huon> pnkfelix: yes
[12:36:26] *** Joins: jdm (jdm@E595D12E.1196002C.7DBB297B.IP)
[12:37:35] *** Quits: mawuli (mawuli@moz-5ADAB167.com.gh) (Connection reset by peer)
[12:38:01] *** Joins: mawuli (mawuli@moz-5ADAB167.com.gh)
[13:14:45] *** Joins: aurynj (Eon@36F86BD3.C264657C.C6282BC4.IP)
[13:16:04] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[13:16:52] *** Quits: aurynj (Eon@36F86BD3.C264657C.C6282BC4.IP) (Ping timeout)
[13:17:08] *** Joins: aurynj (Eon@BF507CFB.1CEEC774.4C51A5AE.IP)
[13:18:22] *** Quits: mawuli (mawuli@moz-5ADAB167.com.gh) (Ping timeout)
[13:18:27] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[13:19:35] *** Quits: zimbabao (rajaram@B730DBAC.15BE4F73.D2D1FAF0.IP) (Ping timeout)
[13:26:42] *** Joins: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP)
[13:26:42] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14d2e0e4b to 14d40b537: 02http://git.io/N3iJvQ
[13:26:42] *** Parts: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP) ()
[13:26:44] *** Joins: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP)
[13:26:44] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/K0e0Jw
[13:26:44] <ghrust> 13rust/06auto 14417b2cd 15Alex Crichton: extra: Capture stdout/stderr of tests by default...
[13:26:44] <ghrust> 13rust/06auto 14fb8c495 15bors: auto merge of #12215 : alexcrichton/rust/test-stdout-capture, r=brson...
[13:26:44] *** Parts: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP) ()
[13:35:06] *** Quits: jdm (jdm@E595D12E.1196002C.7DBB297B.IP) (Quit: Lost terminal)
[13:39:09] *** Joins: mawuli (mawuli@moz-5ADAB167.com.gh)
[13:40:05] *** Joins: edwardw (edwardw@FC63E399.AB331A3B.FAED9FFC.IP)
[13:41:19] *** Quits: mawuli (mawuli@moz-5ADAB167.com.gh) (Ping timeout)
[13:42:18] *** Joins: damag (damien@moz-5C881CB.grassart.com)
[13:42:26] <bstrie_vanished> wondering if we should forbid all the equality and comparison operators on floats :P
[13:46:35] <SiegeLord> That's just silly
[13:46:42] <SiegeLord> We should remove NaNs though ;)
[13:46:45] <bstrie_vanished> how about just a warning!
[13:47:34] <SiegeLord> I don't know if it's possible to have a performance neutral NNaN<f32> type
[13:47:46] <bstrie_vanished> "warn: comparing floating point numbers probably doesn't do what you expect. read http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html in order to disable this warning"
[13:51:25] <SiegeLord> I feel like people viewing that page will just get the idea that floating point is horribly complicated
[13:51:33] <bstrie_vanished> good
[13:51:39] <bstrie_vanished> then they will not feel the urge to use it
[13:51:44] <SiegeLord> It's like teaching 1st graders arithmetic by first teaching them the pitfalls of set theory
[13:52:02] <SiegeLord> You don't need to know much to use floating point effectively
[13:52:08] <bstrie_vanished> kids these days, waiting until third grade to start learning set theory!
[13:52:13] <bstrie_vanished> this generation's gone soft
[13:52:34] <bjz> didn't they try that back in the sixties?
[13:52:55] <SiegeLord> 1) Don't add floating point numbers of different magnitudes 2) Don't use ==
[13:53:05] <SiegeLord> That's 99% of what using floating point is about
[13:53:08] <bjz> teaching mathematics using set theory in primary school I mean?
[13:53:18] <bstrie_vanished> SiegeLord: aha, then you agree that we should at least disable == on floats :)
[13:53:30] <SiegeLord> well, that's what you tell beginners
[13:53:40] <bstrie_vanished> bjz: you have to start from axioms! category theory by second grade
[13:53:52] <bstrie_vanished> this is how we'll at last raise a generation of haskell programmers
[13:53:56] <SiegeLord> You can add a footnote saying, "use == only when comparing to 0"
[13:54:22] <bstrie_vanished> SiegeLord: we can statically determine when you're comparing to 0.0 and forbid all other uses of ==
[13:54:25] <SiegeLord> I guess the footnote is a bit more complicated... don't feel like typing it out :P
[13:54:46] <SiegeLord> It's basically, once you set a floating point number to a literal, you can compare to that literal
[13:54:59] <SiegeLord> That'll work reliably, afaik
[13:56:42] <bstrie_vanished> SiegeLord: theoretically we could also statically determine that under specific circumstances
[13:56:52] <SiegeLord> Yeah, maybe
[13:57:12] <bstrie_vanished> i.e., if you have an immutable float that was assigned from a literal, you can compare it to that literal to make sure that you're immutable float really hasn't changed :)
[13:57:27] <bstrie_vanished> *you are
[13:57:37] <bjz> bstrie_vanished: http://en.wikipedia.org/wiki/New_Math
[13:57:50] <bstrie_vanished> bjz: right, I was wondering if you were talking about new math. have you heard the song?
[13:58:01] <bstrie_vanished> bjz: in any case, I think that new math is *still* how we teach kids math
[13:58:03] <bjz> bstrie_vanished: no
[13:58:22] <SiegeLord> The first rule tends to get taught (but not really pointed out) in high school physics/chemistry in the US
[13:59:56] <bstrie_vanished> bjz: https://www.youtube.com/watch?v=8wHDn8LDks8
[14:04:58] <bjz> bstrie_vanished: the first bit of that song is only part of it
[14:05:29] <bjz> bstrie_vanished: I certainly wasn't taught New Math
[14:05:59] <bstrie_vanished> well really I just don't know what "old math" is
[14:06:11] <bstrie_vanished> my only exposure to the distinction is via the song :P
[14:08:27] <bjz> bstrie_vanished: as I understand it, it was about teaching mathematics from the foundations at the beginning, as opposed to the very top down way it is normally done
[14:08:34] <bjz> but I might be wrong
[14:08:41] <bjz> anyway, abit off topic :P
[14:11:43] *** Joins: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP)
[14:11:43] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14fb8c495 to 14d40b537: 02http://git.io/N3iJvQ
[14:11:43] *** Parts: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP) ()
[14:11:44] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[14:11:44] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/Q4re0g
[14:11:44] <ghrust> 13rust/06auto 143c02749 15Steven Fackler: Tweak ItemDecorator API...
[14:11:44] <ghrust> 13rust/06auto 1418477ac 15bors: auto merge of #12234 : sfackler/rust/restructure-item-decorator, r=huonw...
[14:11:44] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[14:13:21] <bstrie_vanished> bjz: this is supremely on topic, we need to encourage kids to get interested in the sciences if we're going to have any rust contributors 20 years from now!
[14:13:40] <bstrie_vanished> I don't know about the rest of you, but *I* expect to be dead by then
[14:21:31] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[14:36:07] *** Joins: canhtak (canhtak@moz-843B48BB.wl.t.ulaval.ca)
[14:40:56] *** Quits: Zr40 (zr40@EE4BB9F5.926C319A.BE2F4011.IP) (Quit: leaving)
[14:49:00] *** Joins: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net)
[14:57:14] <bstrie_vanished> acrichto: is it just a fluke that the native numbers in https://github.com/mozilla/rust/pull/12172 got slightly slower after that patch?
[14:58:34] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[15:00:49] *** Quits: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net) (Quit: Textual IRC Client: www.textualapp.com)
[15:01:21] *** Joins: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net)
[15:16:08] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[15:17:04] <acrichto> bstrie_vanished: yeah there's no way that it actually made libnative slower
[15:18:26] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[15:21:39] *** Joins: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu)
[15:21:42] *** Joins: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP)
[15:21:43] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/Q4re0g
[15:21:43] *** Parts: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP) ()
[15:26:41] *** Joins: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP)
[15:26:41] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/5EWkDQ
[15:26:41] *** Parts: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP) ()
[15:26:42] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[15:26:42] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/cnv8Yg
[15:26:42] <ghrust> 13rust/06auto 14804955f 15Alex Crichton: Upgrade LLVM...
[15:26:42] <ghrust> 13rust/06auto 1492c5738 15bors: auto merge of #12207 : alexcrichton/rust/up-llvm, r=sfackler...
[15:26:42] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[15:29:10] *** Joins: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP)
[15:29:10] <ghrust> 01[13rust01] 15alexcrichton merged 06master into 06snap-stage3: 02http://git.io/A-4uNg
[15:29:10] *** Parts: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP) ()
[15:32:17] *** Quits: Kxepal (Miranda@moz-D87D4BA.pppoe.mtu-net.ru) (Ping timeout)
[15:33:09] <bstrie_vanished> llvm upgrades, oh goody
[15:36:36] *** Joins: Kxepal (Miranda@moz-F04ED80E.pppoe.mtu-net.ru)
[15:38:57] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[15:58:33] <pnkfelix> acrichto: ping
[15:58:45] <acrichto> pnkfelix: pong
[15:59:23] <pnkfelix> acrichto: why did commit 9c18510 xfail run-pass-fulldeps/qquote.rs ?
[16:00:12] <acrichto> I think it was because I fixed a bug where none of the fulldeps tests were running
[16:00:19] <acrichto> and it was horribly broken so I didn't bother updating it
[16:00:57] <pnkfelix> acrichto: As in feature(quote) is/was horribly broken ?
[16:01:08] <pnkfelix> acrichto: or as in the manner it which it is being tested is horribly broken ?
[16:01:25] <acrichto> I think it was just the test
[16:01:37] <acrichto> the test didn't compile at all and I didn't know how to get it to comile
[16:01:39] <pnkfelix> acrichto: ah yes, it uses IO to compare the quoted form with the original
[16:01:52] <pnkfelix> acrichto: okay, i see how that happened.
[16:02:21] <pnkfelix> acrichto: (the problem is that the feature itself is not being tested at all, so e.g. quote_pat! no longer works)
[16:02:43] <acrichto> :(
[16:02:45] <pnkfelix> acrichto: I'll open a ticket.  Its not a 1.0 blocker since quote_foo! is all feature-gated, but it would be nice if I can get a chance to fix it.
[16:03:20] <acrichto> makes sense
[16:03:23] <pnkfelix> acrichto: a reasonable short-hand compromise would be to make a smaller version of the test that doesn't check the outputs of the macros, but still at least calls them
[16:03:38] <pnkfelix> acrichto: and then un-xfail that.  Then hopefully at least we'll ensure that the darn things compile.  :)
[16:03:53] <pnkfelix> acrichto: (quote_pat! doesn't currently)
[16:04:19] <pnkfelix> acrichto: thanks for clueing me in.
[16:04:22] <acrichto> np
[16:04:42] *** Quits: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu) (Quit: lkuper)
[16:11:40] <cmr> pnkfelix: https://github.com/mozilla/rust/issues/12041 says assigning P-high and P-backcompat-libs but the only label is P-backcompat-lang?
[16:11:48] *** Quits: damag (damien@moz-5C881CB.grassart.com) (Quit: Leaving)
[16:12:52] <pnkfelix> cmr: I probably should have written max(P-backcompat-lang, P-high) [[rather than P-backcompat-libs]], that was probably a typo.
[16:13:06] <pnkfelix> cmr: The fact that I wrote both P-tags was sort of a joke from the conversation at the time
[16:13:39] <pnkfelix> cmr: because IIRC one person said P-high and another said P-backcompat-lang, and that led to some debate about whether P-backcompat-lang is always higher priority than P-high.
[16:13:50] <cmr> ah
[16:13:58] <pnkfelix> cmr: and I tried to cut the conversation short by saying "I'll just write `max` of the two"
[16:14:26] <cmr> ohhh I see now.
[16:15:26] *** kimundi is now known as zz_kimundi
[16:15:31] *** Quits: japaric (japaric@8465B6C3.31BF4ADA.BFC118EE.IP) (Quit: WeeChat 0.4.2)
[16:15:56] <pnkfelix> cmr: The point is, everyone present agreed that its a 1.0 blocker.  :)
[16:16:06] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[16:16:08] <cmr> sure
[16:18:27] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[16:19:56] *** Quits: wycats (sid79@moz-5F4AA75A.irccloud.com) (Ping timeout)
[16:23:08] *** Joins: japaric (japaric@8465B6C3.31BF4ADA.BFC118EE.IP)
[16:26:00] *** Quits: japaric (japaric@8465B6C3.31BF4ADA.BFC118EE.IP) (Quit: WeeChat 0.4.2)
[16:28:28] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[16:30:01] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Quit: Read error: Connection reset by peer)
[16:32:45] *** Joins: japaric (japaric@8465B6C3.31BF4ADA.BFC118EE.IP)
[16:42:30] *** Joins: gwty (gwtypc@D207B5D8.9189635C.49FF672.IP)
[16:44:21] *** Quits: gwty (gwtypc@D207B5D8.9189635C.49FF672.IP) (Ping timeout)
[16:46:12] *** Joins: gwty (gwtypc@81092C33.AB257A8F.F64220F6.IP)
[16:56:50] *** Joins: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP)
[16:56:50] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/cnv8Yg
[16:56:50] *** Parts: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP) ()
[16:59:55] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[17:01:44] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[17:01:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/sRF4Ug
[17:01:44] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[17:01:45] *** Joins: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP)
[17:01:45] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/tAKkTw
[17:01:45] <ghrust> 13rust/06auto 1487e0e6e 15Alex Crichton: Tweak how preference factors into linkage...
[17:01:45] <ghrust> 13rust/06auto 14e0386c2 15Alex Crichton: Re-work loading crates with nicer errors...
[17:01:45] <ghrust> 13rust/06auto 14f994e13 15bors: auto merge of #12164 : alexcrichton/rust/rlibs-and-dylibs, r=cmr...
[17:01:47] *** Parts: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP) ()
[17:06:06] <cmr> http://static.rust-lang.org/doc/master/std/ptr/fn.read_ptr.html
[17:06:09] <cmr> How is that accurate?
[17:06:13] <cmr> "Does not copy *src"
[17:06:18] <cmr> isn't that *exactly* what it does?
[17:08:33] <pnkfelix> cmr: ... I'm grasping at straws, but perhaps that's meant to mean that it does not increment ref count when T is @something ?
[17:08:45] <cmr> perhaps
[17:08:52] <pnkfelix> cmr: its definitely unclear, in anycase
[17:08:56] * cmr removes it
[17:09:06] <pnkfelix> cmr: when I see like that I tend to jump to the source code...
[17:09:21] <cmr> I'm looking at the source
[17:09:40] <cmr> it's pretty simple, it's just a deref without calling any glue or moving etc 
[17:09:49] <pnkfelix> cmr: replace_ptr has a similar note, about not copying either one
[17:10:07] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[17:11:14] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[17:14:33] *** Quits: lpy (lpy@F864F9BC.9B88FD1B.E99F7FDB.IP) (Client exited)
[17:15:45] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[17:17:11] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[17:18:54] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[17:19:11] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[17:20:54] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[17:21:12] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[17:25:26] <cmr> hm
[17:25:53] <cmr> would it be worth it to *not* monomorphize functions which only use their type parameters behind a pointer?
[17:26:09] <cmr> This would avoid monomorphic bloat for most of std::ptr, for example.
[17:26:23] <sully> hm, I know this has been discussed before
[17:26:50] <sully> and there is code to detect *how* type params are used and share code
[17:26:56] <sully> but the code for that is really fucked up
[17:27:04] <cmr> heh
[17:27:06] <sully> well, it was 6 months ago, I guess
[17:27:08] <sully> (type_use.rs)
[17:27:20] <sully> it is wrong in both directions
[17:27:26] <cmr> oh it's that
[17:27:28] <sully> it shares things that it shouldn't
[17:27:44] <eddyb> cmr: from what I hear, rust used to do that at some point
[17:27:45] <sully> but also rarely actually shares anything
[17:27:47] <acrichto> cmr: that's what we were hoping to lean on mergefunc for
[17:28:02] <cmr> sully: I think that was removed recently actually
[17:28:04] <cmr> I don't remember
[17:28:09] <pnkfelix> cmr: see e.g. https://github.com/mozilla/rust/issues/9222
[17:28:14] <cmr> acrichto: I'm more concerned about the compile-time implications of it than the runtime.
[17:28:35] <eddyb> it's really hard to share things...
[17:28:40] <acrichto> ah, it would indeed be concerning then
[17:29:12] <flaper87> eddyb: you were playing with vtables today, weren't you?
[17:30:11] <cmr> sully: https://github.com/mozilla/rust/pull/9538
[17:30:44] <sully> oh good
[17:31:10] <eddyb> flaper87: we would have bounded generic dtors working by now if I didn't go down earlier today
[17:31:33] <eddyb> the solution is quite straightforward, after you learn how that part of typeck works
[17:33:37] <cmr> jeez
[17:33:55] <cmr> stripping hello world saves 500K no-opt, ~230K opt
[17:34:57] <cmr> hello world lto and stripped is only 884K
[17:35:03] <cmr> SiegeLord: ^
[17:36:50] <cmr> and it's 8K dynamic, which matches clang c and c++ (using stl)
[17:37:05] <acrichto> cmr: libnative instead of libgreen gets some more size savings as well
[17:37:07] <acrichto> (statically linked)
[17:37:32] <eddyb> @ in syntax/rustc: http://www.reddit.com/r/rust/comments/1xsfr5/why_have_you_chosen_rust_over_other_system/cfejo4i?context=4
[17:37:35] <eddyb> and maybe servo :))
[17:37:41] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[17:38:50] <SiegeLord> cmr: Well, if we're allowed to strip, then other languages get progressively better too :P
[17:39:02] <SiegeLord> 332K for the D+Tango
[17:40:08] <bstrie_vanished> I want stripped+lto hello world to be < 200 kb
[17:40:20] <bstrie_vanished> I won't help make it happen, but I'll whine until it is! :)
[17:40:51] <cmr> we're 768K native, static+lto+stripped
[17:41:15] <acrichto> oh I wanted to run some tests with --gc-sections
[17:41:21] <acrichto> I don't think we'll ever be able to turn LTO on by default
[17:41:37] <acrichto> but if we could turn gc-sections on by default we may be able to get down to a very small statically linked library
[17:41:55] *** Quits: gwty (gwtypc@81092C33.AB257A8F.F64220F6.IP) (Ping timeout)
[17:42:52] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[17:48:25] *** Joins: wycats (sid79@moz-5F4AA75A.irccloud.com)
[17:50:09] <cmr> acrichto: gc-sections no affect on libnative hello world.
[17:50:21] <acrichto> not today, no
[17:50:39] <acrichto> I was talking with pcwalton and we came up with the idea of putting each module's code in its own section
[17:50:41] <cmr> what do we need to do to make it so? equiv of -ffunction-sections?
[17:50:47] <cmr> yeah
[17:50:54] <acrichto> with ffunction-sections it increases the build time by a fair amount sadly
[17:50:59] <acrichto> we have lots of functions all over the place
[17:51:03] <acrichto> link time*  it increases
[17:51:11] <acrichto> but if it's a per-module section it may not be that bad
[17:51:20] <cmr> are there entire modules that aren't used?
[17:51:22] <cmr> I find that dubious
[17:51:32] <acrichto> do you use everything in libstd when you link against it?
[17:51:45] <acrichto> it may not get us too many wins yeah
[17:51:51] <acrichto> just an idea I had floating around
[17:51:52] <cmr> well no, but libstd uses itself a lot
[17:51:57] <cmr> sure, worth trying.
[17:52:31] <acrichto> I still think that if you want a small executable you should use dynamic linking...
[17:53:22] <cmr> if you're only shipping one executable that's still going to be huge unless you strip metadata
[17:53:53] <acrichto> I guess yeah
[17:53:53] *** Joins: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu)
[17:54:08] <acrichto> LTO will always be the lower bound for the size of libstd executables
[17:54:11] <acrichto> if you statically link
[18:01:49] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[18:01:49] <ghrust> 01[13rust01] 15bors pushed 11 new commits to 06auto: 02http://git.io/ILRi3A
[18:01:49] <ghrust> 13rust/06auto 14665555d 15lpy: return value/use extra::test::black_box in benchmarks
[18:01:49] <ghrust> 13rust/06auto 14ee2a888 15Alex Crichton: extra: Capture stdout/stderr of tests by default...
[18:01:49] <ghrust> 13rust/06auto 143af5f38 15Eduard Burtescu: Don't copy &Trait and &mut Trait to temporaries for every call.
[18:01:51] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[18:12:07] <eddyb> is that a rollup?
[18:12:25] <cmr> yeah
[18:13:16] <acrichto> empty the queue!
[18:14:03] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[18:21:01] *** Joins: mib_6uyt29 (Mibbit@moz-5054324.san.res.rr.com)
[18:21:21] *** Quits: mib_6uyt29 (Mibbit@moz-5054324.san.res.rr.com) (Quit: http://www.mibbit.com ajax IRC Client)
[18:23:02] *** Quits: Leo` (Leo@moz-83832FE2.placeholder.fr) (Ping timeout)
[18:23:18] *** Quits: edwardw (edwardw@FC63E399.AB331A3B.FAED9FFC.IP) (Quit: Leaving...)
[18:25:20] *** Joins: Leo` (Leo@moz-83832FE2.placeholder.fr)
[18:26:50] <cmr> rusti: let x: *int = &42;
[18:26:56] -rusti- pastebinned 10 lines of output: http://ix.io/av9
[18:27:03] *** Quits: pnkfelix (pnkfelix@87C1F78E.1DE10CA8.D8E68FF6.IP) (Quit: rcirc on GNU Emacs 24.3.1)
[18:29:59] *** Joins: sunfish (chatzilla@moz-C06D9702.mtv1.mozilla.com)
[18:30:14] *** Joins: edwardw (Mibbit@655F78EA.BF27AFA4.B9C6B12A.IP)
[18:30:35] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Quit: It's a joke, it's all a joke.)
[18:30:37] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[18:31:27] <acrichto> rusti: version
[18:31:28] -rusti- "rustc 0.10-pre (4cd555d 2014-01-24 03:28:15 -0500)"
[18:31:37] *** Quits: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP) (Ping timeout)
[18:32:21] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[18:38:24] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[18:41:46] *** Joins: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP)
[18:41:46] <ghrust> [13rust] 15bors 04force-pushed 06auto from 149bda299 to 1492c5738: 02http://git.io/N3iJvQ
[18:41:46] *** Parts: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP) ()
[18:41:46] *** Joins: jdm (jdm@E595D12E.1196002C.7DBB297B.IP)
[18:51:29] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[18:52:47] *** Joins: summerlight_ (summerligh@327FC32B.2C956A45.501EFF44.IP)
[18:53:36] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[18:54:51] *** Quits: summerlight_ (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[18:58:07] <cmr> r? https://github.com/mozilla/rust/pull/12269
[18:58:13] <cmr> acrichto: ^ good candidate for your rollup
[18:58:48] <acrichto> I shall r+ for posterity's stake
[18:59:11] <cmr> well don't you leave the PRs open, so that when your rollup fails the queue continues as expected?
[18:59:40] <acrichto> indeed
[19:00:34] <cmr> So I remember a decision to not include mention of unofficial nightlies.
[19:00:55] <cmr> Or maybe that decision was never acted on
[19:00:59] <cmr> the wiki page is still mentioned
[19:01:03] <cmr> nvm me
[19:03:08] <acrichto> cmr: aww I suppose I'm not helping our stats much because all the PRs will count as closed instead of merged
[19:03:33] <cmr> acrichto: bors marks prs as closed
[19:03:41] <cmr> I think it checks if the commits are in the history to decide the status.
[19:03:45] <acrichto> I think it may be a race actually
[19:03:49] <acrichto> some of the are closed, others are merged
[19:03:52] <cmr> yeah
[19:03:54] <cmr> was going to mention
[19:04:00] <acrichto> oh I guess the exact commit isn't in the history
[19:04:05] <acrichto> b/c they're all rebased on one another
[19:04:06] *** Joins: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP)
[19:04:07] <ghrust> [13rust] 15bstrie created 06noise (+1 new commit): 02http://git.io/cZuWjA
[19:04:07] <ghrust> 13rust/06noise 142825f6d 15Ben Striegel: Clean up the Perlin noise benchmark
[19:04:07] *** Parts: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP) ()
[19:04:17] <acrichto> bstrie_vanished: ^ ?
[19:05:03] <bstrie_vanished> god damn it!
[19:05:07] <bstrie_vanished> acrichto: sorry :(
[19:05:13] <bstrie_vanished> I didn't realize origin was mozilla...
[19:05:17] <acrichto> bstrie_vanished: no worries :)
[19:05:25] <acrichto> I remember I reset master back like 50 commits once
[19:05:30] <acrichto> and I didn't have the most recent master :(
[19:05:44] <bstrie_vanished> I haven't used this machine for comitting for over two years, origin is always supposed to be my personal repo
[19:06:29] <acrichto> ugh I keep running in to that compiler-rt makefile dep problem
[19:06:31] <bstrie_vanished> oh right, thank god, that wasn't master
[19:06:33] <bstrie_vanished> phew
[19:06:59] <acrichto> lol
[19:07:07] <bstrie_vanished> ugh, now what's the git syntax for deleting a remote branch
[19:07:19] <edwardw> :branch_name
[19:07:19] <cmr> git push origin :noise
[19:07:30] <acrichto> I never understood why...
[19:07:36] <acrichto> not like git push -d origin noise
[19:07:39] <acrichto> :noise ...
[19:07:43] <cmr> you're pushing nothing to noise
[19:07:44] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[19:07:44] <ghrust> [13rust] 15bstrie 04deleted 06noise at 142825f6d: 02http://git.io/1n778g
[19:07:44] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[19:07:47] <sfackler> acrichto: the syntax is local_branch:remote_branch
[19:07:57] <acrichto> oh!
[19:08:00] <cmr> the full syntax is `git push $remote shaish:shaish`
[19:08:02] <acrichto> that makes sense
[19:08:17] <acrichto> yay new snaps
[19:08:28] <acrichto> that was easy
[19:12:06] <larsberg> question for other people who've looked at @mut-removalâ€¦ if you had a "fn blah(@mut self)", what did you change it to if that function relied on getting the refcounted version of self (e.g., so it could .clone() it and put it in some other structure)? did you just make it no longer a self method and make people call it with Type::blah(thingie) instead of thingie.blah()?
[19:12:36] <acrichto> larsberg: I think pcwalton either changed them to &mut self or you'll have to make a top-level function for now sadly
[19:12:44] <acrichto> I think eventually we want fn(Gc<self>)
[19:12:56] <acrichto> but we don't have it right now sadly
[19:13:04] <larsberg> acrichto: Yeah, I can use &mut self most of the time; it's just when I need to preserve its Rc/Gc-ness. Thanks!
[19:13:16] <larsberg> (only two cases out of all of the non-script Servo, so not that bad)
[19:13:28] <acrichto> hehe
[19:13:34] <acrichto> maybe ufcs will help fix this
[19:13:47] <acrichto> b/c you could possibly make a static method in the type...
[19:19:06] *** Quits: jack (sid19593@moz-A42E5B7B.irccloud.com) (Ping timeout)
[19:21:13] <eddyb> acrichto: I would rather have self: Gc<Self>
[19:21:14] *** Joins: jack (sid19593@moz-A42E5B7B.irccloud.com)
[19:21:44] *** Joins: brson (brson@moz-BBE3ABD.mv.mozilla.com)
[19:21:44] *** ChanServ sets mode: +qo brson brson
[19:21:46] <eddyb> though.... as I've previously mentioned, AselfB tends to map pretty well to self: ASelfB
[19:22:02] <acrichto> I'd also be down with that
[19:22:49] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Quit: Lost terminal)
[19:23:14] *** Joins: brson (brson@moz-BBE3ABD.mv.mozilla.com)
[19:23:14] *** ChanServ sets mode: +qo brson brson
[19:28:42] <eddyb> (I didn't get to finish that comment: Rc<RefCell<self>> makes sense to me, because I *know* it's self: Rc<RefCell<Self>>, but this wasn't obvious at first)
[19:28:47] <Eridius> r? https://github.com/mozilla/rust/pull/12271
[19:29:29] *** Quits: jdm (jdm@E595D12E.1196002C.7DBB297B.IP) (Quit: Lost terminal)
[19:29:54] <sfackler> Eridius: I thought crate was a full keyword for now?
[19:31:31] <eddyb> is there any name for this concept? three crates: std, a and b. std defines a static with value DEFAULT. a defines the same static with value A and b does the same with value B
[19:32:00] <cmr> what would the concept be?
[19:32:03] <cmr> it's three statics.
[19:32:09] <cmr> separate statics
[19:32:14] <cmr> scoped by crate... enforced by hash.
[19:32:19] <eddyb> cmr: wait, I didn't finish...
[19:32:46] <eddyb> linking against std+a results in all crates seeing the value A for the static in std, respectively B for std+b
[19:33:01] <eddyb> I know weak symbols are close to what I've described so far
[19:33:09] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[19:33:20] <eddyb> now, linking against std or std+a+b should result in the value being DEFAULT
[19:34:55] <eddyb> AFAIK, a weak symbol would result in either A, B (presumably depending on order) or a link error
[19:35:27] <eddyb> s/order/the order in which the libraries were specified to the linker/
[19:41:49] *** Quits: teratorn (teratorn@moz-5363C32C.teratorn.org) (Quit: Absum!)
[19:43:20] <acrichto> eddyb: we could do something like that at the source level instead of relying on the linker for that
[19:43:22] <Eridius> sfackler: it is a full keyword but it's only allowed after extern
[19:43:29] <Eridius> sfackler: which is why I mark it as Error if it's in any other position
[19:44:08] <sfackler> ah
[19:44:30] <eddyb> acrichto: still needs LTO to get anywhere
[19:44:35] *** Joins: teratorn (teratorn@moz-5363C32C.teratorn.org)
[19:44:59] <acrichto> eddyb: hm, so what would the semantics of libstd using this static be?
[19:45:17] <acrichto> eddyb: would all the relevant code have to be instantiated differently depending on how you link?
[19:45:48] <eddyb> that sounds complicated... I know that with LTO, this has to potential to make hello world tiny
[19:46:12] *** Quits: edwardw (Mibbit@655F78EA.BF27AFA4.B9C6B12A.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[19:46:14] <acrichto> you're thinking about statics for constructors?
[19:46:19] <acrichto> I/O constructors that is
[19:47:33] <eddyb> the entire ~Runtime interface
[19:48:00] <acrichto> hm, the ~Runtime is a volatile thing that gets moved around a lot
[19:48:09] <acrichto> for libgreen you can think of ~Runtime as being the scheduler
[19:48:30] <acrichto> implementation-wise it's a bit of glue between the Scheduler and a Task, but it's essentially that
[19:48:47] <eddyb> my idea is to have an easy-to-devirtualize immutable static trait object
[19:49:08] *** Joins: edwardw_ (Mibbit@6ED525DA.BF27AFA4.B9C6B12A.IP)
[19:49:10] <eddyb> so that if you link only against green or only against native, it treats that ~Runtime as the only type that implements Runtime
[19:49:23] <acrichto> hm interesting...
[19:49:42] <acrichto> I suppose if LLVM devirtualized everything it would never read the static so it would go away and the vtable would get eliminated
[19:50:07] <eddyb> hah, we can keep the current performance without LTO by instantiating std twice :P
[19:50:21] <eddyb> well, std and every crate using it
[19:51:35] *** edwardw_ is now known as edwardw
[19:52:08] <eddyb> so the .o in .rlib would use ~Runtime like today, while the .bc would use this fancy weak-like method of "devirtualizing" ~Runtime
[19:52:26] *** Quits: aurynj (Eon@BF507CFB.1CEEC774.4C51A5AE.IP) (Ping timeout)
[19:52:30] <eddyb> but that requires going through trans twice, I doubt we want to do that
[19:52:59] <eddyb> (or at least, copy the bc before changing a few things, and optimize both variants)
[19:53:23] <acrichto> hm that sounds... interesting
[19:53:33] <acrichto> if .bc is different than the .o we'd have to create two LLVMModule instances
[19:54:23] <eddyb> I wonder whether we can save the unoptimized .bc file, and load it again after freeing all the memory used by the first LLVMModule instance
[19:55:13] <eddyb> that would just mean doubling the time spent in LLVM passes, but I'm not sure it's that bad for everything other than syntax and rustc
[19:55:51] <acrichto> it's probably pretty bad
[19:55:59] <acrichto> most of our time is spent in LLVM optimizations right now
[19:56:57] <eddyb> true, but it's not really noticeable before libsyntax
[19:57:09] *** Quits: teratorn (teratorn@moz-5363C32C.teratorn.org) (Quit: Absum!)
[19:57:35] *** Joins: teratorn (teratorn@moz-5363C32C.teratorn.org)
[19:57:46] <cmr> please don't do that.
[19:57:56] <eddyb> cmr: maybe just as an experiment :)?
[19:58:25] <acrichto> eddyb: did I tell you about my idea to fix our sizes when doing LTO?
[19:58:39] <eddyb> what's broken?
[19:58:54] <acrichto> oh just in that our hello world statically linked executable is 2MB
[19:58:59] <acrichto> even with LTO turned on
[19:59:07] <eddyb> wait, why?
[19:59:18] <acrichto> hm, this isn't what you're solving?
[19:59:28] <eddyb> because it still statically links with the .o, or what?
[19:59:42] <cmr> it's only 1.6M for me
[19:59:44] <acrichto> we may be talking about different things
[19:59:56] <acrichto> 'fn main() {}' <- compile with LTO and you get a 1.6MB executable
[19:59:59] <acrichto> which is a little absurd
[20:00:10] <acrichto> that's the problem I had ideas how to fix, were you thinking of something else?
[20:00:44] <eddyb> were your ideas related to all the runtime shenanigans we pull in, even with LTO?
[20:01:19] <acrichto> tha's the reason it's 1.6MB
[20:01:24] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[20:01:26] <acrichto> even with LTO you pull in all the I/O that you're not using
[20:01:39] <eddyb> right, so what was your idea?
[20:01:52] *** Joins: gimpf (gimpf@moz-C9F096CE.adsl.highway.telekom.at)
[20:01:54] <eddyb> cmr: this isn't just about ~Runtime, though. I could see this being used to change the default heap allocator by just importing another crate :)
[20:02:23] <cmr> eddyb: I don't think it's acceptable to double LLVM time.
[20:02:41] <eddyb> no it isn't
[20:03:52] <eddyb> cmr: I dismissed the split .o/.bc idea at first, but it's not that bad, it deserves some experimentation
[20:03:57] *** Joins: aepsil0n (eduard@moz-15CB80F2.hsi8.kabel-badenwuerttemberg.de)
[20:05:09] <eddyb> extern crate jemalloc; // BAM. with LTO and a jemalloc compiled with clang, you could even have ~Some(0u) go directly to the right size class
[20:06:33] <eddyb> this is a bit more important in rust-core, where I want to have the default allocator in the crate I'm using rust-core in, and strcat insists rust-core should be a crate of its own
[20:06:47] <acrichto> eddyb: oh sorry, so my idea was to have a thread-local global per I/O constructor
[20:06:54] <acrichto> eddyb: llvm will eliminate globals if you only write to them
[20:07:15] <acrichto> eddyb: so the globals are only read if you create an I/O object, but if you don't create an I/O object you'll never read the global, so that entire portion of code will get eliminated
[20:08:04] <acrichto> eddyb: https://github.com/mozilla/rust/issues/11560
[20:08:11] <eddyb> so you'd be splitting ~Runtime into a per-thread interface and a per-task interface?
[20:08:32] <acrichto> kinda yeah
[20:08:42] <acrichto> native tasks would have to set these globals each time you spawn a task
[20:08:48] <eddyb> actually, there's no per-task interface :)
[20:08:51] <acrichto> green tasks would do nothing b/c they're guaranteed to be run on scheduler threads
[20:09:08] <eddyb> since you can't have a thread used by libgreen contain anything other than green tasks
[20:09:09] <acrichto> the per-task thing wouldn't be I/O related anymore, it'd just be the deschedule/reawaken primitives
[20:09:24] <acrichto> native tasks are the real problem here though
[20:09:51] <acrichto> in theory you can enter native tasks over FFI boundaries
[20:10:15] *** Parts: edwardw (Mibbit@6ED525DA.BF27AFA4.B9C6B12A.IP) ()
[20:10:17] <eddyb> so the virtual interface part of ~Runtime can be moved completely to TLS and LLVM would devirtualize it?
[20:10:22] <acrichto> and you'd have to maintain this set of global I/O constructors across those boundaries
[20:10:38] <acrichto> it wouldn't devirtualize it, this would all get eliminated through DCE
[20:10:43] <eddyb> oh, rith
[20:10:45] <eddyb> *right
[20:10:49] *** Joins: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP)
[20:10:51] <eddyb> would it also be faster?
[20:10:52] <acrichto> if you never read from a thread_local global (a private one) then you can eliminate all stores to it
[20:11:00] <acrichto> nah this would just be for code size
[20:11:07] <acrichto> but the bad part is that it's only *LTO* code size
[20:11:15] <acrichto> people care mostly about the default code size, not LTO code size
[20:11:24] <acrichto> so I ended up concluding that it probably wasn't worth it
[20:11:29] <cmr> I don't think that's a good argument
[20:11:30] <eddyb> TLS accesses can be segment:offset
[20:11:35] <cmr> if you want smaller binaries, compile with LTO
[20:11:40] <cmr> It's like building a release build...
[20:11:45] <cmr> it's fine if it takes longer
[20:11:49] <acrichto> perhaps yeah
[20:11:58] <cmr> it's not like large binaries matter during dev
[20:12:15] <cmr> I agree if there's a better solution that works for non-LTO we should take it.
[20:12:22] <cmr> but I think it's worth it if there isn't.
[20:12:45] <acrichto> this strategy *might* work if we use --gc-sections
[20:12:55] <acrichto> but maybe not
[20:12:55] <eddyb> acrichto: I did think of restructuring the Runtime interface, but I don't know much about it, so I wasn't sure whether something like TLS-only would work
[20:13:49] *** Quits: doener (doener@moz-C68F600D.unity-media.net) (Quit: leaving)
[20:13:52] <eddyb> cmr: my devirtualizable static trait interfaces would also be LTO-only, but more complicated
[20:14:44] <eddyb> "'This would slow down native task spawn times as they would always have to initialize these globals."
[20:15:00] <eddyb> acrichto: ^^ what's the difference between that and the current ~Runtime situation?
[20:15:19] <eddyb> ah, copying an array versus a vtable pointer?
[20:15:37] <acrichto> yeah
[20:15:43] <acrichto> there's no initialization with native tasks right now
[20:15:46] <acrichto> you just spawn the thread and go
[20:16:39] <eddyb> so what does Local do?
[20:16:50] *** Joins: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP)
[20:16:50] <ghrust> [13rust] 15bors merged 06auto into 06master: 02http://git.io/0tkx1A
[20:16:50] *** Parts: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP) ()
[20:17:04] <acrichto> eddyb: all it does any more is read/write the local Task pointer
[20:17:20] <eddyb> is there no ~NativeRuntime allocation that gets put in Task?
[20:17:34] <eddyb> and presumably ~Task itself, if it's heap-allocated
[20:17:37] <acrichto> there is
[20:18:05] <eddyb> isn't that a similarly complicated initialization?
[20:18:07] <acrichto> eddyb: http://static.rust-lang.org/doc/master/src/native/home/rustbuild/src/rust-buildbot/slave/doc/build/src/libnative/task.rs.html#41-49
[20:18:25] <acrichto> it's a very smalla mount of initialization
[20:18:47] <eddyb> TLS will be faster than an allocation, AFAIK
[20:18:58] <acrichto> eddyb: https://github.com/mozilla/rust/blob/master/src/libnative/task.rs#L90-L106
[20:19:00] <acrichto> it's true
[20:19:08] <acrichto> the second pasted blob is native task spawning
[20:19:20] <acrichto> the only initialization is shuffling around a few things
[20:19:42] <acrichto> if we were to have this TLS I/O constructor interface, it would involve a write to all those TLS globals
[20:21:53] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[20:21:54] <ghrust> [13rust] 15bors pushed 13 new commits to 06auto: 02http://git.io/gvCTqg
[20:21:54] <ghrust> 13rust/06auto 14665555d 15lpy: return value/use extra::test::black_box in benchmarks
[20:21:54] <ghrust> 13rust/06auto 14ee2a888 15Alex Crichton: extra: Capture stdout/stderr of tests by default...
[20:21:54] <ghrust> 13rust/06auto 143af5f38 15Eduard Burtescu: Don't copy &Trait and &mut Trait to temporaries for every call.
[20:21:56] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[20:22:11] <eddyb> I hope I am not causing that to fail :P
[20:22:24] <eddyb> acrichto: this looks intricate https://github.com/mozilla/rust/blob/master/src/libnative/task.rs#L252-L254
[20:22:48] <acrichto> eddyb: oh that's not much, native I/O is just a vtable and nothing else
[20:22:52] <acrichto> the data ptr has nothing associated with it
[20:23:21] <eddyb> acrichto: but if the TLS offsets are resolved to constants, it should just be as slow as writing N words to an array
[20:23:53] <acrichto> well when I say "slow down" I don't seriously think it will slow anything down at all
[20:24:03] <acrichto> calling into the kernel to make a thread is like 10000x more expensive than a write to a TLS global
[20:24:47] <eddyb> I'll read more on this task-local I/O stuff and the Runtime trait itself, later, brb now
[20:28:15] <eddyb> acrichto: ahh, there's a bunch of these https://github.com/mozilla/rust/blob/master/src/libnative/io/mod.rs#L188
[20:28:32] <acrichto> eddyb: indeed
[20:28:44] <eddyb> you could probably split them into ~4 vtables
[20:29:50] <eddyb> hmm, Many would let you take the vtable pointer for an impl of a trait by a type, and then reattach it later to a pointer of that type
[20:29:58] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Client exited)
[20:30:00] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Client exited)
[20:30:03] <eddyb> with a relatively safe interface
[20:30:09] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Quit: WeeChat 0.4.3)
[20:31:01] <acrichto> hmm
[20:31:01] *** Quits: Leo` (Leo@moz-83832FE2.placeholder.fr) (Ping timeout)
[20:31:03] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[20:31:26] <eddyb> need DST to implement it without abusing macros, though
[20:31:34] <eddyb> (generic over Trait)
[20:33:10] <Eridius> acrichto: since you cautioned about adding #[inline] everywhere, any objection to adding it to char::from_u32()? I would expect bounds checking like that to get inlined into callers
[20:33:38] <acrichto> yeah things like that specifically for cross-crate I think is ok
[20:33:44] <acrichto> putting it on everything is over the top
[20:33:58] <Eridius> ok. Yeah, when I suggested it on the PR, it didn't occur to me that the function was already generic
[20:34:06] * Eridius is adding CheckedAdd to char and wanted it to be inlineable
[20:35:00] <Eridius> oh hrm, it just occurred to me that CheckedAdd doesn't parameterize the RHS, which makes it not so useful for char, because I wanted to be able to say c.checked_add(1)
[20:35:04] <acrichto> brson: whoa! 'make check-std' is a thing?!
[20:35:17] <Eridius> acrichto: `make check-stage2-std NO_REBUILD=1 NO_BENCH=1` is my go-to
[20:35:28] *** Joins: Leo` (Leo@moz-83832FE2.placeholder.fr)
[20:35:34] <acrichto> I always forget NO_BENCH :\
[20:35:36] <Eridius> didn't occur to me there was a non-stage-specific variant though
[20:35:43] <acrichto> check-ref ?!
[20:35:46] <acrichto> what is this voodoo magic!
[20:35:54] <brson> acrichto: no, not yet
[20:35:56] <Eridius> what is check-ref?
[20:36:02] <brson> acrichto: there are a few targets there that don't exist yet
[20:36:07] <acrichto> brson: oh ok
[20:36:08] <brson> should have mentioned that
[20:36:31] <brson> i figure ref is rpass,rfail,cfail,rmake
[20:36:41] <brson> and that's the 'language reference test' or something
[20:36:53] <brson> starting to think about how to split out a 1.0 regression suite as well
[20:37:04] <strcat> Eridius: I don't think char should implement any arithmetic
[20:37:09] <strcat> it doesn't make semantic sense
[20:38:02] <strcat> range() will become based on a successor method
[20:38:52] <Eridius> oh?
[20:38:53] <Eridius> hmm
[20:41:37] <eddyb> interesting
[20:41:53] <eddyb> can we have pointer ranges :P?
[20:42:06] <strcat> probably doesn't make sense
[20:42:30] <eddyb> I found myself implementing an unsafe *dst = *src; dst = dst.offset(1); src = src.offset(1); loop
[20:42:32] <strcat> you'd need to use non-inbounds pointer arithmetic which is generally an anti-pattern
[20:42:44] <strcat> eddyb: use a slice
[20:42:48] <strcat> two slices
[20:42:57] <strcat> you can make slices from arbitrary ptrs
[20:42:58] <eddyb> dst and src are pointers in the same vector
[20:43:17] <strcat> we'll have unsafe slices with DST, won't be?
[20:43:22] <eddyb> it's a sliding window
[20:43:47] <eddyb> well, "while src < src_end" seemed to work pretty well
[20:44:03] <eddyb> so I let it be, though I could try a few variations
[20:45:30] <eddyb> I feel like weird tight loops like this sliding window thing should be a safe abstraction in std... but I'm not sure how generically they can be expressed
[20:46:51] <eddyb> the PNG decoder itself could use v.strict_mut_chunks::<4>(), if we had numeric values in generics
[20:47:37] <Eridius> v.struct_mut_chunks::<[u8, ..4]>() ;)
[20:48:16] *** Quits: Leo` (Leo@moz-83832FE2.placeholder.fr) (Ping timeout)
[20:48:59] <eddyb> Eridius: I know that trick, I used it in both SlamAllocator and the PNG decoder I was just talking about
[20:49:40] <eddyb> Eridius: the problem is that I would like it to return StrictMutChunks<T, N> which implements Iterator<&mut [T, ..N]>
[20:50:47] <eddyb> I guess ::<[T, ..N]> is a nice compromise... and you can bound it by Fixed<T>, now that we have that
[20:50:48] <Eridius> ah
[20:51:10] *** Joins: Leo` (Leo@moz-83832FE2.placeholder.fr)
[20:51:33] <eddyb> Fixed should have a static method to get the length
[20:52:24] <eddyb> strcat: hehe, I think we can start being generic over [T, ..N] now
[20:53:19] <strcat> eddyb: I don't think so... the trait is just impl'ed for certain sizes
[20:53:33] <strcat> anyway it's not enough to replace ~[T]
[20:53:37] <strcat> so I think it's just going to be removed
[20:53:55] <strcat> ~[x, y, z] works where x, y, and z are non-pod
[20:54:36] <eddyb> and ~([x, y, z]) doesn't?
[20:54:37] <strcat> we'd need a move iterator for fixed-size arrays to make it work
[20:54:48] <strcat> eddyb: talking about Vec and other containers
[20:54:50] <bstrie_vanished> do we really infer variance currently?
[20:54:55] <eddyb> ahh
[20:55:53] <eddyb> ImmutableVector<T>::strict_chunks<TN: Fixed<T>>(&self) -> StrictChunks<TN> {StrictChunks {start: self.as_ptr(), end: self.as_ptr().offset(size_of::<T>() * self.len())}}
[20:56:30] <eddyb> and StrictChunks doesn't need to care about T, nor N, just [T, ..N] (which I've creatively named TN)
[20:57:07] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[20:57:34] <eddyb> strcat: what do you think about those uses ^^?
[21:03:20] <cmr> bstrie_vanished: yes.
[21:03:27] <cmr> but there were marker types added to make it explicit.
[21:03:34] <cmr> https://github.com/mozilla/rust/pull/11768
[21:03:36] <Diamond> [T, ..N] would be great for simd
[21:03:46] <cmr> Diamond: see libstd/unstable/simd.rs
[21:05:56] <Diamond> I'm very familiar with std::unstable::simd :P I've wanted to replace the tuples there with fixed sized arrays && some generics, but the lack of support for [T, ..N] makes that impossible
[21:18:10] <acrichto> brson: r? https://github.com/mozilla/rust/pull/12085
[21:19:40] <eddyb> strcat: is match ctz(src ^ dst) {0 | 1 => copy_each_byte, 2 | 3 => align_to_4_and_copy_4_bytes_at_once, _ => align_to_16_and_copy_16_bytes_at_once} a good memcpy optimization?
[21:20:07] <strcat> huh?
[21:21:12] <eddyb> I have seen weird memcpy contraptions before, but AFAIK, the destination and the source have to be relatively alignable, otherwise you can't use SSE and whatnot
[21:22:15] <eddyb> that is, to copy 16 bytes at once, you need dst % 16 == src % 16
[21:22:46] <eddyb> and then I thought of a switch over the result of ctz(src ^ dst)
[21:22:49] <cmr> I'm pretty sure they need to *actually* be aligned for sse etc
[21:22:50] <strcat> just use rep, it's optimized in microcode
[21:22:58] <strcat> cmr: not on modern CPUs
[21:23:00] <strcat> on older ones, yes
[21:23:03] <cmr> cool
[21:23:11] <eddyb> cmr: if dst % 16 == src % 16, you can align them both
[21:23:17] <cmr> I don't remember seeing that in the manual
[21:23:51] <eddyb> copy src % 16 bytes and then both dst and src are aligned
[21:24:11] <cmr> but yeah just use rep
[21:24:52] <eddyb> strcat: I wonder why manual memcpy/memset optimizations beat rep...
[21:24:59] <strcat> eddyb: they don't
[21:25:11] <strcat> on a recent CPU, rep usually wins
[21:25:14] <eddyb> I wonder if qemu breaks that microcode optimization somehow
[21:25:30] <eddyb> strcat: how recent?
[21:25:35] <cmr> post-sandy I think
[21:25:45] <eddyb> that's too recent :/
[21:25:58] <strcat> you don't even get fast unaligned access before then!
[21:26:00] <eddyb> it's like using AVX in publicly distributed binaries
[21:26:26] <cmr> except backwards compatible.
[21:27:15] <eddyb> meh
[21:28:35] <strcat> eddyb: gcc and LLVM already tune for sandy/ivy bridge and haswell
[21:28:58] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[21:29:15] <eddyb> makes me want architecture-dependent bytecode distribution, instead of binaries
[21:29:32] <strcat> there aren't that many architecture variants
[21:29:43] <strcat> can just build binaries for each
[21:30:11] <strcat> http://archlinuxarm.org/packages that's what arch arm does...
[21:30:11] <eddyb> I know there's a distro that makes you compile everything. LLVM codegen shouldn't take that long :/
[21:30:28] <strcat> LLVM bytecode isn't platform independent
[21:30:35] <strcat> and there will be optimizations at a source level
[21:30:38] <strcat> based on platform
[21:30:40] <eddyb> I said architecture-dependent :P
[21:31:02] <strcat> eddyb: where 'architecture' here differs between haswell and ivy bridge
[21:31:14] <strcat> the bytecode targeting haswell is not the same as the bytecode targeting ivy bridge
[21:31:23] <strcat> there are source-level differences and then other target differences
[21:31:29] <eddyb> whoa?
[21:31:35] <strcat> I don't think that's surprising
[21:31:53] <strcat> there are new instructions introduced all the time
[21:31:55] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[21:31:55] <ghrust> [13rust] 15bors merged 06auto into 06master: 02http://git.io/gvCTqg
[21:31:55] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[21:31:56] <strcat> cache sizes change
[21:32:10] <strcat> costs of various things change
[21:32:39] <eddyb> I guess I wouldn't be surprised something like poly would optimize bytecode based on that
[21:33:00] <strcat> eddyb: doesn't require anything but standard gcc/llvm
[21:33:07] <eddyb> but I didn't know LLVM itself was doing it before codegen
[21:33:11] <strcat> it is
[21:33:16] <strcat> and the source code is too...
[21:33:42] <strcat> eddyb: LLVM bytecode is entirely platform dependent
[21:33:47] <strcat> it includes alignment, vector ops, etc.
[21:33:55] <eddyb> at least Rust code doesn't do #[cfg(mtune_haswell)]
[21:33:57] <strcat> it makes all kinds of decisions during IR transformations based on costs
[21:34:01] <strcat> eddyb: it will
[21:34:10] * eddyb blinks
[21:34:15] <strcat> anyway talking about architecture targets, not mtune
[21:34:32] <eddyb> no idea which is which anymore, sorry
[21:34:41] <strcat> march sets a target
[21:35:02] <strcat> mtune just tunes for a target or group of targets without changing the compatibility
[21:35:21] <eddyb> wait, so rustc built (exclusively) for a recent Intel CPU could just discard alignments everywhere?
[21:35:33] <eddyb> and use like 2x less RAM :P?
[21:35:45] <strcat> x86 allows unaligned memory access, not just recently
[21:35:54] <eddyb> I mean, efficiently
[21:36:03] <strcat> the penalty for unaligned access was erased recently, yeah
[21:36:15] <eddyb> does LLVM expose that information?
[21:36:18] <strcat> although in some cases you do still want to align
[21:36:18] <sunfish> unaligned accesses are fast on modern Intel, though still not quite as fast as aligned accesses
[21:36:36] *** Joins: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP)
[21:36:36] <ghrust> [13rust] 15bors pushed 0 new commits to 06auto: 02http://git.io/ik426Q
[21:36:36] *** Parts: ghrust (ghrust@23EC81EC.6A2AE50.F3114085.IP) ()
[21:36:38] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[21:36:38] <ghrust> [13rust] 15bors pushed 3 new commits to 06auto: 02http://git.io/uWkmXw
[21:36:38] <ghrust> 13rust/06auto 1452a3d38 15Kevin Ballard: rustdoc: Strip impls of stripped private types...
[21:36:38] <ghrust> 13rust/06auto 149e6c3f0 15Kevin Ballard: rustdoc: Strip impls of traits on #[doc(hidden)] types...
[21:36:38] <ghrust> 13rust/06auto 14718c13f 15bors: auto merge of #12195 : kballard/rust/rustdoc-strip-impls-of-stripped, r=cmr...
[21:36:40] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[21:37:01] <eddyb> strcat: I would think of it as a memory usage experiment
[21:37:32] *** Quits: doomlord_ (servitor@moz-9B2006BF.range109-151.btcentralplus.com) (Quit: Leaving)
[21:37:56] <eddyb> sunfish: so LLVM would still align everything?
[21:38:02] <strcat> no
[21:38:06] <strcat> alignment is up to the frontend
[21:38:13] <strcat> for the most part
[21:38:14] <sunfish> eddyb: yes, LLVM generally does align stuff when it has a choice
[21:38:27] <eddyb> strcat: oh, right, ABIs
[21:38:42] <strcat> not ABIs
[21:39:02] <strcat> whether or not you care about following a certain ABI for function calls, the frontend does alignment
[21:39:02] <larsberg> fyi, Nehalem was the start of making these sorts of things go faster. Back in grad school, we spent some time (working with folks at Intel) trying to things that reproduce a drop in behavior for unaligned access, but the only ways you can do that are if you force additional cache refs. Everybody already pays the cost for the alignment network they built in.
[21:39:16] <larsberg> s/behavior/performance
[21:39:34] <strcat> until recently vector ops were still a lot slower if they weren't aligned
[21:39:50] <larsberg> you will still see horrific performance on even modern AMD x86_64 chips, though
[21:40:03] <eddyb> I mean, LLVM doesn't know/care how C structs should have their fields aligned, that's probably defined in an ABI and/or C11 spec
[21:40:31] <strcat> not part of the C spec
[21:41:03] <strcat> and rust could just require that you mark structs you are going to pass to C
[21:41:14] <eddyb> #[repr(C)]
[21:41:19] <eddyb> that would be fine with me :)
[21:42:25] <eddyb> larsberg: wait, so are you saying that even older Intel CPUs can do fast unaligned accesses, you just have to be careful with caches?
[21:42:47] <strcat> the cache part depends anyway
[21:42:51] <Eridius> we already have #[repr(C)], no?
[21:42:55] <strcat> Eridius: for enums
[21:42:57] <Eridius> ahh
[21:43:05] <strcat> rust structs are always C compatible
[21:43:23] <strcat> if you align memory, then in some cases you are making fewer accesses across cachelines
[21:43:29] <strcat> in other cases, you are making more access across cachelines
[21:43:39] <strcat> if the you don't align memory then data is packed more, so there's more data in each cacheline
[21:43:56] <strcat> but you also might have a struct overlapping two when it didn't before
[21:44:00] <larsberg> eddyb: yes, if you have anything more modern than a circa-2008 Xeon, you should be fine (based on our testing and discussions with the intel architects)
[21:44:18] *** Quits: gimpf (gimpf@moz-C9F096CE.adsl.highway.telekom.at) (Ping timeout)
[21:44:33] <strcat> you'd most likely want to align AVX-512 vectors for example...
[21:45:18] <eddyb> larsberg: should totally test it on my i3 then :)
[21:45:56] <strcat> which generation of i3?
[21:46:35] <strcat> there are 3 architecture generations of i3/i5/i7 ;p
[21:46:50] <strcat> it's silly...
[21:49:12] <eddyb> and 20 sockets
[21:49:23] <eddyb> 350M IIRC, first or second generation
[21:49:47] <eddyb> was around in early 2010, I would think
[21:53:19] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[21:54:11] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Connection reset by peer)
[21:56:25] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[21:56:58] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[22:01:44] *** Quits: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP) (Ping timeout)
[22:18:56] <Eridius> whoa, nice type signature: |s: &~~[~str]|
[22:19:34] <steveklabnik> lol
[22:19:54] <Eridius> even better: fn get_global_ptr() -> *mut Option<~~[~str]>
[22:27:17] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[22:27:17] *** ChanServ sets mode: +o tjc
[22:34:57] *** Quits: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net) (Ping timeout)
[22:35:04] *** Joins: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net)
[22:38:36] *** Joins: mankyKitty (Instantbir@325B2C60.E2538F64.BC02889B.IP)
[22:46:31] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[22:46:31] <ghrust> [13rust] 15bors merged 06auto into 06master: 02http://git.io/uWkmXw
[22:46:31] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[22:47:59] <brson> it looks like the 1.0 issues may go down this week for the first time in a month
[22:49:24] <acrichto> brson: \o/
[22:50:10] *** Joins: pcwalton (pcwalton@moz-7B0110AD.mv.mozilla.com)
[22:50:10] *** ChanServ sets mode: +ao pcwalton pcwalton
[22:51:34] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[22:51:34] <ghrust> [13rust] 15bors pushed 0 new commits to 06auto: 02http://git.io/7ezqYQ
[22:51:34] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[22:51:36] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[22:51:36] <ghrust> [13rust] 15bors pushed 2 new commits to 06auto: 02http://git.io/z8I1wA
[22:51:36] <ghrust> 13rust/06auto 14b33c422 15Alex Crichton: Allow configuration of uid/gid/detach on processes...
[22:51:36] <ghrust> 13rust/06auto 14059bbdb 15bors: auto merge of #12085 : alexcrichton/rust/issue-12082, r=brson...
[22:51:36] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[22:59:53] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Quit: WeeChat 0.4.3)
[23:03:34] <cmr> acrichto: empty reply on the ML to the struct self-borrow thread?
[23:04:45] <acrichto> cmr: did I do that?
[23:04:50] <cmr> acrichto: yeah.
[23:05:00] <cmr> oh wait
[23:05:03] <cmr> no
[23:05:05] <cmr> I don't know how to read.
[23:05:05] <acrichto> I'm not seeing it on rust-dev
[23:05:07] <acrichto> oh lol
[23:05:22] <acrichto> you scared me
[23:08:51] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[23:11:33] *** Quits: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net) (Quit: Leaving.)
[23:16:23] *** Quits: mankyKitty (Instantbir@325B2C60.E2538F64.BC02889B.IP) (Quit: mankyKitty)
[23:16:34] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[23:16:34] <ghrust> [13rust] 15bors pushed 3 new commits to 06auto: 02http://git.io/2OWs9w
[23:16:34] <ghrust> 13rust/06auto 14abf54d2 15Alex Crichton: Register new snapshots...
[23:16:34] <ghrust> 13rust/06auto 14f4d330c 15Alex Crichton: extern mod => extern crate...
[23:16:34] <ghrust> 13rust/06auto 1464b498b 15bors: auto merge of #12272 : alexcrichton/rust/snapshot, r=kballard...
[23:16:36] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[23:18:24] <huon> acrichto: btw, why was -Z debug-info removed? aiui other compilers offer a "low overhead" DWARF option (e.g. one person said that going from -Z debug-info to -g took compile times from 1 minute to 4!)
[23:18:47] <acrichto> huon: oh I was under the impression that -Z debug-info was the same as -Z extra-debug-info
[23:18:53] <acrichto> perhaps I should not have removed it
[23:19:16] <sfackler> iirc it's only line number mappings
[23:19:18] <huon> I'm not sure of the exact difference, but I think there was one
[23:21:46] <huon> acrichto: I'll open a bug
[23:22:10] <acrichto> huon: thanks
[23:23:38] <huon> acrichto: https://github.com/mozilla/rust/issues/12280
[23:24:40] <cmr> dammit
[23:31:51] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[23:32:05] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[23:34:36] *** Joins: mawuli (mawuli@moz-5ADAB167.com.gh)
[23:34:53] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[23:35:57] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[23:38:56] *** Joins: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au)
[23:42:03] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[23:49:22] <Eridius> whoa, acrichto's snapshot failed and the failing test had a rather interesting error
[23:49:26] <Eridius> error: `extern crate` is obsolete, use `extern crate` instead to refer to external crates.
[23:49:30] *** zz_kimundi is now known as kimundi
[23:49:37] <Eridius> (it was on an `extern mod`, naturally. Also the span pointed at the identifier instead of the whole item)
[23:50:53] <acrichto> oh lol search and replace gone wrong
[23:51:11] <cmr> can someone take a look at https://github.com/cmr/rust/commit/9fa4cc3e6bef26faef96a8cd048fd7ff7b40566d ?
[23:51:17] <cmr> it's causing stage1 rustc to segfault
[23:51:30] *** Joins: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP)
[23:51:30] <ghrust> [13rust] 15bors 04force-pushed 06auto from 1464b498b to 14718c13f: 02http://git.io/N3iJvQ
[23:51:30] *** Parts: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP) ()
[23:51:30] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[23:51:31] <ghrust> [13rust] 15bors pushed 5 new commits to 06auto: 02http://git.io/Hv3L9g
[23:51:31] <ghrust> 13rust/06auto 1484c6018 15Kevin Ballard: Update vim syntax for extern crate
[23:51:31] <ghrust> 13rust/06auto 14c718e0e 15Kevin Ballard: Add CheckedDiv to vim syntax
[23:51:31] <ghrust> 13rust/06auto 14fff1222 15Kevin Ballard: Add crate to emacs and kate modefiles
[23:51:33] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[23:51:43] <Eridius> yay, bors is going to spend a while testing something that didn't change anything testable! \o/
[23:51:50] <cmr> \o/
[23:53:53] <cmr> (watch it fail anyways)
[23:53:58] <Eridius> :'(
[23:55:45] <ChrisMorgan> Wait, how did that jump to the head of the queue? The queue had two things approved before it was approved.
[23:56:11] <cmr> ChrisMorgan: it's older.
[23:56:12] <Eridius> ChrisMorgan: it's ordered by PR number, after priority
[23:56:21] <Eridius> the order of approval is irrelevant
[23:56:26] <ChrisMorgan> OK.
[23:56:43] <ChrisMorgan> I understood it as a *queue*, you see, in the most obvious sense of the word.
