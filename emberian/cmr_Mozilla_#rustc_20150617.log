[00:13:18] <eddyb> test result: ok. 23 passed; 0 failed; 0 ignored; 0 measured
[00:13:21] <eddyb> so that's out of the way :D
[00:19:58] *** Joins: eddyb_ (eddyb@moz-4q5.hlc.26.188.IP)
[00:22:32] *** Quits: eddyb (eddyb@moz-1t4sgi.residential.rdsnet.ro) (Ping timeout: 121 seconds)
[00:34:32] *** eddyb_ is now known as eddyb
[00:35:10] *** eddyb is now known as eddyb__
[00:35:13] *** eddyb__ is now known as eddyb
[00:45:17] <eddyb> nrc: added a comment https://github.com/eddyb/rust/commit/f55e383e0fdb9a6fbcd9463491d9655e983b6280
[00:45:58] <eddyb> nrc: is that better?
[00:46:13] <eddyb> well, better than nothing, but is it enough?
[00:49:16] *** Joins: aatch (james@moz-c6etfk.fosn.r6an.e000.2406.IP)
[01:06:50] <nrc> f+
[01:09:40] *** Quits: Eridius (kevin@moz-6opvqs.us) (Quit: BBIAB, upgrading my Linode to KVM)
[01:09:49] <acrichto> nmatsakis: sgtm
[01:20:06] *** Joins: Eridius (kevin@moz-6opvqs.us)
[02:39:28] <mystor> When making an llvm pass plugin on nightly, how should I get the headers to link against?
[02:43:33] <eddyb> mystor: rust-lang/rust's LLVM submodule, presumabl
[02:45:05] <mystor> eddyb: So, if I'm in a build script, and the user didn't build rustc from source (they downloaded the nightlies), then I can't link against their LLVM?
[02:45:17] <mystor> I'd have to clone & build llvm myself?
[02:45:46] <eddyb> mystor: I'm not sure
[02:46:06] <mystor> hmm, ok
[02:46:23] <eddyb> mystor: you can try linking something which uses LLVM symbols, against the crate that wraps LLVM
[02:46:56] <mystor> true, but there are some LLVM headers which are generated by the configure script iirc
[02:47:12] <cmr> mystor: we don't ship an llvm you can link against, no.
[02:47:18] *** Quits: zz_kimundi (kimundi@moz-0a7524.dip0.t-ipconnect.de) (Ping timeout: 121 seconds)
[02:47:21] <eddyb> well, you only need to run the same configure script with the same options
[02:47:27] <eddyb> but that's just a guess
[02:47:34] <mystor> cmr: How are you supposed to build llvm pass plugins then?
[02:48:02] <cmr> mystor: you aren't.
[02:48:31] <eddyb> cmr: I am seeing exported symbols from librustc_llvm-whatever.so
[02:48:32] <mystor> cmr: oh. is the llvm pass plugin registrar feature for internal use then?
[02:48:43] <eddyb> random example: addr=0x0111b8b0 off=0x0111b8b0 ord=33548 fwd=NONE sz=42 bind=GLOBAL type=FUNC name=LLVMConstIntOfString
[02:49:55] <cmr> eddyb: sure, librustc_llvm contains a copy of llvm.
[02:50:11] <eddyb> and you know the exact rust-lang/rust git tree
[02:50:12] <cmr> I guess you could probably link against that instead of libllvm?
[02:50:14] *** Joins: zz_kimundi (kimundi@moz-357luu.dip0.t-ipconnect.de)
[02:50:15] *** zz_kimundi is now known as kimundi
[02:50:19] <mystor> You can definitely add passes to rustc? https://github.com/rust-lang/rust/blob/master/src/librustc/plugin/registry.rs#L132-L139
[02:50:19] <cmr> That's pretty hacky though.
[02:50:32] <eddyb> mystor: oh that's for existing LLVM passes
[02:50:38] <eddyb> mystor: like, built-in
[02:50:46] <mystor> eddyb: Oh - so you don't have any support for writing custom passes?
[02:50:58] <eddyb> actually, afl-rs uses a LLVM pass, doesn't it?
[02:50:59] <mystor> eddyb: I feel like having support for that would be nice
[02:51:20] <eddyb> https://github.com/kmcallister/afl.rs/blob/master/plugin/build.rs
[02:51:34] <eddyb> https://github.com/kmcallister/afl.rs/blob/master/plugin/src/lib.rs
[02:51:37] <mystor> eddyb: afl-rs does a hack where it assumes you built from source, goes up two directories from `which rustc` and then `find -name llvm-configure`
[02:51:50] <eddyb> oh
[02:52:01] <mystor> I was hoping there was a better way :(
[02:52:01] <eddyb> mystor: riiight, that's a bit of a problem
[02:52:07] <eddyb> what does it do with llvm-configure?
[02:52:25] <mystor> eddyb: With that, you can run it and get the correct include paths
[02:52:27] <eddyb> $LLVM_CONFIG --cxxflags
[02:52:38] <mystor> then link the compiled Cpp file into your rust plugin
[02:52:44] <mystor> which is linked against rustc, and thus against llvm
[02:52:52] <mystor> and so symbols resolve
[02:52:53] <mystor> (I think)
[02:53:04] <eddyb> -I/home/eddy/Projects/rust/src/llvm/include -I/home/eddy/Projects/rust/x86_64-unknown-linux-gnu/llvm/include  -DNDEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -O3 -fomit-frame-pointer -std=c++11 -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -fPIC -ffunction-sections -fdata-sections -Wcast-qual
[02:53:04] <mystor> It's pretty nasty
[02:53:25] <eddyb> out of that, the only interesting ones are the first two
[02:53:44] <mystor> -I/Volumes/Devel/Code/rust/src/llvm/include -I/Volumes/Devel/Code/rust/x86_64-apple-darwin/llvm/include  -DNDEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -O3  -stdlib=libc++ -std=c++11 -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -fno-common -Wcast-qual
[02:53:45] <eddyb> that's a lot of files though
[02:53:46] <mystor> for me
[02:53:57] <eddyb> mystor: so, plan B :D
[02:54:06] <mystor> It's 2 include paths, a bunch of defines, and then random extra flags
[02:54:22] <mystor> eddyb: What's plan B
[02:54:23] <eddyb> make: Nothing to be done for 'x86_64-unknown-linux-gnu/llvm/Release/bin/llvm-config'.
[02:54:24] <mystor> ?
[02:54:30] <eddyb> hmm
[02:54:42] <eddyb> does rust's makefile know about llvm-config?
[02:54:47] <mystor> I'm not sure
[02:55:00] <mystor> I was thinking of cloning rust locally with the build script, and running ./configure
[02:55:09] <mystor> I think there's a _chance_ it will generate the required files
[02:55:11] <mystor> :P
[02:55:17] <eddyb> mystor: it will
[02:55:21] <mystor> yeah
[02:55:23] <eddyb> they're not build products
[02:55:25] <mystor> but I don't want to build
[02:55:30] <mystor> exactly
[02:55:37] <mystor> It just seems super messy
[02:55:41] <eddyb> not really :D
[02:55:48] <mystor> "oh yeah - my crate clones rustc when you build it"
[02:55:52] <eddyb> and you can do it all in bash!
[02:56:04] <mystor> and use `rustc --version` to get the right commit!
[02:56:07] <mystor> :P
[02:56:07] <eddyb> yupp
[02:56:13] <mystor> WOO HACKS
[02:56:23] <eddyb> git clone --depth 1 so you don't download more than you have to
[02:56:32] <mystor> definitely (what about windows...)
[02:56:33] <eddyb> though I think that still doesn't work with submodules
[02:56:52] <mystor> I guess I could do it all from within build.rs?
[02:57:01] <eddyb> libgit2 is a thing
[02:57:09] <mystor> *sigh*
[02:57:13] <eddyb> libgit2-rs I mean
[02:57:18] <eddyb> it has a nice API AFAICT
[02:57:33] <eddyb> mystor: you might be able to trick cargo into downloading it
[02:57:40] <mystor> eddyb: Thats
[02:57:42] <mystor> that's easy
[02:57:46] <mystor> [build-dependency]
[02:57:51] <mystor> and then use the build script
[02:58:20] <eddyb> worst case you generate a Cargo.lock with the right commit hash
[02:59:32] <mystor> yeah
[03:00:04] <mystor> The way I've been doing the thing I'm trying to do was previously by casting a shared pointer to a mutable one - so I guess this is better?
[03:00:19] <mystor> maybe?
[03:00:26] <mystor> *sigh*
[03:00:57] *** Quits: frewsxcv (sid86219@moz-dneii9.brockwell.irccloud.com) (Quit: )
[03:02:49] *** Quits: Tobba (Tobba@moz-o13d22.bredband.telia.com) (Quit: Leaving)
[03:02:56] *** Joins: Tobba (Tobba@moz-o13d22.bredband.telia.com)
[03:22:20] *** Quits: Eridius (kevin@moz-6opvqs.us) (Quit: leaving)
[03:22:23] *** Joins: Eridius (kevin@moz-6opvqs.us)
[03:22:26] <mystor> eddyb: Even with --depth 1 it's super slow :(
[03:31:49] <eddyb> mystor: because the LLVM submodule isn't cloned with --depth 1
[03:32:02] <eddyb> mystor: this bugged me back in the day and I'm not sure it has been fixed since
[03:32:17] <mystor> hmm
[03:32:27] <eddyb> git submodule update --depth 1
[03:32:29] <mystor> If I made rustc a submodule of my crate
[03:32:34] <mystor> would cargo clone it?
[03:32:47] <cmr> mystor: yes.
[03:32:56] <eddyb> cmr: would it use a depth of 1?
[03:33:06] <mystor> nope - cargo uses libgit2
[03:33:10] <mystor> which can't do shallow clones
[03:33:14] <eddyb> great
[03:33:16] <mystor> (I think)
[03:33:31] <eddyb> mystor: yeah, I remember that being the case
[03:33:44] <mystor> https://github.com/rust-lang/cargo/issues/1171
[03:34:41] <mystor> well - the version of llvm which rustc uses is a seperate repo
[03:34:53] <mystor> I think
[03:34:59] <eddyb> rust-lang/llvm
[03:35:17] <eddyb> src/llvm in rust-lang/rust is a submodule to that
[03:35:53] <mystor> so I only need to submodule that
[03:35:57] <mystor> and that hasn't been updated in forever
[03:36:10] <eddyb> you might want the build system, I don't know
[03:36:15] <mystor> wait nvm
[03:36:19] <mystor> (wrong branch)
[03:36:21] <eddyb> there's branches :D
[03:36:34] <eddyb> mystor: a LLVM upgrade is being tested right now, too, AFAIK
[03:37:00] <mystor> well - I'll just have to make a new version of my unstable-api-depending-on crate then
[04:16:19] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[04:20:41] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[04:22:39] *** aatch is now known as help
[04:22:44] *** help is now known as aatch
[04:50:23] *** Quits: bluss (bluss@moz-ec5o68.cust.bredbandsbolaget.se) (Ping timeout: 121 seconds)
[04:59:15] *** Quits: acrichto (acrichto@moz-u3dg2t.sfo1.mozilla.com) (Quit: leaving)
[04:59:55] *** Joins: acrichto (acrichto@moz-u3dg2t.sfo1.mozilla.com)
[04:59:55] *** ChanServ sets mode: +qo acrichto acrichto
[05:12:39] *** Quits: Rym (uid91135@moz-n2i7qm.charlton.irccloud.com) (Quit: Connection closed for inactivity)
[06:03:24] *** Quits: aatch (james@moz-c6etfk.fosn.r6an.e000.2406.IP) (Connection closed)
[07:09:12] *** Joins: laumann (thomas@moz-3m6.3kq.109.2.IP)
[07:13:52] *** Joins: aatch (james@moz-is4j4r.cable.telstraclear.net)
[07:14:36] *** Joins: doener (doener@moz-eku96m.hsi08.unitymediagroup.de)
[08:25:17] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[09:22:33] *** Quits: tekacs (tekacs@moz-q64vt8.com) (Quit: Disappearing... *poof*)
[09:28:42] *** Joins: tekacs (tekacs@moz-q64vt8.com)
[10:17:04] *** Joins: bluss (bluss@moz-ec5o68.cust.bredbandsbolaget.se)
[12:00:17] <doener> *sigh* the debug backtrace testcase is so fragile WRT LLVM applying inlining optimizations
[12:14:27] <eddyb> doener: maybe -C no-prepopulate-passes?
[12:15:07] <eddyb> if you're talking about -C opt-level=0 having issues with optimizations
[12:17:12] <doener> eddyb: it's run-pass/backtrace-debuginfo.rs -- that makes use of #[inline(always)], so no-prepopulate-passes would kill that part of the test
[12:17:35] <eddyb> oh and you added inline(always) to something else?
[12:18:12] <doener> eddyb: no, but I made rustc pass fat pointers as two immediate arguments instead of one indirect one, and that seems to change the inlining behavior
[12:18:38] <doener> eddyb: the file already has a comment about having a certain layout to prevent LLVM from messing up the line info
[12:18:45] <eddyb> hah
[12:25:24] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Quit: Leaving.)
[12:26:10] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[13:32:21] <doener> eddyb: nice, passing fat pointers as two immediates reduces time for llvm passes by about 3-5% and gives smaller binaries :-)
[13:32:36] <doener> eddyb: now I "just" need to clean up the mess that this branch currently is
[13:33:48] <eddyb> :D
[13:34:14] <eddyb> doener: do you set aliasing attributes for the pointer in &mut [T] and &mut Trait?
[13:35:03] <doener> eddyb: I hope so, let me check
[13:37:47] <doener> eddyb: https://gist.github.com/dotdash/cc986cadc549849c79e5
[13:38:31] <eddyb> doener: lovely :D
[13:39:26] <doener> should probably add nonnull on the vtable pointer 
[14:01:01] *** Quits: aatch (james@moz-is4j4r.cable.telstraclear.net) (Ping timeout: 121 seconds)
[15:48:13] *** Joins: globin (globin@moz-isrgf8.de)
[15:50:05] *** Quits: laumann (thomas@moz-3m6.3kq.109.2.IP) (Ping timeout: 121 seconds)
[16:14:10] *** Joins: arielb1 (Ariel@moz-1uf694.red.bezeqint.net)
[16:38:28] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[16:53:08] *** Joins: brson (brson@moz-cfhap5.mtv2.mozilla.com)
[16:53:09] *** ChanServ sets mode: +qo brson brson
[17:46:50] *** Quits: nrc (sid365@moz-3taf2s.0j4i.jtu0.0101.2620.IP) (A TLS packet with unexpected length was received.)
[17:46:51] *** Quits: pnkfelix (sid344@moz-nnnecs.0j4i.jtu0.0101.2620.IP) (Connection closed)
[17:46:51] *** Quits: aturon (sid379@moz-hhfc8n.0j4i.jtu0.0101.2620.IP) (Connection closed)
[17:46:51] *** Quits: nmatsakis (sid381@moz-32a8b5.0j4i.jtu0.0101.2620.IP) (Connection closed)
[17:52:52] *** Quits: geofft (geofft@moz-vfphq1.mit.edu) (Ping timeout: 121 seconds)
[18:01:53] *** Joins: pnkfelix (sid344@moz-nnnecs.0j4i.jtu0.0101.2620.IP)
[18:01:53] *** ChanServ sets mode: +ao pnkfelix pnkfelix
[18:02:27] *** Joins: nrc (sid365@moz-3taf2s.0j4i.jtu0.0101.2620.IP)
[18:02:27] *** ChanServ sets mode: +qo nrc nrc
[18:03:01] *** Joins: nmatsakis (sid381@moz-32a8b5.0j4i.jtu0.0101.2620.IP)
[18:03:14] *** Joins: aturon_ (sid379@moz-hhfc8n.0j4i.jtu0.0101.2620.IP)
[18:03:17] *** Quits: aturon_ (sid379@moz-hhfc8n.0j4i.jtu0.0101.2620.IP) (Quit: )
[18:03:36] *** Joins: aturon_ (sid379@moz-hhfc8n.0j4i.jtu0.0101.2620.IP)
[18:03:38] *** aturon_ is now known as aturon
[18:03:49] *** ChanServ sets mode: +o aturon
[18:34:07] *** Joins: frewsxcv (sid86219@moz-dneii9.brockwell.irccloud.com)
[18:41:47] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[19:23:28] *** Quits: globin (globin@moz-isrgf8.de) (Connection closed)
[20:07:02] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[20:57:09] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[21:09:43] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[23:00:31] *** kimundi is now known as zz_kimundi
[23:00:35] *** zz_kimundi is now known as kimundi
[23:11:13] *** Quits: arielb1 (Ariel@moz-1uf694.red.bezeqint.net) (Quit: Ex-Chat)
[23:21:37] *** Joins: aatch (james@moz-i1k1ks.tlms.2o1v.e006.2406.IP)
[23:30:36] *** Quits: barosl (barosl@moz-tmp.qma.67.220.IP) (Connection closed)
[23:52:02] *** kimundi is now known as zz_kimundi
[23:53:56] *** Joins: barosl (barosl@moz-tmp.qma.67.220.IP)
[23:56:33] *** zz_kimundi is now known as kimundi
