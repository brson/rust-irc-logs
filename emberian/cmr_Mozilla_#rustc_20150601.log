[00:23:26] *** Quits: bluss (bluss@moz-ec5o68.cust.bredbandsbolaget.se) (Ping timeout: 121 seconds)
[01:22:35] *** Quits: whipsch (whipsch@moz-bl4i0b.from.irc.camp) (Ping timeout: 121 seconds)
[01:31:16] *** Joins: whipsch (whipsch@moz-bl4i0b.from.irc.camp)
[01:50:51] *** Joins: c74d3 (c74d3a4ebb6@moz-l85t2q.mggc.hibn.4404.2002.IP)
[01:52:21] *** Quits: c74d (c74d3a4ebb6@moz-0ersgu.oc.cox.net) (Ping timeout: 121 seconds)
[01:52:31] *** c74d3 is now known as c74d
[01:56:34] *** Quits: c74d (c74d3a4ebb6@moz-l85t2q.mggc.hibn.4404.2002.IP) (Connection closed)
[01:56:58] *** Joins: c74d (c74d3a4ebb6@moz-gadv8g.mggc.hibn.4404.2002.IP)
[02:50:46] *** Quits: zz_kimundi (kimundi@moz-rb1gq6.dip0.t-ipconnect.de) (Ping timeout: 121 seconds)
[02:53:03] *** Joins: zz_kimundi (kimundi@moz-pvqpe9.dip0.t-ipconnect.de)
[02:53:04] *** zz_kimundi is now known as kimundi
[03:11:18] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[03:38:12] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[03:42:22] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[04:24:31] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[04:28:46] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[04:34:58] *** Joins: ChrisPls (Mibbit@moz-ou1.3i1.67.138.IP)
[05:10:41] *** Quits: ChrisPls (Mibbit@moz-ou1.3i1.67.138.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[05:18:39] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[05:22:57] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[05:42:46] *** Quits: Tobba (Tobba@moz-o13d22.bredband.telia.com) (Ping timeout: 121 seconds)
[05:51:00] *** Quits: c74d (c74d3a4ebb6@moz-gadv8g.mggc.hibn.4404.2002.IP) (Connection closed)
[05:51:14] *** Joins: c74d (c74d3a4ebb6@moz-0ersgu.oc.cox.net)
[06:12:50] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[06:17:06] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[06:47:38] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[06:49:29] *** Joins: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de)
[06:52:33] *** Quits: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de) (Quit: Bye)
[06:54:30] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[06:54:44] *** Joins: bluss (bluss@moz-ec5o68.cust.bredbandsbolaget.se)
[07:06:58] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[07:11:14] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[07:31:11] *** Quits: aatch (james@moz-is4j4r.cable.telstraclear.net) (Ping timeout: 121 seconds)
[07:39:49] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[07:50:08] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[08:01:06] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[08:05:23] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[08:11:28] *** Joins: acharles (acharles@moz-ulbdcn.ca.comcast.net)
[08:55:16] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[08:59:34] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[09:09:01] *** Joins: eddyb_ (eddyb@moz-9ak.sgj.26.188.IP)
[09:11:48] *** Quits: eddyb (eddyb@moz-ure.pug.25.188.IP) (Ping timeout: 121 seconds)
[09:40:08] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[09:49:28] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[09:53:43] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[10:02:09] *** Joins: aatch (james@moz-is4j4r.cable.telstraclear.net)
[10:20:08] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[10:42:30] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[10:43:47] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[10:47:53] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[11:18:25] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[11:22:53] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[12:05:24] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[12:08:41] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[12:09:34] *** eddyb_ is now known as eddyb
[12:22:40] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[12:23:38] *** Quits: vadimcn (uid46608@moz-0d43u8.highgate.irccloud.com) (Quit: Connection closed for inactivity)
[12:24:37] *** Joins: Tobba (Tobba@moz-6oh.7ki.21.217.IP)
[12:25:05] *** Quits: aatch (james@moz-is4j4r.cable.telstraclear.net) (Ping timeout: 121 seconds)
[12:59:00] *** Quits: Tobba (Tobba@moz-6oh.7ki.21.217.IP) (Ping timeout: 121 seconds)
[14:10:09] *** Joins: Tobba (Tobba@moz-o13d22.bredband.telia.com)
[14:26:30] *** Joins: laumann (thomas@moz-gqpfnm.science.ku.dk)
[14:53:49] *** Joins: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net)
[15:24:50] *** Quits: laumann (thomas@moz-gqpfnm.science.ku.dk) (Ping timeout: 121 seconds)
[15:26:52] *** Joins: laumann (thomas@moz-1f0.hq0.225.130.IP)
[16:04:13] *** Joins: vadimcn (uid46608@moz-0d43u8.highgate.irccloud.com)
[16:27:05] *** Quits: laumann (thomas@moz-1f0.hq0.225.130.IP) (Quit: leaving)
[16:52:34] *** Quits: madmalik (uid13697@moz-lfin5p.brockwell.irccloud.com) (Quit: Connection closed for inactivity)
[17:04:59] *** Joins: brson (brson@moz-cfhap5.mtv2.mozilla.com)
[17:04:59] *** ChanServ sets mode: +qo brson brson
[17:07:46] *** Quits: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net) (Ping timeout: 121 seconds)
[17:08:00] *** Joins: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net)
[18:44:44] *** Quits: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net) (Quit: Ex-Chat)
[18:49:05] *** Joins: eddyb_ (eddyb@moz-e8s.ur8.27.188.IP)
[18:51:52] *** Quits: eddyb (eddyb@moz-9ak.sgj.26.188.IP) (Ping timeout: 121 seconds)
[18:54:18] *** eddyb_ is now known as eddyb
[19:01:51] *** Joins: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de)
[19:18:41] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[19:41:38] *** Joins: nrc (nrc@moz-14pjgj.xtra.co.nz)
[19:41:38] *** ChanServ sets mode: +qo nrc nrc
[19:50:54] <nrc> ping nmatsakis 
[19:55:40] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[19:57:28] <nmatsakis> nrc: poing
[19:57:42] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[20:00:02] <nrc> nmatsakis: hi, I tracked down the linkage problem a bit further - it is due to using the trait mathcing system in trans, in particular common::fulfill_obligation
[20:00:10] <nrc> so, now I have questions
[20:01:39] <nmatsakis> interesting, ok
[20:05:49] <nrc> what is happening is that we use the obligation stuff to get the method origin in meth::trans_method_callee. This works OK in the first compilation unit, but then the answer is cached somewhere and repeated for the second compilation unit, even though the answer is different (because the callee is inlined)
[20:06:48] <nrc> So, questions: how does the id of the inlined callee get *into* trait selection? I don't see anywhere that trans passes inlined ids to traits, and presumably traits can't know about inlined ids before trans has actually done the inlining?
[20:08:04] <nrc> next question is how do I 'localise' that information, which is a bit vague...
[20:08:08] <eddyb> inlining should happen at the end of the pipeline, I would think
[20:08:46] <eddyb> unless you are already in an inlined function and you're globally caching a "local" inlined ID
[20:09:52] <eddyb> nrc: why are inlined functions local to a compilation unit?
[20:10:33] <nmatsakis> nrc: hmm so there is caching at two levels, in principle, but I think in trans that the majority of the caching comes from ccx.trait_cache(), which claims to be "Local"
[20:10:47] <nmatsakis> nrc: ah well
[20:11:05] <eddyb> what's the policy on monomorphizations? are all monomorphizations of a specific function belonging to one compilation unit?
[20:11:09] <nmatsakis> nrc: no there is also a global selection-cache in the tcx
[20:11:22] <nmatsakis> nrc: which is only used when there are no parameters in scope
[20:11:26] <nmatsakis> nrc: but of course that applies here
[20:11:40] <nmatsakis> nrc: (there is also a cache in the parameter environment, but that is created fresh each time through)
[20:11:59] <nmatsakis> nrc: the cache on the parameter environment is used during type-checking in cases where there are generics in scope etc that would affect the result
[20:12:10] <nmatsakis> nrc: but that doesn't quite answer your question yet :)
[20:12:40] <nmatsakis> nrc: as you say I don't know how the id flows in yet
[20:13:50] <nmatsakis> nrc: what is the callee in this case, a closure type?
[20:14:13] <nrc> nmatsakis: yes
[20:15:00] <nmatsakis> nrc: hmm. ok, so, in that case, the trait code gives back a def-id of the closure (and some substs) 
[20:15:10] <nmatsakis> which it obtains from the self-type that is provided as input
[20:15:38] <nmatsakis> can you spell out the self-types in question a bit more?
[20:17:35] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Quit: leaving)
[20:18:14] *** Joins: doener (doener@moz-929cn9.unity-media.net)
[20:21:30] <nrc> nmatsakis: we're down the MethodTypeParam path, so we don't look at the type of the receiver at all, the trait ref is
[20:21:31] <nrc> Binder(<[closure((usize, <core::iter::Map<core::slice::Iter<&'static str>, [closure((&&str,)) -> usize]> as core::iter::Iterator>::Item)) -> usize] as core::ops::FnMut<(usize, usize)>>)
[20:21:41] <nrc> is that what you want?
[20:21:59] <nmatsakis> nrc: yes, though I guess the pretty printer is hiding the closure def-id info 
[20:22:49] <nmatsakis> nrc: basically I'm a bit surprised because I expect that the two closures being selected upon would be different
[20:24:20] <nrc> the ids of the closures are different, that is, we pass in method_call which has expr_id which is different in the two cases
[20:24:46] <nrc> but that isn't an input to fulfill_obligation
[20:24:52] <nrc> we only pass in the trait ref
[20:25:09] <nrc> let me get the def_ids, one sec...
[20:27:14] <nmatsakis> nrc: right, so I'd expect the trait-ref to be changed to match, perhaps that's the problem
[20:27:20] <nmatsakis> nrc: we're not rewriting the id in that case properly
[20:27:31] <nmatsakis> seems pretty plausible
[20:27:53] <nmatsakis> closure def-ids in this case are kind of a special case
[20:28:05] <nmatsakis> normally we wouldn't rewrite a def-id in this way (e.g. for a struct/enum etc)
[20:28:11] <nmatsakis> annoying
[20:30:40] <nmatsakis> nrc: hmm it seems like we do TRY to convert closure def-ids, if you look at astencode.rs in rustc/middle and search for "CLOSURE_SOURCE"
[20:32:01] <nmatsakis> nrc: (which is called from tydecode.rs when convering a closure-type)
[20:32:24] <nmatsakis> er, search for ClosureSource, not CLOSURE_SOURCE
[20:33:20] <nrc> confirmed - same trait def ids
[20:33:26] <nrc> - the non-inlined ones
[20:34:42] <nrc> fn convert_def_id is certainly named like it should do something like that :-p
[20:37:43] <nrc> that looks like it is used to convert the closure ids, but not the trait ids
[20:39:07] <nmatsakis> nrc: sorry, the *trait* def-ids should be the same?
[20:39:14] <nmatsakis> nrc: if by that you mean the references to `FnMut` etc
[20:39:20] <nmatsakis> nrc: after all, it's the same FnMut in both cases
[20:39:36] <nmatsakis> but I expect the closure ids to be different
[20:39:41] * nmatsakis ponders
[20:41:05] <nrc> but the closure ids aren't used as input to fulfill_obligation
[20:41:29] <nrc> I don't know which trait ids are being used there, I guess it must be the Fn traits
[20:42:15] <nrc> yes, they are coming from libcore, so must be
[20:43:04] <nmatsakis> nrc: the closure def-ids are embedded in the self-type
[20:43:11] <nmatsakis> in that print-out, it says
[20:43:14] <nmatsakis> "closure(...)"
[20:43:16] <nmatsakis> which is hiding it
[20:43:23] <nmatsakis> but associated with that closure is a def-id
[20:43:32] <nrc> that is part of the substs?
[20:43:34] <nmatsakis> it might be worthwhile to augment ppaux.rs to stop hiding it
[20:43:37] <nmatsakis> no, it's not part of the substs
[20:43:41] <nmatsakis> ty_closure(def_id, substs)
[20:43:52] <nmatsakis> basically if you think of the desugaring
[20:43:56] <nmatsakis> there is some ananonymous struct
[20:44:04] <nmatsakis> the def_id is sort of conceptually the def_id of that struct
[20:44:09] <nmatsakis> though it is also the expr id
[20:44:42] <nmatsakis> it might worth modifying ppaux.rs
[20:44:50] <nmatsakis> so thaat it includef-id
[20:44:53] <nmatsakis> argh
[20:44:55] <nmatsakis> includhe def-id
[20:44:58] <nmatsakis> stupid bluetooth kb
[20:45:01] <nmatsakis> includes the def-id!
[20:45:08] <nrc> right, but in the trait_def, the self type is part of the substs as opposed to referenced by the def_id?
[20:45:24] <nmatsakis> oh, yes
[20:45:29] <nmatsakis> in the traitref, the self-type is part of the substs
[20:45:46] <nmatsakis> the def-id there refers to the trait (`FnMut`, here)
[20:46:44] <nrc> right
[20:53:06] <nrc> It looks like we intern the decoded def ids once per crate rather than per compilation unit, which presumably is why we get the wrong ids for the inlined closures
[21:07:52] *** Quits: flaper87 (flaper87@moz-fnn.1e9.132.209.IP) (Ping timeout: 121 seconds)
[21:10:59] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[21:11:02] *** Joins: flaper87 (flaper87@moz-fnn.1e9.132.209.IP)
[21:18:04] *** Quits: flaper87 (flaper87@moz-fnn.1e9.132.209.IP) (Ping timeout: 121 seconds)
[21:23:19] *** Joins: flaper87 (flaper87@moz-fnn.1e9.132.209.IP)
[21:34:14] *** Quits: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de) (Quit: Bye)
[21:37:50] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[21:42:04] *** Quits: Rym (y@moz-mhu.sd4.38.217.IP) (Ping timeout: 121 seconds)
[22:14:58] *** Joins: Rym (y@moz-mhu.sd4.38.217.IP)
[23:19:38] *** Joins: aatch (james@moz-5r41gb.6pd7.20lj.e000.2406.IP)
[23:31:42] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[23:58:33] *** Quits: eddyb (eddyb@moz-e8s.ur8.27.188.IP) (Ping timeout: 121 seconds)
