[00:19:06] *** Joins: bombless (_@moz-1j8.piv.41.59.IP)
[00:21:44] *** Joins: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de)
[00:22:00] *** Quits: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de) (Quit: Bye)
[00:33:57] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[01:10:15] *** Quits: c74d (c74d3a4ebb6@moz-0ersgu.oc.cox.net) (Connection closed)
[01:11:18] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[01:29:39] *** Joins: c74d (c74d3a4ebb6@moz-0ersgu.oc.cox.net)
[01:53:44] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[02:50:07] *** Joins: kimundi_ (kimundi@moz-rb1gq6.dip0.t-ipconnect.de)
[02:52:34] *** Quits: kimundi (kimundi@moz-pu1phi.dip0.t-ipconnect.de) (Ping timeout: 121 seconds)
[02:52:34] *** kimundi_ is now known as kimundi
[04:25:05] *** Joins: aatch (james@moz-is4j4r.cable.telstraclear.net)
[04:41:27] *** Quits: bombless (_@moz-1j8.piv.41.59.IP) (Ping timeout: 121 seconds)
[04:46:39] *** Parts: ChrisPls (Mibbit@moz-ou1.3i1.67.138.IP) ()
[07:43:05] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Connection closed)
[09:22:28] *** Joins: sigma (sigma@moz-k1ghg8.range109-153.btcentralplus.com)
[09:56:34] *** Joins: laumann (thomas@moz-3v9.hq0.225.130.IP)
[09:56:40] *** Quits: laumann (thomas@moz-3v9.hq0.225.130.IP) (Quit: leaving)
[10:41:08] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[10:54:49] *** Joins: Tobba (Tobba@moz-o13d22.bredband.telia.com)
[12:07:31] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[12:54:30] *** Joins: ncarrillo (textual@moz-mke7jn.cable.rcn.com)
[13:07:39] *** Joins: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de)
[13:17:12] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[13:21:40] *** Quits: ncarrillo (textual@moz-mke7jn.cable.rcn.com) (Quit: My Mac has gone to sleep. ZZZzzz…)
[13:38:05] *** Quits: aatch (james@moz-is4j4r.cable.telstraclear.net) (Ping timeout: 121 seconds)
[14:37:53] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[16:26:59] *** Quits: blank_name (blank_name@moz-1gd.aq8.36.50.IP) (Ping timeout: 121 seconds)
[16:28:00] *** Joins: blank_name (blank_name@moz-b1omh3.mi.frontiernet.net)
[16:57:58] *** Joins: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net)
[17:54:28] *** Joins: ncarrillo (textual@moz-mke7jn.cable.rcn.com)
[17:56:41] *** Quits: ncarrillo (textual@moz-mke7jn.cable.rcn.com) (Quit: My Mac has gone to sleep. ZZZzzz…)
[18:01:03] *** Joins: ncarrillo (textual@moz-mke7jn.cable.rcn.com)
[18:02:06] <simukis> what are examples of TT and non-TT style macroses?
[18:02:43] <eddyb> simukis: what do you mean?
[18:03:25] <eddyb> TT just means "token tree", the (token | delimited sequnce of tokens) primitives that all macros work with
[18:04:14] <simukis> eddyb: expansion code refers to expanding TT macros
[18:04:20] <simukis> which must mean there’s non-TT macros, right?
[18:04:54] <eddyb> are you talking about comments? those can be very old
[18:05:15] <simukis> oh ok
[18:05:21] <simukis> so we only have TT macroses now, right?
[18:05:53] <eddyb> simukis: out of context "TT macros" means nothing to me
[18:06:00] <eddyb> do you have an actual location in the code?
[18:06:05] <simukis> I will try to find the comment in question again
[18:06:12] <eddyb> I can't find anything like that in ext::expand
[18:09:52] <simukis> doc-comment for syntax::ast::TokenTree refers to “MBE macro”. Does this ThreeLetterAcronym mean anything special?
[18:10:45] <eddyb> macro-by-example
[18:11:02] <simukis> otherwise, sorry, I can’t seem to find the comment which made me think there might be non-tt macroses
[18:11:03] <eddyb> yes, MBE macro is redundant
[18:11:25] <eddyb> simukis: macroses? isn't the plural macros?
[18:11:31] * simukis shrugs
[18:11:44] <simukis> double plural lol
[18:12:05] <eddyb> makes me think "hobbitses"
[18:14:03] <arielb1> eddyb: ping
[18:14:06] <arielb1> gh25916
[18:15:37] <eddyb> arielb1: so I was looking into that
[18:15:48] <eddyb> arielb1: `select_new_obligations` is for something else
[18:15:52] <eddyb> that's new *obligations*
[18:16:01] <eddyb> we care about new *inference information*
[18:16:37] <eddyb> like unifications since the last select_where_possible call
[18:16:51] <arielb1> so check_binop tries to resolve typevars too aggressively
[18:16:57] <eddyb> it's not alone
[18:17:19] <eddyb> arielb1: I think I know how to do it, by tracking the mutations of each SnapshotVec used by InferCtxt
[18:17:20] <arielb1> resolve_type_vars_if_possible can have O(n) worstcase
[18:17:35] <eddyb> mutations, but not additions
[18:17:56] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[18:17:56] <arielb1> it tries to discover new type information too hard
[18:18:02] <eddyb> and it increases over time, rolling back snapshots not causing it to go down
[18:18:32] <arielb1> eddyb: resolve_type_variables_if_possible is intended for where failure would cause compilation failure
[18:18:59] <arielb1> with arithmetic operations
[18:19:07] <arielb1> you have an unconstrained impl
[18:19:10] <eddyb> I *hope* there's no mutations (i.e. .set calls) during short-lived snapshots, because that would cause issues. hmm. maybe I do need to roll back mutations
[18:19:13] <arielb1> so it tries *very hard* to make it constrained
[18:19:23] <arielb1> but it can't
[18:19:29] <arielb1> and eventually fallback makes it constrained
[18:19:34] <eddyb> arielb1: that's a smart solution, though
[18:19:42] <eddyb> changing something binop-specific, I mean
[18:19:52] <eddyb> I want to try a dumb solution for the general case
[18:20:06] <arielb1> eddyb: that's the reason it is O(n^2)
[18:20:29] <arielb1> you are generally not supposed to end up in the slowpath of resolve_type_vars_if_possible
[18:20:52] <eddyb> so, what, special-case integer and flaot inference variables?
[18:21:05] <arielb1> also, its the wrong call
[18:21:13] <arielb1> we only need structurally_resolved_type here
[18:21:19] <arielb1> or shallow_resolve
[18:21:37] <arielb1> actually, we are okay with resolving to a float/int var
[18:21:53] <arielb1> shallow_resolve would also try to resolve the float/int var to an actual type
[18:22:40] *** Quits: blank_name (blank_name@moz-b1omh3.mi.frontiernet.net) (Ping timeout: 121 seconds)
[18:23:03] <arielb1> also, structurally_resolve_type should do a shallow resolve
[18:23:30] <arielb1> and, I think, allow intvars
[18:23:44] <arielb1> but that would require fixing some places to accept it
[18:25:50] <arielb1> it *would* also help if select_where_possible checked that we made progress on an obligation
[18:28:15] <arielb1> but there are several ways to make progress
[18:30:16] <eddyb> ugh, region inference has its own stuff
[18:30:25] <arielb1> eddyb: why is that relevant?
[18:30:40] <arielb1> region inference runs *after* integer fallback
[18:31:04] <arielb1> *after* all ty_infer are gone
[18:36:34] <arielb1> eddyb: could you provide a callgrind through?
[18:36:51] <arielb1> how do we end in commit_if_ok?
[18:39:10] <eddyb> arielb1: that's the call stack
[18:39:34] <eddyb> arielb1: from linear to quadratic
[18:39:59] <eddyb> arielb1: there's nothing recorded in between traits::FulfillmentContext::select and infer::InferCtxt::commit_if_ok
[18:40:02] <arielb1> these million lookups should go via the cache
[18:40:02] <arielb1> shouldn't be *that* slow
[18:40:02] <arielb1> maybe we should make freshen not allocate
[18:40:16] <arielb1> eddyb: could you use debuginfo?
[18:40:23] <eddyb> yeah, the slowdown is actually caused by allocation churn
[18:40:46] <arielb1> eddyb: but freshen on IntVar shouldn't really allocate anything
[18:41:09] <eddyb> arielb1: not without a new build. if someone already has a build with debuginfo, they can run callgrind themselves pretty easily
[18:41:20] <arielb1> I have a build with debuginfo
[18:41:22] <arielb1> but its broken
[18:41:26] <arielb1> I am rebuilding it
[18:41:48] <eddyb> my own build will have the first version of the hack
[18:41:59] <eddyb> tracking the number of mutations
[18:42:18] <eddyb> the path compression in type_variables worries me that it's going to add up to the number of mutations
[18:42:23] <arielb1> eddyb: mutations of what?
[18:42:42] <arielb1> eddyb: the problem with these selects is that *they are not making progress*
[18:43:12] <eddyb> yes, so InferCtxt should stay at a stable number of mutations
[18:43:18] <arielb1> I don't think there are mutations of type_variables
[18:43:27] <eddyb> hopefully
[18:44:06] <arielb1> not O(n^2) of them
[18:44:07] <arielb1> actually
[18:44:07] <arielb1> well
[18:47:12] <arielb1> I would like to allocate the junk freshen generates into a type-arena
[18:47:17] <arielb1> *into a junk arena
[18:47:33] <eddyb> yeah, that would be nice
[18:47:46] <eddyb> each function should have its own "local type arena" but that's another issue entirely
[18:47:49] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[18:48:03] <eddyb> (it would've been done already if it wouldn't make a complete mess out of everything)
[18:48:08] <arielb1> eddyb: but we don't have find_equiv
[18:48:15] *** Quits: sigma (sigma@moz-k1ghg8.range109-153.btcentralplus.com) (Ping timeout: 121 seconds)
[18:48:19] <eddyb> arielb1: huh?
[18:48:26] <arielb1> and I think Ty is invariant
[18:48:30] <eddyb> we have the new fancy borrow stuff
[18:48:36] <eddyb> ah, you mean that
[18:48:36] <arielb1> eddyb: its bad
[18:48:58] <eddyb> it already works kind of fine
[18:49:11] <arielb1> except you can't index
[18:49:13] <arielb1> (Vec<T>, Vec<T>)
[18:49:15] <arielb1> with (&T, &T)
[18:49:16] <eddyb> when inserting, we lookup with a sty on the stack
[18:49:38] <arielb1> eddyb: but its a Ty<'tcx>
[18:49:59] <eddyb> it shouldn't be invariant, if it is, it's Vec's fault
[18:50:03] <arielb1> we intern its contents
[18:50:03] <arielb1> bad
[18:50:03] *** Joins: blank_name (blank_name@moz-tq3.7iq.183.192.IP)
[18:50:07] <eddyb> ah, yeah, I wanted to switch to interned slices
[18:50:41] <eddyb> but that's tricky because Substs code is super inefficient
[18:50:45] <eddyb> and doesn't use iterators
[18:50:58] <eddyb> pretty much everything working with Substs calls push
[18:51:08] <eddyb> it's a nightmare
[18:51:52] <arielb1> can you even index a HashMap<Ty<'tcx>> with Ty<'a>?
[18:51:59] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[18:52:13] <eddyb> arielb1: so there's a reason you can't split ty::ctxt nicely, and it's accessing "global fields". in repr, of all places
[18:52:25] <eddyb> and repr usage bubbles up through subst calls, all over the plce
[18:52:35] <eddyb> arielb1: that's a very good question
[18:52:45] <eddyb> and I don't really know
[18:52:52] <arielb1> eddyb: the only thing that calls Substs and is on a critical-y path is subst
[18:52:52] <arielb1> i.e. super_fold_substs
[18:53:31] <eddyb> Substs-building code being inefficient means it's also hard to make it intern slices instead of vectors
[18:53:34] <arielb1> which *does not* call push
[18:53:36] <arielb1> it's mostly astconv that likes pushing to substs
[18:54:00] <eddyb> yeah
[18:54:13] <eddyb> do we have ExactSize yet? I really want it for this
[18:55:03] <arielb1> and astconv can basically be as slow as it likes
[18:55:35] <eddyb> Repr infecting everything with dependencies on all sorts of global maps could be solved through custom scoped TLS (which nmatsakis was saying a lot, but I never understood. mainly because the API in libstd would be unusable)
[18:56:50] <eddyb> so you have a pointer to the tcx, in TLS and you access it by doing GLOBAL_TCX.with(|tcx| ...) and the tcx you get has only anonymous lifetimes
[18:57:04] <eddyb> except, you know, it's actually invariant, so that would be unsafe
[18:57:41] <eddyb> might be able to split it into a safe TLS subset used by printing and whatnot
[18:57:57] <eddyb> and the lifetime'd rest, per-function if possibl
[18:58:00] <eddyb> *possible
[18:58:23] <arielb1> eddyb: you could intern when you mk_substs
[18:58:59] <eddyb> the problem is that you don't want the temporary vector
[18:59:08] <arielb1> eddyb: why?
[18:59:11] <arielb1> it is only in astconv
[18:59:18] <eddyb> IIRC it's not
[18:59:20] <arielb1> give it a OldSubsts
[18:59:32] *** Quits: ncarrillo (textual@moz-mke7jn.cable.rcn.com) (Quit: My Mac has gone to sleep. ZZZzzz…)
[18:59:38] <arielb1> or an IncrementalSubsts or something
[18:59:44] <eddyb> there was something in middle::ty building Substs
[18:59:53] <arielb1> eddyb: typeck::check also creates it in its astconv-y parts
[18:59:55] <eddyb> or maybe I'm mis-remembering
[19:00:31] <arielb1> eddyb: couldn't find any call to push in ty.rs
[19:00:34] <arielb1> any relevant call
[19:00:44] <eddyb> oh, not `push`
[19:00:59] <eddyb> I meant Vec::push, called indirectly through the Substs API
[19:01:08] <eddyb> and even insert
[19:01:20] <arielb1> eddyb: there's Self insertion
[19:01:23] <arielb1> probably that
[19:01:33] <eddyb> IIRC middle::traits was doing some of it
[19:01:33] <arielb1> it does an insert
[19:01:42] <arielb1> probably Self insertion then
[19:01:47] <eddyb> no, not *just* that
[19:01:53] <eddyb> calling push or insert in a loop
[19:02:02] *** Quits: blank_name (blank_name@moz-tq3.7iq.183.192.IP) (Ping timeout: 121 seconds)
[19:02:18] <eddyb> time to see if my change did anything good
[19:02:23] <arielb1> I can't see why middle::traits would play with substs
[19:02:54] <arielb1> if you could find it
[19:02:54] <eddyb> that was a few months ago, though
[19:02:55] <arielb1> great
[19:05:33] <eddyb> it doesn't speed up libcore typeck
[19:05:44] <arielb1> eddyb: what's your change?
[19:06:15] <eddyb> tracking a "mutation count" in SnapshotVec and querying it from InferCtxt
[19:06:28] <eddyb> bypassing select_where_possible if it's unchanged
[19:07:01] <arielb1> the commit_if_ok comes from PolyProjectAndUnifyType
[19:07:10] <arielb1> that's poly_project_and_unify_type
[19:07:40] <eddyb> oh, yeah, there was something about projects in the callgrind stuff, further down
[19:07:56] <eddyb> mixed in with allocations, jemalloc internal mutexes, hashtable stuff
[19:09:22] <arielb1> on my callgrind it comes first
[19:09:52] <arielb1> I mean, first after you take out the parents of select_where_possible
[19:09:54] <eddyb> are you looking at what calls what?
[19:10:30] <eddyb> well, crap, I didn't fix anything
[19:11:01] <eddyb> I can try to ignore certain things and see what happens
[19:14:53] <arielb1> hey, projection doesn't have a selection cache
[19:15:14] <arielb1> whatever
[19:15:18] <arielb1> it actually works differently
[19:31:08] <eddyb> arielb1: my thing has an impact alright
[19:31:09] <eddyb>  error: the type of this value must be known in this context
[19:31:27] <eddyb> 86 errors in libcore if I ignore updates to type_variables
[19:33:51] <eddyb> so that was a waste of time
[19:34:33] <eddyb> unless it's path compression I'm hitting and I can eliminate that... maybe
[19:41:54] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[19:46:08] *** Quits: Rym (y@moz-c2u.sd4.38.217.IP) (Ping timeout: 121 seconds)
[20:04:38] *** Joins: Rym (y@moz-c2u.sd4.38.217.IP)
[20:25:12] *** Joins: iu (iu@moz-6263qv.cc.cmu.edu)
[20:39:47] <arielb1> eddyb: I guess you did it too aggressively
[21:01:34] <eddyb> arielb1: to get the error? yeah, I ignored type_variables entirely
[21:04:47] <arielb1> eddyb: I would prefer to ask nmatsakis to do that
[21:04:53] <arielb1> that kind of work
[21:04:59] <arielb1> you could break stuff very easily
[21:05:07] <arielb1> and subtly
[21:05:24] <eddyb> yeah, I don't know why I even try
[21:05:46] <eddyb> I do stupid things to forget the imminent exams
[21:05:54] <arielb1> imminent?
[21:06:54] <eddyb> wait, that might not be a word in English
[21:07:25] <eddyb> no, it is
[21:09:49] <eddyb> arielb1: impending doom
[21:10:06] <arielb1> I mean, the exam are a month from now
[21:11:30] <eddyb> more like 3 weeks. how do you know?
[21:11:54] <eddyb> I do start the more boring stuff next week
[21:12:09] <eddyb> and 3 weeks is not enough to get ready at all
[21:12:16] <arielb1> University exams are always late June-early July
[21:12:26] <arielb1> I mean, these that are not at January-February
[21:12:52] <eddyb> arielb1: where, in US?
[21:12:56] <arielb1> in US
[21:12:57] <arielb1> in IL
[21:13:10] <eddyb> I am not in US and I'm not in uni
[21:13:33] <arielb1> these are high-school exams then?
[21:13:44] <arielb1> just before June 20?
[21:13:45] <eddyb> maybe if there was something to compare it to, it would be SAT. but that doesn't seem to be this hard
[21:13:59] <eddyb> arielb1: post-highschool-graduation exams
[21:14:18] <eddyb> it's a blocker for going to any kind of higher-level education
[21:14:54] <eddyb> and then, if I'm lucky to pass those, I'll have an (easier, because it's just math+CS) exam for uni admission
[21:15:23] <arielb1> the RO version of SAT?
[21:15:38] <eddyb> maybe. I'd have to research SAT
[21:16:34] <arielb1> I mean, are these the standard high-time-pressure lots-of-questions exams?
[21:17:15] <eddyb> well, this is nice, but not what I'm looking for https://en.wikipedia.org/wiki/Boolean_satisfiability_problem
[21:17:19] <eddyb> arielb1: not exactly
[21:17:37] <eddyb> arielb1: https://en.wikipedia.org/wiki/Baccalaur%C3%A9at
[21:18:19] <eddyb> thankfully we copied it from the French so it's on wikipedia :D
[21:18:33] <arielb1> that's a different kind of exams
[21:18:49] <arielb1> we have these in IL too
[21:19:30] <arielb1> just they are spread through the year
[21:21:33] <arielb1> and we also have a SAT-style exam
[21:22:59] <eddyb> ugh, I wanted to work on ARTs, not fool around with unlikely solutions to this regression
[21:23:40] <arielb1> ART?
[21:24:33] <eddyb> anonymized return types
[21:24:54] <eddyb> it should be easy for free functions (and non-trait methods)
[21:25:16] <eddyb> in traits you need to pretend that each `impl Trait` type is an associated type and deal with those shennanigans
[21:28:40] <eddyb> and you can't do that with the current name-based projection scheme, so it will have to switch to DefIds
[21:30:30] *** Quits: killercup (killercup@moz-723bo4.dip0.t-ipconnect.de) (Ping timeout: 121 seconds)
[21:32:51] <arielb1> eddyb: you can't inflate sty
[21:33:11] <arielb1> please make it a TraitItemId if you play with this
[21:42:43] <eddyb> it shouldn't inflate sty
[21:43:25] <eddyb> it's pretty easy to handle cross-crate (read: no metadata code) if there's no side-table for the trait list
[21:45:06] <eddyb> but, I don't know... there's also the issue of making ty_trait hold a sorted set/list of traits
[21:55:00] *** Joins: aatch (james@moz-is4j4r.cable.telstraclear.net)
[22:09:59] <eddyb> arielb1: btw, the mutation tracking thing really didn't pan out, even after ignoring the stuff type_variables does behind the scenes. there's new information being added into the system as each expression gets type-checked, even if it's irrelevant for resolving those variables
[22:10:59] <eddyb> tracking ranges of inference variable indexes for certain things might work, but it's already too much for me
[22:44:36] *** Quits: iu (iu@moz-6263qv.cc.cmu.edu) (Quit: )
[22:55:08] *** Joins: bluss (bluss@moz-ec5o68.cust.bredbandsbolaget.se)
[23:06:42] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[23:22:14] *** Quits: arielb1 (Ariel@moz-9he9ta.red.bezeqint.net) (Quit: Ex-Chat)
[23:39:48] *** Joins: blank_name (blank_name@moz-j00b3g.mi.frontiernet.net)
[23:40:42] *** kimundi is now known as zz_kimundi
