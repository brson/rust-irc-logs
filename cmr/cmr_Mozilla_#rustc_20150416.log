[02:07:58] *** Quits: Sergio (Sergio@moz-23roph.bz) (Ping timeout: 121 seconds)
[02:37:08] *** Quits: zz_kimundi (kimundi@moz-nr28ki.dip0.t-ipconnect.de) (Ping timeout: 121 seconds)
[02:38:08] *** Joins: zz_kimundi (kimundi@moz-6dpcih.dip0.t-ipconnect.de)
[02:38:10] *** zz_kimundi is now known as kimundi
[02:43:21] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Ping timeout: 121 seconds)
[02:45:46] *** Joins: Unwound_ (bkoropoff@moz-kthi5c.wa.comcast.net)
[02:45:54] *** Unwound_ is now known as unwound
[02:47:43] *** Joins: Sergio (Sergio@moz-23roph.bz)
[03:10:48] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[03:11:49] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Connection closed)
[03:43:43] *** Joins: Unwound_ (bkoropoff@moz-kthi5c.wa.comcast.net)
[03:47:21] *** Quits: unwound (bkoropoff@moz-kthi5c.wa.comcast.net) (Ping timeout: 121 seconds)
[04:00:24] *** Quits: Sergio (Sergio@moz-23roph.bz) (Ping timeout: 121 seconds)
[04:04:59] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[04:05:35] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Connection closed)
[04:10:13] *** Unwound_ is now known as unwound
[04:10:50] *** Joins: Sergio (Sergio@moz-23roph.bz)
[04:59:06] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[05:00:05] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Connection closed)
[05:53:16] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[05:57:32] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Ping timeout: 121 seconds)
[06:04:11] *** Quits: unwound (bkoropoff@moz-kthi5c.wa.comcast.net) (Quit: Ex-Chat)
[06:13:11] *** Quits: LinuxBunny (Retep998@moz-r1n9v0.east.verizon.net) (Ping timeout: 121 seconds)
[06:13:46] *** Joins: LinuxBunny (Retep998@moz-r1n9v0.east.verizon.net)
[06:37:59] *** Quits: acharles (acharles@moz-ulbdcn.ca.comcast.net) (Client exited)
[06:46:04] *** Quits: sigma (sigma@moz-ohog4c.range86-135.btcentralplus.com) (Ping timeout: 121 seconds)
[06:47:25] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[06:48:23] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Connection closed)
[06:50:05] *** Joins: sigma (sigma@moz-ohog4c.range86-135.btcentralplus.com)
[06:55:44] *** Joins: p1start (p1start@moz-nftjhe.org)
[07:01:21] *** Joins: laumann (thomas@moz-3v9.hq0.225.130.IP)
[07:03:39] *** Quits: sigma (sigma@moz-ohog4c.range86-135.btcentralplus.com) (Ping timeout: 121 seconds)
[07:26:37] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[07:41:36] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[07:42:48] <nrc> does trans insert SIGTRAP calls into bad dtors?
[07:45:14] <nrc> apparently I am failing the check for a sane drop flag
[07:45:51] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Ping timeout: 121 seconds)
[07:45:52] <nrc> I expect my sanity won't be far behind in terms of failing
[08:35:44] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[08:40:00] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Ping timeout: 121 seconds)
[08:59:16] *** Joins: pnkfelix (pnkfelix@moz-6v5.3nd.202.89.IP)
[08:59:16] *** ChanServ sets mode: +o pnkfelix
[09:05:58] <nrc> pnkfelix: ping
[09:06:06] <pnkfelix> nrc: pong
[09:06:16] <nrc> pnkfelix: hi, I need help with drop flags
[09:06:29] <nrc> let me pastebin something, one sec
[09:06:57] <nrc> https://pastebin.mozilla.org/8830288
[09:07:11] <nrc> this is a simplified version of Rc<DST>
[09:07:36] <nrc> when g goes out scope I get the SIGTRAP indicating a bad drop flag
[09:07:58] <nrc> i.e., drop glue thinks g should have a drop flag, but it doesn't
[09:08:13] <nrc> if I understand correctly
[09:08:23] <nrc> or perhaps the drop flag has been corrupted some how?
[09:08:29] <pnkfelix> hmm, its possible i was over-zealous in the number of places I inserted that check
[09:08:33] <pnkfelix> let me see
[09:08:52] <nrc> Note that Bar is a sized type and all its fields are sized
[09:09:01] <nrc> but that Foo<[T]> us unsized
[09:09:38] <pnkfelix> nrc: and when you remove the `let g ...` line, it works?
[09:09:55] <nrc> what is odd, is that I am dumping the adt treatment of Bar and it is adding a drop flag to the list of fields
[09:10:07] <nrc> yes, removing that line, its all fine (including with Valgrind)
[09:10:24] <pnkfelix> so `Bar<T>` itself should indeed have a drop-flag
[09:10:31] <pnkfelix> since, as you point out, it is sized
[09:10:57] <nrc> right
[09:11:02] <pnkfelix> and if I understand what you are saying, it *sounds* like the drop-flag check is complaining about the drop-flag for `g` being corrupted
[09:11:17] <nrc> yes
[09:11:22] <nrc> that is my understanding
[09:11:23] <pnkfelix> nrc:  I can show you where it trans those checks are inseretd
[09:11:26] <pnkfelix> *in trans
[09:11:37] <nrc> I can see them in trans
[09:11:43] <nrc> in glue
[09:11:45] <nrc> .rs
[09:11:45] <pnkfelix> nrc: though I suppose the important thing is to figure out whether the drop flag really is getting corrupted
[09:12:14] <pnkfelix> nrc: Have you run under a debugger yet and inspected what the actual value is thre, maybe set a hardware breakpoint at that address at teh outset?
[09:12:27] <nrc> I wonder if the flag is corrupted or if the check is bogus in some way
[09:12:32] <pnkfelix> nrc: (to track how that mmemory is initialized and updated)
[09:12:43] <nrc> yeah, that is a good idea
[09:13:24] <pnkfelix> nrc: so, stupid question (I haven't kept up with the RFCs), what is the meaning of CoerceUnsized for Bar there ?
[09:13:37] <pnkfelix> nrc: its making Bar a smart-pointer that can hold unsized things?
[09:13:45] <nrc> It means that the let g = line is valud
[09:13:50] <nrc> *valid
[09:14:00] <pnkfelix> nrc: yeah I see, coercing its contents
[09:14:01] <nrc> i.e., it allows it to act as a smart pointer wrt coercions
[09:14:11] <pnkfelix> nrc: I bet it is indeed something where the drop flag is getting corrupted
[09:14:18] <pnkfelix> nrc: that or the check is looking at the wrong place
[09:14:26] <nrc> holding the unsized things is just a property of T: ?Sized
[09:14:31] <pnkfelix> nrc: e.g. maybe its looking at the extra-field of the fat ptr
[09:14:36] <pnkfelix> nrc: rather than the actual drop flag
[09:14:48] <pnkfelix> nrc: so I'd definitely try under a debugger
[09:14:57] <nrc> that makes sense as a hypothesis
[09:15:18] <pnkfelix> nrc: I assume CoerceUnsized is only in your own branch ?
[09:15:27] <nrc> I've just noticed that in the ir we are using the concrete type when passing to the dtor
[09:15:30] <nrc> that seems wrong
[09:15:36] <nrc> pnkfelix: that is correct
[09:15:57] <pnkfelix> nrc: okay. Just worried how nervous I should get in reaction to this example.  :)
[09:16:27] <pnkfelix> nrc: oh another idea
[09:16:30] <nrc> oh no, my bad, type in the ir is correct
[09:16:37] <pnkfelix> nrc: that might be quicker than running under a debugger
[09:16:49] <pnkfelix> nrc: try adding an extra field after `x` in `Bar`
[09:17:57] <pnkfelix> nrc: and/or coerce `&g` to a `*const u8` and print out all of its bytes at the end of the scope
[09:18:53] <pnkfelix> (adding an extra field would be a way to get more control over what data is being put at the end of the struct, before the drop flag itself.  This is assuming we can control the struct field ordering; you might need to do repr(C) or something too...)
[09:19:10] <nrc> what size is the drop flag?
[09:19:11] <pnkfelix> These are not meant to be actual fixes for the internal bug here, of course
[09:19:16] <nrc> sure
[09:19:22] <pnkfelix> the drop flag is a u8
[09:23:26] <nrc> I am slightly weirded out by the result of doing this
[09:24:09] <pnkfelix> you tried making the modifications?  are they up at the same pastebin?
[09:24:20] <nrc> there is 127 in the most significant byte of the length of the array in teh fat pointer
[09:24:30] <nrc> that is weird
[09:24:34] <nrc> the drop flag is 0
[09:24:47] <pnkfelix> drop flag shouldn't be 0
[09:24:48] <nrc> I added
[09:24:51] <nrc>     unsafe {
[09:24:52] <nrc>         let gg: *const _ = &g;
[09:24:54] <nrc>         let p = gg as *const u8;
[09:24:55] <nrc>         for i in 0..18 {
[09:24:57] <nrc>             println!("{}", *((p as usize + i) as *const u8));
[09:24:58] <nrc>         }
[09:25:00] <nrc>     }
[09:25:04] <nrc> I got:
[09:25:07] <nrc> 184
[09:25:09] <nrc> 62
[09:25:10] <nrc> 142
[09:25:12] <nrc> 249
[09:25:13] <nrc> 255
[09:25:15] <nrc> 127
[09:25:16] <nrc> 0
[09:25:18] <nrc> 0
[09:25:19] <nrc> 3
[09:25:21] <nrc> 0
[09:25:22] <nrc> 0
[09:25:24] <nrc> 0
[09:25:25] <nrc> 0
[09:25:27] <nrc> 0
[09:25:28] <nrc> 0
[09:25:30] <nrc> 0
[09:25:31] <nrc> 42
[09:25:33] <nrc> 0
[09:25:34] <nrc> oh, I added y: i64 to Bar and set it to 42
[09:25:36] <nrc> so the 42 is obvious
[09:25:37] <nrc> the 3 is the length of the array
[09:25:44] <nrc> I assume the first four bytes are a good pointer
[09:25:49] <nrc> and the 127?1
[09:25:54] <pnkfelix> 64-bit or 32-bit system ?
[09:25:56] <nrc> I am weirded out by
[09:25:58] <nrc> 64
[09:26:35] <nrc> er
[09:26:40] <nrc> I thought it was
[09:26:48] <nrc> but this only makes sense on 32
[09:27:04] <pnkfelix> well could all 8 bytes be the pointer?  I haven't really counted it yet
[09:27:14] <pnkfelix> maybe you should be going up to sizeof::<G> rather than hard-coding 18
[09:27:23] <pnkfelix> though I guess you did already check this with your insertion of 42
[09:27:49] <nrc> I've gone to 25
[09:28:00] <nrc> which I should have done in the first place
[09:28:09] <pnkfelix> on second thought, this seems like it makes sense to be a 64-bit system, right?
[09:28:13] <nrc> 248
[09:28:14] <nrc> 136
[09:28:16] <nrc> 247
[09:28:17] <nrc> 67
[09:28:19] <nrc> 255
[09:28:21] <nrc> 127
[09:28:22] <nrc> 0
[09:28:24] <nrc> 0
[09:28:25] <nrc> 3
[09:28:27] <nrc> 0
[09:28:28] <nrc> 0
[09:28:30] <nrc> 0
[09:28:31] <nrc> 0
[09:28:33] <nrc> 0
[09:28:34] <nrc> 0
[09:28:34] <pnkfelix> if the extra-word in the fat pointer starts with the '3', that is ...
[09:28:36] <nrc> 0
[09:28:37] <nrc> 42
[09:28:39] <nrc> 0
[09:28:40] <nrc> 0
[09:28:42] <nrc> 0
[09:28:43] <nrc> 0
[09:28:45] <nrc> 0
[09:28:46] <nrc> 0
[09:28:48] <nrc> 0
[09:28:49] <nrc> 1
[09:28:51] <nrc> 0
[09:28:52] <nrc> and drop flag = 1
[09:28:54] <nrc> yeah, that makes sense
[09:28:55] * cmr nominates nrc for best gdb frontend
[09:29:05] <nrc> * worst
[09:29:37] <nrc> pnkfelix: is 1 sensible for a drop flag?
[09:29:44] <nrc> (I thought no)
[09:29:56] *** Joins: Rym (y@moz-4vn.8i0.144.109.IP)
[09:30:07] <pnkfelix> no the two possible values are both meant to be harder to find by accident
[09:30:15] <pnkfelix> in adt.rs
[09:30:21] <pnkfelix> trans/adt.rs
[09:30:34] <pnkfelix> you see DTOR_NEEDED = 0xd4 and DTOR_DONE = 0x1d
[09:30:45] <nrc> right
[09:30:49] <pnkfelix> so when the drop-code still needs to be run (i.e. initialized data, its 0xd4)
[09:30:52] *** Quits: Rym (y@moz-4vn.8i0.144.109.IP) (Connection closed)
[09:31:08] <pnkfelix> so none of this really makes sense
[09:31:37] <pnkfelix> what does `f` look like?  (Maybe print in 4-byte chunks just to ease transcription to IRC ? )
[09:32:09] <pnkfelix> (though this is so low traffice, I guess people won't mind the byte feeds)
[09:33:45] <pnkfelix> nrc: Anyway, I figure the next step is to figure out ... is the drop flag being copied over and/or initialized at all, and then corrupted?
[09:34:03] <nrc> is -44 the initial drop flag in decimal?
[09:34:27] <pnkfelix> (I actually do not know whether our code for doing assignments works by copying the drop flag of the source input, or by separately setting it)
[09:35:18] <pnkfelix> no, neither has the sign bit set
[09:35:19] <nrc> google says yes == d4
[09:35:33] <pnkfelix> oh wait
[09:35:34] <pnkfelix> I'm dumb
[09:35:42] <nrc> I have no idea why we emit code to do it that way :-s
[09:35:49] <pnkfelix> sorry, I was thinking of them as 32-bit values.  :P
[09:35:57] <nrc> and this is pre-optimisation too
[09:36:21] <nrc> also, `256-44 in hex` works as a valid search term in google :-p
[09:36:40] <nrc> so its def being set
[09:36:47] * nrc slowly reads more llvm ir
[09:36:55] * pnkfelix always just switches to printing out his data via `{:x}` rather than trying to do math
[09:37:00] <doener_> nrc:     for i in 0..8 { unsafe { print!("{:02x}{:02x} ", *p.offset(i*2), *p.offset(i*2+1)); } }
[09:37:44] * nrc has a special kind of laziness when it comes to remembering format strings
[09:37:44] <doener_> gives slightly more readable output :-)
[09:39:39] <nrc> pnkfelix: so it looks like when we memcpy %f into %_coercion_source, we copy only 24 bytes, not 25, i.e., we miss the drop flag
[09:39:55] <nrc> which seems like the error
[09:39:59] <pnkfelix> nrc: yeah that seems wrong
[09:40:20] <pnkfelix> nrc: I assume there must be some relevant sizeof calculation that is feeding in the wrong inputs?
[09:40:37] <doener_> btw, this reminds me of the last problem I had with always marking things as dropped in drop glue to avoid copies when passing moving things by value. I got a double drop for some Rcs in a vector
[09:42:01] <pnkfelix> doener_: what library was this for? I assume you ... switching to using the newly added `read_and_drop`  (which I assume must be thrown out when we move to nonzeroing drop) ?
[09:43:17] *** kimundi is now known as zz_kimundi
[09:43:33] <doener_> pnkfelix: that was for rustc. Yes, I switched to read_and_drop, also added that in the forget() and move_val_init() intrinsics. And I had that problem before the move to 0x1d as the drop marker, too.
[09:44:10] <doener_> pnkfelix: basically trying to see if a shortterm fix for gh23657 is possible
[09:45:16] <pnkfelix> doener_: oh I see now, okay
[09:46:31] <nrc> hmm, interesting
[09:47:02] <nrc> (pnkfelix I am finishing off eddyb's work on DST coercions, which is why I'm kind of figuring out the code as I go along)
[09:47:20] <nrc> we are looping over the fields in the struct and either copying them or coercing them
[09:47:49] <nrc> but, we are iterating over the fields as type checking knows them, not trans::adt, iiuc
[09:47:57] <pnkfelix> !
[09:48:05] <pnkfelix> yikes
[09:48:32] <pnkfelix> I ... wonder if that impacts things other than the drop flag? Maybe not
[09:52:13] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[10:00:23] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Connection closed)
[10:01:10] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[10:06:20] <nrc> well changing naively to just using adt's fields causes an ICE
[10:06:30] <nrc> so I guess, we'll have to see if that it really the fix
[10:06:39] <nrc> because it is too late for me to continue
[10:06:51] <nrc> pnkfelix: thanks for the help!
[10:11:14] <pnkfelix> nrc: np, sounds like you're close to something working, anyway. :)
[10:11:30] <pnkfelix> nrc: (and I bet the drop-flag checks probably saved you time in the long term.)
[10:11:51] <pnkfelix> (well, you, or someone else down the road...)
[10:20:55] <nrc> I expect so
[10:26:09] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[10:40:22] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Connection closed)
[10:40:59] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[10:42:42] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Connection closed)
[10:43:27] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[10:55:04] *** zz_kimundi is now known as kimundi
[11:22:45] *** Quits: nrc (nrc@moz-4bhi2i.xtra.co.nz) (Ping timeout: 121 seconds)
[11:25:08] *** Joins: nrc (nrc@moz-4bhi2i.xtra.co.nz)
[11:25:08] *** ChanServ sets mode: +qo nrc nrc
[11:26:00] *** Quits: p1start (p1start@moz-nftjhe.org) (Ping timeout: 121 seconds)
[11:29:22] *** Quits: nrc (nrc@moz-4bhi2i.xtra.co.nz) (Ping timeout: 121 seconds)
[12:48:19] *** Quits: rprichard (rprichard@moz-imu4l1.en8f.d045.0009.2601.IP) (Connection closed)
[13:34:30] *** kimundi is now known as zz_kimundi
[14:24:14] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Ping timeout: 121 seconds)
[14:29:11] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[14:39:46] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Connection closed)
[14:40:36] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[15:23:09] *** zz_kimundi is now known as kimundi
[15:26:18] *** Quits: laumann (thomas@moz-3v9.hq0.225.130.IP) (Ping timeout: 121 seconds)
[15:51:17] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[15:51:27] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[15:51:27] *** ChanServ sets mode: +qo brson brson
[16:29:07] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[16:49:31] *** Quits: brson (brson@moz-u3dg2t.sfo1.mozilla.com) (Quit: leaving)
[16:49:40] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[16:49:40] *** ChanServ sets mode: +qo brson brson
[16:51:15] *** Quits: brson (brson@moz-u3dg2t.sfo1.mozilla.com) (Quit: leaving)
[16:56:21] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[16:56:21] *** ChanServ sets mode: +qo brson brson
[17:44:20] *** Quits: pnkfelix (pnkfelix@moz-6v5.3nd.202.89.IP) (Ping timeout: 121 seconds)
[17:56:47] *** Quits: brson (brson@moz-u3dg2t.sfo1.mozilla.com) (Connection closed)
[17:57:06] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[17:57:06] *** ChanServ sets mode: +qo brson brson
[17:57:07] *** Quits: brson (brson@moz-u3dg2t.sfo1.mozilla.com) (Quit: leaving)
[18:00:31] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[18:00:31] *** ChanServ sets mode: +qo brson brson
[18:03:10] *** Joins: nrc (nrc@moz-4bhi2i.xtra.co.nz)
[18:03:11] *** ChanServ sets mode: +qo nrc nrc
[18:18:03] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[18:20:01] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[18:29:35] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[18:35:29] *** Joins: laumann (thomas@moz-n9e72h.0.fullrate.dk)
[18:40:01] *** Quits: brson (brson@moz-u3dg2t.sfo1.mozilla.com) (Ping timeout: 121 seconds)
[18:41:28] *** Joins: sigma (sigma@moz-ohog4c.range86-135.btcentralplus.com)
[18:55:28] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Connection closed)
[18:59:43] *** Joins: simukis (nagisa@moz-8t068g.static.zebra.lt)
[19:00:10] *** Quits: nrc (nrc@moz-4bhi2i.xtra.co.nz) (Ping timeout: 121 seconds)
[19:47:33] *** Quits: simukis (nagisa@moz-8t068g.static.zebra.lt) (Quit: Leaving.)
[20:15:36] *** Quits: sigma (sigma@moz-ohog4c.range86-135.btcentralplus.com) (Ping timeout: 121 seconds)
[20:27:28] *** Quits: laumann (thomas@moz-n9e72h.0.fullrate.dk) (Ping timeout: 121 seconds)
[20:50:37] *** Joins: pnkfelix (pnkfelix@moz-eljppb.fbx.proxad.net)
[20:50:37] *** ChanServ sets mode: +o pnkfelix
[21:01:41] *** Quits: Rym (y@moz-uso.r81.55.31.IP) (Ping timeout: 121 seconds)
[21:02:58] *** Joins: p1start (p1start@moz-nftjhe.org)
[21:07:30] *** Joins: Rym (y@moz-uso.r81.55.31.IP)
[21:33:16] *** Quits: p1start (p1start@moz-nftjhe.org) (Ping timeout: 121 seconds)
[22:22:49] *** Joins: rprichard (rprichard@moz-6t31kt.en8f.d045.0009.2601.IP)
[23:03:16] *** Joins: brson (brson@moz-u3dg2t.sfo1.mozilla.com)
[23:03:16] *** ChanServ sets mode: +qo brson brson
