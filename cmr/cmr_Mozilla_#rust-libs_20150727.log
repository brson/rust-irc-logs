[01:37:01] *** Quits: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se) (Ping timeout: 121 seconds)
[01:49:03] *** Quits: nagisa (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
[02:16:07] *** Joins: aatch (james@moz-i1k1ks.tlms.2o1v.e006.2406.IP)
[02:40:56] *** Quits: kimundi (kimundi@moz-2r8k4e.l723.d4mv.57bc.2002.IP) (Ping timeout: 121 seconds)
[02:46:36] *** Joins: kimundi (kimundi@moz-upm4u8.3d6k.qdkt.57bc.2002.IP)
[03:41:12] *** Quits: Tobba (Tobba@moz-o13d22.bredband.telia.com) (Ping timeout: 121 seconds)
[04:09:08] <Gankro> aturon: back?
[06:26:58] *** Quits: aatch (james@moz-i1k1ks.tlms.2o1v.e006.2406.IP) (Quit: Leaving)
[07:04:13] *** Joins: canhtak (jeremy@moz-kcs.u0t.149.5.IP)
[07:12:35] *** Quits: canhtak (jeremy@moz-kcs.u0t.149.5.IP) (Ping timeout: 121 seconds)
[09:01:08] *** Joins: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se)
[10:08:12] *** Joins: nagisa (nagisa@moz-8t068g.static.zebra.lt)
[11:38:21] <bluss> SimonSapin: your rc crate is a good argument for not keeping Weak unstable any longer
[11:39:23] <SimonSapin> bluss: asking nicely did not give results before, so I’m trying something else
[11:39:39] <bluss> yeah
[11:39:51] <bluss> I'm a fan of self determination myself :) just do what you need to
[11:40:13] <bluss> but in the long run, having rc::Rc and std::rc::Rc being incompatible types is a mess
[11:40:28] <SimonSapin> right, this is a stopgap
[11:41:06] <SimonSapin> I only plan to use it for the "toy" tree data structure of html5ever that’s used to run tests
[11:42:31] <SimonSapin> but I just realized that most tests are dynamically created by messing with test crate internals anyway…
[12:33:43] *** Joins: Tobba (Tobba@moz-o13d22.bredband.telia.com)
[13:34:49] *** Joins: gleb (gleb@moz-3u1drv.rusanovka-net.kiev.ua)
[14:22:09] <aturon> Gankro: back
[15:34:04] <Gankro> aturon: hey!
[15:34:19] <Gankro> The ownership chapter probably needs a re-read
[15:36:20] <aturon> Gankro: ok, will do
[15:38:40] <aturon> Gankro: i can take on some of the un-reviewed sections also, just let me know
[15:39:05] <Gankro> aturon: that would be great!
[15:39:39] <aturon> Gankro: do you know if pnkfelix has started reviewing the one you have him down for?
[15:40:30] <aturon> also, should I re-read all of ownership, or are there specific sections that changed?
[15:42:05] <Gankro> aturon: enough has changed, and also I'm not sure about the chapter as a whole entity
[15:42:21] <Gankro> but feel free to skim anything that is clearly identical
[15:42:34] <aturon> ok, SGTM
[16:16:56] *** Joins: brson (brson@moz-cfhap5.mtv2.mozilla.com)
[16:16:57] *** ChanServ sets mode: +qo brson brson
[16:57:27] *** Quits: gleb (gleb@moz-3u1drv.rusanovka-net.kiev.ua) (Ping timeout: 121 seconds)
[17:16:10] <aturon> Gankro: re-read ownership, just left you a comment. let's discuss in person as well
[17:16:19] <aturon> Gankro: i'll try to get another chapter in today as well
[17:16:23] <Gankro> now?
[17:16:25] <Gankro> later?
[17:16:38] <aturon> Gankro: maybe read over the comment first, then let's talk
[17:17:02] <Gankro> kk
[17:36:52] *** Joins: killercup (killercup@moz-f6o3r9.dip0.t-ipconnect.de)
[17:41:04] *** Quits: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se) (Ping timeout: 121 seconds)
[17:42:02] *** Joins: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se)
[17:46:17] *** Quits: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se) (Ping timeout: 121 seconds)
[17:47:36] *** Joins: bluss (bluss@moz-rip51k.cust.bredbandsbolaget.se)
[17:47:45] <SimonSapin> kimundi, Elaine, huon, eddyb: In the spirit of the StableAddress trait: https://github.com/SimonSapin/kuchiki/blob/a2302e70e6/src/cell_option.rs#L57-L93
[17:48:04] <SimonSapin> to avoid the replace dance of MoveCell
[17:48:15] <eddyb> WellBehavedClone is okay-ish
[17:48:18] <huon> nice trick
[17:48:31] <SimonSapin> eddyb: only ish? :)
[17:48:45] <eddyb> SimonSapin: I kinda chose not to make use of it
[17:48:52] <eddyb> but I never started a discussion on the real solution
[17:49:36] <eddyb> SimonSapin: fwiw you can implement Cell<Vec<T>> where T: WellBehavedClone
[17:49:52] <eddyb> also see https://github.com/rust-lang/rfcs/issues/1106
[17:50:34] <huon> eddyb: oh, you might be interested in http://huonw.github.io/alias/alias/
[17:51:07] <eddyb> I am confused
[17:51:22] <eddyb> ahhh you implemented that API
[17:51:26] <huon> it's exactly from_mut
[17:51:47] <eddyb> IMO it should be in libcore, but at least now I can use a crate instead of unsafe :D
[17:51:48] <huon> (invented independently :) )
[18:04:24] *** Joins: sigma (sigma@moz-92585k.range217-44.btcentralplus.com)
[18:58:41] *** Joins: gleb (gleb@moz-3u1drv.rusanovka-net.kiev.ua)
[20:07:12] <SimonSapin> Gankro: How real is the problem of implicit drop of recursive data structures blowing up the stack? I just crated a Rc-based tree 80 millions nodes deep
[20:07:36] <SimonSapin> … it took a couple minutes to allocate 12 GB of RAM, and then another minute to free it
[20:07:45] <Gankro> iirc I had to make a singly linked list with a million or so nodes
[20:07:46] <SimonSapin> but it worked, apparently
[20:07:53] <Gankro> But obviously it depends onyour stack depth
[20:08:04] <bluss> with a balanced tree I doubt you can overflow
[20:08:20] <SimonSapin> this was completely unbalanced
[20:08:26] <huon> playbot: enum Foo { A, B(Box<Foo>) } let mut x = A; for _ in 0..1000000 { x = B(Box::new(x)) }
[20:08:26] -playbot- <anon>:9:49: 9:50 error: unresolved name `A`
[20:08:27] -playbot- <anon>:9         enum Foo { A, B(Box<Foo>) } let mut x = A; for _ in 0..1000000 { x = B(Box::new(x)) }
[20:08:27] -playbot- output truncated; full output at: http://bit.ly/1gh6I1j
[20:08:49] <SimonSapin> each node (except the leaf) had one child
[20:08:51] <huon> playbot: enum Foo { A, B(Box<Foo>) } let mut x = Foo::A; for _ in 0..1000000 { x = Foo::B(Box::new(x)) }
[20:08:53] -playbot- thread '<main>' has overflowed its stack
[20:08:53] -playbot- playpen: application terminated abnormally with signal 4 (Illegal instruction)
[20:09:25] <huon> (that seems to overflow even in release)
[20:11:05] <Gankro> SimonSapin: http://is.gd/D0dYAF
[20:11:28] <Gankro> ah huon's got it covered
[20:11:36] <Gankro> playpen vomits on 100_000
[20:11:49] <huon> only in debug :)
[20:11:57] <Gankro> Ah, makes sense
[20:12:12] <SimonSapin> Hum, right. Let me experiment some more :)
[20:12:38] <bluss> if you try Rc, it overflows in release mode too, 100k length
[20:12:41] <Gankro> SimonSapin: note that Rc is a bit easier in the case that your nodes are genuinely multiply aliased
[20:13:03] <SimonSapin> Gankro: easier to blow up the stack?
[20:13:08] <Gankro> easier to not
[20:13:15] <SimonSapin> right
[20:13:15] <Gankro> Any refcount 2 kills the recursion
[20:14:11] <Gankro> huon: so does std's abort not allocate if you pass it a str?
[20:17:08] <huon> simple formatting doesn't allocate
[20:17:48] <Gankro> huon: So the only reason we don't use that is because oom isn't defined in std?
[20:18:00] <huon> I have no idea why we don't use it
[20:18:01] <Gankro> Could we use some kind of weak symbol...?
[20:18:03] <huon> I suspect it
[20:18:17] <huon> 's more because it's just a random function used by the "runtime"
[20:18:31] <huon> not a real abort
[20:18:48] <huon> I think it just makes more sense for the book to not mention it at all
[20:19:11] <Gankro> Right, but we could in principle have oom in std print "Out of memory"?
[20:19:17] <huon> (i.e. instead of mentioning to say why we don't use it)
[20:19:21] <huon> yes, we could/should
[20:19:36] <huon> if necessary we could do plain libc calls
[20:19:48] <Gankro> huon: Sorry, what exactly do you want to remove?
[20:19:49] <huon> `write(2, "out of memory\0".as_ptr())`
[20:19:55] <Gankro> We need to do *a thing* on OOM
[20:19:57] <SimonSapin> Gankro: mystery solved! I got the idea to try it half-way through implementing Drop to work around the problem. And my test only exercised the half that *was* handled already :)
[20:20:13] <SimonSapin> removing that Drop impl I can easly brow up the stack
[20:20:24] <Gankro> SimonSapin: y... yaaayyyy
[20:20:33] <huon> Gankro: both versions of TARPL I've read have said somsething like "we don't use std's abort because ..."
[20:20:42] <huon> Gankro: when we could just not mention it at all :)
[20:20:54] <Gankro> huon: Ok so just jump straight to `exit`?
[20:20:58] <huon> yeah
[20:21:02] <SimonSapin> Gankro: strong=1 is the typical case in this tree, as I use weak refs to avoid cycles
[20:21:14] <Gankro> SimonSapin: ah, too bad
[20:21:49] <bluss> huon: um why don't we do that, the simple out of memory message?
[20:21:55] <Gankro> SimonSapin: btw how the hell do you properly use Rc<RefCell> anywhere? Is at mapping and returning Refs?
[20:22:12] <Gankro> bluss: liballoc doesn't have a runtime
[20:22:35] <Gankro> Or
[20:22:39] <Gankro> Not all the runtime
[20:22:44] <Gankro> Wait...
[20:22:48] <Gankro> maybe it does...
[20:22:53] <bluss> runtime?
[20:22:53] <SimonSapin> Gankro: "interiorer" mutability. I don’t put the entire node in a refcell, only smaller things is separate (ref)cells
[20:24:10] <Gankro> bluss: printing a message requires assuming that's a thing you can do on your platform
[20:24:50] <bluss> Gankro: yeah. But what's going to happen if you can't.. we're already aborting :-)
[20:25:27] <Gankro> bluss: basically you need some kinda weak symbols or something
[20:25:28] <SimonSapin> Gankro: but for cases where you can’t, that’s why I added std::cell::Ref::{filter_,}map
[20:25:41] <huon> bluss: bceause no-one's implmemented it?
[20:25:48] <huon> bluss: don't know of any other reason
[20:26:13] <bluss> huon: I'd certainly like to see it happen
[20:26:48] <huon> bluss: as do I
[20:35:39] <Gankro> bluss: huon: acrichto: https://github.com/rust-lang/rust/issues/27335
[20:35:58] *** Quits: sigma (sigma@moz-92585k.range217-44.btcentralplus.com) (Connection closed)
[20:38:31] <bluss> Gankro: sounds good!
[20:55:23] *** Elaine is now known as Elainemo
[21:35:40] <SimonSapin> If I have std::rc::Weak cycles, does this prevent the RcBox’es from being ever deallocated?
[21:55:38] <SimonSapin> no it doesn’t I was confused
[22:32:43] *** Quits: killercup (killercup@moz-f6o3r9.dip0.t-ipconnect.de) (Quit: Bye)
[22:32:53] *** Joins: killercup (killercup@moz-f6o3r9.dip0.t-ipconnect.de)
[22:33:26] *** Quits: killercup (killercup@moz-f6o3r9.dip0.t-ipconnect.de) (Quit: Bye)
[22:39:53] *** Joins: apasel422 (Mibbit@moz-6ga37r.ma.comcast.net)
[23:06:14] <SimonSapin> This is tricky and seems hard to test: https://github.com/SimonSapin/kuchiki/commit/c05dec7671#diff-ecc927991c14fae6e03a511ed1d458b3
[23:08:21] <Gankro> SimonSapin: yeah that's the whole point of weak; The strong drops the type, cascading the elimination of the cycle
[23:09:55] <Gankro> SimonSapin: you can make a dummy type that increments a global. Make a deep tree, make sure it doesn't blow the stack but the counter is right
[23:10:16] <Gankro> Oh your node isn't generic @_@
[23:10:23] <SimonSapin> Gankro: counter incremented in Drop?
[23:10:34] <Gankro> SimonSapin: yeah
[23:10:42] <Gankro> we have a few tests like that in std iirc
[23:12:23] <SimonSapin> yeah, it isn’t generic. I do have examples/stack-overflow.rs in that commit that overflows when I make drop return early, but it’s only testing one particular shape of tree, and it doesn’t check that drop is not overly destructive
[23:12:57] <Gankro> SimonSapin: eh, presumably it will show up elsewhere if serious?
[23:13:09] <Gankro> Also this code should be write-once forget forever
[23:13:34] <SimonSapin> of course, since the rest of my test suite is so comprehensive :)
[23:13:36] <SimonSapin> (it’s not)
[23:14:11] <Gankro> SimonSapin: It'll show up in someone's application :P
[23:14:46] *** Quits: gleb (gleb@moz-3u1drv.rusanovka-net.kiev.ua) (Ping timeout: 121 seconds)
[23:14:58] <SimonSapin> If nobody observes a critical bug in the forest, is it really a bug?
[23:15:58] <steveklabnik> heh
[23:22:27] *** Joins: aatch (james@moz-i1k1ks.tlms.2o1v.e006.2406.IP)
[23:30:53] <SimonSapin> I think Rc::try_unwrap could return Ok when the weak count is non-zero. (It would invalidate those weak references.) Should it?
[23:41:37] <Gankro> SimonSapin: Yes it should
[23:43:10] <Gankro> In the past Rc and Arc were overly conservative there
[23:58:15] *** Quits: nagisa (nagisa@moz-8t068g.static.zebra.lt) (Ping timeout: 121 seconds)
