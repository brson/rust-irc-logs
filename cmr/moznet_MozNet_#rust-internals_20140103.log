[00:08:16] *** Quits: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP) (Connection reset by peer)
[00:11:55] *** Joins: geoffhill (geoffhill@moz-738DC0DB.org)
[00:18:01] <bjz> acrichto: hoy
[00:33:21] *** Joins: larsberg_ (sid16141@moz-A42E5B7B.irccloud.com)
[00:33:59] *** Quits: larsberg_ (sid16141@moz-A42E5B7B.irccloud.com) (Quit: )
[00:34:17] *** Joins: larsberg_ (sid16141@moz-A42E5B7B.irccloud.com)
[00:34:36] *** larsberg_ is now known as larsberg
[00:41:04] <sfackler> acrichto: is this a semi-reasonable way to get macro_rules exports working?
[00:41:24] <sfackler> I'm not super happy about the way it checks for #[macro_export]
[00:41:49] <sfackler> https://github.com/sfackler/rust/commit/34ef57c83994c72ed89554824296db3327c55007
[00:41:56] *** Joins: jdm (jdm@moz-3FFA85CA.dsl.teksavvy.com)
[00:44:31] *** Joins: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP)
[00:45:08] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[00:45:28] *** Joins: gwty (gwtypc@75A7448E.8DB61C28.F44414AF.IP)
[01:06:52] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[01:06:52] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/vveFuA
[01:06:52] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[01:11:51] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[01:11:51] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/fKk8_w
[01:11:51] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[01:11:52] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[01:11:52] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/YRDwgQ
[01:11:52] <ghrust> 13rust/06auto 143936fbc 15Alex Crichton: Add read_to_str and write_{str, line}...
[01:11:52] <ghrust> 13rust/06auto 143ecfb35 15bors: auto merge of #10861 : alexcrichton/rust/iostr, r=pcwalton...
[01:11:52] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[01:20:46] *** Quits: jdm (jdm@moz-3FFA85CA.dsl.teksavvy.com) (Quit: Lost terminal)
[01:29:44] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[01:29:44] <ghrust> 01[13rust01] 15brson merged 06master into 06dist-snap: 02http://git.io/HXfSmg
[01:29:44] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[01:43:58] *** Quits: geoffhill (geoffhill@moz-738DC0DB.org) (Ping timeout)
[01:44:50] *** Quits: shachaf (shachaf@moz-F37E0395.members.linode.com) (Ping timeout)
[01:44:54] *** Quits: jld (jld@moz-B94C75AD.xlerb.net) (Ping timeout)
[01:45:16] *** Quits: Eridius (kevin@moz-533B0DB4.us) (Ping timeout)
[01:46:52] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[01:46:52] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 143ecfb35 to 1427ce4d3: 02http://git.io/N3iJvQ
[01:46:52] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[01:46:53] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[01:46:53] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/W8mIrA
[01:46:53] <ghrust> 13rust/06auto 14d2004e0 15Young-il Choi: librustc: ar call fix to support android cross compile on mac
[01:46:53] <ghrust> 13rust/06auto 14cad0215 15Young-il Choi: librustc: move target dependent logic to back::link
[01:46:54] <ghrust> 13rust/06auto 14c487065 15Young-il Choi: librustc: add get_system_tools for target specific environment
[01:46:56] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[01:48:13] *** Joins: shachaf (shachaf@moz-F37E0395.members.linode.com)
[01:59:08] *** Joins: jld (jld@moz-B94C75AD.xlerb.net)
[02:01:32] *** Joins: geoffhill (geoffhill@moz-738DC0DB.org)
[02:03:00] *** Joins: Eridius (kevin@moz-533B0DB4.us)
[02:06:47] *** Quits: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com) (Quit: pcwalton)
[02:07:47] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[02:09:03] *** Quits: geoffhill (geoffhill@moz-738DC0DB.org) (Ping timeout)
[02:09:49] *** Quits: shachaf (shachaf@moz-F37E0395.members.linode.com) (Ping timeout)
[02:13:11] *** Joins: shachaf (shachaf@moz-F37E0395.members.linode.com)
[02:16:18] <brson> i wish there were more things on the 1.0 milestone that were easy
[02:16:34] <brson> every time i want something easy to nock out i look at them all and say 'nah'
[02:28:23] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Quit: It's a joke, it's all a joke.)
[02:30:20] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[02:33:13] *** kimundi is now known as zz_kimundi
[02:40:07] <bjz> in syntax::ext, is there meant to be one unique ExtCtxt?
[02:40:23] <dbaupp> yes
[02:40:28] <dbaupp> I think
[02:40:30] <bjz> ok
[02:41:07] <bjz> yeah, see the format stuff requires a &mut ExtCtxt, but I can only access a &ExtCtxt
[02:41:42] <bjz> I was thinking I could do ExtCtxt::new(cx.parse_sess, cx.cfg)
[02:42:29] <dbaupp> you can probably just change #[deriving]
[02:43:21] <sfackler> bjz: I may have just missed a couple of &-> &mut when I was changing that stuff around
[02:44:31] <bjz> mmk
[02:44:42] <bjz> https://github.com/mozilla/rust/blob/master/src/libsyntax/ext/deriving/generic.rs#L302-L303 vs https://github.com/mozilla/rust/blob/master/src/libsyntax/ext/format.rs#L725-L726
[02:47:19] <bjz> so TraitDef could borrow a mutable ExtCtxt?
[02:47:33] <sfackler> yep
[02:48:15] <bjz> same as expand_meta_deriving?
[02:48:18] <bjz> ok
[02:49:08] <sfackler> ExtCtxt used to be passed around as @ExtCtxt with a bunch of @mut stuff inside to make it mutable. I got rid of some stuff, but didn't push the &mut transition out far enough
[02:49:26] <sfackler> *that stuff
[02:50:13] <bjz> ah. you were de-@-ing?
[02:50:28] <sfackler> yeah
[02:50:47] <bjz> so much @_@
[02:51:22] <bjz> it is like living in old rust land here
[02:53:08] <sfackler> yep
[02:53:10] <sfackler> :(
[02:54:59] *** Quits: dbaupp (Thunderbir@moz-EB2EFE6F.lns20.syd6.internode.on.net) (Ping timeout)
[02:55:02] <bjz> so rustc is de-@-ed though?
[02:55:20] <bjz> or was that de-@mut-ed?
[02:55:39] <sfackler> pcwalton has a patch to de-@mut it 
[02:55:45] <sfackler> de-@-ing is still continuing
[02:56:54] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[02:56:54] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/6qPXSw
[02:56:54] <ghrust> 13rust/06auto 14f4dcb17 15Jan Niklas Hasse: Make CFG_LIBDIR configurable. Fixes #5222
[02:56:54] <ghrust> 13rust/06auto 146610668 15bors: auto merge of #11045 : jhasse/rust/patch-libdir, r=brson...
[02:56:54] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[02:56:55] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[02:56:56] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14b67195d to 1427ce4d3: 02http://git.io/N3iJvQ
[02:56:56] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[02:57:08] <bjz> sfackler: that will be touching deriving right?
[02:57:28] <bjz> sfackler: atm I am trying to implement deriving(Format)
[02:57:43] <bjz> (default fmt trait)
[02:58:25] <sfackler> looks like it only touches deriving/ty.rs: https://github.com/mozilla/rust/pull/11251/files
[02:58:28] *** Joins: dbaupp (Thunderbir@moz-EB2EFE6F.lns20.syd6.internode.on.net)
[02:59:27] <sfackler> but it'll probably be bouncing around for a while, I'd just do your thing and make pcwalton handle the conflicts :D
[03:00:53] <bjz> heh
[03:01:23] <dbaupp> can someone on mac run https://github.com/mozilla/rust/issues/6233#issuecomment-31502364 please?
[03:01:50] <dbaupp> (if it doesn't crash, up the #[cfg(crash)] size to like 1 << 23 or something.)
[03:02:02] <dbaupp> (`rustc --cfg crash foo.rs && ./foo`)
[03:03:03] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[03:05:44] <sfackler> dbaupp: I can't get it to crash at all on OSX
[03:06:00] <sfackler> it does start taking a really long time to compile when I set it to like 1 << 30
[03:06:04] <dbaupp> hah
[03:06:10] <dbaupp> ok, awesome
[03:07:05] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[03:11:56] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[03:11:56] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 146610668 to 1427ce4d3: 02http://git.io/N3iJvQ
[03:11:56] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[03:14:59] <bjz> sfackler: ok, so I'm getting 'cannot move out of dereference of & pointer' here: https://github.com/mozilla/rust/blob/master/src/libsyntax/ext/deriving/generic.rs#L355
[03:15:27] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Quit: leaving)
[03:15:28] <bjz> that's only when I change: https://github.com/mozilla/rust/blob/master/src/libsyntax/ext/deriving/generic.rs#L193
[03:15:29] <dbaupp> bjz: `let cx = &self.cx;`
[03:15:42] <bjz> to cx: &'a ExtCtxt,
[03:15:51] <bjz> woops `cx: &'a mut ExtCtxt,`
[03:16:12] <bjz> dbaupp: why did it work before the mut-ification?
[03:16:41] <dbaupp> bjz: because you can have multiple &T's but only one &mut T
[03:16:51] <dbaupp> (i.e. &T doesn't move but &mut T does)
[03:23:22] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[03:23:22] *** ChanServ sets mode: +ao pcwalton pcwalton
[03:30:07] <dbaupp> r? https://github.com/mozilla/rust/pull/11284
[03:35:14] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[03:37:36] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[03:37:37] *** ChanServ sets mode: +ao pcwalton pcwalton
[03:37:53] *** Quits: zz_kimundi (kimundi@moz-56BCBF80.dip0.t-ipconnect.de) (Ping timeout)
[03:39:03] <bjz> can syntax::ext::fmt be removed now?
[03:39:21] <dbaupp> bjz: after 0.9
[03:39:30] <bjz> oh ok
[03:39:34] <bjz> ahh
[03:39:39] <dbaupp> bjz: so that people tracking the releases get nice-ish error messages for fmt!()
[03:39:42] <bjz> so people get a better error
[03:39:44] <bjz> yep
[03:39:52] <bjz> makes sense
[03:40:06] <bjz> will format! -> fmt!?
[03:41:07] <dbaupp> don't think so
[03:41:43] *** Joins: zz_kimundi (kimundi@moz-6316CA96.dip0.t-ipconnect.de)
[03:41:45] *** zz_kimundi is now known as kimundi
[03:42:06] <bjz> then shouldn't std::fmt be renamed std::format?
[03:42:59] <dbaupp> maybe
[03:43:02] <dbaupp> talk to acrichto 
[03:50:28] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Connection reset by peer)
[04:06:01] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[04:06:01] <ghrust> 01[13rust01] 15huonw 04force-pushed 06try from 14687309e to 14ebdfbd1: 02http://git.io/k471pw
[04:06:01] <ghrust> 13rust/06try 14ebdfbd1 15Huon Wilson: std: adjust requested stack size for thread-local storage....
[04:06:01] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[04:06:58] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[04:06:58] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/8Mrq5Q
[04:06:58] <ghrust> 13rust/06auto 141c648fc 15Alex Crichton: rustc: Strip struct fields and enum variants...
[04:06:58] <ghrust> 13rust/06auto 14fb46225 15bors: auto merge of #11093 : alexcrichton/rust/issue-11085, r=pcwalton...
[04:06:58] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[04:07:00] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[04:07:00] *** ChanServ sets mode: +o tjc
[04:31:56] *** Joins: sipun (chatzilla@D97E2835.F486C877.274135A6.IP)
[04:33:05] *** Parts: sipun (chatzilla@D97E2835.F486C877.274135A6.IP) ()
[04:54:15] *** Quits: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca) (Quit: canhtak)
[04:55:48] *** Joins: jdm (jdm@moz-3FFA85CA.dsl.teksavvy.com)
[04:58:20] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[05:05:59] *** Joins: steveklabnik (uid17044@moz-A42E5B7B.irccloud.com)
[05:13:55] *** Joins: eddyb (eddy@EE946B63.921A1753.FCAAE698.IP)
[05:15:01] <dbaupp> eddyb: btw https://github.com/mozilla/rust/issues/10615
[05:17:04] <eddyb> dbaupp: that's fixed here, since immediates are truly passed by value
[05:17:26] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[05:17:26] <ghrust> 01[13rust01] 15huonw 04force-pushed 06try from 14ebdfbd1 to 1452e5b1e: 02http://git.io/k471pw
[05:17:26] <ghrust> 13rust/06try 1452e5b1e 15Huon Wilson: std: adjust requested stack size for thread-local storage....
[05:17:26] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[05:17:50] <dbaupp> eddyb: awesome! (Be sure to throw a "fixes #10615" in there, then. :) )
[05:18:14] <eddyb> I did say I may have fixed 5 bugs without knowing it
[05:18:20] <dbaupp> <3
[05:20:00] <eddyb> dbaupp: maybe https://github.com/mozilla/rust/issues/7411 too?
[05:20:12] <dbaupp> eddyb: I guess so
[05:20:30] <dbaupp> if you're replacing the environment slot with the self arg
[05:20:48] <eddyb> yeah, it has the proper type and everything
[05:21:04] <dbaupp> <3
[05:21:07] *** Joins: sanxiyn (tinuviel@B4104EBB.3CC170B1.1E14B209.IP)
[05:21:17] <eddyb> which I can't get for methods imported from other crates (generics) *but* I just realized that I might not have to store that info
[05:21:40] <eddyb> the old code needed a way to know the true type of self to know what to bitcast the env ptr to
[05:21:52] <eddyb> dbaupp: this must be strcat's dtor problem https://github.com/mozilla/rust/issues/4252
[05:22:04] <eddyb> OMG 100 pages of self issues
[05:22:47] <dbaupp> eddyb: https://github.com/mozilla/rust/issues/4252#issuecomment-27637889 it is the allocator blocker
[05:28:14] *** Joins: whitglint (uid15486@moz-31ABA2C0.irccloud.com)
[05:33:13] <eddyb> oooh, trans_method knows that self type... what it does is ty::node_id_to_type(ccx.tcx, method.self_id);
[05:34:40] *** Quits: acrichto (acrichto@moz-B63D64BD.res.cmu.edu) (Ping timeout)
[05:37:10] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[05:38:44] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[05:38:44] *** ChanServ sets mode: +ao pcwalton pcwalton
[05:52:03] *** Quits: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net) (Quit: Textual IRC Client: www.textualapp.com)
[05:52:15] *** Quits: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net) (Quit: NO CARRIER)
[05:52:40] *** Joins: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net)
[06:01:05] <eddyb> erm, what? error: internal compiler error: node_id_to_type: no type for node `local (id=500, name=self)`
[06:01:40] *** Quits: sanxiyn (tinuviel@B4104EBB.3CC170B1.1E14B209.IP) (Quit: Leaving)
[06:02:11] <eddyb> that breaks libstd :(
[06:06:31] <eddyb> why would there be no type for "self"? that doesn't sound sane
[06:07:27] *** Joins: acrichto (acrichto@moz-B63D64BD.res.cmu.edu)
[06:07:27] *** ChanServ sets mode: +o acrichto
[06:08:05] <eddyb> ooh, it could be a static method
[06:08:42] <acrichto> sfackler: that seems totally reasonable
[06:08:42] <acrichto> the only change I would make is to fail!() in ty_of_item
[06:08:42] <acrichto> b/c something else is already failing it seems reasonable to continue failing
[06:09:25] <Yurume> is this channel appropriate for the question/discussion about rustpkg?
[06:10:37] <ChrisMorgan> Yurume: "yes, it's broken" is probably an adequate answer for most things :P
[06:12:04] <Yurume> haha
[06:12:20] <Yurume> <Yurume> I have a question about rustpkg: a package (not an workspace) is as simple as lib.rs, but then how can one build that package outside of workspaces? i.e. is it possible to build packages not in the workspace?
[06:12:24] <Yurume> was my question in #rust
[06:13:26] *** Quits: acrichto (acrichto@moz-B63D64BD.res.cmu.edu) (Ping timeout)
[06:20:09] *** Joins: acrichto (acrichto@moz-B63D64BD.res.cmu.edu)
[06:20:09] *** ChanServ sets mode: +o acrichto
[06:22:23] <sfackler> acrichto: I made the change to ty_of_item because the old failure case was getting hit
[06:22:31] <sfackler> though I didn't look into where it was getting called from
[06:22:50] <acrichto> sfackler: hm, if it's called from lots of places then that's sad, but it would be kinda neat to avoid item_mac like item_foreign_mod is avoided
[06:22:53] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Quit: WeeChat 0.4.2)
[06:22:54] <acrichto> but again, demo quality :)
[06:22:54] <sfackler> so I may just have to tweak something else to get it to skip over macro definitions
[06:22:56] <sfackler> yeah
[06:23:03] <acrichto> this is super-awesome as-is
[06:23:16] * acrichto wants to put all format! logic in std::fmt
[06:23:28] <acrichto> bjz: oh about that, I don't want to rename fmt => format
[06:23:30] <sfackler> I'm working on a patch right now to only dlopen the library if there is a registration function
[06:23:39] <acrichto> bjz: fmt::Signed/fmt::Formatter are very easy to type
[06:23:42] <sfackler> then I've just got to wait for the SynatxEnv rewrite to go through to fix the segfaults
[06:23:53] <sfackler> then I think the only thing left will be the build infrastructure change
[06:23:54] <acrichto> sfackler: nice
[06:23:55] <eddyb> dbaupp: std and extra build!
[06:24:09] <acrichto> sfackler: and typechecking for a later date?
[06:24:12] <sfackler> yeah
[06:24:18] <acrichto> how would we add libstd macros?
[06:24:20] <eddyb> that should be over with this hell
[06:24:22] <acrichto> libstdmacro?
[06:24:31] <sfackler> typechecking seems hard
[06:24:38] <acrichto> I agree lol
[06:24:48] <sfackler> and stuff like #[start] functions aren't typechecked either so...
[06:25:05] <acrichto> we really need to do that...
[06:25:08] <bjz> acrichto: I have this stuff done: https://github.com/bjz/rust/commits/fmt
[06:25:11] <sfackler> acrichto: I'm not sure if you'd want to have a separate libstdmacro or just toss them in libstd
[06:25:21] <bjz> acrichto: still figuring out deriving though
[06:25:32] <acrichto> sfackler: so how would it work in libstd, like how would I write a procedural macro that depends on libsyntax?
[06:25:53] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[06:26:03] <sfackler> well keep in mind that there are actually 2 libstds
[06:26:05] <acrichto> bjz: awesome!
[06:26:12] <sfackler> the one the compiler uses and the one that use code links against
[06:26:19] <eddyb> are you doing that already o_O?
[06:26:23] <acrichto> but in theory those should be the same?
[06:26:36] <sfackler> possibly?
[06:26:43] <acrichto> so let's say I wanted to move format! all into libstd
[06:26:49] <sfackler> that may be the huge build system overhaul that brson was talking about
[06:26:51] <acrichto> that requires libsyntax deps b/c it's a procedural macro
[06:26:57] <acrichto> how would that look?
[06:26:58] <sfackler> if that happens then I think you'd need a separate libstdmacro crate
[06:27:05] <acrichto> #[phase(syntax)] extern mod std; ?
[06:27:11] <acrichto> #[phase(syntax)] extern mod stdmacro; ?
[06:27:24] <acrichto> b/c doesn't that mean all crates need a foo and foomacro crate?
[06:27:30] <sfackler> one of the two, but I'd guess that'd be put in the prelude anyway
[06:27:45] <sfackler> std is a bit of a special case
[06:27:48] <acrichto> is it?
[06:27:50] <sfackler> since libsyntax uses libstd
[06:27:53] <bjz> acrichto: I'm not sure how to work the syntax::ext::format::Context though :[
[06:27:55] <eddyb> acrichto: if you want it in std, you could have it attribute-gated, and rustc could split the crate into procedural macros and the rest
[06:28:03] <acrichto> sfackler: let's say you wanted to write macros for libpostgres
[06:28:06] <dbaupp> eddyb: \o/
[06:28:26] <acrichto> bjz: I wouldn't worry too much about it, you shouldn't have to touch it?
[06:28:28] <eddyb> sfackler, acrichto: std macros would have code that runs on the *previous* std/syntax and output AST for the *current* std
[06:28:44] <bjz> acrichto: I'm trying to use it in deriving
[06:28:44] <acrichto> eddyb: sfackler: I'm talking in the ideal world with the "perfect build system"
[06:28:50] <sfackler> acrichto: I could just toss them into the libpostgres crate, but then it'd transfer a dependency on libsyntax to anything linking against it
[06:28:51] <acrichto> bjz: oh you don't want to do that
[06:28:54] <sfackler> unless it turned lto on
[06:29:01] <eddyb> acrichto: it's simpler the way I'm talking about
[06:29:02] <acrichto> bjz: or hm maybe you can't emit a call to format!
[06:29:07] <bjz> acrichto: https://github.com/bjz/rust/blob/fmt/src/libsyntax/ext/deriving/format.rs#L50
[06:29:19] <acrichto> sfackler: yeah but that's much less than ideal
[06:29:20] <sfackler> so if you just want to export macro_rules definitions, you can leave them in the same crate as everything else
[06:29:20] <eddyb> acrichto: the previous/current std could be the same and it would still work and it requires no extern mode nonsense
[06:29:28] <eddyb> *mod
[06:29:33] <sfackler> but if you have procedural macros, you _probably_ want them in a separate crate
[06:29:37] <sfackler> which isn't the end of the world
[06:29:44] <acrichto> eddyb: we still have the problem of compiling two entirely separate crates
[06:29:45] <bjz> acrichto: sorry - still new to all this libsyntax stuff
[06:29:49] <sfackler> since it'll be a lot of gross code that I'd kind of want to segregate anyways
[06:30:00] <acrichto> bjz: no worries! I can certainly help with teh Context 
[06:30:15] <acrichto> sfackler: so ideall all code would live in one place
[06:30:23] <acrichto> sfackler: I would rustc src/libstd/lib.rs
[06:30:25] <eddyb> acrichto: they have to be separate, since one of them is compiled *and ran* to compile the other one
[06:30:25] <bjz> acrichto: would you be able to extend my commits? if you have time?
[06:30:29] <acrichto> and out comes libstd.rlib and libstdmacros.dylib
[06:30:41] <acrichto> eddyb: yes, but our experience doesn't have to be that way b/c it's pretty bad
[06:30:53] <acrichto> eddyb: it's separating the two implementations when they should be tied together
[06:30:56] <sfackler> acrichto: having rustc do the split for you is one option
[06:31:00] <acrichto> bjz: how so?
[06:31:02] <eddyb> acrichto: it doesn't have to be separate in code, that's what I'm saying
[06:31:09] <eddyb> sfackler: yeah, that
[06:31:13] <sfackler> though I'm not sure if that's really preferrable to just having two separate crates
[06:31:26] <acrichto> sfackler: I'd really want the format stuff all in libstd
[06:31:37] <acrichto> because think of how everyone else is going to be using it
[06:31:40] <bjz> acrichto: need to re-do the to_str functionality, but using the writer: https://github.com/bjz/rust/blob/fmt/src/libsyntax/ext/deriving/to_str.rs
[06:31:45] <acrichto> libstd is just the guinea big that everyone else will model after
[06:32:13] <acrichto> bjz: oh! you may be able to use quote_expr! to generate a token tree and then just pass that to the expansion 
[06:32:25] <acrichto> bjz: so you'd "write the code" but then let ext::format do all the parsing
[06:32:30] <eddyb> dbaupp: pffft, tests are dropping like flies
[06:32:43] <bjz> acrichto: quote_expr!?
[06:32:49] <acrichto> bjz: I know very little about it :(
[06:32:51] <sfackler> acrichto: I think the most reasonable thing is to actually have src/libstd and src/libstdmacros
[06:32:56] <acrichto> I think you put rust code in there, and an Expr comes out
[06:32:57] <bjz> acrichto: is that a libsyntax specific thing
[06:32:59] <sfackler> and libstdmacros links against libsyntax and libstd
[06:33:12] <acrichto> sfackler: but that means that *all* crates must have libfoo and libfoomacros
[06:33:18] <sfackler> rather than having rustc magically split some methods out into a separate crate
[06:33:28] <sfackler> acrichto: not necessarily
[06:33:41] <acrichto> sfackler: it might not be that magical, #[phase(syntax)] mod extension { ... }
[06:33:43] <sfackler> if you're only using macro_rules, there's no reason to split it
[06:33:50] <acrichto> that seems weird...
[06:34:00] <acrichto> macro_rules is loaded from the source and elsewhere from libfoomacros?
[06:34:22] <acrichto> so implementation-wise, there should *definitely* be two libraries
[06:34:33] <acrichto> code-wise, it seems like we should avoid having two libraries
[06:34:39] <acrichto> it just complicates all build processes and everything
[06:34:54] <eddyb> sfackler: it should be easy to determine whether there are procedural macros in the crate
[06:35:20] <sfackler> eddyb: yep, if it has a function tagged #[macro_registrar], that's the entry point
[06:35:25] <bjz> acrichto: where is quote_expr? I see a quote.rs
[06:35:31] <sfackler> bjz: it's in there
[06:35:45] <acrichto> bjz: grep around for it and you should see an example or two
[06:35:54] <sfackler> bjz: env.rs uses it
[06:36:00] <acrichto> sfackler: I think for now two crates is ok, but I'd like to explore the idea of merging the crates together before settling on this
[06:36:06] <bjz> ah cheers
[06:36:26] <sfackler> acrichto: sure
[06:36:55] <acrichto> with lots of work, I think it's possible to do in the same crate
[06:37:03] <acrichto> b/c we're real big on the "one crate" compilation so far
[06:37:14] <acrichto> or rather crate == compilation unit
[06:37:20] <acrichto> and I would expect the syntax extensions to be part of the compilation unit
[06:37:25] <acrichto> but bootstrapping is hard
[06:37:29] <sfackler> the compiler will have to be pretty aggressive about stripping stuff from the macro crate
[06:37:40] <sfackler> or you'll end up with a full copy of libstd with a few macro definitions attached
[06:37:55] <bjz> can you call a macro inside a quote_expr?
[06:37:59] <acrichto> sfackler: you would favor dynamic linking and only the registra would be exported
[06:38:21] <acrichto> you'd have to do all the analysis, but you could make the trans result the appropriate size
[06:38:27] <acrichto> bjz: I think?
[06:39:09] <bjz> like, quote_expr!(cx, write!($writer, "{}", $x))
[06:39:18] <sfackler> acrichto: the current reachability machinery may be able to do it if you can reconfigure it to treat the registrar function as the only external thing
[06:39:36] <acrichto> sfackler: this would essentially be two entire runs of the Session though
[06:39:39] <sfackler> yeah
[06:39:46] <acrichto> it's just bundled up for you into one rustc command
[06:39:50] <acrichto> which sounds like "just do two libraries"
[06:39:56] <sfackler> yep
[06:40:07] <acrichto> well it's still 1000000000x better than what we have now
[06:40:16] <acrichto> "just submit a PR!"
[06:42:45] <eddyb> o_O this is bad. just a println! with libstd - 183420 lines of LLVM
[06:43:33] <eddyb> acrichto: how can I use libnative?
[06:43:33] <acrichto> println! is not at all optimized for O0 codegen
[06:43:39] <acrichto> eddyb: extern mod native;
[06:43:49] <eddyb> -O3 :P
[06:44:10] <eddyb> acrichto: will that replace libgreen completely?
[06:44:12] <acrichto> println! optimized output is actually really good
[06:44:14] <acrichto> eddyb: not quite
[06:44:29] <acrichto> oh argh I didn't gist under my account
[06:44:33] <acrichto> thanks gist
[06:44:43] <eddyb> 183374 lines with "extern mod native" so it's slightly better
[06:44:53] <eddyb> oh, did I mention -Z lto?
[06:44:54] <acrichto> eddyb: https://gist.github.com/anonymous/8162357
[06:45:05] <eddyb> fork the gist
[06:45:09] <benh> with people getting excited about cmake, does that mean that rustpkg is not going to build rust code anymore?
[06:45:10] <acrichto> lto won't bring down O0 lines
[06:45:28] <eddyb> acrichto: lto + -O3
[06:45:33] <acrichto> benh: there has been talk about separating out the dependency management and build portions of rustpkg
[06:45:47] <acrichto> benh: but no official decision has been made yet about the "blessed" way to build rust cde
[06:45:54] <eddyb> acrichto: did #[boot] not land yet?
[06:46:03] <acrichto> eddyb: not yet, still need to discuss
[06:46:08] <acrichto> I'll be back in SFO on Monday
[06:46:27] <eddyb> with your gist, 82749 lines
[06:46:42] <acrichto> oh well most of that is I/O
[06:46:46] <acrichto> vtables pull it all in
[06:47:05] <acrichto> the "magic" of working with libgreen/libnative seamlessly
[06:47:24] <eddyb> acrichto: how does that work?
[06:47:38] <acrichto> eddyb: there's a vtable of "every I/O constructor"
[06:47:45] <acrichto> and that vtable cannot be optimized away
[06:47:50] <acrichto> b/c you use it in println!
[06:47:56] <acrichto> hence *all* I/O is in all static binaries
[06:48:05] <acrichto> whether it be green or native
[06:48:15] <acrichto> or rather let me put it this way
[06:48:22] <acrichto> all rust code using libstd has a local Task
[06:48:23] <acrichto> in TLS
[06:48:29] <acrichto> inside this Task is a trait object
[06:48:31] <acrichto> 'trait Runtime'
[06:48:48] <acrichto> this ends up meaning that the runtime trait object is considered "used" by llvm
[06:48:54] <acrichto> so it cannot optimize it away (even on LTO)
[06:49:04] <eddyb> oooh, and boot injects that trait object?
[06:49:05] <acrichto> inside this trait object is the dynamic dispatch method of getting at all I/O
[06:49:19] <acrichto> boot injects how the initial Task is set up
[06:49:21] <eddyb> 862 functions btw
[06:49:31] <acrichto> I did a code-size analysis of an LTO binary awhile back
[06:49:36] <acrichto> it's mostly IoFactory
[06:49:41] <acrichto> and also a huge amount of Path
[06:49:49] <acrichto> our Path module has some serious code bloat issue
[06:49:54] <eddyb> acrichto: okay, I was curious about that. I wonder if TBAA could remove some of that
[06:50:05] <acrichto> probably not, this is all necessary
[06:50:09] <acrichto> it's all used in one way or another
[06:50:21] <acrichto> it's unfortunate that a program not using TCP has all the TCP/UDP libraries
[06:50:34] <acrichto> but it's the way things are with our "compile libraries once" requirement
[06:50:53] <acrichto> unless we can think of a way to *only* load that trait object if used
[06:51:08] <acrichto> which may be possible, I haven't thought much about it
[06:53:53] <eddyb> LLVM should know with LTO which trait object was injected and devirtualize everything. now, I know LLVM is bad at devirtualization, but could we give it a push?
[06:55:00] <acrichto> this isn't devirtualization that can happen though
[06:55:09] <acrichto> b/c the object is being loaded from a global
[06:55:17] <acrichto> as in the ~Task comes from a global #[thread_local]
[06:55:23] <acrichto> and out of the ~Task comes the vtable
[06:55:33] <acrichto> I highly doubt LLVM can devirtualize that much
[06:55:56] <eddyb> all LLVM needs to know is that nothing writes to that thread_local after boot injected it
[06:56:15] <acrichto> it's a lot of tracing to do, it may indeed be possible, just speculating
[06:56:25] <eddyb> and since the injection is the first thing that happens, it could be inlined
[06:56:27] <acrichto> LLVM would have to track *all* writes to that pointer
[06:56:33] <acrichto> and make sure they all have the same vtable
[06:56:39] <acrichto> that global is written to many times
[06:56:42] <acrichto> reading/writing from it
[06:56:45] <eddyb> oh :(
[06:57:00] <eddyb> wait, the object or also its vtable?
[06:57:07] <acrichto> the ~Task
[06:57:16] <acrichto> the runtiem is also removed/replaced many times though
[06:57:23] <eddyb> pffffft
[06:57:26] <acrichto> the runtime needs to get decoupled from the Task in order to use it
[06:57:33] <acrichto> lots of ownership dances
[06:58:08] <eddyb> I was also hoping to see the result of format! being inlined, but it doesn't look like it. I should try some simpler heap stuff first though. all the exception nonsense really hinders LLVM's powers
[06:58:17] <eddyb> acrichto: the Cell kind of dances?
[06:58:39] <acrichto> Option
[06:58:55] <acrichto> format! has some serious code behind it
[06:59:05] <acrichto> although I guess in theory it *could* get inlined
[06:59:10] <acrichto> it's *a lot* of code to get inlined though
[06:59:15] <acrichto> b/c you've got to go across a MemWriter
[06:59:22] <eddyb> :/
[06:59:26] <acrichto> lots of inlining/devirtualization would need to happen
[06:59:36] <eddyb> is it a virtual MemWriter?
[06:59:41] <acrichto> it's like printf in C, you can't optimize that to a write()
[06:59:52] <eddyb> (the next question is "why??")
[06:59:52] <acrichto> yes
[07:00:12] <acrichto> code bloat
[07:00:26] <eddyb> since format! always produces ~str, I don't see the problem
[07:00:28] <acrichto> format! is used in lots and lots of places
[07:00:40] <acrichto> it uses the same infrastructure that can write to any Writer
[07:00:51] <eddyb> oh, so the same thing as write!?
[07:01:01] <acrichto> yeah
[07:05:48] <eddyb> added to my TODO list. we might just be missing perf there if LLVM can optimize that code
[07:11:55] *** Joins: Diamond (dick@moz-80556682.ks.ks.cox.net)
[07:16:11] *** Quits: tupshin_ (quassel@moz-54DE2E9C.du.xdsl.is) (Ping timeout)
[07:22:06] *** Joins: tupshin_ (quassel@moz-54DE2E9C.du.xdsl.is)
[07:29:01] <eddyb> it's not RevokeClean causing double frees :(
[07:31:59] *** Joins: jack (sid19593@moz-A42E5B7B.irccloud.com)
[07:51:59] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[07:51:59] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/8Mrq5Q
[07:51:59] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[07:56:54] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[07:56:54] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/tKYiZQ
[07:56:54] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[07:56:58] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[07:56:58] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/9zvGVA
[07:56:58] <ghrust> 13rust/06auto 14f032237 15Julia Evans: Add testing tutorial to docs
[07:56:58] <ghrust> 13rust/06auto 14bb9c5c4 15bors: auto merge of #11052 : jvns/rust/testing-tutorial, r=brson...
[07:56:58] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[07:57:41] *** Joins: lpy (lpy@7360AA58.F09091A8.1348A864.IP)
[08:00:06] *** flaper87|afk is now known as flaper87
[08:13:24] <eddyb> dbaupp: haha, I think std::from_buf_len allocates a string, writes to it, then frees it. oops :P
[08:30:30] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:42:52] <eddyb> o_O this only happens when calling the function cross-crate
[08:43:07] <eddyb> or rather, std is compiled wrong, my test isn't
[08:45:53] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[08:45:54] <ghrust> 01[13rust01] 15alexcrichton 04force-pushed 06try from 1452e5b1e to 14c46f51a: 02http://git.io/k471pw
[08:45:54] <ghrust> 13rust/06try 14e9372ec 15Alex Crichton: Implement std::rt::at_exit...
[08:45:54] <ghrust> 13rust/06try 14c46f51a 15Alex Crichton: Implement native timers...
[08:45:54] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[08:46:19] <eddyb> no, same problem, I just can't get free to abort on double-free
[08:47:04] *** Quits: gwty (gwtypc@75A7448E.8DB61C28.F44414AF.IP) (Ping timeout)
[08:47:19] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:47:23] <eddyb> transmute seems to free its argument
[09:00:08] <eddyb> dbaupp, cmr: we need this as an intrinsic or something, it's useful for inspecting LLVM output: #[inline(never)] fn BOO() {unsafe {*(1 as *mut u8) = 1;}}
[09:00:30] <eddyb> actually, let me add #[no_mangle], that should make it even clearer
[09:03:36] *** Quits: lpy (lpy@7360AA58.F09091A8.1348A864.IP) (Quit: Leaving...)
[09:11:07] <eddyb> oooooh, I must've broken the double free protection in the free glue
[09:11:53] <eddyb> which is kinda stupid, because it could be statically removed
[09:11:59] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[09:11:59] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/9zvGVA
[09:11:59] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[09:16:53] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[09:16:53] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/hZ4Cwg
[09:16:53] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[09:16:53] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[09:16:53] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/ZgJHTQ
[09:16:53] <ghrust> 13rust/06auto 14a2a6720 15Alex Crichton: Add read_to_str and write_{str, line}...
[09:16:53] <ghrust> 13rust/06auto 14bfde029 15bors: auto merge of #10861 : alexcrichton/rust/iostr, r=pcwalton...
[09:16:54] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[09:23:06] <eddyb> how on earth does this not cause a double free? let x = ~15; let y: *int = unsafe{::std::unstable::intrinsics::transmute(x)}; let z1: ~int = unsafe{::std::unstable::intrinsics::transmute(y)};
[09:23:26] <eddyb> ooooh, I see, the value is moved into transmute. derp
[09:23:50] <eddyb> it has nothing to do with zeroing things
[09:37:48] *** Quits: tupshin_ (quassel@moz-54DE2E9C.du.xdsl.is) (Ping timeout)
[09:39:35] <eddyb> oh, yes it does. kdiff3 to the rescue :D
[09:49:01] <eddyb> nmatsakis: Datum.add_clean has a comment // Schedules this datum for cleanup in `bcx`.  The datum must be an rvalue.
[09:49:33] <eddyb> nmatsakis: and then revoke_clean has another comment // Lvalues which potentially need to be dropped must be passed by ref, so that we can zero them out.
[09:49:56] <eddyb> nmatsakis: so what am I supposed to do when datumizing arguments?
[09:55:14] <eddyb> s/revoke_clean/Datum.cancel_clean
[10:06:18] *** Quits: jdm (jdm@moz-3FFA85CA.dsl.teksavvy.com) (Quit: Lost terminal)
[10:09:43] <eddyb> nmatsakis: it almost looks like Datum.move_to called on a ByValue Datum is broken. the code looks like it could work with a ByValue, but there's a comment // Since it needs to zero out the source, src also needs to be an lval.
[10:18:50] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[10:18:50] <ghrust> 01[13rust01] 15alexcrichton 04force-pushed 06try from 14c46f51a to 14c768129: 02http://git.io/k471pw
[10:18:50] <ghrust> 13rust/06try 14c768129 15Alex Crichton: Implement native timers...
[10:18:50] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[10:23:07] *** Joins: tupshin_ (quassel@moz-54DE2E9C.du.xdsl.is)
[10:36:53] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[10:36:53] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/ZgJHTQ
[10:36:53] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[10:41:51] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[10:41:51] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/hwzX_Q
[10:41:51] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[10:41:53] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[10:41:53] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/xUx8Ow
[10:41:53] <ghrust> 13rust/06auto 14cc0eb89 15Jan Niklas Hasse: Make rustc's own lib directory configurable and change the default to rustlib. Fixes #3319
[10:41:53] <ghrust> 13rust/06auto 1400fbb64 15bors: auto merge of #11118 : jhasse/rust/patch-rustlibdir, r=alexcrichton...
[10:41:53] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[10:51:50] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[10:51:50] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 1400fbb64 to 14bfde029: 02http://git.io/N3iJvQ
[10:51:50] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[10:51:54] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[10:51:54] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/ZmTV5g
[10:51:54] <ghrust> 13rust/06auto 14ade8b0a 15Alex Crichton: Remove std::either
[10:51:54] <ghrust> 13rust/06auto 14a7e9862 15bors: auto merge of #11149 : alexcrichton/rust/remove-either, r=brson...
[10:51:54] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[11:04:53] <eddyb> revoke_clean([block 52], { i64, i64, [0 x i8] }*) revoking None :(
[11:32:42] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[11:32:42] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/VmdF0Q
[11:32:42] <ghrust> 13rust/06auto 1432eaa12 15Brian Anderson: Don't allow single-variant enums to be dereferenced. #6246...
[11:32:42] <ghrust> 13rust/06auto 14c755cf0 15Brian Anderson: Don't allow newtype structs to be dereferenced. #6246
[11:32:42] <ghrust> 13rust/06auto 1439d23e4 15Brian Anderson: rustc: Add error about obsolete struct deref
[11:32:45] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[11:35:00] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[11:36:13] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[11:51:50] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[11:57:27] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[12:20:10] *** Joins: a_m0d|home (a_m0d@moz-322A4DE4.acanac.net)
[12:30:23] *** Quits: luz (lucy@moz-CD18B14B.customer.cdi.no) (Ping timeout)
[12:32:01] <eddyb> nmatsakis: so moving out of function arguments is broken (theoretically), even on master. it only works there because it's always ByRef(ZeroMem). if it is ByValue or ByRef(RevokeClean), revoke_clean can't find the argument in the cleanups
[12:32:09] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[12:32:09] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14f081eb6 to 14bfde029: 02http://git.io/N3iJvQ
[12:32:09] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[12:33:45] <dbaupp> eddyb: can you construct an example that crashes? (out of interest)
[12:33:55] *** Joins: luz (lucy@moz-CD18B14B.customer.cdi.no)
[12:34:47] *** Quits: a_m0d|home (a_m0d@moz-322A4DE4.acanac.net) (Quit: Leaving.)
[12:35:25] <eddyb> dbaupp: on master? no, it's always going to use ByRef(ZeroMem) (which causes bloat btw)
[12:36:21] <eddyb> the problem is that it's going through a generic interface which fails to match the argument with the value (supposedly the same one as the argument) of the cleanup which was added
[12:37:22] <eddyb> dbaupp: my test is fn foo(x: ~[u8]) -> ~str {unsafe{::std::unstable::intrinsics::transmute(x)}}let x = foo(~[66]);
[12:38:38] <eddyb> dbaupp: I now think that I can use something simpler than transmute, to get even cleaner IR. what triggers it is foo moving out of x and into a function argument
[12:39:23] <eddyb> revoke_clean([block 52], { i64, i64, [0 x i8] }*) revoking (0x183bac0 as *()) from &mut ~[]
[12:39:32] <eddyb> it's... not there
[12:40:35] <eddyb> (and it takes like 15min+ to even add that little piece of debugging)
[12:42:59] <dbaupp> yay bootstraps! :P
[12:43:12] <dbaupp> (you are doing rustc-stage1, right?)
[12:43:37] <eddyb> yeah
[12:43:53] <eddyb> so the only thing I can think of right now... is that the cleanup is in the wrong scope
[12:45:38] <eddyb> I removed the unsafe block wrapping the transmute call, same thing
[12:49:10] <dbaupp> um, how did it compile without the unsafe block?
[12:51:08] <eddyb> by moving the unsafety up
[12:52:51] <dbaupp> oh, unsafe fn foo()
[13:04:48] <eddyb> if the scope differs, I have no idea how to fix it
[13:07:56] *** Joins: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca)
[13:13:12] <eddyb> dbaupp: AFAICT, the revoke is done on the function while the cleanup is added on the block
[13:13:32] <eddyb> I have no idea how to fix this
[13:13:38] * dbaupp is a rubber duck
[13:21:19] *** Quits: tupshin_ (quassel@moz-54DE2E9C.du.xdsl.is) (Ping timeout)
[13:21:41] <eddyb> wait, is this safe? since you can move out of arguments conditionally
[13:22:59] <eddyb> I mean, would what I'm doing work for this? fn foo(x: T) -> T{if pred(&x) {x} else {x.clone()}}
[13:23:18] <eddyb> there's no way for it to cancel the cleanup for one branch and not the other
[13:23:34] <eddyb> nmatsakis: have you fixed this? if you did, then it means I have to wait for your PR
[13:25:33] *** Joins: gwty (gwtypc@FCD031E2.AE087544.25B273F5.IP)
[13:25:50] <dbaupp> aiui, the plan is to require moving out in both branches
[13:26:05] <dbaupp> so it'd have to be `let ret = x.clone(); drop(x); ret` in the else branch
[13:27:31] <eddyb> dbaupp: the codegen will be so much better IMO. I hope one day we can completely get rid of zero checks, it's such a hack
[13:32:50] <dbaupp> eddyb: i.e. the drop flag?
[13:32:54] <dbaupp> yup
[13:33:05] <dbaupp> pcwalton et al. want to get rid of that
[13:33:07] <eddyb> dbaupp: it also zeroes any pointers to cancel cleanup
[13:34:45] <dbaupp> "yay"
[13:41:55] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[13:41:55] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/Bp61sg
[13:41:55] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[13:46:50] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[13:46:50] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/vsdWwg
[13:46:50] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[13:46:53] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[13:46:53] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/gbwftg
[13:46:53] <ghrust> 13rust/06auto 14dd33b14 15Alex Crichton: Fix usage of rustc --ls on invalid files...
[13:46:53] <ghrust> 13rust/06auto 148d47190 15bors: auto merge of #11262 : alexcrichton/rust/issue-11259, r=pcwalton...
[13:46:53] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[13:59:51] *** Joins: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net)
[14:05:49] *** Quits: gwty (gwtypc@FCD031E2.AE087544.25B273F5.IP) (Client exited)
[14:11:12] <eddyb> dbaupp: oh, this crashes fn foo(x: ~int) -> ~int {x}
[14:22:33] *** Joins: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP)
[14:48:17] <eddyb> dbaupp: added a comment to make the situation clear
[14:56:03] *** Quits: eddyb (eddy@EE946B63.921A1753.FCAAE698.IP) (Ping timeout)
[14:56:47] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[14:56:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/gbwftg
[14:56:48] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[15:02:02] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[15:02:03] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/gVP4ow
[15:02:03] <ghrust> 13rust/06auto 148965e34 15a_m0d: Add linting for `crate_type` attribute values....
[15:02:03] <ghrust> 13rust/06auto 14f083931 15bors: auto merge of #11264 : am0d/rust/crate_type_lint, r=alexcrichton...
[15:02:03] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[15:02:05] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[15:02:05] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/w_b9WQ
[15:02:05] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[15:02:38] <dbaupp> rusti: fn foo(x: ~int) -> ~int {x} foo(~1)
[15:02:38] -rusti- ~1
[15:07:57] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[15:19:18] <bjz> what is the difference between quote_expr and quote_stmt
[15:19:57] <bjz> does one just emit a statement?
[15:21:00] <bjz> so if I had: `quote_expr!(cx, write!($buf, "{}", *$x))`, could I just do `quote_stmt!(cx, write!($buf, "{}", *$x))` to get a statement?
[15:24:31] *** Quits: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP) (Ping timeout)
[15:27:03] *** Joins: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP)
[15:27:56] <bjz> what is the `expr: Option<@Expr>,` bit of ast::Block for?
[15:32:45] *** Quits: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au) (Ping timeout)
[15:35:31] *** Quits: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca) (Quit: canhtak)
[15:41:11] *** Quits: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net) (Connection reset by peer)
[15:42:40] *** Joins: tedh (tedh@moz-F3B34318.hsd1.il.comcast.net)
[15:43:22] *** Quits: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP) (Ping timeout)
[15:43:56] *** Joins: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP)
[15:46:47] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[15:46:48] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14f083931 to 148d47190: 02http://git.io/N3iJvQ
[15:46:48] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[15:56:41] *** Joins: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca)
[16:07:23] *** Quits: jdm (jdm@CC0122E6.8F96AEA7.2D179A7D.IP) (Quit: Lost terminal)
[16:33:39] *** Quits: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca) (Quit: canhtak)
[16:33:47] *** Quits: Kxepal (Miranda@moz-9E54938F.pppoe.mtu-net.ru) (Ping timeout)
[16:34:51] *** Joins: Kxepal (Miranda@moz-244F811C.pppoe.mtu-net.ru)
[16:35:18] *** Joins: jdm (jdm@13F2CEC5.7672369.D8E68FF6.IP)
[16:41:47] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[16:41:47] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14bf44412 to 148d47190: 02http://git.io/N3iJvQ
[16:41:47] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[16:41:47] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[16:41:48] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/HrDz7Q
[16:41:48] <ghrust> 13rust/06auto 1433c7d76 15matt-auld: Update references to rustc.rc in README.
[16:41:48] <ghrust> 13rust/06auto 14a1cb8dc 15bors: auto merge of #11275 : matt-auld/rust/update_readme, r=pcwalton
[16:41:48] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[16:50:24] *** Joins: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca)
[17:20:12] *** Joins: brson (brson@moz-BBE3ABD.mv.mozilla.com)
[17:20:12] *** ChanServ sets mode: +qo brson brson
[17:25:28] *** flaper87 is now known as flaper87|afk
[17:26:21] *** Quits: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net) (Quit: NO CARRIER)
[17:27:18] *** Joins: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net)
[17:30:03] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[17:30:03] *** ChanServ sets mode: +ao pcwalton pcwalton
[17:51:47] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[17:51:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/HrDz7Q
[17:51:47] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[17:51:57] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[17:56:47] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[17:56:47] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/Y34maw
[17:56:47] <ghrust> 13rust/06auto 1456ec9c2 15Brian Anderson: Bump version to 0.9
[17:56:47] <ghrust> 13rust/06auto 1411ce6b7 15bors: auto merge of #11276 : brson/rust/0.9, r=pcwalton
[17:56:47] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[17:56:49] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[17:56:49] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/-ySlhQ
[17:56:49] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[17:58:14] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[17:58:14] <ghrust> 01[13rust01] 15brson merged 06master into 06dist-snap: 02http://git.io/QIyceQ
[17:58:15] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[18:07:22] *** Joins: eddyb (eddy@EE946B63.921A1753.FCAAE698.IP)
[18:08:21] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[18:09:29] *** Joins: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net)
[18:09:29] *** ChanServ sets mode: +ao dherman dherman
[18:13:24] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[18:13:24] <ghrust> 01[13rust01] 15alexcrichton 04force-pushed 06try from 14c768129 to 143a30751: 02http://git.io/k471pw
[18:13:24] <ghrust> 13rust/06try 143a30751 15Alex Crichton: Implement native timers...
[18:13:24] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[18:19:13] *** Joins: lkuper (lkuper@moz-D862222C.dhcp-bl.indiana.edu)
[18:27:58] <jack> is it possible for a Chan to not fulfill Send?
[18:35:21] <brson> jack: I don't think so
[18:59:54] <brson> it seems like we're no longer doing any x86 cross-compiles on the bots :-(
[19:00:01] *** Joins: doomlord_ (servitor@moz-CA917A47.range86-184.btcentralplus.com)
[19:06:44] *** Quits: TimAbraldes (quassel@moz-7FD19BDC.hsd1.or.comcast.net) (Ping timeout)
[19:06:45] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[19:06:45] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/Y34maw
[19:06:45] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[19:07:36] <olsonjeffery> \o/
[19:08:54] *** Joins: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com)
[19:08:55] *** ChanServ sets mode: +ao pcwalton pcwalton
[19:11:44] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[19:11:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/J-2R9g
[19:11:44] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[19:11:47] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[19:11:47] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/UoeBBQ
[19:11:47] <ghrust> 13rust/06auto 144bea679 15Alex Crichton: Remove std::either
[19:11:47] <ghrust> 13rust/06auto 14479d5e3 15bors: auto merge of #11149 : alexcrichton/rust/remove-either, r=brson...
[19:11:47] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[19:15:53] *** Quits: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net) (Quit: dherman)
[19:22:15] *** Joins: TimAbraldes (quassel@moz-CD87643E.hfc.comcastbusiness.net)
[19:41:53] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[19:59:24] *** kimundi is now known as zz_kimundi
[19:59:48] *** Quits: eddyb (eddy@EE946B63.921A1753.FCAAE698.IP) (Ping timeout)
[20:16:49] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[20:16:49] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14479d5e3 to 1411ce6b7: 02http://git.io/N3iJvQ
[20:16:49] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[20:16:50] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[20:16:50] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/x5VR9g
[20:16:50] <ghrust> 13rust/06auto 144bea679 15Alex Crichton: Remove std::either
[20:16:50] <ghrust> 13rust/06auto 1408321f1 15bors: auto merge of #11149 : alexcrichton/rust/remove-either, r=brson...
[20:16:50] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[20:32:26] *** Quits: TimAbraldes (quassel@moz-CD87643E.hfc.comcastbusiness.net) (Ping timeout)
[20:37:39] *** Quits: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com) (Quit: pcwalton)
[20:37:53] *** flaper87|afk is now known as flaper87
[20:39:56] *** Joins: TimAbraldes (quassel@moz-7FD19BDC.hsd1.or.comcast.net)
[20:53:32] <bjz> what is the `expr: Option<@Expr>,` field of ast::Block used for?
[20:54:56] <sfackler> bjz: it's the expression at the end of the block that gives the return value
[20:55:27] <bjz> sfackler: ohh
[20:55:54] <bjz> what happens if you use None?
[20:56:04] <bjz> does it return nil?
[20:56:45] <sfackler> I think so
[20:57:01] <sfackler> for blocks that end with a semicolon terminated statement
[21:04:05] <bjz> is it possible to work out whether a non-self argument is a Struct or EnumMatching in deriving?
[21:05:43] <bjz> there is a vector of non-self args, but they are @Exprs
[21:09:53] *** zz_kimundi is now known as kimundi
[21:15:37] *** Joins: mib_if50nk (Mibbit@7B4B4A5D.C090BA12.80995853.IP)
[21:17:52] *** Quits: mib_if50nk (Mibbit@7B4B4A5D.C090BA12.80995853.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[21:18:29] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[21:18:29] *** ChanServ sets mode: +ao pcwalton pcwalton
[21:19:13] *** Joins: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net)
[21:19:13] *** ChanServ sets mode: +ao dherman dherman
[21:21:13] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Client exited)
[21:26:49] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[21:26:49] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/x5VR9g
[21:26:49] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[21:32:04] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[21:32:04] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/sslzow
[21:32:04] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[21:33:11] *** Joins: eddyb (eddy@EE946B63.921A1753.FCAAE698.IP)
[21:43:20] *** Quits: wtw (wtw@moz-D8FB7390.org) (Quit: leaving)
[21:43:26] *** Joins: wtw (wtw@moz-D8FB7390.org)
[21:47:52] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[21:47:52] *** ChanServ sets mode: +o tjc
[21:56:13] <pcwalton> brson: do you know why bors isn't picking up https://github.com/mozilla/rust/pull/11251 ?
[21:56:36] *** Quits: wtw (wtw@moz-D8FB7390.org) (Quit: leaving)
[21:57:41] <brson> pcwalton: no. bors missed one of mine the other day too that said 'r=alexcrichton p=1'
[21:57:44] <brson> i r+ed
[21:57:57] <pcwalton> ok, thanks
[22:06:12] <brson> pcwalton: maybe the last commit isn't the 'head' commit
[22:06:23] <brson> i know sometimes github displays them in an unexpected order
[22:06:37] <pcwalton> indeed it's not! thank you
[22:08:20] *** Joins: msm (Mibbit@moz-A3C5D209.hsd1.ga.comcast.net)
[22:08:22] *** Quits: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net) (Quit: dherman)
[22:09:14] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Ping timeout)
[22:12:06] *** Joins: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net)
[22:12:06] *** ChanServ sets mode: +ao dherman dherman
[22:12:08] *** Quits: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net) (Quit: dherman)
[22:12:46] <pcwalton> brson: bors found it :)
[22:14:28] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[22:22:45] <brson> acrichto: maybe you can make sense of this https://github.com/mozilla/rust/pull/11292
[22:29:53] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[22:29:53] *** ChanServ sets mode: +ao pcwalton pcwalton
[22:31:42] *** Quits: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net) (Ping timeout)
[22:41:51] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[22:41:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/bRW8Zg
[22:41:51] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[22:43:16] <jack> how do i get this now post green/native split?
[22:43:16] <jack>         let c = task.get().coroutine.get_ref();
[22:46:45] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[22:46:45] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/g9eeJQ
[22:46:45] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[22:46:48] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[22:46:48] <ghrust> 01[13rust01] 15bors pushed 59 new commits to 06auto: 02http://git.io/k5T6RA
[22:46:48] <ghrust> 13rust/06auto 14f553701 15Patrick Walton: libsyntax: De-`@mut` `ParseSess::included_mod_stack`
[22:46:48] <ghrust> 13rust/06auto 143aa19a6 15Patrick Walton: librustc: De-`@mut` the parse session
[22:46:49] <ghrust> 13rust/06auto 14b33386d 15Patrick Walton: libsyntax: De-`@mut` `StringReader::pos`
[22:46:51] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[22:47:13] <jack> acrichto, brson: ^
[22:49:32] <jack> maybe_take_runtime() returns a GreenTask?
[22:51:37] <jack> oh god. that removes it from teh task. that seems bad.
[22:54:18] *** Joins: a_m0d|home (a_m0d@moz-322A4DE4.acanac.net)
[22:54:32] <jack> at least I can put it back.
[22:55:43] <sfackler> jack: any chance you could update https://github.com/mozilla/rust/pull/11086 ?
[22:55:51] <sfackler> it looks like it just needs a line cut down in length
[22:55:54] <jdm> pcwalton: are you removing @mut from the language?
[22:56:00] <sfackler> and maybe a rebase
[22:56:01] <jdm> if so, that's going to be a fun servo upgrade
[22:56:14] <brson> jack: yeah, Local::take, then task.maybe_take_runtime then task.put_runtime, then Local::put it looks like
[22:56:16] <jack> jdm: NOT IT
[22:56:18] <pcwalton> jdm: yes, I already did in a patch
[22:56:50] <jack> brson: send_deferred is dead and gone right?
[22:57:10] <brson> jack: i think it still exists in some form for now
[22:57:24] <brson> it's just try_send_deferred
[22:58:30] <jack> f64 is not TotalOrd??
[22:58:38] <jack> so i can't sort a vec of floats.
[23:00:07] <sfackler> there isn't a total ordering on floats
[23:00:20] <sfackler> you should be able to use sort_by
[23:00:48] <sfackler> http://static.rust-lang.org/doc/master/std/vec/trait.MutableVector.html#tymethod.sort_by
[23:01:15] <jack> sure, but now i have to write my own compare.
[23:01:56] <jack> I'm pretty sure people are going to think we're insane that sort doesn't work on a vector of floats.
[23:02:02] <pcwalton> jack: you may want to wait on niko's lifetime extension stuff to land. ETA next week.
[23:02:09] <pcwalton> it'll make the transition away from @mut much easier.
[23:02:41] <pcwalton> jack: there's been discussion about just removing TotalOrd
[23:02:49] <pcwalton> in which case it would work
[23:05:23] <jack> if you can't deref a newtype struct, how do you get at the underlying value now?
[23:05:45] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[23:05:48] <jack> oh nm. i see deref still works. misread the error message.
[23:07:08] <jack> SharedChan has no send_deferred. have we just decided that there's no need to avoid descheduling?
[23:07:17] <jack> (servo uses it for the profiler)
[23:07:50] <kimundi> jack: In any case, you get to the value by pattern matching
[23:08:17] <pcwalton> jack: I think it doesn't make sense for 1:1 so it was removed
[23:08:23] <pcwalton> we can just 1:1 the profiler task
[23:08:37] <pcwalton> that brings the same benefits of send deferred basically
[23:10:05] *** Quits: lkuper (lkuper@moz-D862222C.dhcp-bl.indiana.edu) (Ping timeout)
[23:12:57] <jack> why did we replace tim_sort iwth a sort that requires totalord?
[23:13:01] <jack> because we wanted it to be stable?
[23:13:21] <pcwalton> I think so. you'd need to ask brson to be sure.
[23:13:36] <pcwalton> also tim_sort was really slow as implemented
[23:13:44] <brson> jack: we don't want there to be a need to avoid descheduling. the profiler uses it because of performance? to avoid the context switches?
[23:14:15] <pcwalton> brson: the context switches were very large in my profiles
[23:14:18] <brson> i don't know why we put totalord on the new sort, but we did want it to be stable
[23:14:21] <jack> brson: the profiler is sending messages about timing info. it will be silly to deschedule for that, and pretty much ruin the performance we're measuring
[23:15:41] <strcat> jack: probably because TotalOrd is more efficient for strings and so on
[23:15:54] *** flaper87 is now known as flaper87|afk
[23:16:04] <strcat> jack: https://github.com/thestinger/rust-core/blob/master/core/cmp.rs I'd rather just have it like this. no impls for floats
[23:16:08] <strcat> and just use sort_by for floats
[23:16:42] <strcat> then Ord can inherit from Eq (in a sensible way), you can have a cmp method for efficient string ordering, and sensible laws
[23:17:01] <strcat> what good is a trait not providing any rules? ;p
[23:17:15] <jack> if there was a cmp for ord that just did if a < b { Less } else { Greater }, that would be fine i suppose
[23:17:33] <strcat> jack: but wrong for floats
[23:17:34] <jack> but having to retype the same stupid comparator everytime i want to sort makes me mad
[23:17:50] <jack> strcat: that is what people are going to do unless we fix this.
[23:18:04] <jack> we can say it's wrong all we want
[23:18:16] <jack> i mean, it's what i'm doing
[23:18:19] <strcat> so what is fixing it? imo fixing it is offering specialized min/max/clamp and so on for floats
[23:18:24] <strcat> because they need to be done differently
[23:18:30] <strcat> and not having floats impl Ord/Eq
[23:18:34] <jack> because I'm too lazy to write the correct implementation
[23:18:34] <strcat> and not having TotalEq/TotalOrd
[23:19:05] <pcwalton> we could have floats implement Eq/Ord for convenience with a big disclaimer saying "this is evil"
[23:19:09] <jack> i mena, the naive thing works if there are no NaNs.
[23:19:14] <pcwalton> yeah
[23:19:25] <jack> I assume that's what all the C libraries assume
[23:19:30] <jack> and python, etc
[23:19:36] <jack> and if there is NaN, the sort isn't stable.
[23:19:44] <kimundi> is NaN the only evil value for floats for ordering?
[23:19:57] <strcat> jack: or correct at all, depending on how you implement it
[23:20:00] <pcwalton> there's also +/-0 but I forget whether that causes problems
[23:20:03] <strcat> it might interleave the NaNs
[23:20:14] <strcat> jack: lets say you have a refcounted box type
[23:20:24] <strcat> if Eq is sane, you can compare the address and then call the inner Eq impl
[23:20:28] <strcat> if Eq is as it is now, you can't.
[23:20:37] <strcat> the current Eq trait is *not* useful, because it doesn't say anything
[23:20:42] <strcat> what does it mean? other than '== is overloaded'
[23:20:44] <strcat> it doesn
[23:20:48] <strcat> doesn't mean anything*
[23:20:52] <strcat> a trait without rules is a useless trait
[23:20:56] <jack> I'm not talking about Eq :)
[23:21:01] <strcat> Ord too, then
[23:21:25] <jack> Ord and TotalOrd certainly exist for f64 when NaN and Inf aren't involved.
[23:21:33] <jack> and Inf i think works fine.
[23:21:50] <strcat> jack: the defined total ordering on floats per IEEE754 is not the same as the weak ordering
[23:21:55] <strcat> with or without NaN
[23:22:20] <kimundi> Just have Ord abort the process on NaN, problem solved ;P
[23:22:34] <strcat> so Ord shouldn't do the same thing as <, >, etc. ?
[23:23:13] <strcat> having TotalEq/TotalOrd is pointless imo
[23:23:20] *** Joins: tjc (tjc@moz-9872E99C.tmodns.net)
[23:23:20] *** ChanServ sets mode: +o tjc
[23:23:21] <strcat> just make those the guarantees on the normal ones
[23:23:23] <strcat> much simpler
[23:23:34] <jack> quicksort was removed?
[23:23:50] <strcat> jack: yes, the merge sort is faster
[23:23:58] <strcat> and if you don't want allocation there's a heap sort 
[23:24:23] *** Quits: canhtak (canhtak@moz-59105D0.wl.t.ulaval.ca) (Quit: canhtak)
[23:26:18] <strcat> anyone looking at rust is going to wonder why we need four comparison traits
[23:26:24] <strcat> two of which provide no guarantees whatsoever
[23:26:33] <strcat> and Eq/Ord aren't related to each other
[23:27:15] <strcat> having to remember to derive all 4 is great
[23:27:28] <strcat> and having no sugar for the sensical operations
[23:27:30] * strcat shrugs
[23:29:17] <jack> where did spawn_sched go?
[23:29:54] *** Quits: jdm (jdm@13F2CEC5.7672369.D8E68FF6.IP) (Quit: Lost terminal)
[23:30:35] <sfackler> is there a defined order of destruction of struct fields?
[23:30:35] <jack> so do i need to do native::task::spawn now instead of spawn_sched(SingleThreaded) ?
[23:30:48] *** Quits: msm (Mibbit@moz-A3C5D209.hsd1.ga.comcast.net) (Quit: http://www.mibbit.com ajax IRC Client)
[23:30:52] <strcat> jack: or just put it in 1:1 mode
[23:31:11] <jack> strcat: how does one do that?
[23:31:24] <strcat> jack: umm, I think some attribute, don't remember though ;[
[23:31:25] <dbaupp> strcat: isn't that exactly how one puts something in 1:1 mode (using libnative)?
[23:31:39] <strcat> dbaupp: you can use both, though, afaik
[23:31:40] *** Quits: tjc (tjc@moz-9872E99C.tmodns.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[23:31:51] <jack> I guess my question is do I have to use both now?
[23:32:00] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[23:32:00] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14b121274 to 14d3ae3a2: 02http://git.io/N3iJvQ
[23:32:00] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[23:32:02] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[23:32:02] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/o0DMDw
[23:32:02] <ghrust> 13rust/06auto 1498066ad 15Brian Anderson: Don't allow single-variant enums to be dereferenced. #6246...
[23:32:02] <ghrust> 13rust/06auto 14a81e793 15Brian Anderson: Don't allow newtype structs to be dereferenced. #6246
[23:32:02] <ghrust> 13rust/06auto 145290b29 15Brian Anderson: rustc: Add error about obsolete struct deref
[23:32:04] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[23:32:08] <dbaupp> strcat: I'd guess jack doesn't want the whole of servo in 1:1 mode
[23:32:13] <strcat> why not?
[23:32:21] <dbaupp> jack: ask acrichto
[23:32:41] *** Joins: wtw (wtw@moz-D8FB7390.org)
[23:32:42] <pcwalton> eventually script/layout should be M:N once we have the operation callback working
[23:32:42] <jack> strcat: because reasons? :)
[23:32:53] <pcwalton> so that script->layout queries don't go through the kernel
[23:32:57] <pcwalton> if they're blocking
[23:33:01] <strcat> pcwalton: shouldn't they be a form of task without stacks at all?
[23:33:06] <strcat> or do they need to do I/O
[23:33:22] <pcwalton> sometimes they're nonblocking and sometimes they're blocking
[23:33:28] <pcwalton> depends on the type of query
[23:33:33] <pcwalton> but in the blocking case you need it to be super fast
[23:33:44] <pcwalton> also you can't restart the layout task
[23:33:55] <pcwalton> it could also be done with some sort of mechanism that lets you temporarily steal the layout's heap
[23:34:00] <pcwalton> but this is not implemented
[23:34:16] <brson> jack: native::task::spawn is the replacement for spawn_sched, yes
[23:36:09] <jack> brson: do you recommend I use that or SchedPool::new with PoolConfig.threads = 1?
[23:36:31] <brson> jack: use native::task::spawn
[23:36:39] <jack> i mean, the native schedule has no i/o right?
[23:36:48] <brson> it does have most types of i/o
[23:36:49] <jack> that's going to kind of suck for the script task :)
[23:36:52] <jack> ok
[23:36:58] * strcat learned ruby this week and really hates it ;p
[23:36:59] <brson> what i/o does the script task use?
[23:37:09] <jack> script parses the html 
[23:37:26] <brson> really? it doesn't spawn another task for that?
[23:37:30] <jack> it does
[23:37:34] <jack> but i assume native spawns native
[23:37:35] <brson> oh, but one thing you need to be careful of is subtasks
[23:37:36] <brson> yeah
[23:37:52] <brson> unless you explicitly use a pool it will create native subtasks
[23:37:57] <brson> hm
[23:38:14] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[23:38:47] <brson> that's an interesting problem since you mostly don't want to have multiple pools
[23:39:11] <brson> when you create your main thread in servo it'll be a native task now, and so you'll have to create your own green thread pool
[23:39:31] <strcat> brson: hm, what hurts about having multiple pools?
[23:39:33] <brson> you might stuff it in a mutex and share the pool itself with the script tasks
[23:39:50] <jack> that pool has to be shared everywehre.
[23:39:56] <jack> we use spawn() a lot
[23:40:06] <brson> it only needs to be shared with native tasks
[23:40:13] <brson> green tasks will spawn directly into their pool
[23:40:24] <jack> also, the script task depends on GreenTask :(
[23:40:30] <jack> becuase it needs to get stack bounds
[23:40:43] <strcat> jack: to tell spidermonkey?
[23:40:44] <jack> i suppose there is some similar thing to the coroutine stuff in native::task?
[23:42:04] <brson> jack: i don't see the bounds stored in the native task, but you can get at least one of the pointers via std::unstable::stack::get_sp_limit
[23:42:09] <brson> that will give you the low number
[23:42:23] <brson> and for the high number you can just grab the contents of sp at some point
[23:43:30] <brson> strcat: having multiple pools means your not scheduling those tasks together. it should be less efficient since there's more scheduler work and less task work
[23:43:47] <jack> I don't suppose you'd like to add get_sp_high to libnative? :)
[23:44:00] <jack> this is going to be a bigger change that I was expecting.
[23:50:24] *** Joins: tjc (tjc@moz-6EB4E533.dsl.tsoft.com)
[23:50:24] *** ChanServ sets mode: +o tjc
[23:50:39] <brson> jack: get_sp_high is going to be equal to get_sp_limit() + std::rt::env::min_stack() - 1024
[23:50:45] *** Joins: geoffhill (geoffhill@moz-738DC0DB.org)
[23:51:31] <brson> I'll file an issue to make this information available for all tasks
[23:51:55] <jack> brson: cool. that will help.
[23:52:07] <jack> that will work in both green and native mode?
[23:52:27] <jack> is there any reason not to just switch servo to 1:1 for now?
[23:54:31] <acrichto> brson: dunno bout that makefile thing, I've seen that error before but I have no idea why reording fixes it...
[23:54:54] <acrichto> jack: yeah you found maybe_take_runtime(), you need to have previous knowledge that you're dealing with a green task before you can look at the coroutine
[23:56:02] <acrichto> jack: that's just for stack bounds right? we should probably do that for native task anyway and expose it directly on the Task structure
[23:56:08] <brson> jack: green threads don't subtract 1024
[23:56:34] <brson> jack: servo could use native threads
[23:57:09] <brson> it would be disappointing, since we're counting on servo wanting green threads to make them worth maintaining
[23:57:32] <brson> the ultimate goal was for spidermonkey to use green threads, not native
[23:57:55] <brson> but to do that it needs to grow and shrink the pool when spawning a spidermonkey task, and right now we can't actually shrink the pool
[23:58:30] <acrichto> we can "request a shrink"
[23:58:39] <acrichto> but without migrating uv handles we can't actually fully remove a scheduler just yet
[23:58:45] <jack> not sure what you mean about needing to grow and shrink the pool
[23:59:23] <brson> if you don't grow the pool of scheduler threads then you can have all your threads blocking in user js scripts
[23:59:26] <brson> 'blocking'
[23:59:27] <brson> running
