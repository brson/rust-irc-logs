[00:18:51] *** Quits: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au) (Ping timeout)
[00:20:38] *** Joins: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au)
[00:23:23] *** Quits: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com) (Quit: pcwalton)
[00:24:03] *** Joins: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com)
[00:24:03] *** ChanServ sets mode: +ao pcwalton pcwalton
[00:42:40] *** Quits: tikue_ (tkuehn@6E051717.B9B3942C.689607DE.IP) (Quit: tikue_)
[00:46:40] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[00:46:40] <ghrust> 01[13rust01] 15bors pushed 13 new commits to 06auto: 02http://git.io/K--Axw
[00:46:40] <ghrust> 13rust/06auto 14aca1775 15Patrick Walton: test: Remove most uses of `&fn()` from the tests.
[00:46:40] <ghrust> 13rust/06auto 14343bc1f 15Patrick Walton: librustc: Remove remaining uses of `&fn()` in favor of `||`.
[00:46:40] <ghrust> 13rust/06auto 1428263eb 15Patrick Walton: libsyntax: Remove the old-style borrowed closure type syntax from the...
[00:46:42] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[00:47:45] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[01:03:15] <acrichto> woo working select on new port/chan
[01:03:29] <acrichto> both native and scheduler based
[01:08:59] <sfackler> nice!
[01:15:50] *** kimundi is now known as zz_kimundi
[01:20:36] *** Quits: tedh (tedh@moz-F0B37C08.hsd1.il.comcast.net) (Quit: Textual IRC Client: www.textualapp.com)
[01:33:45] *** Joins: ktt3ja (Mibbit@moz-D69B60E4.hsd1.va.comcast.net)
[01:36:44] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[01:36:44] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 145d43ac1 to 14e632c44: 02http://git.io/N3iJvQ
[01:36:44] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[01:36:45] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[01:36:45] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/7lfqDQ
[01:36:45] <ghrust> 13rust/06auto 14eccd145 15Marvin LÃ¶bel: Removed unneccessary `_iter` suffixes from various APIs
[01:36:45] <ghrust> 13rust/06auto 14ec958d0 15bors: auto merge of #10622 : Kimundi/rust/str_de_iter, r=alexcrichton...
[01:36:45] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[01:44:30] *** Joins: blank_name (blank_name@FAB53C88.7071B2C8.31EC03F3.IP)
[01:46:33] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[01:46:33] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14ec958d0 to 14e632c44: 02http://git.io/N3iJvQ
[01:46:33] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[01:46:34] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[01:46:34] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/qfVUVA
[01:46:34] <ghrust> 13rust/06auto 1420233b9 15Andreas Ots: std: IPv6 addresses are represented as eight groups of four HEXADECIMAL digits
[01:46:34] <ghrust> 13rust/06auto 14ffaee0f 15bors: auto merge of #10650 : andreasots/rust/ipv6-is-in-hex, r=alexcrichton...
[01:46:35] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[01:55:16] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[02:05:37] *** Quits: Axord (xord@moz-C0D5F15A.lsanca.dsl-w.verizon.net) (Quit: I'm sure it's perfectly safe)
[02:38:38] *** Quits: jdm (jdm@moz-AC9499B2.cable.teksavvy.com) (Quit: Lost terminal)
[02:51:37] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[02:51:37] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/qfVUVA
[02:51:37] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[02:51:51] *** Quits: hansjorg (hansjorg@moz-41C5CE61.redpill-linpro.com) (Ping timeout)
[02:56:32] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[02:56:32] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/k4HTTQ
[02:56:32] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[02:56:34] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[02:56:34] <ghrust> 01[13rust01] 15bors pushed 13 new commits to 06auto: 02http://git.io/3TdNcw
[02:56:34] <ghrust> 13rust/06auto 14aca1775 15Patrick Walton: test: Remove most uses of `&fn()` from the tests.
[02:56:34] <ghrust> 13rust/06auto 14343bc1f 15Patrick Walton: librustc: Remove remaining uses of `&fn()` in favor of `||`.
[02:56:34] <ghrust> 13rust/06auto 1428263eb 15Patrick Walton: libsyntax: Remove the old-style borrowed closure type syntax from the...
[02:56:36] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[03:01:11] *** Quits: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com) (Quit: pcwalton)
[03:05:41] *** Joins: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net)
[03:07:48] *** Quits: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net) (Quit: jeffdb_)
[03:22:03] *** Quits: blank_name (blank_name@FAB53C88.7071B2C8.31EC03F3.IP) (Ping timeout)
[03:24:38] *** Joins: pcwalton (pcwalton@moz-14285ACF.ptr.us.xo.net)
[03:24:38] *** ChanServ sets mode: +ao pcwalton pcwalton
[03:25:05] *** Quits: zz_kimundi (kimundi@moz-55BB9741.dip0.t-ipconnect.de) (Ping timeout)
[03:27:22] *** Quits: pcwalton (pcwalton@moz-14285ACF.ptr.us.xo.net) (Quit: pcwalton)
[03:28:30] *** Joins: zz_kimundi (kimundi@moz-28813223.dip0.t-ipconnect.de)
[03:28:31] *** zz_kimundi is now known as kimundi
[03:34:29] *** Joins: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net)
[03:38:13] *** Quits: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net) (Quit: jeffdb_)
[03:42:25] *** Joins: blank_name (blank_name@FAB53C88.7071B2C8.31EC03F3.IP)
[03:47:09] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[03:47:09] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 141f33afc to 14ffaee0f: 02http://git.io/N3iJvQ
[03:47:09] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[03:47:13] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[03:47:13] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/p6rjYg
[03:47:13] <ghrust> 13rust/06auto 14ac59888 15Alex Crichton: Move LittleLock to using RAII...
[03:47:13] <ghrust> 13rust/06auto 14f6bc6e2 15bors: auto merge of #10660 : alexcrichton/rust/little-scope, r=pcwalton...
[03:47:14] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[03:47:28] *** Quits: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net) (Quit: tikue_)
[04:00:47] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[04:20:05] *** Joins: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net)
[04:20:35] <klutzy> is condition planned to be disappeared? or only io_error is?
[04:32:24] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[04:32:24] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14f6bc6e2 to 14ffaee0f: 02http://git.io/N3iJvQ
[04:32:24] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[04:32:32] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[04:32:32] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/_5ksSw
[04:32:32] <ghrust> 13rust/06auto 148624d5b 15Jed Davis: Represent C-like enums with a plain LLVM integer, not a struct....
[04:32:32] <ghrust> 13rust/06auto 140c04a26 15Jed Davis: Fix the usual check-fast scoping mistake.
[04:32:32] <ghrust> 13rust/06auto 14720bcd8 15bors: auto merge of #10652 : jld/rust/enum-unstruct, r=thestinger...
[04:32:34] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[04:44:40] *** Quits: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au) (Ping timeout)
[04:47:13] *** Joins: hansjorg (hansjorg@moz-41C5CE61.redpill-linpro.com)
[04:48:10] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[04:48:11] *** ChanServ sets mode: +ao pcwalton pcwalton
[04:59:35] *** Joins: jdm (jdm@moz-AC9499B2.cable.teksavvy.com)
[05:08:04] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[05:09:34] *** Joins: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net)
[05:09:46] *** Quits: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net) (Quit: jeffdb_)
[05:10:48] *** Quits: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net) (Quit: tikue_)
[05:24:00] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[05:26:06] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[05:26:07] *** ChanServ sets mode: +ao pcwalton pcwalton
[05:34:07] <acrichto> klutzy: ping
[05:34:16] <klutzy> acrichto: pong
[05:34:25] <acrichto> klutzy: do you know if weak symbols work on mingw-w64?
[05:34:56] <klutzy> acrichto: uh, I've forgot it. :(
[05:35:02] <klutzy> and I'm on debian now :p
[05:35:25] <acrichto> I'm don't like having this leading-underscore-or-not business with the symbol, and I'm curious if weak symbols "just work" on mingw-w64
[05:40:56] <klutzy> it seems that at least __attribute__((weak)) doesn't work with mingw gcc
[05:41:55] <acrichto> that's unfortunate
[05:42:07] <acrichto> it's probably just a windows thing
[05:42:16] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[05:42:16] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/_5ksSw
[05:42:16] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[05:42:54] *** Quits: Sharp (Sharp@1710C26.8381A41.8725677B.IP) (Quit: Sharp)
[05:47:22] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[05:47:22] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/l_6RXg
[05:47:22] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[05:47:25] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[05:47:25] <ghrust> 01[13rust01] 15bors pushed 9 new commits to 06auto: 02http://git.io/XTSUZw
[05:47:25] <ghrust> 13rust/06auto 146ff697d 15klutzy: rustc: Add lint for misplaced crate attributes
[05:47:25] <ghrust> 13rust/06auto 141f7bfac 15klutzy: rustc: Add lint for obsolete attributes...
[05:47:25] <ghrust> 13rust/06auto 1487b166d 15klutzy: std: Remove unused attributes...
[05:47:27] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[05:53:24] <klutzy> as I remember, `nm rustc.exe | grep crate_map_toplevel` returned `_rust_crate_map_toplevel` and `__rust_crate_map_toplevel` on win64
[05:53:38] <klutzy> but on win32 it returns `__rust_...` and `___rust_...`
[05:53:49] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[05:53:56] <klutzy> something funky is going here, but I didn't investigated it more
[05:54:31] *** Quits: doomlord_ (servitor@moz-9738D381.range86-160.btcentralplus.com) (Ping timeout)
[05:58:19] <Luqman> acrichto: the leading underscore thing is really more of a matter in differing convention on win64
[05:58:54] <Luqman> and afaik weak symbols won't work quite the same way on windows
[06:02:16] <sfackler> acrichto: what do you/the core dev team in general think of https://github.com/mozilla/rust/issues/10090 ?
[06:02:58] <acrichto> Luqman: oh well, r+ for klutzy then!
[06:03:25] <acrichto> sfackler: we haven't discussed it as a team much, I'm a little wary of 'enum mod', but I can see something like that being pretty useful
[06:03:52] <acrichto> sfackler: although I do think the 'enum mod' is the best solution to that
[06:04:18] <acrichto> I shall add this to the meeting minutes
[06:04:21] <acrichto> agenda*
[06:04:33] <sfackler> thanks
[06:04:38] <acrichto> although it may not happen this week
[06:04:44] <Luqman> klutzy: the one with the extra underscore is just an alias to the real one
[06:06:49] <acrichto> klutzy: also re #10654 yes, my pull request moves everything to using IoResult, that just doesn't provide a solution in the interim sadly
[06:06:59] <acrichto> klutzy: if you want to update to using unwrap_or_else in the appropriate spots that's fine by me
[06:07:09] <klutzy> Luqman: then it seems that dynamic_lib's symbol() doesn't follow alias
[06:08:26] <klutzy> acrichto: I think unwrap_or_else doesn't solve it, because the routine must return something inside else-part but it has nothing to return
[06:08:59] <acrichto> klutzy: right now the options are unwrap_or_else or Option<T>, just not Result<T>
[06:09:04] <Luqman> klutzy: er, it does afaik. the reason i added the alias is because without it the linker complains about not finding the symbol
[06:09:48] <klutzy> acrichto: hmm, then the function needs to return Option<T> instead of T as now
[06:10:14] <klutzy> acrichto: then I think it's better to wait your IoResult pr :)
[06:10:31] <acrichto> klutzy: cool, I think I'll put that on the agenda as well... it needs a resolution
[06:11:19] <klutzy> Luqman: symbol() uses GetProcAddress() winapi so it may behave differently?
[06:11:53] <klutzy> acrichto: btw, do you know if condition is totally going to be replaced by result or not?
[06:12:47] <acrichto> klutzy: that's kinda the idea, it's not fully resolved just yet
[06:13:03] <acrichto> the general opinion is that conditions are not right, but neither is "just result"
[06:13:34] <klutzy> I realized that condition doesn't fit with "always return something or raise" scenario
[06:14:10] <acrichto> that's why File::open returns Option<File>
[06:14:12] <acrichto> and not File
[06:14:58] <cmr> r? https://github.com/mozilla/rust/pull/10665
[06:15:59] <acrichto> cmr: why not call check_missing_doc_attrs?
[06:16:11] <cmr> acrichto: explained in the comment
[06:16:28] <cmr> ... and the commit message
[06:16:32] <cmr> kinda split between them..
[06:16:41] <acrichto> hm, I'd almost rather add a escape hatch argument to the function
[06:16:42] <cmr> acrichto: root module doesn't have a NodeId, not that I could find.
[06:16:51] <acrichto> I don't want to duplicate detection of documentation
[06:16:53] <cmr> yeah
[06:17:02] <cmr> I'll just make it an Option<NodeId>
[06:17:13] <acrichto> sounds reasonable
[06:17:26] <acrichto> cmr: also I don't think that we should be splitting up our license blocks
[06:17:46] <acrichto> there are other tests for it, so it's fine to just put dox on the crate
[06:17:52] <cmr> ok
[06:18:18] <Luqman> klutzy: so the problem was evident if you looked at the asm: .globl  __rust_crate_map_toplevel  /* stuff */  .ascii   " -export:__rust_crate_map_toplevel,data"
[06:18:53] <Luqman> the actual symbol name has only one underscore but for some reason the export line also gets prepended with an underscore
[06:19:01] <Luqman> which it shouldn't
[06:19:29] <Luqman> i couldn't figure out a way around, so i just added an alias from the symbol is was looking for to the one it should actually be
[06:19:51] <Luqman> .globl  ___rust_crate_map_toplevel   ___rust_crate_map_toplevel = __rust_crate_map_toplevel
[06:21:36] <Luqman> x86_64 would be the same, just with one less underscore on everything
[06:22:18] <cmr> (the _ is the calling convention's C mangling on win32)
[06:22:19] *** Joins: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net)
[06:23:33] *** Joins: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net)
[06:23:56] <Luqman> cmr: yep. really the problem is, it shouldn't be adding the extra underscore to the -export bit
[06:24:10] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[06:24:55] <Luqman> klutzy: oh! but actually, come to think of it. you don't need the alias on x86_64. so we can just limit that unsavoury bit to x86 only
[06:26:11] *** Quits: jeffdb_ (jeff@moz-ED35AD97.hsd1.ca.comcast.net) (Ping timeout)
[06:26:34] *** Quits: tikue_ (tkuehn@moz-DB51A23.pitbpa.fios.verizon.net) (Quit: tikue_)
[06:28:30] *** Joins: Sharp (Sharp@1710C26.8381A41.8725677B.IP)
[06:34:34] *** Joins: tjc (tjc@moz-6EB4E533.dsl.tsoft.com)
[06:34:35] *** ChanServ sets mode: +o tjc
[06:35:19] *** Quits: tjc (tjc@moz-6EB4E533.dsl.tsoft.com) (Quit: Textual IRC Client: www.textualapp.com)
[06:35:58] <cmr> oh lord
[06:36:12] <cmr> Compare:
[06:36:18] <cmr> https://github.com/joyent/libuv/blob/master/src/unix/tty.c
[06:36:20] <cmr> https://github.com/joyent/libuv/blob/master/src/win/tty.c
[06:37:03] <cmr> I admire the brave heart who implemented windows support
[06:37:43] <acrichto> first time I saw that, I just couldn't believe that someone did that for windows
[06:37:46] <acrichto> that's insane
[06:37:55] <cmr> https://github.com/piscisaureus
[06:37:58] <cmr> That man is a hero
[06:37:59] <acrichto> ah yes, one terminal emulator, coming right up!
[06:41:27] <ChrisMorgan> Colorama does similar stuff for Python, though probably not so thoroughly: https://pypi.python.org/pypi/colorama
[06:41:27] <ktt3ja> extern fn are never dead, right?
[06:42:41] <sfackler> dead?
[06:43:30] <cmr> ktt3ja: only if they're pub
[06:43:58] <ktt3ja> cmr: so it's possible for them to be dead otherwise?
[06:44:08] <cmr> ktt3ja: sure, if they're not called
[06:44:11] <cmr> just like regular fns
[06:44:16] <ktt3ja> sfackler: dead as in not possible to be used
[06:44:27] <cmr> (called, not used)
[06:44:38] <cmr> (at runtime)
[06:49:11] <cmr> acrichto: re-r? https://github.com/mozilla/rust/pull/10665
[06:49:18] <cmr> (also dbaupp)
[06:56:56] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[06:56:56] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/XTSUZw
[06:56:56] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[07:01:48] <sfackler> dbaupp / anyone: r? https://github.com/mozilla/rust/pull/10649
[07:02:22] <ChrisMorgan> :O
[07:02:30] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[07:02:30] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/Qsf2AA
[07:02:30] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[07:02:39] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[07:02:39] <ghrust> 01[13rust01] 15bors pushed 7 new commits to 06auto: 02http://git.io/ENwlWA
[07:02:39] <ghrust> 13rust/06auto 148d990c3 15klutzy: std::libc: Remove TCHAR types
[07:02:39] <ghrust> 13rust/06auto 14e1091fd 15klutzy: std::libc: Simplify win32/win64 type definitions
[07:02:39] <ghrust> 13rust/06auto 14561277d 15klutzy: std: Fix transmute error on win64
[07:02:41] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[07:06:55] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[07:10:23] <cmr> Where's the code that verifies lang items have the correct structural type/signature?
[07:12:57] <Luqman> i don't think there was any, save for a few of them?
[07:13:31] <cmr> Well at the very least it has to be done for malloc_raw etc? The compiler can't generate calls to them if it doesn't know the signature..
[07:13:59] <eddyb> *exchange_alloc
[07:14:09] <cmr> I actually just meant malloc
[07:15:27] *** Joins: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au)
[07:16:06] <eddyb> pub fn xorPush(marks: &mut ~[uint], mark: uint) {
[07:16:08] <cmr> It... doesn't verify them at all O_O
[07:16:43] <eddyb> s/uint/Mrk :(
[07:16:45] <Luqman> cmr: nope
[07:17:39] <Luqman> that reminds, the change for drop to make &mut self was pretty much just changing the trait's signature. xD
[07:21:03] <cmr> lol
[07:21:21] <cmr> https://gist.github.com/cmr/c36ebe57f03477dd0958
[07:22:14] <cmr> This is bonkers
[07:22:57] <dbaupp> cmr: doesn't the root module have NodeId 0?
[07:23:04] <cmr> dbaupp: does it?
[07:23:15] <dbaupp> cmr: there's a static in ast to that effect, iirc
[07:23:38] <dbaupp> yeah
[07:23:41] <dbaupp> `pub static CRATE_NODE_ID: NodeId = 0;`
[07:23:50] * dbaupp isn't 100% sure that's what you want, though.
[07:26:21] <sfackler> dbaupp: look good? https://github.com/mozilla/rust/pull/10649
[07:26:33] <klutzy> cmr: you could add #[lang="start"] to mod a {} to kill rustc
[07:26:39] <sfackler> I stripped down the SmallVector APi
[07:26:44] <sfackler> API
[07:27:04] <dbaupp> sfackler: one last comment :)
[07:27:54] <dbaupp> rusti: #[lang="start"] mod a {}
[07:27:55] -rusti- error: duplicate entry for `start`
[07:27:55] -rusti- error: aborting due to previous error
[07:27:55] -rusti- application terminated with error code 101
[07:28:00] <sfackler> I don't think it warned
[07:28:16] <cmr> you need #[no_std]
[07:28:22] <sfackler> dbaupp: updated
[07:29:21] <dbaupp> sfackler: weird; I guess not warning is a bug.
[07:29:37] <cmr> https://github.com/mozilla/rust/issues/10666
[07:29:49] <cmr> Quite an appropriate issue number I think..
[07:30:45] <dbaupp> ( https://github.com/mozilla/rust/issues/10667 for that lint thing)
[07:31:01] <klutzy> cmr: https://github.com/mozilla/rust/issues/9307
[07:31:14] <cmr> dammit strcat
[07:31:57] <klutzy> I should've said that I'd filed one which was closed as dup
[07:36:11] *** Quits: jdm (jdm@moz-AC9499B2.cable.teksavvy.com) (Ping timeout)
[07:47:29] *** Quits: ktt3ja (Mibbit@moz-D69B60E4.hsd1.va.comcast.net) (Quit: http://www.mibbit.com ajax IRC Client)
[07:56:59] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[07:58:41] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[08:07:35] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[08:09:43] <eddyb> wooo
[08:09:53] <eddyb> middle::ty::sty is down by 40 bytes
[08:10:11] <eddyb> sadly, it's just a quarter, I was hoping for more
[08:10:46] *** flaper87|afk is now known as flaper87
[08:11:27] <eddyb> Expr_ and ast_node are still huge, because of the unboxed Block
[08:12:25] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[08:12:25] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/ENwlWA
[08:12:25] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[08:13:58] <eddyb> rusti: ::std::sys::size_of::<Either<Option<u32>, u32>>>()
[08:13:59] -rusti- <anon>:9:9: 9:59 error: binary operation > cannot be applied to type `extern "Rust" fn() -> uint`
[08:13:59] -rusti- <anon>:9          ::std::sys::size_of::<Either<Option<u32>, u32>>>()
[08:13:59] -rusti-                   ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[08:13:59] -rusti- error: aborting due to previous error
[08:14:01] -rusti- application terminated with error code 101
[08:14:14] <eddyb> rusti: ::std::sys::size_of::<Either<Option<u32>, u32>>()
[08:14:15] -rusti- 24u
[08:15:40] <eddyb> that's 12 now, but it could be 8 (with alignment. 6 - maybe 5 - without)
[08:17:19] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[08:17:19] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/WylrAQ
[08:17:19] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[08:17:19] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[08:17:19] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/2Gj1bA
[08:17:19] <ghrust> 13rust/06auto 1440deb8d 15Steven Fackler: Add SmallVector to libsyntax
[08:17:19] <ghrust> 13rust/06auto 145003ca5 15Steven Fackler: Support multiple item macros...
[08:17:20] <ghrust> 13rust/06auto 14872ffb8 15Steven Fackler: Clean up SmallVector use a bit
[08:17:22] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[08:19:41] <eddyb> Left(Some(u32) | None) | Right(u32) - why can't that be EitherTag: u8, union { (OptionTag: u8, union {(/* 2 bytes padding */u32), ()}), (/* 3 bytes padding */u32)}?
[08:20:28] <cmr> Where are you getting 12?
[08:20:40] <cmr> Or, 8 rather
[08:20:46] <cmr> 4 for each discrim, 4 for the contents.
[08:21:13] *** Quits: Sharp (Sharp@1710C26.8381A41.8725677B.IP) (Quit: Sharp)
[08:22:35] <cmr> 8 would just be the two u32s
[08:22:44] *** Joins: pnkfelix (pnkfelix@87C1F78E.1DE10CA8.D8E68FF6.IP)
[08:22:50] <cmr> Oh, I see what you're saying..
[08:23:24] <cmr> Yeah, it could be smarter about compacting nested enums
[08:25:05] <eddyb> it should compute alignment padding *after* expansion, if the Either is 4-aligned, the u32s will be 4-aligned, even when taking the address of Some(u32) in Left
[08:25:32] <eddyb> I'm not even sure what's computing alignment. LLVM?
[08:25:42] <cmr> yes and no
[08:26:22] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:26:43] *** Quits: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:27:49] <cmr> We query llvm for the alignment of a type
[08:27:56] <cmr> But we use that to determine the enum layout
[08:28:16] <cmr> https://github.com/mozilla/rust/pull/9613 is the relevant PR btw
[08:28:59] <cmr> acrichto: ping
[08:29:04] <acrichto> cmr: pong
[08:29:15] <cmr> I'm disappointed you aren't sleeping, but happy you aren't.
[08:29:21] <acrichto> lol
[08:29:32] <cmr> acrichto: so bjz hit https://github.com/bjz/glfw-rs/pull/49#issuecomment-29273642, and I think that https://github.com/mozilla/rust/pull/10199 is a bit too strict.
[08:29:32] <acrichto> says the man on the east coast a 3:30 am
[08:29:37] <cmr> shush
[08:29:42] <cmr> :P
[08:29:55] <acrichto> I have ideas of how to make this better once the linking redesign lands
[08:30:03] <acrichto> we made a conscious decision to swallow those linker errors
[08:30:05] <cmr> For crates like glfw-rs whose explicit purpose is wrapping a native lib, I think it's silly/burdensome to have child crates require things.
[08:30:20] * bjz blushes
[08:30:30] <acrichto> yeah we didn't think it would be that bad, but I fear it's worse than we thought
[08:30:33] <cmr> I think a #[propagate_link_args="-lglfw3], for example, would be nice..
[08:30:43] <acrichto> we don't want link_args at all
[08:30:48] <acrichto> that's becoming a feature-gated thing
[08:30:48] <cmr> How are we going to avoid it?
[08:31:01] <Luqman> yea, i was talking to acrichto about this since i hit it with the sdl bindings as well.
[08:31:08] <Luqman> i kinda like cmr's proposal
[08:31:10] <acrichto> so the reason we stopped propagating is that you have no guarantee that libraries will be available downstream
[08:31:20] <acrichto> e.g. libuv, libuv_support, etc.
[08:31:33] <acrichto> now the one thing in common with all of those is that they're statically linked
[08:31:44] <acrichto> in my linking redesign (static linking), you have #[link(name = "foo", kind = "bar")]
[08:31:54] <acrichto> where if kind == "static" then there's no propagation ever
[08:32:04] <acrichto> and if kind is omitted then it's assumed to be dynamic
[08:32:13] <acrichto> we could easily add back in propagation of native dynamic libraries
[08:32:19] <acrichto> becuase those are foced to be available downstream anyway
[08:32:24] <acrichto> (at runtime)
[08:32:40] <acrichto> I want to do this, but I'm still waiting on review of static linking :\
[08:32:48] <cmr> Oh that hasn't landed yet?
[08:32:58] <acrichto> no one's reviewed it
[08:33:27] <eddyb> this is what I was talking about: https://github.com/mozilla/rust/blob/master/src/librustc/middle/trans/adt.rs#L33-L39
[08:35:05] <Eridius> linked failure was removed? So, if a task fails, what happens now? The rest of the app just proceeds?
[08:35:28] <acrichto> Eridius: the idea is to propagate failure across channel boundaries instead of at arbitrary locations
[08:38:39] <cmr> acrichto: You removed the docs for nolink. Is nolink now the default or something?
[08:38:50] <acrichto> nolink basically means nothing
[08:39:04] <acrichto> in the olden days #[link_name] was required on extern blocks
[08:39:10] <acrichto> #[nolink] said "I don't care about that"
[08:39:13] <acrichto> we don't require anything now
[08:39:17] <cmr> Ok
[08:39:42] <bjz> acrichto: any way to do conditional linking via cfgs/os attributes?
[08:39:49] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[08:39:52] <bjz> ie. in your proposed scheme
[08:40:13] <acrichto> bjz: same as today, just cfg-off the extern block
[08:40:20] <bjz> that's one of the reasons why we use extern blocks
[08:40:44] <acrichto> brson wants to add linked native libraries to the top of crates though
[08:40:50] <bjz> ok
[08:40:55] <cmr> acrichto: What's your plan for rlib format for 1.0?
[08:40:58] <acrichto> may support both
[08:41:01] <cmr> Is binary compat completely out of scope for 1.0?/
[08:41:08] <acrichto> cmr: right now it's a .a, and I don't plan on changing it soon
[08:41:18] <acrichto> I explicitly don't want to commit to a format
[08:41:22] <acrichto> an rlib == compiler defined
[08:41:36] <acrichto> we may want it to be lto stuff one ay
[08:41:37] <acrichto> day*
[08:41:43] <acrichto> or perhaps lto *and* objects
[08:41:50] <acrichto> the possibilities are endless!
[08:41:52] <cmr> We need to commit to a format, though, so that future versions of the compiler can link to libraries compiled with older compilers
[08:41:57] <cmr> (compiler compiler compiler...)
[08:42:19] <eddyb> some kind of versioning would be nice
[08:42:23] <acrichto> we have no hope of forwards binary compatibility right now
[08:42:26] <cmr> (eventually. not saying it needs to be now)
[08:42:28] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:42:35] <acrichto> it's just too much of a pain to completely design around it when it's fundamentally broken
[08:42:40] <cmr> sure
[08:42:52] <eddyb> how about using a simple format that can embed different types of files/data?
[08:43:00] *** Joins: strcat (strcat@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:43:06] <acrichto> eddyb: .a files already do that :)
[08:43:13] <acrichto> you can put anything in a .a file
[08:43:16] <cmr> eddyb: if it's not in scope for 1.0 it doesn't matter at all
[08:43:17] <acrichto> it's like a tar archive
[08:43:31] <acrichto> cmr: I see your point though, I think that we can get around it regardless
[08:43:35] <cmr> Right
[08:43:40] <acrichto> cmr: we could put various sentiel files in archives
[08:43:42] <acrichto> VERSION
[08:43:42] <cmr> If it's just a .a it's mostly fine
[08:43:52] <eddyb> right, I know that. so, allow .o, .bc for LTO or both, inside
[08:44:14] <acrichto> there's no reason that we don't allow that, we just don't do that by default right now
[08:46:43] <pnkfelix> acrichto: which PR was the native mutex PR ?
[08:46:55] <cmr> https://github.com/mozilla/rust/pull/10479
[08:47:04] <acrichto> pnkfelix: 10479
[08:47:06] <pnkfelix> cmr: thx
[08:47:09] <cmr> (I have every PR for the last ~5 months in my browser history)
[08:47:09] <acrichto> ah beaten
[08:47:20] <cmr> I type in any two words and chances are a rust PR comes up :P
[08:47:28] <eddyb> compiling against a .rlib should be able to use any of the types inside the archive, and creating a .rlib should allow specifying which types of output should be produced. it seems this is pretty much what will happen anyway :D
[08:48:00] <Luqman> cmr: haha, so what you're saying is i should go through you now?
[08:48:43] <cmr> Luqman: if you want to annoy me, yes :P
[08:49:05] <eddyb> cmr-pr-pedia
[08:50:05] <eddyb> so, right now sty has a 25% size reduction. should I try harder?
[08:50:08] <cmr> I might buy a large disk for my builder this upcoming holliday.. it's not getting unweidly yet, but it will eventually.
[08:50:10] <cmr> eddyb: yes
[08:50:13] <cmr> :)
[08:52:08] <eddyb> well, typeck brought my testcase up to 1.6GB, let's see if it's lower now
[08:52:28] <Luqman> cmr: i've so far relied on school computers :P plently of bandwith & space
[08:52:35] <eddyb> 1.2GB and it doesn't look like it's growing
[08:52:59] <cmr> eddyb: that is very significant!
[08:53:00] <Luqman> also, cpu/mem (64core/192gb)
[08:53:17] <cmr> Luqman: Well, my desktop is faster than bors, so that's all that really matter ;p
[08:53:30] *** Quits: bjz (bjz@moz-6AF19015.lnse4.cha.bigpond.net.au) (Ping timeout)
[08:53:42] <eddyb> cmr: yeah, but my testcase stresses rustc more than compiling librustc does
[08:53:52] <cmr> eddyb: so? :)
[08:54:50] <eddyb> remember I've had to wrap every match case in a function to work around borrowck
[08:55:10] <eddyb> cmr: peak is at 1.4, but much shorter lived than the previous flat region at 1.6
[08:55:19] <eddyb> so the gain is 200-400MB
[08:55:39] <cmr> :shipit:
[08:56:14] * eddyb is afraid it doesn't make a difference on stage2 rustc
[08:57:15] <eddyb> cmr: I did see uint in a few places where specialized types would've fared better, so this isn't over yet
[08:58:54] <eddyb> oh, and, you can probably pack a crate num and an index in a single u32, but that could affect performance and without careful consideration it will bite you
[08:59:46] *** Joins: tedh (tedh@moz-A5D1CAB7.public.wayport.net)
[09:00:58] <eddyb> cmr: heeey, that's something, librustc never touches 1.4GB
[09:02:01] <eddyb> cmr: again, same thing, the peak is much shorter lived. maybe it's just swap behavior over here :/
[09:02:15] *** Joins: Axord (xord@moz-C0D5F15A.lsanca.dsl-w.verizon.net)
[09:03:52] <eddyb> Luqman: how do I use the type sizes thing?
[09:04:21] <cmr> rustc -Z count-type-sizes
[09:04:58] <eddyb> cmr: it's reflexive?
[09:05:00] <kimundi> acrichto: Need a new r+, missed a method in windows-only code :) https://github.com/mozilla/rust/pull/10622
[09:05:09] <cmr> eddyb: hm?
[09:05:19] * acrichto is looking forward to string.chars()
[09:05:36] <cmr> *for*ward to, eh?
[09:05:43] <cmr> (also amusing: they're forward iterators)
[09:05:51] <eddyb> cmr: it counts the sizes of types inside the compiler itself? or do I have to insert that flag somehow during rustc-stage1
[09:06:04] <cmr> eddyb: rustc -Z count-type-sizes librustc/lib.rs
[09:06:43] <eddyb> errrrr I somehow doubt that won't explode on me, but let's try
[09:07:41] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[09:07:41] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14d630588 to 14b42c438: 02http://git.io/N3iJvQ
[09:07:41] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[09:07:50] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[09:07:50] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/9EcV8g
[09:07:50] <ghrust> 13rust/06auto 1424b316a 15Marvin LÃ¶bel: Removed unneccessary `_iter` suffixes from various APIs
[09:07:50] <ghrust> 13rust/06auto 1421990cd 15bors: auto merge of #10622 : Kimundi/rust/str_de_iter, r=alexcrichton...
[09:07:50] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[09:08:01] <kimundi> acrichto: thanks :)
[09:09:05] <kimundi> Btw, is there anyway to test for compile failure on windows/macos without having access to those platforms?
[09:09:15] <eddyb> Luqman: why .rb here :P? https://gist.github.com/luqmana/2940d391e3ef2754850d
[09:10:09] <eddyb> src/librustc/middle/trans/debuginfo.rs:876:19: 876:68 error: Environment variable CFG_VERSION not defined
[09:10:26] <acrichto> kimundi: we can push to try, but that's kinda the only solution (which may not be the best)
[09:11:01] <eddyb> I'm up to env CFG_VERSION= CFG_PREFIX= CFG_LIBDIR= CFG_COMPILER=
[09:12:51] <kimundi> acrichto: I would be happy with the compiler trying to resolve and typecheck all rust code, even if it fails because of missing extern stuff.
[09:13:47] <kimundi> Seeing how most of my bigger PRs are about renaming stuff...
[09:13:59] <acrichto> kimundi: hm that's an interesting idea... you may be able to emulate that but it'd probably get tricky quicly
[09:14:27] <kimundi> yeah, I could probably just manually rustc --cfg windows everything
[09:14:34] <kimundi> But... that's to much effort :P
[09:15:28] * kimundi hopes that once rust is ported to rustpkg, hacking those sepcial debbuging compile modes into the build process becomes easier
[09:15:58] * kimundi refuses to hack on the makefile himself, for fear of his remaining sanity
[09:16:17] <eddyb> cmr: compare: https://gist.github.com/luqmana/2940d391e3ef2754850d and https://gist.github.com/eddyb/5a75f8973d3d8018afd3
[09:16:32] <eddyb> middle::lang_items::LanguageItemCollector is halved O_O
[09:16:47] <Luqman> eddyb: i piped it into some ruby script which posts to gist. guess it defaults to a.rb :P
[09:17:07] <kimundi> Then again, the proper solution would be a refactoring tool...
[09:17:23] <eddyb> updated mine, the github highlighter for rust is crappier than the one for ruby
[09:17:34] <Luqman> eddyb: but that's amazing!
[09:18:00] <eddyb> why the fuck would std::rt::task::Task be smaller?
[09:18:53] *** Joins: bjz (bjz@moz-6AF19015.lnse4.cha.bigpond.net.au)
[09:19:06] <eddyb> eh, I don't care, let's move on
[09:19:25] <Luqman> eddyb: so, mine might be from an older commit
[09:19:41] <eddyb> mine is from the latest snapshot, I think
[09:19:55] <eddyb> (since I used stage0/bin/rustc with the flag)
[09:20:32] <eddyb> if middle::trans::context::CrateContext has many instances, that would account for the high usage in trans when compiling librustc
[09:20:52] <eddyb> (or I'm just silly)
[09:21:15] <Luqman> afaik there's only 1 CrateContext that gets passed around behind a @
[09:26:17] <eddyb> monomorphizing: HashMap<ast::DefId, uint>, // what's the uint for?
[09:26:51] <eddyb> Luqman: but CrateContext references types which I've shrinked :D
[09:26:58] <eddyb> in hash sets/maps
[09:27:41] <Eridius> if I have a rust library that needs to link against a C library, that dependency is no longer propagated, right? Is there a way to explicitly mark it as propagating, or do I need to add link args to the program that uses the rust library?
[09:29:54] <cmr> Eridius: we just discussed this
[09:29:59] <cmr> you need to add link args atm
[09:30:22] <Eridius> adding it to the `extern mod foo;` seemed to do nothing. I had to add an empty `extern {}` block :/
[09:30:35] <cmr> Yes
[09:30:40] <Eridius> that's surprising
[09:31:22] *** Quits: Kxepal (Miranda@moz-AF2D243E.pppoe.mtu-net.ru) (Ping timeout)
[09:32:08] <eddyb> Luqman: ctxt_ is smaller because it contains middle::lang_items::LanguageItems, which has been halved
[09:32:24] <Eridius> why is Result requiring ToStr on it's second bound for basic functions?
[09:32:27] <eddyb> (and I guess the latter is a newtype of [std::option::Option<syntax::ast::DefId>, .. 40])
[09:32:32] <Eridius> this is rather problematic
[09:32:51] <eddyb> Eridius: fancy error messages, maybe?
[09:32:59] <Eridius> shouldn't be necessary for basic functionality like .as_mut()
[09:33:09] <eddyb> can that ever fail?
[09:33:14] <cmr> Yeah, it should be more fine-grained.
[09:33:21] <kimundi> Eridius: You mean Result?
[09:33:54] <Eridius> I said Result, didn't I?
[09:34:07] <kimundi> derp, can't read :P
[09:34:40] <eddyb> we need to allow an "opposite" version to be defined, with a bound on !ToStr, and it should pass coherence
[09:34:40] *** Joins: Kxepal (Miranda@moz-788FED86.pppoe.mtu-net.ru)
[09:34:56] <Eridius> the ToStr bound shouldn't be required at all for most of this stuff
[09:35:03] <kimundi> The idea behind the ToStr bound is that the Error type should _always_ be able to provide a useful error message, and that'S the best-ish way to require it
[09:35:04] <Eridius> if not all of it
[09:35:15] <eddyb> Eridius: it should be opt-in
[09:35:25] <eddyb> i.e. you get shitty error messages without it
[09:35:26] <Eridius> kimundi: myResult.as_mut() returns a Result whose E bound may not be a ToStr
[09:35:29] <Eridius> which is precisely my problem
[09:35:42] <kimundi> Good/bad news though, I have a Result API proposal that is basically incompatible with that, and thus removes the ToStr bound: https://github.com/mozilla/rust/pull/10364
[09:35:59] <kimundi> Eridius: That is exactly the problem I ran into with that PR
[09:36:12] <Eridius> `for t in term.iter() { t.fg(color::RED); }` apparently used to work, but now it's complaining that the t is an immutable &-ptr. So I tried adding .as_mut(), but now I can't call .iter() because &mut ~str doesn't impl ToStr
[09:36:18] <Eridius> this seems like a rather serious issue for Result
[09:36:54] <cmr> Have you considered just matching on it? :p
[09:36:59] <Eridius> I'm going to have to do that
[09:37:01] <eddyb> shouldn't that be .mut_iter?
[09:37:28] <Eridius> eddyb: there is no .mut_iter() on Result
[09:37:31] <Eridius> seems like maybe there should be
[09:37:39] <kimundi> iter on Result takes byvalue
[09:37:39] <eddyb> you're iterating on Result?
[09:37:48] <Eridius> (since .as_mut().iter() adds an extra unwanted indirection)
[09:38:02] * eddyb tries to comprehend
[09:38:12] <Eridius> kimundi: no it doesn't
[09:38:15] <eddyb> what does .iter() do, exactly, on Result?
[09:38:25] <Eridius> eddyb: iterates 0 or 1 times
[09:38:30] <Eridius> depending on whether the result is_ok()
[09:38:48] <Eridius> it's an easy way to get a one-liner instead of using a match
[09:38:54] <kimundi> Eridius: Oh, right, I cahanged that in that PR though
[09:39:19] <kimundi> Eridius: Do you want to work with a mutable reference to the content of a Ok() variant?
[09:39:41] <eddyb> kimundi: weren't there Option map-like methods on Result before your PR?
[09:39:56] <Eridius> kimundi: yes
[09:40:15] <Eridius> kimundi: I'm using Terminal::new() which returns a Result<Terminal<T>, ~str>
[09:40:23] <Eridius> and I'm trying to run a method on the Terminal that takes &mut self
[09:41:05] <kimundi> hm... hwo about res.into_option().map(|t| t. ...) ? :P
[09:41:18] <Eridius> interesting. I'm just going with the match though, which should make this more future-proof
[09:41:40] <kimundi> The Result API is kinda broken in that regard right now, because of the as_Ref, as_mut => no ToStr bound issue
[09:42:11] * Eridius goes to bed
[09:47:40] * acrichto has a working chase-lev deque
[09:48:01] <cmr> I do believe you're #3 among those who have done so.. fsvo working
[09:50:49] <eddyb>     // FIXME (#3469): Change uint to @expr (actually only constant exprs)
[09:56:47] *** Quits: nrc (nrc@7BE24E90.A5032A01.3CFC199D.IP) (Ping timeout)
[10:04:09] *** Quits: bjz (bjz@moz-6AF19015.lnse4.cha.bigpond.net.au) (Ping timeout)
[10:04:41] <Luqman> Eridius: err, that's my fault :P i changed most of term things to take &mut self
[10:05:13] <cmr> Luqman: (you also removed all use of @-boxes in multibuilder!)
[10:05:31] <Luqman> multibuilder?
[10:05:59] <cmr> https://github.com/huonw/multibuilder
[10:06:08] <cmr> it's what drives irsy, for the most part
[10:06:16] <cmr> 1755 rust builds and counting
[10:06:50] <Luqman> ah
[10:07:57] <Luqman> i did it cause i didn't like having to use @mut in my chat thing :P
[10:08:20] <Luqman> on an unrelated note, rlwrap is awesome
[10:09:15] <cmr> ohhh, that is awesome
[10:09:19] <cmr> haven't seen that before
[10:13:52] <cmr> acrichto: eugh I thought that commit would never end :(
[10:20:12] <eddyb> https://github.com/mozilla/rust/pull/10670 no idea why I felt the need to write that up
[10:21:09] <eddyb> cmr, dbaupp ^^
[10:21:18] <cmr> Is... is that ghetto superscript?
[10:21:29] <pnkfelix> eddyb: Wait, didn't Luqman say that his gist might have been from an older commit ?
[10:22:12] *** Joins: quvarxa_ (chatzilla@moz-978E4C31.static.tpgi.com.au)
[10:22:36] *** Quits: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au) (Ping timeout)
[10:22:37] *** quvarxa_ is now known as quvarxa
[10:22:39] <eddyb> pnkfelix: I only saw differences inside rt, that I can't account for, if you can easily generate a newer one (without rebuilds), I will change it
[10:22:44] <Luqman> well, here is one from HEAD-1 or so https://gist.github.com/luqmana/3a82a51fa9c86d9191fa
[10:22:44] <pnkfelix> eddyb: Note, I'm not saying you need to take the time to redo the experiment (to ensure that you've isolated the changes to just your own commit).  I just thought it might be good to provide that caveat, to allow grains of salt to be applied as needed.
[10:23:21] <pnkfelix> Luqman: okay, I can see that Task has shrunk in the more recent one, as you guessed earlier.
[10:23:34] <pnkfelix> Luqman: and much of the rest seems to match up
[10:23:43] <eddyb> Luqman: thanks, edited
[10:24:03] <eddyb> cmr: just unicode. github didn't do anything with ^ :(
[10:25:03] <eddyb> the equal spaces before and after the headings bugs me
[10:25:57] <eddyb> cmr: when's the meeting?
[10:26:08] <cmr> eddyb: tomorrow at around 5PM UTC
[10:26:38] <eddyb> thanks, I'll try to be around
[10:28:34] <eddyb> cmr: any change is-rust-slim-yet can just so a random comparison build from my branch?
[10:28:41] <eddyb> s/change/chance/
[10:47:03] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[10:47:03] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/9EcV8g
[10:47:03] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[10:48:28] <nmatsakis> pnkfelix: ping
[10:48:31] <eddyb> cmr: Leo`s work on Rc<Block> could show even better results, but I doubt it will be finished in time for the meeting
[10:48:41] <pnkfelix> nmatsakis: pong
[10:50:22] <nmatsakis> pnkfelix: do you remember back when we were talking about object types and traits...
[10:50:51] <nmatsakis> pnkfelix: ...we had this example of `trait Message { fn send(~self); ... }` and `impl Message for ~Message { fn send(~self) { ... } ... }`
[10:51:05] <nmatsakis> pnkfelix: ...which of course is kind of inefficient because you wind up with a ~~Message
[10:51:20] <pnkfelix> nmatsakis: where we were discussing whether it made any sense to choose to use ~self ?
[10:51:34] <nmatsakis> pnkfelix: ...and we thought we could solve it by doing `trait Message { fn send(self); ... }` and `impl Message for ~Message { fn send(self) { ... } ... }`
[10:51:46] <pnkfelix> nmatsakis: versus it being "idiomatic" to either use "&self" or sigil-less "self" ?
[10:51:46] <cmr> eddyb: unfortunately not.
[10:51:52] <nmatsakis> pnkfelix: but, at least with the current rules, I remembered that one cannot invoke a bare self method on an object,
[10:52:05] <cmr> eddyb: Rc<Block> is an uninteresting change, yours actually effects semantics.
[10:52:06] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[10:52:06] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/WWHiKw
[10:52:06] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[10:52:14] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[10:52:14] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/FmiD5w
[10:52:14] <ghrust> 13rust/06auto 14ac59888 15Alex Crichton: Move LittleLock to using RAII...
[10:52:14] <ghrust> 13rust/06auto 144fe1296 15bors: auto merge of #10660 : alexcrichton/rust/little-scope, r=pcwalton...
[10:52:14] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[10:52:17] <nmatsakis> pnkfelix: because we don't know then if the receiver type is immediate or not etc...
[10:52:25] <dbaupp> cmr: in what way does it affect semantics?
[10:52:27] <nmatsakis> pnkfelix: ...though of course we could (and probably should) lift this restriction by using an adaptor function
[10:52:37] <nmatsakis> pnkfelix: just an interesting wrinkle I thought of while writing this up
[10:52:42] <cmr> dbaupp: It changes the size of the types the compiler uses for everything
[10:52:45] <eddyb> dbaupp: I may have broken metadata but I have *no clue*
[10:52:49] <pnkfelix> nmatsakis: I'm confused, isn't the sigil-less self here itself of type ~Message ?
[10:53:09] <dbaupp> cmr: so? 2^32 nodes is a lot
[10:53:10] <cmr> (only on x64, sure, but I still think it should be discussed...)
[10:53:15] <pnkfelix> nmatsakis: maybe I do not understand what you mean by the receiver type being "immediate" ...
[10:53:40] <nmatsakis> pnkfelix: yes, it is, but then once we try to *implement* fn send(self) for the type ~Message, our self has type `~Message`,
[10:53:46] <eddyb> dbaupp: not if you have half a TB of RAM :P
[10:53:48] <nmatsakis> pnkfelix: and we need to call self.send()
[10:54:01] <nmatsakis> pnkfelix: that's a virtual call (self is an object type),
[10:54:26] <nmatsakis> pnkfelix: and currently we don't permit virtual calls to methods whose "self type" is just self
[10:54:26] <dbaupp> eddyb: fwiw, I think that PR has too many `as int`s and `as NodeId`s; it probably indicates that you need to change the types of some functions too?
[10:54:35] <nmatsakis> pnkfelix: by "immediate" I mean that perhaps the receiver type is an integer,
[10:54:42] <pnkfelix> nmatsakis: hmm.  Even though in this case it should make sense?
[10:54:48] <nmatsakis> pnkfelix: in which case it is (or rather should be, we do weird stuff with self) not passed indirectly,
[10:55:02] <nmatsakis> pnkfelix: but when calling virtually we can't know that, since we don't know what the receiver type is,
[10:55:10] <nmatsakis> pnkfelix: anyway we can fix it but providing an adapter, 
[10:55:17] <nmatsakis> pnkfelix: so that the function in the vtable always expects an indirect self,
[10:55:25] <nmatsakis> pnkfelix: and then dereferences and invokes the actual function
[10:55:34] <dbaupp> eddyb: random example, https://github.com/mozilla/rust/pull/10670/files#diff-74b5ba63896c56c0964426955d2700d1R569, couldn't that just change to take a Name and return a Name?
[10:55:42] <dbaupp> (the last line)
[10:55:47] <eddyb> dbaupp: there's functions working with int/uints that are not related to node IDs or names (like the methods on the string interner)
[10:56:00] <eddyb> heh, just what I was giving as example, the interner
[10:56:41] <eddyb> the interner doesn't know about ast
[10:57:37] <pnkfelix> nmatsakis: okay, I'm trying to work through the different pieces of the puzzle here.
[10:57:40] <eddyb> I did touch generic-looking *local* functions, like the three here https://github.com/mozilla/rust/pull/10670/files#diff-e62b730a8686526ed1b9d6dd076574c1L806
[10:58:10] <nmatsakis> pnkfelix: I'm writing it up, i'll send you the issue #
[10:58:35] <pnkfelix> nmatsakis: okayâ€¦ would you prefer I keep asking questions here, or wait to read the issue # and then post any questions I have there?
[10:59:32] <dbaupp> eddyb: what about all these `as int`s? https://github.com/mozilla/rust/pull/10670/files#diff-43aafc1e04ee5bc1cf78f38bd1c929f8R226 surely they're being treated as crate numbers internally?
[10:59:34] *** Joins: bjz (bjz@moz-6AF19015.lnse4.cha.bigpond.net.au)
[11:00:11] <eddyb> dbaupp: I was afraid of changing the storage format of metadata
[11:00:27] <eddyb> that's why I asked for someone who knows how that works ;)
[11:01:04] <nmatsakis> pnkfelix: latter
[11:01:05] <dbaupp> eddyb: I don't think changing the type of "parse_trait_ref_data" to indicate that it takes a CrateNum will change the format
[11:01:13] <dbaupp> (etc)
[11:01:15] <cmr> eddyb: (fwiw I don't think anybody knows how metadata works :p)
[11:01:20] <eddyb> dbaupp: let's hope there's no generic magic
[11:01:22] <pnkfelix> nmatsakis: k good, that's what I would prefer. 
[11:01:23] <cmr> (that's the running joke, at least)
[11:02:17] <dbaupp> eddyb: the only thing (in terms of types) that will change the format is directly changing one of the ebml reading/writing functions; I don't think there's much generics in metadata at all.
[11:02:39] <eddyb> thanks, that means I only have to cleanup explicit (u)ints
[11:04:05] <nmatsakis> pnkfelix: https://github.com/mozilla/rust/issues/10672
[11:04:14] <nmatsakis> pnkfelix: gotta run in a bit though, bbl
[11:07:16] <eddyb> if v > (u32::max_value - count) {
[11:07:31] <eddyb> dbaupp: ^ does that work as an overflow check for v + count?
[11:07:46] <cmr> eddyb: we have .checked_add
[11:08:01] <cmr> And it will use the hardware where it's available
[11:10:08] <eddyb> cmr: where are the docs?
[11:10:17] <cmr> dunno, use the search :P
[11:10:40] <eddyb> ah, num. looked everywhere but there. heeey, the search works better now :D
[11:10:54] <cmr> search hasn't changed for a while
[11:12:08] <eddyb> rusti: -1u32.checked_add(1u32)
[11:12:11] -rusti- pastebinned 8 lines of output: http://sprunge.us/dWCK
[11:12:15] <eddyb> rusti: -1u32.checked_add(&1u32)
[11:12:16] -rusti- <anon>:9:9: 10:5 error: cannot apply unary operator `-` to type `std::option::Option<u32>`
[11:12:16] -rusti- <anon>:9          -1u32.checked_add(&1u32)
[11:12:16] -rusti- <anon>:10     };
[11:12:16] -rusti- error: aborting due to previous error
[11:12:16] -rusti- application terminated with error code 101
[11:12:18] <cmr> it's new
[11:12:24] <eddyb> rusti: (-1u32).checked_add(&1u32)
[11:12:24] -rusti- None
[11:12:30] <eddyb> nah, my code is bad
[11:12:35] <eddyb> rusti: (-2u32).checked_add(&1u32)
[11:12:35] -rusti- Some(4294967295u32)
[11:12:44] <cmr> ... didn't think we had it in 0.8!
[11:12:53] <eddyb> okay, so that will prevent you from using -1 as a value
[11:13:12] <eddyb> I mean, as a NodeId. that's perfect because it's reserved for the dummy
[11:15:56] <eddyb> cmr: btw, I kinda made it so now you can use 2^32 - 1 nodes on 32-bit targets instead of half that :P
[11:21:58] <eddyb> (the previous check wasn't that good either, but I doubt anyone hit it)
[11:34:46] *** Quits: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au) (Ping timeout)
[11:35:41] *** Joins: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au)
[11:37:43] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[11:38:48] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[11:41:18] <eddyb> dbaupp: changed all of the metadata stuff, yay explicit types in more places
[11:41:30] <eddyb> but I left the string interner alone for now
[11:52:40] *** Quits: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au) (Ping timeout)
[11:56:28] <eddyb> this shouldn't need more than half a GB, but hygiene doesn't help :(
[12:02:42] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[12:02:42] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/FmiD5w
[12:02:42] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[12:07:30] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[12:07:30] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/hcvWRQ
[12:07:30] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[12:07:34] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[12:07:34] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/T6tjxA
[12:07:34] <ghrust> 13rust/06auto 141c949af 15Alex Crichton: Correctly handle libuv errors in addrinfo calls...
[12:07:34] <ghrust> 13rust/06auto 14567bf3d 15bors: auto merge of #10664 : alexcrichton/rust/issue-10663, r=luqmana...
[12:07:34] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[12:11:41] *** flaper87 is now known as flaper87|afk
[12:18:17] *** Quits: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net) (Quit: Sharp)
[12:20:19] *** Joins: doomlord_ (servitor@moz-9738D381.range86-160.btcentralplus.com)
[12:26:59] *** flaper87|afk is now known as flaper87
[12:27:19] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[12:36:12] *** kimundi is now known as zz_kimundi
[12:56:50] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[12:56:50] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14567bf3d to 144fe1296: 02http://git.io/N3iJvQ
[12:56:50] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[12:56:59] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[12:56:59] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/AWGqCQ
[12:56:59] <ghrust> 13rust/06auto 149c6bba9 15Vijay Korapaty: Updating docs with updated closure syntax, `&fn` -> `||`
[12:56:59] <ghrust> 13rust/06auto 14ef70b76 15bors: auto merge of #10668 : vky/rust/closure-doc-update, r=alexcrichton
[12:56:59] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[13:04:04] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[13:06:58] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[13:10:36] *** zz_kimundi is now known as kimundi
[13:15:54] *** Quits: dbussink (dbussink@moz-E0A5568C.bussink.me) (Ping timeout)
[13:23:43] *** Joins: jdm (jdm@moz-AC9499B2.cable.teksavvy.com)
[13:26:26] *** Joins: dbussink (dbussink@moz-E0A5568C.bussink.me)
[13:40:20] *** Quits: dbussink (dbussink@moz-E0A5568C.bussink.me) (Ping timeout)
[13:45:24] *** Joins: dbussink (dbussink@moz-E0A5568C.bussink.me)
[14:12:28] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[14:12:28] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/AWGqCQ
[14:12:28] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[14:16:11] <eddyb> there's a lot of cloning going on in the parser, is all of that desired?
[14:16:28] <eddyb> the maybe_whole! macro and its uses, to be precise
[14:17:27] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[14:17:27] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/A4ErHQ
[14:17:27] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[14:17:59] <eddyb> Leo`: error: aborting due to 129 previous errors // after I got libsyntax to compile :D
[14:18:06] <eddyb> @ sure makes it easier
[14:56:55] <Leo`> eddyb: how did you get libsyntax to compile ? :/
[14:57:09] <Leo`> you used @ finally ?
[14:57:28] <eddyb> oh yeah, I started with @
[14:57:36] <eddyb> right now I'm fixing librustc
[14:57:40] <Leo`> ok
[14:58:50] <eddyb> half of it is replacing the visitor/folder fn signatures and the other half is removing the bind-by-ref in matches over enums where previously Block was unboxed
[14:59:15] <Leo`> yup
[15:26:01] *** Quits: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net) (Quit: Sharp)
[15:27:39] *** kimundi is now known as zz_kimundi
[15:30:30] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[15:32:00] *** Quits: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net) (Quit: Sharp)
[15:57:58] <eddyb> cmr: Expr_ is down by 40 (56 with my current PR) bytes
[16:00:09] <eddyb> node_block(@Block) wasn't the largest ast_node O_O?
[16:00:15] <eddyb> s/@//
[16:01:15] <eddyb> I am foolish
[16:01:19] <eddyb> pub type variant = Spanned<variant_>;
[16:01:21] <eddyb> that's huge
[16:02:24] <Leo`> https://github.com/mozilla/rust/pull/10675 need review here
[16:04:41] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[16:04:41] *** ChanServ sets mode: +ao pcwalton pcwalton
[16:05:28] <Leo`> hello pcwalton :p
[16:06:40] <eddyb> (fn_decl, @Block) is also huge. maybe @fn_decl?
[16:06:46] <pcwalton> hi
[16:07:20] <eddyb> pcwalton: serious progress in shrinking memory usage :D
[16:07:37] <pcwalton> eddyb: oh, nice
[16:07:43] <eddyb> although this gets kinds tiring without a Java IDE :P
[16:07:50] <pcwalton> reducing AST bloat or something?
[16:07:53] <eddyb> *kinda
[16:07:56] <Leo`> haha
[16:08:22] <Leo`> pcwalton: if you have 2 secs for a "r+" here https://github.com/mozilla/rust/pull/10675 :P
[16:08:22] <eddyb> pcwalton: yeah, there's big structures embedded in critical enums, I'm boxing them
[16:10:02] * eddyb wishes libsyntax and librustc were self-consistent
[16:10:40] <eddyb> my oCd brain can't stand mixed naming styles, but I'll try to keep myself from changing things outside of scope
[16:11:07] <eddyb> btw, could we have u32 arena "pointers" at some point?
[16:11:42] <eddyb> that would be the last shrink step
[16:12:13] <pnkfelix> eddyb: I assume extra::Arena is not up to the task, right?
[16:12:23] <pnkfelix> eddyb: (I haven't tried using it myself, its an honest question.)
[16:13:19] <eddyb> I don't know, this has to be discussed with nmatsakis, I've heard he has plans for using arenas in librustc
[16:13:58] <pnkfelix> eddyb: okay so you are aware of #10444 then ?
[16:14:23] <eddyb> eeeeh nope
[16:14:48] <strcat> pnkfelix: extra::arena is pretty close to useless
[16:15:09] <pnkfelix> strcat: okay, like I said, haven't tried using it.
[16:15:14] <strcat> I guess it existed before there was an alternative to @? *shrug*
[16:15:37] <Leo`> pcwalton: fixed the case in the error message
[16:15:50] <strcat> it seems more of an obsolete proof of concept that a useful module
[16:16:35] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[16:16:37] <Leo`> but not sure if the error message is right anyway
[16:17:53] *** Quits: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net) (Quit: Sharp)
[16:22:17] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[16:22:17] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/A4ErHQ
[16:22:17] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[16:22:18] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[16:22:18] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/xO6oFA
[16:22:18] <ghrust> 13rust/06auto 14a3a6618 15LeÌo Testard: Forbid keywords as lifetime parameters names.
[16:22:18] <ghrust> 13rust/06auto 148579a7d 15bors: auto merge of #10675 : LeoTestard/rust/lifetimes-no-keywords, r=pcwalton...
[16:22:18] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[16:26:55] <pcwalton> why is arena so terrible?
[16:28:46] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[16:33:37] *** Quits: jdm (jdm@moz-AC9499B2.cable.teksavvy.com) (Quit: Lost terminal)
[16:35:55] <strcat> pcwalton: it's slower than using malloc directly
[16:36:18] <Leo`> https://github.com/mozilla/rust/pull/10581/files why removing all those do s ? :(
[16:36:32] <pcwalton> because "do" is going away except for ~fn
[16:36:43] <Leo`> it's sad :/
[16:36:45] <strcat> dunno exactly what is wrong with it
[16:36:47] <Leo`> I liked the do
[16:36:49] <pcwalton> I am tired of defending this decision
[16:37:01] <strcat> spawn(proc() { }) looks good to me
[16:37:05] <Leo`> oh.
[16:37:12] <pcwalton> it is because || infers to the right kind of closure
[16:37:16] <tikue> has it actually been controversial? i thought it was generally considered the right thing
[16:37:23] * strcat hates `do` :)
[16:37:31] <Leo`> I haven't read anything about it in fact, sorry
[16:37:33] <pcwalton> which makes it hard to tell when you're allocating
[16:37:36] <pcwalton> no problem
[16:37:49] <pcwalton> tikue: it was very controversial
[16:37:55] <Leo`> but I liked the do syntax
[16:37:59] <strcat> I think 'let x = do foo |x| { };' looks a lot worse than 'let x = foo(|x| { });'
[16:38:07] <Leo`> well I don't know
[16:38:14] <pcwalton> the problem is that it is weird from type checking POV
[16:38:18] <strcat> only looks better for zero-parameter closures imo
[16:38:35] <pcwalton> it just takes the "expected type"
[16:38:36] <strcat> and even then it's multiple ways of doing the same thing which I detest :)
[16:38:41] <eddyb> it only removes the trailing );
[16:38:47] <Leo`> pcwalton: yes I imagine there was more important arguments to its removal than syntactic point of view
[16:39:14] <eddyb> not even ;, just )
[16:39:29] <Leo`> the ( also
[16:39:36] <Leo`> if there is a single parameter
[16:39:44] <eddyb> the do with_ pattern seemed cool IMO, but it can find another home
[16:39:46] <Leo`> and the || too
[16:39:52] <pcwalton> eddyb: it's not a great pattern
[16:39:57] <pcwalton> bad for performance and causes the pyramid of doom
[16:40:10] <Leo`> the pyramid of doom... ? :d
[16:40:13] <eddyb> it looks better than the pyramid, but I get your point
[16:40:17] <pcwalton> too much rightward drift
[16:40:54] <eddyb> we get that with error matching too, but you can return early, I guess
[16:40:56] <Leo`> what's the current state about closures anyway ? I missed some things
[16:41:00] <Leo`> proc is the new &fn ?
[16:41:05] <eddyb> ~once fn
[16:41:09] <Leo`> mh
[16:41:12] <Leo`> oh yes
[16:41:19] <Leo`> and &fn is now written || ?
[16:41:29] <strcat> yes
[16:42:07] <Leo`> well
[16:42:23] <Leo`> there's Tony Hoare speaking in my university in about ~20 mins
[16:43:13] <eddyb> that reminds me of school. teehee
[16:43:23] * eddyb has a dark secret
[16:43:26] <Leo`> wut
[16:44:49] <friggle> annoying Microsft Research has now moved across Cambridge. He used to be in the building next door and you'd frequently see him at lunch in the cafeteria
[16:45:38] <friggle> *annoyingly
[16:48:12] *** Quits: pnkfelix (pnkfelix@87C1F78E.1DE10CA8.D8E68FF6.IP) (Quit: Leaving.)
[16:50:57] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[16:54:41] *** Quits: dcrewi (david@moz-AB8667CE.gyrae.net) (Ping timeout)
[16:59:13] *** flaper87 is now known as flaper87|afk
[17:00:04] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[17:00:04] *** ChanServ sets mode: +ao pcwalton pcwalton
[17:02:41] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[17:02:41] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 148579a7d to 14ef70b76: 02http://git.io/N3iJvQ
[17:02:41] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[17:02:43] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[17:02:43] <ghrust> 01[13rust01] 15bors pushed 13 new commits to 06auto: 02http://git.io/vSWokA
[17:02:43] <ghrust> 13rust/06auto 144068139 15Patrick Walton: test: Remove most uses of `&fn()` from the tests.
[17:02:43] <ghrust> 13rust/06auto 149e61057 15Patrick Walton: librustc: Remove remaining uses of `&fn()` in favor of `||`.
[17:02:43] <ghrust> 13rust/06auto 146801bc8 15Patrick Walton: libsyntax: Remove the old-style borrowed closure type syntax from the...
[17:02:45] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[17:04:06] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[17:06:11] <eddyb> woo, Expr_ down by 72 bytes
[17:06:26] <eddyb> 176 -> 104, almost halved
[17:07:20] <eddyb> ast_node was butchered, 104 -> 32
[17:07:30] <eddyb> now we're getting somewhere!
[17:07:47] <eddyb> cmr, dbaupp: ^^
[17:17:39] <friggle> eddyb: is it making a measurable difference in overall memory usage?
[17:17:47] <eddyb> will see soon
[17:17:59] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[17:17:59] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 141c46e12 to 14ef70b76: 02http://git.io/N3iJvQ
[17:17:59] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[17:18:00] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[17:18:00] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/P6wN9g
[17:18:00] <ghrust> 13rust/06auto 147f35012 15Alex Crichton: Correctly handle libuv errors in addrinfo calls...
[17:18:00] <ghrust> 13rust/06auto 14e03f17e 15bors: auto merge of #10664 : alexcrichton/rust/issue-10663, r=luqmana...
[17:18:00] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[17:21:02] <Leo`> https://github.com/mozilla/rust/pull/10675/files I think it's fixed
[17:21:07] <Leo`> if someone can r+
[17:22:11] *** zz_kimundi is now known as kimundi
[17:26:03] <Leo`> strcat: -^
[17:27:18] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[17:28:51] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[17:29:58] <eddyb> ^ that's the sound of trans finishing
[17:38:29] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[17:38:29] *** ChanServ sets mode: +o pnkfelix
[17:39:07] <Leo`> nobody to r+ me ? :(
[17:39:39] <eddyb> moment of truth
[17:40:35] <eddyb> it's looking good, under 700MB so far
[17:41:41] <Leo`> but you used @T
[17:41:43] <Leo`> you cheater.
[17:41:58] <eddyb> it's full of @
[17:42:08] <strcat> yeah and someone is going to have to do the hard work of removing it
[17:42:11] <strcat> so why add more?
[17:42:27] <eddyb> strcat: because you can't use anything else
[17:42:32] <strcat> @ is going to become Gc, and it's going to use a lot more memory
[17:42:40] <strcat> eddyb: why not?
[17:42:55] <eddyb> it's actually going to be easier to move everything *at once* from @T to something else
[17:43:24] <strcat> no it's not
[17:43:31] <strcat> moving from @ isn't going to be easy
[17:43:42] <eddyb> it can be done in parallel
[17:43:58] *** Joins: nrc (nrc@7BE24E90.A5032A01.3CFC199D.IP)
[17:44:06] <strcat> it's not going to be easy to remove @, not at all
[17:44:14] <strcat> unless you port it all to Gc
[17:44:18] <eddyb> you can't just use Rc<T> right now because a lot of things aren't Freeze
[17:44:19] <strcat> anything else will have different requirements
[17:44:35] <strcat> by switching to more @, you're creating the work of figuring out which things are actually cyclic and so on later
[17:44:47] <strcat> eddyb: which things in the AST aren't Freeze?
[17:44:52] <eddyb> Block isn't
[17:44:53] <Leo`> token_tree
[17:45:03] <Leo`> and thus everything that uses it
[17:45:10] <Leo`> because of @muts
[17:45:18] <strcat> the AST is mutable?
[17:45:30] <Leo`> apparently
[17:45:42] <strcat> anyway @ is going to start using a lot more memory
[17:45:46] <eddyb> also, if you move everything (or some things) to Rc<T> and then you want to move it to an arena, it will be harder than @T -> arena
[17:45:49] <strcat> so switching to it is counter-productive imo
[17:45:57] <strcat> @ won't just magically be replaced with Rc or some arena type
[17:46:00] <strcat> it will not happen.
[17:46:31] <strcat> everything using @ will switch to using a GC that's going to be consuming 3x+ the amount of memory to maintain perf, because that's how GCs are
[17:46:52] <strcat> eddyb: how will @T -> arena be  easy? at all?
[17:46:57] <strcat> an arena will be a lot less flexible than Rc
[17:47:09] <eddyb> easier than @T -> Rc<T> -> arena
[17:47:26] <strcat> moving to arenas in rustc isn't realistic if moving to Rc<T> is viewed as too hard
[17:47:35] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[17:47:35] <strcat> how are you going to deal with the AST having a lifetime bound/
[17:47:38] <strcat> the whole AST
[17:47:45] <pnkfelix> strcat: you are right and wrong.   Gc's do typcially need to use 2 â€” 3x the amount of live memory to have competitive perofrmance.  But the existing  @T are pretty bad (e.g. carrying the links for a doubly-linked list as well as refcounts)
[17:47:46] <strcat> I thought we wanted the AST to be sendable?
[17:48:10] <strcat> pnkfelix: yeah but these nodes are pretty huge, so the header isn't a big deal
[17:48:23] <strcat> and Rc has a 1-word header, today, and only does refcounts on ownership splits
[17:48:39] <pnkfelix> strcat: Also, its not clear to me whether we'll end up using the same sort of load factor.
[17:48:53] <eddyb> sooo, uint -> u32 shaves 200MB from my testcase
[17:49:03] <benh> heh
[17:49:12] <eddyb> boxing some structures in @ gives me another 200MB
[17:49:15] <benh> petition to rename uint to ureallybig
[17:49:16] <pnkfelix> strcat: though its certainly safer to guess that we would
[17:49:39] <strcat> pnkfelix: I'm sure it will perform worse than Rc, though, and the AST isn't ever cyclic afaik
[17:49:57] <strcat> eddyb: if you removed all the @ from the AST you could safely use new_unchecked
[17:49:57] <eddyb> and it seems faster, too
[17:50:11] <eddyb> strcat: the key word here is *all*
[17:50:16] <strcat> sure
[17:50:22] <strcat> and adding more @ makes it harder to do that
[17:50:29] <strcat> step backwards imo, we don't want GC in rustc
[17:50:57] <strcat> even failure in rustc is too high a cost, but good luck to anyone trying to restructure it to bubble up errors
[17:50:57] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[17:50:57] *** ChanServ sets mode: +ao pcwalton pcwalton
[17:52:07] <strcat> is rustc just going to be rewritten as a whole? what's the path forwards for it?
[17:53:25] <benh> If failure is too hight a cost for rustc, isn't that a problem with failure more so than rustc
[17:53:31] <strcat> benh: no
[17:53:37] <strcat> well, sure
[17:53:45] * strcat shrugs
[17:53:51] <strcat> LLVM disables exceptions and RTTI
[17:53:56] <strcat> they have a very real size and performance cost
[17:54:06] <strcat> they are useful features though
[17:54:12] <strcat> they have a known cost, across the codebase
[17:54:48] <strcat> the problem is using them in something performance critical like a compiler
[17:54:57] <strcat> the *whole* codebase is perf critical
[17:55:09] <strcat> that's not usually going to be the case
[17:55:10] <pnkfelix> â€¦ a jit is performance critical ...
[17:55:14] <pnkfelix> .. but a compiler ?
[17:55:18] <strcat> pnkfelix: yes
[17:55:32] <eddyb> don't use too much memory and don't take a century
[17:55:36] <strcat> compile-time performance is the number one thing clang offers over gcc
[17:55:41] <pnkfelix> <shrug>
[17:55:42] <strcat> rust won't succeed if it takes as long to compile as it does
[17:55:49] <strcat> compile-time is your cycle-time for development
[17:55:55] <pnkfelix> yes, there is certainly a threshold that we need to get over
[17:56:04] <strcat> pnkfelix: well I think it's nowhere near that threshold
[17:56:10] <Leo`> maybe if we want to reduce compile-time we shoudl begin with separate compilation
[17:56:33] <strcat> pnkfelix: if rust didn't have any compiler/library bugs, and was much faster, and had a nice stdlib, I think people still wouldn't be using it
[17:56:46] <Leo`> recompiling hundred of files beacuse of a one-word modification seems a more important concern than the presence of GC in the compiler to me :p
[17:57:00] <eddyb> what's the baseline for rustc-stage2 memory usage? 1.4GB?
[17:57:16] <eddyb> 1.27GB. I won :D
[17:57:26] <strcat> pnkfelix: 50% faster compile-time means quite a lot when a build takes even 4 minutes
[17:57:29] <eddyb> it's above 1GB for only a couple seconds
[17:57:32] <strcat> it's a reason to pick another language
[17:57:44] <eddyb> oh wow that's a fucking lot
[17:57:50] <strcat> so yeah, I think the whole compiler codebase is performance critical
[17:57:57] <strcat> that's how LLVM/clang is viewed
[17:58:16] <strcat> that's why they use sum types for error reporting and not exceptions
[17:58:33] <pnkfelix> don't get me wrong, at one time I was using jikes instead of javac
[17:58:34] <strcat> and that's a lot more painful in C++ than rust
[17:58:39] <pnkfelix> for exactly the reasons you are citing
[17:58:50] *** Joins: andrew-__ (andrew-d_w@moz-5A92CAFF.dsl.static.sonic.net)
[17:59:00] <strcat> pnkfelix: if rustc was written in C++ and we compiled it with clang, it would build in 20 seconds and not 4 minutes
[17:59:02] <eddyb> friggle: quite a measurable difference
[17:59:03] <strcat> that's a *serious* issue
[17:59:23] <rbancroft> strcat: so why is it so slow?
[17:59:31] *** Quits: andrew-d_w (andrew-d_w@moz-9A2674DF.dsl.static.sonic.net) (Ping timeout)
[17:59:33] * Leo` doesn't understand why nobody cares about separated compilation
[17:59:34] <strcat> you don't get performance without writing for performance
[17:59:38] <eddyb> LLVM is actually what takes most of the time
[17:59:43] <strcat> eddyb: no
[17:59:54] <eddyb> http://huonw.github.io/isrustfastyet/mem/
[17:59:54] <rbancroft> does it do whole program optimization or something?
[18:00:06] <eddyb> that says 30s in rustc, the rest in LLVM
[18:00:07] <strcat> eddyb: in a no-optimization build, it doesn't
[18:00:18] <strcat> eddyb: the time is spent in LLVM because rust generates such awful code, in an optimized build
[18:00:45] <eddyb> that's a place to start, I guess, for improving performance
[18:00:51] <strcat> rust is basically in the interpreted language ballpark unoptimized, with the stdlib
[18:01:27] *** Joins: jdm (jdm@FCCEA34F.7672369.D8E68FF6.IP)
[18:01:50] *** Quits: andrew-__ (andrew-d_w@moz-5A92CAFF.dsl.static.sonic.net) (Input/output error)
[18:01:54] *** Joins: pnkfelix1 (pnkfelix@moz-43495417.fbx.proxad.net)
[18:02:10] *** Joins: andrew-d_w (andrew-d_w@moz-9A2674DF.dsl.static.sonic.net)
[18:02:13] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[18:02:57] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Ping timeout)
[18:03:41] *** pnkfelix1 is now known as pnkfelix
[18:04:53] <strcat> imo if rust is going to succeed the compile-time and performance needs to be comparable to C++, or no one will take a second look at it for anything serious
[18:05:17] <sfackler> re-r anyone? https://github.com/mozilla/rust/pull/10649
[18:05:26] <sfackler> was just missing a "pub" before "fn main" in a run-pass test
[18:05:36] <strcat> if you can't do better than C++ *without clang modules*, there's a problem
[18:05:42] <Leo`> https://github.com/mozilla/rust/pull/10675/files this one too. :P
[18:05:46] <strcat> (and we're at least an order of magnitude slower)
[18:05:48] <Leo`> a typo in the test
[18:06:25] <rbancroft> is there a way to preserve generated llvm code?
[18:06:41] <strcat> rbancroft: hm?
[18:07:24] <rbancroft> somehow save the llvm ir in a readable format from a rust build
[18:07:25] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[18:07:30] <strcat> rbancroft: --emit-llvm -S
[18:07:50] <rbancroft> thanks strcat
[18:21:02] <friggle> pcwalton: do you have a source for firefox's move from incremental rebuild to an "amalgamated" build (to use sqlite terminology)
[18:23:31] <pcwalton> friggle: mozilla dev platform thread "unified builds"
[18:23:39] <friggle> pcwalton: cheers
[18:26:58] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[18:26:58] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/P6wN9g
[18:26:58] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[18:29:19] *** Quits: mark_edward (mark@moz-DCB0B750.lightspeed.cicril.sbcglobal.net) (Quit: Leaving)
[18:31:54] <strcat> pcwalton: so they're manually doing LTO?
[18:31:56] <strcat> ;\
[18:32:10] <pcwalton> yes to avoid parsing .h over and over
[18:32:32] <pnkfelix> very odd, i thought precompiled headers were standard feature in most compilers nowadays...
[18:32:45] <strcat> well, clang has modules too, but for C++ they're still experimental
[18:32:45] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[18:32:45] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/Ia1Hwg
[18:32:45] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[18:32:57] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[18:32:57] <ghrust> 01[13rust01] 15bors pushed 13 new commits to 06auto: 02http://git.io/3AO2bA
[18:32:57] <ghrust> 13rust/06auto 144068139 15Patrick Walton: test: Remove most uses of `&fn()` from the tests.
[18:32:57] <ghrust> 13rust/06auto 149e61057 15Patrick Walton: librustc: Remove remaining uses of `&fn()` in favor of `||`.
[18:32:57] <ghrust> 13rust/06auto 146801bc8 15Patrick Walton: libsyntax: Remove the old-style borrowed closure type syntax from the...
[18:32:59] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[18:33:09] <strcat> pcwalton: they don't actually get parsed over and over though... there are include guards ;\
[18:33:15] <strcat> clang/gcc optimize that to avoid checking them again
[18:33:25] <pcwalton> strcat: look at the numbers.
[18:33:25] <strcat> don't even need pragma once
[18:33:28] * strcat shrugs
[18:33:45] <strcat> I'd blame gnu make and firefox before blaming gcc/clang
[18:34:09] <strcat> make is absolutely terrible fwiw
[18:35:08] <strcat> pcwalton: well I can believe that it would be faster but it still seems pretty odd if they're not doing as much in headers as boost ;p
[18:41:32] <eddyb> cmr: sorry to ask twice, but is there any chance you can build this for "Is Rust Slim Yet"? https://github.com/mozilla/rust/pull/10676
[18:41:40] <eddyb> strcat: ^^ unleash your hate btw
[18:44:39] * strcat doesn't really care
[18:45:16] <eddyb> 400MB less at the peak for my own code is a lot *to start with*
[18:45:25] <strcat> until a GC lands
[18:45:28] <strcat> and it increases mem usage
[18:46:04] <sfackler> is there any reason Block &co were changed to @Block and not ~Block?
[18:46:38] <eddyb> sfackler: hmm. consistency, sharing, *maybe*
[18:46:53] <strcat> I still think it should be Rc
[18:47:00] <strcat> and if there's something non-Freeze, that should be fixed
[18:47:30] <strcat> since afaik the AST is immutable, or supposed to be
[18:47:38] <eddyb> well, here's an idea: I think there's parts of the API (like the visitor) which can just be &T, not @T or ~T or anything else
[18:48:49] <eddyb> most of that should be easy to mass-replace, and then... I need nmatsakis, though, I could be saying something wrong (and strcat will know it)
[18:49:08] <strcat> if it's easy to mass replace why not do it now? Rc isn't going to drastically change
[18:49:28] <eddyb> I mean @T -> &T
[18:49:42] <eddyb> the "and then" part is either Rc or arenas
[18:51:24] <eddyb> I also so some naive (to the uninitiated, at least) implementations
[18:51:44] <eddyb> a lot of cloning
[18:52:53] <eddyb> [15:32] <eddyb> noop_fold_block could return the same block if its contents weren't modified, I would think
[18:53:00] <eddyb> oh wow, it's been 5 hours already?
[18:56:11] <friggle> pcwalton: why is gcroot in llvm a deadend? Having to spill sucks, but it's not *that* bad
[18:56:19] <pcwalton> because it spills :)
[18:56:34] <pcwalton> and can't be fixed without a total change to the API
[18:57:03] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[18:57:03] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14d8abd24 to 14e03f17e: 02http://git.io/N3iJvQ
[18:57:03] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[18:57:03] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[18:57:03] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/27vWrQ
[18:57:03] <ghrust> 13rust/06auto 145b42962 15klutzy: Turn off attribute_usage warning on check-fast
[18:57:03] <ghrust> 13rust/06auto 149f9efae 15bors: auto merge of #10673 : klutzy/rust/quite, r=alexcrichton
[18:57:04] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[18:57:41] <friggle> pcwalton: yeah, llvm devs happy to have something better...just need someone to implement it :)
[18:59:26] * strcat hasn't had a great experience contributing to LLVM
[18:59:32] <strcat> my tiny little change is still sitting there
[18:59:43] <strcat> and I worked with someone with fix mergefunc and their changes are still sitting there ;\
[19:00:19] <strcat> doesn't inspire confidence in what would happen with a significant change
[19:00:26] <strcat> unless you're an insider
[19:00:33] <friggle> yes, codereview can be a bottleneck. The appropriate developers can be hassled in person if you can make it to a meetup
[19:01:02] <strcat> why should you have to hassle someone for a 12 line, trivial change with a test? ;\
[19:01:15] <strcat> reminds me of gnome
[19:01:37] <friggle> strcat: I agree, you shouldn't. I meant that was an approach for a large change. That does kind of suck
[19:01:40] <jld> Interesting -- when I had a small patch for LLVM it was handled pretty promptly.
[19:01:40] * strcat has a patch for a focus bug sitting in the gtk bug tracker since 2010
[19:02:13] <strcat> jld: well was it a fix for something a `clang` user would have run into? I expect they'd have fixed that quickly
[19:02:35] * strcat shrugs
[19:04:57] <acrichto> eddyb: ping
[19:05:02] <eddyb> acrichto: pong :D
[19:05:17] <acrichto> eddyb: for #10670, it looks like the interner has lots of 'as uint' casts around it?
[19:05:29] <eddyb> pcwalton: what did you do? r+ triggers bors?
[19:05:35] <pcwalton> yeah
[19:05:36] <pcwalton> it does
[19:05:38] <eddyb> DON'T
[19:05:40] <pcwalton> oh
[19:05:46] <eddyb> "Note: this contains the commit from my #10670 PR, don't merge before that."
[19:05:50] <pcwalton> oops
[19:05:52] <strcat> eddyb: you can delete an r+ on your commit
[19:05:58] <pcwalton> deleted
[19:05:59] <eddyb> I should've made that BIG
[19:06:04] <eddyb> pcwalton: I panicked :)))
[19:06:10] <jld> strcat: Looks like reproducing it with Clang would require a C switch statement with 1<<32 cases.  So no.
[19:06:30] <eddyb> acrichto: the interner works with uint, not Name. should I change its API?
[19:06:33] <jld> strcat: But the LLVM example was pretty small, and the misopimization inverted the sense of a test, so maybe that made is scarier than usual.
[19:06:42] <acrichto> eddyb: sounds like it should change to Name
[19:06:53] <eddyb> okay, I'll try to not break anything
[19:06:56] <acrichto> eddyb: it'd be nice to avoid casts entirely, but it may be necessary in a few locations
[19:07:03] <strcat> I'll be happy when we can use mergefunc
[19:07:09] <strcat> just taking so long :(
[19:07:13] <acrichto> eddyb: also for metadata, I'd just run this through bors to see if anything dies
[19:07:30] <strcat> and I'd rather not be the one to ask for more rust-specific LLVM patches
[19:07:33] <eddyb> hmm, okay, let me change the interner first
[19:08:40] <jld> (It was also the kind of thing I'd expect a fuzz tester at the LLVM level to have caught pretty quickly.)
[19:08:43] <eddyb> acrichto: dbaupp told me that it's all using explicit methods (and something to do with ebml), and my casts were enough
[19:09:00] <acrichto> eddyb: yeah I don't think that problems will arise
[19:10:51] <strcat> how do you go from an ast::item -> the attributes it has?
[19:11:11] <strcat> hrm
[19:11:22] <strcat> I guess via def id unless I'm overthinking it...
[19:11:22] <acrichto> pcwalton: you may be interested in #10678
[19:11:36] <acrichto> strcat: I don't think that there's an existing method of doing that
[19:11:45] <acrichto> strcat: is this for feature gating thread_local?
[19:11:47] <strcat> yes
[19:11:54] <acrichto> just doing it for statics is fine
[19:12:10] <acrichto> lints elsewhere can detect usage of thread_local on a function and error/warn about it
[19:12:48] <sfackler> acrichto: re-r? was just missing a "pub" in front of "fn main" in a run-pass test https://github.com/mozilla/rust/pull/10649
[19:12:53] <strcat> so... node id to attributes then?
[19:13:03] <Luqman> strcat: item.attr no?
[19:13:07] <acrichto> sfackler: r+
[19:13:12] <sfackler> thanks
[19:13:24] <acrichto> strcat: why do you need to go from id to attributes? in feature_gate you've got the nod
[19:13:27] <acrichto> node*
[19:13:42] <strcat> oh, right
[19:13:45] <strcat> I was overthinking it
[19:13:58] * strcat is used to having to get them in trans
[19:14:23] * jld wonders how many cores it takes for the Gecko full build to be faster than, say, stage1/bin/rustc minus LLVM.
[19:14:25] <strcat> acrichto: it's easier to just feature gate it on any item anyway ;p
[19:14:44] <strcat> saves me an ast::item_static(_, _, _) =>
[19:14:57] <acrichto> strcat: sure, plus I think you'll have to allow all usage of it for now b/c I made the brilliant decision of denying unknown features by default
[19:15:40] <strcat> yeah I added managed_boxes so I know what a pain it is
[19:15:56] <strcat> takes 2 snapshots or something :\
[19:16:08] <strcat> well to forbid it at stage0
[19:16:10] <acrichto> if you want to change that to warn-by-default I would totally be ok with that
[19:17:44] *** Joins: andrew-__ (andrew-d_w@moz-9A2674DF.dsl.static.sonic.net)
[19:18:22] *** Quits: andrew-d_w (andrew-d_w@moz-9A2674DF.dsl.static.sonic.net) (Ping timeout)
[19:18:31] <strcat> should I add a test for this? or just check if it works
[19:18:36] <strcat> well I guess I can't check
[19:18:39] <strcat> because it's allowed...
[19:18:50] * strcat sighs
[19:20:21] <eddyb> acrichto: added one file to the diff and removed two, that's nice :D
[19:20:35] <acrichto> eddyb: yay! that's what I like to hear!
[19:21:29] <eddyb> acrichto: I might actually have *less* casts now :P
[19:21:39] <acrichto> that's what I really like to hear!
[19:22:18] <eddyb> since I think I removed a couple, added one and just replaced the uint/int in the rest with the actual type
[19:22:34] <strcat> acrichto: https://github.com/mozilla/rust/pull/10312
[19:23:31] <strcat> meh typo
[19:23:57] <acrichto> strcat: can you add a NOTE to change at stage0 and also elaborate a bit more on why its experimental? Basically something that encapsulates that there's no destructors run, it doesn't correspond to tasks at all, etc.
[19:24:11] <acrichto> not like a paragraph, but just a sentence or two
[19:24:21] <strcat> I don't think you can put types with dtors in statics though?
[19:24:30] <sfackler> you can!
[19:24:36] <strcat> uh, isn't that bad?
[19:24:41] <sfackler> probably
[19:24:51] <acrichto> you shouldn't be able to
[19:24:57] <acrichto> but I think we're letting it leak right now
[19:25:12] <acrichto> MUTEX_INIT has destructors (from the NonCopyable structs)
[19:25:33] <eddyb> bah, I need to add new casts in the interner
[19:25:40] <strcat> I don't think it's a problem that it doesn't correspond to tasks though, it just means #[task_local] is needed
[19:25:47] <acrichto> eddyb: for array accesses?
[19:25:52] <strcat> for example for the usage inside the scheduler, it needs to correspond to threads
[19:25:56] <acrichto> strcat: yes, but that should be explained
[19:25:57] <eddyb> acrichto: from vec.len()
[19:26:06] <strcat> acrichto: I explained it in rust.md
[19:26:07] <acrichto> eddyb: oh well, I suppose that's necessary
[19:26:18] <acrichto> strcat: the error message is also a good place to put it
[19:26:25] * strcat shrugs
[19:27:35] <strcat> acrichto: there
[19:27:56] <strcat> fwiw it could easily handle dtors
[19:28:03] <strcat> I just didn't think they worked in statics
[19:28:13] <acrichto> hmm, reading over the runtime implementation again, this is a lot of cfg(...)
[19:28:22] <strcat> acrichto: because mingw is broken
[19:28:25] <strcat> mingw-w64 works fine
[19:28:37] <acrichto> that means it shouldn't work on mingw, doesn't mean that there should be a littering of cfg everywhere
[19:28:37] <eddyb> strcat: you get a cookie for using the right name :D
[19:28:52] <strcat> acrichto: it's really a PITA because the test harness adds a new runtime
[19:29:03] <strcat> it can be cleaner when it's past stage0
[19:29:10] <acrichto> we're currently at a state of "very few cfg"
[19:29:43] <strcat> the test harness adds a new runtime with a TLS implementation not corresponding to the old one if you write it the sane way
[19:30:10] <acrichto> why did you change the testable libstd to use the realstd's tls key?
[19:30:35] <strcat> because otherwise std and the code in the tests use different TLS and it breaks
[19:31:26] <strcat> acrichto: when you build the std test harness, it builds the whole stdlib again
[19:31:30] <strcat> so you have two stdlibs
[19:31:38] <strcat> but you need 1 TLS
[19:31:40] <acrichto> strcat: yes I understand the problem, but why are you changing it?
[19:31:45] <strcat> hm?
[19:31:47] <strcat> I'm not changing it
[19:31:53] <jld> So I tried turning llvm::TypeKind into a #[repr(C)] enum, and: UNREACHABLE executed at /usr/local/src/rust/src/llvm/lib/IR/Core.cpp:168!
[19:31:54] <acrichto> it's working fine today, why does it need changing?
[19:32:04] * jld is afraid
[19:32:05] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[19:32:16] <strcat> acrichto: it uses pthread_setspecific today
[19:32:18] <strcat> not a global
[19:32:38] <strcat> hm why is it rejected thread_locl
[19:32:39] <acrichto> strcat: yes, but what goes wrong if you don't use the original runtime's key?
[19:32:51] <strcat> acrichto: the tests fail, TLS doesn't correspond
[19:32:57] <strcat> today, it doesn't use a global like this
[19:33:00] <strcat> so it uses the same TLS
[19:33:13] <strcat> /home/strcat/projects/rust/src/libstd/rt/local_ptr.rs:39:0: 39:58 note: add #[feature(thread_local)] to the crate attributes to enable
[19:33:15] <strcat> ;\
[19:33:16] <acrichto> both libstd and realstd use the same slot?
[19:33:26] <strcat> yes
[19:33:29] <strcat> I re-exported it
[19:33:34] <strcat> it's a weird dance
[19:33:43] <acrichto> no I mean before you did the reexportation
[19:33:44] <strcat> acrichto: you mean today? yes
[19:34:09] <strcat> why is it rejecting thread_local when I added it as Accepted?
[19:35:18] <acrichto> strcat: so I think the whole idea of local_ptr vs thread_local_storage is that local_ptr doesn't have any cfg statements
[19:35:39] <strcat> it passes tests like this and not without it ;\
[19:36:03] <acrichto> no I mean in general with if windows { ... } else { ... }
[19:36:07] <strcat> acrichto: afaik local_ptr just defines a thread-local ptr to use for task-local storage
[19:36:22] <strcat> and that's why it exists
[19:36:31] <pcwalton> acrichto: chase-lev! yay!
[19:36:48] <pcwalton> and it's generic!
[19:36:49] <pcwalton> you are my hero
[19:36:52] <acrichto> pcwalton: the never-freeing buffers may be a big problem though
[19:37:03] <acrichto> or rather never-freeing until the deque is completely gone
[19:37:20] <pcwalton> I wonder if I should spend my time this week trying to get Servo doing parallel layout
[19:37:29] <pcwalton> there's some grunt work needed to make it work
[19:37:34] <pcwalton> most notably, a rust upgrade...
[19:37:44] <pcwalton> although maybe I could just copy and paste it in
[19:37:46] <acrichto> pcwalton: it may be nice to have a dogfooding of the deque before it's put into the scheduler
[19:37:56] <pcwalton> I'll just copy and paste it in
[19:38:07] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[19:38:07] *** ChanServ sets mode: +o tjc
[19:38:10] <acrichto> strcat: r=me with the feature gate business sorted out
[19:38:19] <acrichto> strcat: you'll just need to add the feature to the list but never check for it
[19:38:22] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[19:38:22] <pcwalton> still some grunt work though. all the random pieces of data that layout uses are not yet thread safe :(
[19:38:24] <acrichto> and stage0 will have to uncomment the check
[19:39:08] <eddyb> pcwalton: if you want, I can probably rebase the boxing PR to not be on top of the other PR. but I'd rather have a discussion first, I think it can get even better
[19:39:17] *** Joins: vfetwnuncszu (david@moz-AB8667CE.gyrae.net)
[19:39:18] <pcwalton> eddyb: works for me
[19:39:22] <acrichto> pcwalton: the deque is also probably slower than it could be, I used SeqCst everywhere and I doubt that it's necessary
[19:39:32] *** vfetwnuncszu is now known as dcrewi
[19:39:34] <pcwalton> should be close enough
[19:39:58] <strcat> is our usage of queues really lock-free? I thought we just blocked
[19:40:09] <Luqman> strcat: you may be able to test on windows now that you can actually build rust with mingw64
[19:40:22] <strcat> Luqman: I tested on windows with rust-core
[19:40:26] <strcat> and C++11
[19:40:31] * strcat has windows 7 for victoria 2
[19:40:54] <jld> Oh of course.
[19:41:27] <jld> stage1/bin/rustc is built by stage0/bin/rustc.  So of *course* it's doing the ABI wrong.
[19:42:02] <pcwalton> does kind inheritance work?
[19:42:13] <pcwalton> I guess I can just try
[19:42:17] <strcat> I think so
[19:42:26] <pcwalton> yup, it does
[19:42:27] <pcwalton> yay
[19:42:32] <strcat> sully fixed it
[19:42:54] <sully> I don't think I fixed kind inheritance
[19:42:56] <sully> maybe I did
[19:42:59] <strcat> pcwalton: are you doing some kind of data parallelism?
[19:42:59] <sully> I think someone did
[19:43:03] <strcat> sully: I thought you did ;p
[19:43:05] <pcwalton> strcat: yeah, I am
[19:43:11] <strcat> maybe you fixed it by accident
[19:44:09] <strcat> pcwalton: afaik we need new kinds
[19:44:18] <strcat> &mut is neither Send or Freeze
[19:44:35] <pcwalton> yeah, I just hit that
[19:44:42] <pcwalton> :(
[19:45:38] <pcwalton> I wonder what the best way to hack around it is
[19:46:25] <strcat> probably not that hard to add them, just make types that aren't primitive non-Share and make &T/&mut T for T: Share also Share
[19:46:30] <strcat> and add #[unsafe_share]
[19:46:39] <strcat> at least that's what I was going to do
[19:46:56] <strcat> but making an equivalent to intel tbb task trees turned out to be harder than I expected ;p
[19:49:12] <strcat> it's like rust tasks for without context switching
[19:49:23] <strcat> so the tasks have to inform it when they're going to wait on a child so it can make another temporary thread
[19:49:37] <strcat> (since tbb tasks don't have stacks)
[19:51:08] <strcat> acrichto: had to deal with the lint changes too...
[19:51:23] <strcat> it'd be nice to make that lint even stricter
[19:52:31] <strcat> it didn't stop #[mutable_doc] from being used in hashmap.rs ... maybe it didn't get applied to anything
[19:58:56] <eddyb> pcwalton, acrichto: updated both PRs, and they're not stacked anymore
[19:59:02] <pcwalton> cool
[19:59:18] <eddyb> I will leave soon, have fun with them
[19:59:31] <acrichto> eddyb: thanks!
[20:01:11] <eddyb> if he doesn't mind, bug cmr for the third time to trigger a "is rust slim yet" build - or wait for a merge and automatic build :P
[20:04:27] *** Quits: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net) (Quit: Jesse)
[20:04:56] <Leo`> no one to r+ me ? :/
[20:07:51] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[20:07:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/27vWrQ
[20:07:51] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[20:08:51] *** Joins: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net)
[20:10:52] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Quit: Leaving.)
[20:11:33] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[20:11:33] *** ChanServ sets mode: +o pnkfelix
[20:13:04] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[20:13:04] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/8AGnog
[20:13:04] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[20:13:06] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[20:13:06] <ghrust> 01[13rust01] 15bors pushed 13 new commits to 06auto: 02http://git.io/RkpnAw
[20:13:06] <ghrust> 13rust/06auto 144068139 15Patrick Walton: test: Remove most uses of `&fn()` from the tests.
[20:13:06] <ghrust> 13rust/06auto 149e61057 15Patrick Walton: librustc: Remove remaining uses of `&fn()` in favor of `||`.
[20:13:06] <ghrust> 13rust/06auto 146801bc8 15Patrick Walton: libsyntax: Remove the old-style borrowed closure type syntax from the...
[20:13:08] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[20:14:59] *** Quits: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net) (Ping timeout)
[20:23:06] <eddyb> pcwalton: ok, I do feel a little bad, so I'll tell you https://github.com/mozilla/rust/pull/10670#issuecomment-29281387 on the same PR you r+'d
[20:23:10] <eddyb> good night!
[20:24:52] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[20:26:14] *** Joins: Sharp (Sharp@moz-7B61DF4.dsl.static.sonic.net)
[20:29:10] *** Joins: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP)
[20:40:27] *** Joins: lkuper (lkuper@moz-D862222C.dhcp-bl.indiana.edu)
[20:47:38] *** Quits: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net) (Quit: Jesse)
[20:59:04] *** Quits: eddyb (eddy@336E3A7F.D51DAF03.FB866788.IP) (Ping timeout)
[21:03:30] *** Joins: jmbto (jmbto@moz-FE174E29.fbx.proxad.net)
[21:04:41] *** Joins: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net)
[21:06:30] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[21:16:30] <pnkfelix> strcat: wait, what is "Share" supposed to denote?
[21:17:19] *** Quits: dbaupp (Thunderbir@moz-3BE4086E.lns20.syd6.internode.on.net) (Ping timeout)
[21:17:23] <strcat> pnkfelix: can be shared between parallel threads, when the threads are known to have a shorter lifetime than a reference passed to them will
[21:17:40] <strcat> pnkfelix: so you can do fork-join with &[T], &mut [T], &T, &mut T where T is Share
[21:17:44] <pnkfelix> strcat: ok
[21:17:56] <strcat> rust knows &mut doesn't alias another &mut or &
[21:18:19] <strcat> pnkfelix: niko has a blog post about it but the landscape might be different since he wrote it
[21:18:25] <strcat> TypeContents rewrite, etc.
[21:20:24] <acrichto> huh, apparently bors doesn't care what the contents of foo are in 'r=foo'
[21:20:33] <acrichto> bors just checks who made the comment
[21:20:58] <acrichto> r=bors!
[21:21:26] <pnkfelix> strcat: its what niko called `Isolate` in http://smallcultfollowing.com/babysteps/blog/2013/06/11/data-parallelism-in-rust/ ?
[21:21:33] <strcat> pnkfelix: I guess so! :)
[21:22:29] <pnkfelix> strcat: I see, and then he actually defines `Share` as some subset of `Isolate` that excludes &mut .  I will have to read this more carefully.
[21:22:32] <strcat> I'm not really sure we need both
[21:22:52] <strcat> anything you actually want to share has to be in an arc
[21:23:00] <strcat> unless it's &
[21:23:14] <strcat> just by the nature of not being able to deal with any other way
[21:23:28] <strcat> so concurrent data structures could just tag themselves as being safe to share
[21:24:02] <strcat> maybe I'm missing something important.
[21:25:14] <acrichto> pcwalton: it landed!
[21:25:24] <acrichto> *entire bors queue is invalidated*
[21:27:19] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[21:27:19] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/RkpnAw
[21:27:19] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[21:29:27] <strcat> hm
[21:29:37] <strcat> I wonder if there's any point in having both ShardMap and ConcurrentHashMap
[21:29:54] <strcat> the only overhead of ShardMap will be a layer of indirection for a vector
[21:30:03] <strcat> perhaps an extra cache miss I guess
[21:30:09] * strcat will just provide both, 20 lines of code
[21:32:43] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[21:32:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/3Z4oTg
[21:32:44] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[21:32:53] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[21:32:53] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/nhpl7A
[21:32:53] <ghrust> 13rust/06auto 141795ae4 15Daniel Micay: add `#[thread_local]` attribute...
[21:32:53] <ghrust> 13rust/06auto 142cf3d8a 15Daniel Micay: port the runtime to `#[thread_local]`
[21:32:53] <ghrust> 13rust/06auto 14a5af479 15Daniel Micay: add a thread_local feature gate
[21:32:55] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[21:33:53] <pcwalton> acrichto: \o
[21:33:54] <pcwalton> \o/
[21:34:28] <strcat> heh
[21:35:05] <strcat> pcwalton: do you know what the plan is for something like scope guards? it seems like you'd need stack once fns unless it was a language feature
[21:35:13] <pcwalton> strcat: yes, I want scope guards.
[21:35:46] <sfackler> is there any reason to not have stack once fns?
[21:35:59] * Eridius wants stack once fns
[21:36:05] <pcwalton> language complexity
[21:36:10] <sfackler> other than it being yet another thing
[21:36:15] <pcwalton> and encouraging people to use them over RAII
[21:36:41] <Eridius> std::hashmap::HashMap.mangle() still has an extra unnecessary parameter purely to work around the lack of stack once fns
[21:37:14] * strcat should rephrase that as *borrowed* once functions
[21:43:03] <pnkfelix> Eridius: you're referring to the `A` argument that is passed along to `not_found` and `found`, right?
[21:46:00] * pnkfelix is only inferring from context what `stack/borrowed once fns` are; I assume they are fn's that are captured by a closure in either an affine or a linear manner (and thus must be called either at most or exactly once by the capturing closure).  But perhaps i am wrong.
[21:47:22] <kimundi> pnkfelix: I think that is correct
[21:47:23] <pnkfelix> (I guess part of the point is that they can be captured by *multiple* closures, as long as the target is called at most/exactly once.)
[21:50:44] <Eridius> pnkfelix: yes
[21:51:01] <pnkfelix> I see the `A` in hashmap::mangle as having a perfectly understandable purpose; the unit value syntax is lightweight enough that I don't mind passing it in for `A`.
[21:51:06] <acrichto> pcwalton: whoa, I just came across std::routine, is that intended on being used?
[21:51:12] <pcwalton> I guess not
[21:51:16] <pcwalton> actually no
[21:51:16] <pcwalton> it's not
[21:51:23] <acrichto> r=you if I remove it?
[21:51:26] <pcwalton> yup
[21:51:28] <Eridius> pnkfelix: in the case of mangle(), we actually only needed the A in the not_found, it's being passed to found just in case
[21:51:38] <pnkfelix> Would the "simplification" to hashmap api enabled by a borrowed once-fn pay for itself?  I guesss I'm not the best person to judge.
[21:51:56] <acrichto> pcwalton: aww it's used somewhere :(
[21:52:04] <friggle> pnkfelix: nmatsakis: have you read this llvm-dev thread? http://thread.gmane.org/gmane.comp.compilers.llvm.devel/66843 there's some very interesting gc discussion lead by the Azul guys
[21:52:06] <Eridius> the intent was to have mangle<'a>(&'a mut self, k: K, not_found: &once fn(&K) -> V, found: &once fn(&K, &mut V)) -> &'a mut V
[21:52:26] <pcwalton> uh-oh
[21:52:29] <pcwalton> there's a race in acid1
[21:52:33] <pcwalton> and I haven't even turned on parallel layout
[21:52:41] <kimundi> Oo
[21:52:51] <strcat> Eridius: what exactly does it do if a key isn't found?
[21:52:57] <strcat> adds it from not_found?
[21:53:09] <pcwalton> I bet it's the parallel selector matching
[21:53:09] * strcat shrugs
[21:53:11] <pcwalton> it's racy
[21:54:13] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[21:54:13] <Eridius> strcat: yes, if the key isn't present, it adds it using the return value of not_found
[21:54:25] <Eridius> otherwise it passes the &mut V to the found fn
[21:54:58] <Eridius> this function is what powers find_or_insert/find_or_insert_with/insert_or_update_with
[21:55:08] <strcat> ShardMap works well ;]
[21:55:15] <pnkfelix> Eridius: hmm.  Yeah I guess I was trying to imagine uses of mangle where you would pass in other interesting stuff in the accumulator.  Like a histogram where you would want to combine new data with preexisting data.  (Not a good example, since the fn returns &mut V...)
[21:55:23] <strcat> it's far better than my attempt at a more complex one
[21:56:14] <pnkfelix> friggle: had not seen that thread.  bookmarked, will skim now but am doubtful i'll digest it now.
[21:56:35] <strcat> hm
[21:56:44] <strcat> maybe it does need to rehash per sub-table
[21:56:57] <friggle> pnkfelix: I'm just reading it now. Many interesting views/insights and references
[21:57:00] <Eridius> pnkfelix: my feeling is that accessing a non-implicitly-copyable value from both closure environments would be extremely rare. But if desired, you could use the old Option trick
[21:57:35] <strcat> ughhhhh
[21:57:37] <strcat> I do need to double-hash
[21:57:45] * strcat sighs
[21:58:13] <strcat> or split the hash
[22:00:18] <strcat> pnkfelix: I didn't consider that by sharding the table I would be leaving the sub-tables with uneven distributions :(
[22:00:34] <strcat> if the hash for sharding is the same
[22:00:37] <strcat> maybe not a big deal?
[22:00:47] <strcat> it's only a big deal because I'm using tiny tables
[22:00:55] <pnkfelix> strcat: uneven as in some tables are getting too many objects?
[22:01:07] <pnkfelix> strcat: or uneven as in some tables are seeing more collisions than you expect?
[22:01:27] <strcat> pnkfelix: as in because I filter at the top-level based on hash, the tables don't see a full range of hashes (ofc)
[22:01:30] <strcat> anyway it's probably not a big deal
[22:01:39] <pnkfelix> strcat: ah
[22:01:50] <pnkfelix> strcat: â€¦ i would think there should be a way to deal with that
[22:02:47] <pnkfelix> strcat: i.e. some way to incorproate the other bits from the original hash into the hash you use for the subtable?  (Is that what you meant by double-hash?  I had thought you had meant get a second independent hash fcn, as is used in e.g. cuckoo hashing)
[22:03:08] <pnkfelix> strcat: or wait, never mind
[22:03:10] <strcat> by double-hash I mean use a different set of keys for the top-level and the individual maps, so like cuckoo hashing
[22:03:13] <strcat> but not really
[22:03:24] <pnkfelix> strcat: my idea doesn't help anyway
[22:03:29] <friggle> strcat: what does Java do then?
[22:03:39] <strcat> I would prefer to figure out if it's really a problem to be doing % 16 on the hash to find the shard and reusing the hash
[22:03:49] <pnkfelix> strcat: (its not like you are stripping out the bits you used for the discriminant...)
[22:03:50] <strcat> it may be less of a big deal than I thought
[22:04:20] <pnkfelix> strcat: it probably depends on the quality of the hash function you are using
[22:04:33] <strcat> pnkfelix: well, SipHash can be assumed to be evenly distributed entropy
[22:04:40] <pnkfelix> strcat: A good one should be resistant to the % 16, right ?
[22:05:13] <pnkfelix> strcat: (in terms of collecting all objects whose hash%16 is the same)
[22:05:26] <pnkfelix> strcat: since you should still have plenty of entropy in the remaining bits
[22:05:31] <strcat> yeah
[22:05:48] <strcat> just wondering if it's going to be a problem since the table will then do % buckets, where buckets is a power of 2
[22:05:49] <strcat> hrmm
[22:06:19] <strcat> pnkfelix: I know it won't be *worse* than a single hash map
[22:06:31] <strcat> ignoring space consumption
[22:06:50] <strcat> just want to leech off the entropy in the best way possible ;p
[22:07:15] * strcat will just leave it as-is for now
[22:07:35] <pnkfelix> strcat: seems like it should be an easy thing to instrument, gather stats on?
[22:07:48] <strcat> pnkfelix: yeah
[22:07:54] <pnkfelix> strcat: though of course having solid math is always nice ...
[22:09:28] <strcat> it can just remain a lingering doubt in the back of my mind forever
[22:09:44] <strcat> java and C++ use weak hashes so they don't care, anyway
[22:09:46] <pnkfelix> friggle: I had seen the epoch's guys posts about integrating with llvm.  I believe niko found them quite encouraging about the potential for such integration working out
[22:12:48] <friggle> pnkfelix: yeah, the thread was also intersting for things like advocacy of Bartlett's mostly-copying gc either you or Niko pointed me too
[22:12:55] <pnkfelix> friggle: and the Bartlett style collector is basically what we (or I) are planning to do for the short-term.  We're aware of the drawbacks, though I suspect we'll work around some of them.
[22:14:53] <sfackler> acrichto: re-re-r? had to rebase over pcwalton's do change https://github.com/mozilla/rust/pull/10649
[22:15:16] <acrichto> r+
[22:15:19] <acrichto> r++
[22:19:34] <pnkfelix> friggle: ooh I don't think I had seen this link before: http://www.cs.kent.ac.uk/pubs/2009/3128/content.pdf
[22:19:52] <pnkfelix> or wait, is that just a revised version of ...
[22:20:34] <pnkfelix> (no, was going to say Henderson, but this is different)
[22:23:27] <pnkfelix> but Pizlo (one of the authors) concludes on the mailing list "Of course it was still slower than Bartlett."  heh.
[22:23:37] <pnkfelix> friggle: thanks for the ptr, that was fun.
[22:24:29] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Quit: Leaving.)
[22:26:55] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[22:27:54] <strcat> acrichto: the rationale for using mutexes is that it's the most efficient way to implement blocking data structures in 1:1
[22:28:05] <strcat> but it's not efficient in M:N
[22:28:16] <strcat> I don't think a concurrent hash map would work well in an M:N threading model
[22:28:26] <acrichto> strcat: I do not believe the statement that "mutexes are efficient in 1:1 and nothing is efficient in M:N"
[22:29:02] <strcat> if you don't plan on implementing primitives as micro-optimized as the pthread ones on linux/windows, it's true
[22:29:43] <strcat> s/pthread/native/
[22:31:01] <strcat> if you have 10 producers and 10 consumers using a blocking queue with a mutex, it won't need any syscalls if the rate of production approximately matches consumption
[22:31:08] <strcat> anyway poor example
[22:32:33] <strcat> you could obviously write that for M:N threading
[22:32:45] <strcat> it would yield to the scheduler instead of calling futex
[22:33:00] <strcat> but that's a whole lot of low-level building blocks in libc to remake
[22:33:18] *** Joins: dbaupp (Thunderbir@A56F6AEF.D5A1DCF.37681C44.IP)
[22:33:44] * strcat shrugs
[22:34:58] <strcat> rust tasks aren't going to be able to hit the mark TBB ones do for CPU-bound work
[22:35:15] <strcat> because TBB ones don't ever yield, they don't have a stack
[22:35:37] <strcat> so either way, you need a separate TaskTree/Pool concept
[22:35:46] <strcat> mapping to 1:1
[22:36:53] <strcat> and that doesn't handle I/O *at all*
[22:43:07] *** Quits: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net) (Quit: Jesse)
[22:43:43] *** Joins: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net)
[22:43:58] *** Quits: Jesse (jruderman@moz-5973C6FA.oc.oc.cox.net) (Quit: Jesse)
[22:46:54] <strcat> I like the concept of having 1:1 globally and then pool/scheduler objects you can submit procs to
[22:47:21] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[22:47:21] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/nhpl7A
[22:47:21] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[22:47:53] <strcat> pool.submit(proc() { ... }), scheduler.submit(proc() { ... })
[22:51:41] <strcat> there are a lot of different scheduler policies you could want
[22:52:06] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[22:52:06] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/Rpyf6Q
[22:52:06] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[22:52:14] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[22:52:14] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/1rWK0g
[22:52:14] <ghrust> 13rust/06auto 1409f84aa 15Steven Fackler: Add SmallVector to libsyntax
[22:52:14] <ghrust> 13rust/06auto 14c144752 15Steven Fackler: Support multiple item macros...
[22:52:15] <ghrust> 13rust/06auto 14c403c1f 15Steven Fackler: Clean up SmallVector use a bit
[22:52:17] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[22:52:30] <strcat> rather than round-robin
[22:52:41] <pauls> \o/
[22:52:45] <pauls> Multi-item macros!
[22:52:56] <strcat> might want to service requests solely on the order they arrived
[22:53:09] <strcat> pauls: does your client ping you when macros are mentioned? ;p
[22:53:16] <pauls> strcat: of course.
[22:53:37] * strcat remembers to complain about macros slowing down compiles more
[22:54:10] <pauls> strcat: really? I didn't think they were used extensively enough to do that yet.
[22:54:22] <strcat> pauls: hygiene slows everything atm ;]
[22:54:28] <pauls> strcat: ahhhh.
[22:54:33] <strcat> variable declarations are O(n^2)
[22:54:34] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[22:54:34] *** ChanServ sets mode: +o pnkfelix
[22:55:07] <pauls> There's an algorithm to fix that, but it's a bit friggin' complicated.
[22:55:32] <strcat> is there some magical way to make it not cost anything in scopes with no macro usage?
[22:55:41] <sfackler> iirc, whoever (eddyb maybe?) was working on the 8086 emulator ran into a brick wall wrt to the n^2 thing
[22:56:00] <pauls> strcat: huh, I don't think it *should* be doing that.
[22:56:10] <strcat> afaik that's what it does
[22:56:24] <strcat> atm
[22:56:35] <pauls> Lemme check the Dybvig paper...
[22:57:48] *** Joins: tikue_ (tkuehn@8148C5E3.21C37D63.689607DE.IP)
[23:00:31] <dbaupp> pauls: https://github.com/mozilla/rust/issues/10607 fwiw
[23:00:40] <kimundi> pauls: Apart from the complexity issues, eddyb at one point also had to figure out how to prevent the compile from trying to malloc 750GB for housekeeping data ;)
[23:00:47] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Ping timeout)
[23:01:10] <tjc> you mean your laptop doesn't have 750 GB of RAM?
[23:01:11] <tjc> pfft
[23:01:15] <pauls> strcat: turns out I was wrong: the basic algorithm does in fact appear to be O(n^2) traversing only non-macro code.
[23:01:36] <strcat> ;(
[23:02:26] <strcat> tjc: linux only lets you allocate 131 petabytes of VIRT :[
[23:02:36] <tjc> strcat: heh
[23:02:47] <strcat> x86_64 is secretely a 48-bit address space and linux uses a bit to distinguish userland
[23:02:59] <strcat> anyway it happily lets me mmap that much ;p
[23:03:40] * strcat is sure *someone* will hit that limit soon
[23:03:52] <strcat> mmap every file on some huge array of drives
[23:04:12] <strcat> real 64-bit plz
[23:04:50] <kmc> at least Linux has transparent hugepage support now
[23:04:51] <strcat> tjc: hm actually it's 128 TERA bytes
[23:04:54] <strcat> far worse than I thought.
[23:05:06] <tjc> yeah, that's worse
[23:05:09] <tjc> I'm not sure how much a peta is
[23:05:13] <tjc> that has not yet been relevant to my life :-)
[23:05:17] <strcat> tjc: 1000x more than a tera ;p
[23:05:24] <kmc> to map 131 TB with 4k pages you'd need more than 131 GB of page tables :)
[23:05:46] <strcat> kmc: well you can map that much as long as you don't use separate mappings
[23:06:01] <strcat> how many huge table pages can you have? I didn't think it was a lot
[23:06:57] <kmc> I don't think there's a specific limit
[23:08:03] <tjc> that's a lot of lolcats
[23:08:26] <strcat> you'll have to buy a lot of silverware to go with the huge tables
[23:09:47] <tjc> think of the dishwashers, too
[23:10:39] <strcat> is the complexity to find a page just log(n)?
[23:10:56] * strcat has no understanding about how MMUs and kernel memory management work
[23:11:36] <strcat> I don't comprehend why there needs to be a max_map_count sysctl knob at all
[23:13:13] *** Quits: jmbto (jmbto@moz-FE174E29.fbx.proxad.net) (Quit: Leaving)
[23:13:52] <strcat> it's a really low arbitrary limit on the number of threads it lets you spawn :(
[23:16:31] <kmc> as for huge pages on x86 i believe there's just a bit in one level of the page table tree that means "this points to a huge page rather than a page of page table entries"
[23:18:59] <sfackler> yeah, a page directory entry either points to a page table or a 4mb physical page
[23:20:01] <sfackler> iirc there's something similar on x86_64, but that uses a 4-level page table and I don't know which levels can have large pages
[23:20:02] <kmc> but the kernel has its own memory management datastructures separate from the ones the MMU reads
[23:22:38] <kmc> and I think it's those which max_map_count is meant to limit
[23:23:37] *** Joins: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com)
[23:23:37] *** ChanServ sets mode: +ao pcwalton pcwalton
[23:28:54] <kmc> those are per-mapping rather than per-page
[23:30:03] <strcat> acrichto: can you update our LLVM? I think mergefunc will work now even though it's not entirely right, because we don't use address spaces
[23:30:12] <kmc> incidentally, there are "soft-fill TLB" architectures where the kernel can store page mappings however it likes, and all the CPU cares about is the TLB
[23:30:34] <strcat> acrichto: hmmm, actually nvm it doesn't look like that part was merged
[23:30:44] <kmc> but in that case, every TLB miss is an interrupt to the kernel, so performance tends to be bad
[23:30:56] <strcat> https://github.com/llvm-mirror/llvm/commit/dff57f19a14560e7ce9d5dbba17a62f1cb85021e I thought this was the aggregate fix :(
[23:31:07] * strcat got it backwards
[23:32:59] *** Quits: jdm (jdm@FCCEA34F.7672369.D8E68FF6.IP) (Quit: Lost terminal)
[23:36:31] *** Quits: tikue_ (tkuehn@8148C5E3.21C37D63.689607DE.IP) (Quit: tikue_)
[23:39:21] *** Joins: quvarxa (chatzilla@moz-978E4C31.static.tpgi.com.au)
[23:55:17] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[23:55:17] *** ChanServ sets mode: +o pnkfelix
