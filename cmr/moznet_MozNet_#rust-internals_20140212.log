[00:01:36] *** Quits: dherman (dherman@moz-BBE3ABD.mv.mozilla.com) (Quit: dherman)
[00:10:59] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[00:15:29] *** Quits: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP) (Connection reset by peer)
[00:15:52] *** Joins: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP)
[00:16:51] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[00:16:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/xH8hsw
[00:16:51] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[00:17:40] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[00:21:31] *** flaper87 is now known as flaper87|afk
[00:21:49] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[00:21:49] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/xrXpsA
[00:21:49] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[00:21:51] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[00:21:51] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/-AsgbA
[00:21:51] <ghrust> 13rust/06auto 140ea6d39 15Alex Crichton: Shuffle around ownership in concurrent queues...
[00:21:51] <ghrust> 13rust/06auto 14abee44e 15Alex Crichton: Rewrite channels yet again for upgradeability...
[00:21:52] <ghrust> 13rust/06auto 147b9391a 15bors: auto merge of #11578 : alexcrichton/rust/chan-changes, r=brson...
[00:21:54] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[00:31:44] <nmatsakis> cgaebel: nice
[00:31:48] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[00:31:48] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 147b9391a to 140ac6e5a: 02http://git.io/N3iJvQ
[00:31:48] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[00:31:50] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[00:31:50] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/ramh3w
[00:31:50] <ghrust> 13rust/06auto 141843670 15Nif Ward: Includes new add method that uses .clone() for support....
[00:31:50] <ghrust> 13rust/06auto 14a4a908e 15bors: auto merge of #11961 : niftynif/rust/btree, r=brson...
[00:31:50] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[00:32:42] *** Joins: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net)
[00:35:03] <cgaebel> what's the bug number for the Some(~()) == None bug?
[00:35:50] <acrichto> cgaebel: https://github.com/mozilla/rust/issues/11998
[00:36:00] <cgaebel> acrichto: thanks!
[00:38:31] <nmatsakis> hey, my borrow checker changes landed.
[00:38:37] <nmatsakis> that was...surprisingly easy.
[00:42:10] <acrichto> nmatsakis: nice!
[00:42:23] <acrichto> you should share your landing skills rather than hoard them :P
[00:43:08] <nmatsakis> acrichto: "landing skills"... given my mean rate of "patches per week" I'd argue that you should share some skills with me
[00:43:19] <nmatsakis> acrichto: I noted your comment that cgaebel ought to be marker::NoPod--
[00:43:37] <nmatsakis> acrichto: it got me thinking that if that is really going to be common, we really ought to have a lighter weight way to declare a "non-pod stuct"
[00:43:41] <nmatsakis> *struct
[00:43:43] <ChrisMorgan> What's happened to `-Z debug-info`?
[00:43:45] <nmatsakis> wycats has been saying this for a while of course
[00:43:50] <Eridius> ChrisMorgan: is that not now just -g?
[00:44:02] <acrichto> nmatsakis: yeah that's what was I was thinking for 'class Foo' awhile back
[00:44:20] * ChrisMorgan only knows that -Z debug-info has stopped working in the past two days
[00:44:22] <nmatsakis> acrichto: yes I hvae thought the same sometimes :)
[00:44:28] <acrichto> but clas :(
[00:44:30] <acrichto> class*
[00:44:36] * nmatsakis has no problem with the word class 
[00:44:47] <nmatsakis> though I'd probably have it combine:
[00:44:50] <cgaebel> maybe a 'nocopy' keyword?
[00:44:50] <nmatsakis> private by default and linear
[00:45:03] <acrichto> that was my inclination as well
[00:45:10] <acrichto> I think I went too far requiring that struct be Pod 
[00:45:10] <nmatsakis> those two things often go together
[00:45:10] <cgaebel> it seems clearest in terms of intention
[00:45:26] <nmatsakis> I don't think you can require that struct be pod
[00:45:33] <acrichto> yeah I don't think that would work out either
[00:45:36] <nmatsakis> there are types that are either pod or linear depending on generics
[00:45:43] <acrichto> it's true
[00:45:51] <nmatsakis> and I think that's the way it should be (personally)
[00:46:54] <nmatsakis> cgaebel: I agree that using class to mean linear/private is not exactly obvious
[00:46:57] <nmatsakis> if you don't know Rust
[00:47:11] <nmatsakis> though I'm not sure that nocopy struct
[00:47:23] <acrichto> pub nocopy struct
[00:47:31] <nmatsakis> would be so clear either, just because no other language has this notion of non-copyable
[00:47:34] <cgaebel> #[nocopy] maybe?
[00:47:39] <nmatsakis> well, c++ sort of does with prviates and so on 
[00:47:44] <nmatsakis> private copy constructors
[00:47:47] <cgaebel> yeah boost has a thing for this
[00:47:52] <nmatsakis> sort of amusing since we just moved away from annotations
[00:47:57] <cgaebel> oh
[00:48:02] <cgaebel> my bad. Rust history was not my major
[00:48:03] <nmatsakis> but this particular case might be worth making an exception for
[00:48:07] <cgaebel> :P
[00:48:21] <cgaebel> it might set a bad precedent though
[00:48:22] <nmatsakis> but I still kind of favor another form of type declaration
[00:48:23] <cmr> I'm not sure that using the keyword `class` is a good idea, because it implies that Rust has classes... and our classes are really quite different from other major language's
[00:48:27] <acrichto> although you rarely use marker types unless you're using unsafe cde
[00:48:38] <nmatsakis> I feel like having a linear value
[00:48:42] <cmr> classes would be, that is
[00:48:44] <nmatsakis> is something that you might reasonably want to do
[00:48:47] <nmatsakis> even without unsafe code
[00:48:48] <cgaebel> but most people don't know what that means..
[00:48:51] <nmatsakis> for semantic reasons
[00:48:55] <acrichto> oh that's a good point
[00:49:09] <nmatsakis> that's why it seems a bit different to me than the other marker types
[00:49:12] <nmatsakis> like no_freeze or whatever
[00:49:28] <nmatsakis> e.g., I wanted Datum<> to be linear in trans,
[00:49:34] <nmatsakis> but not for any memory safety reason.
[00:49:43] <nmatsakis> just because if you were copying one,
[00:49:48] <nmatsakis> you were probably generating invalid code
[00:50:07] <acrichto> hm, perhaps this is a special case as opposed to no_freeze
[00:50:25] *** nrc|afk is now known as nrc
[00:50:35] <cmr> nmatsakis: did #12158 fix all known soundness issues with closures?
[00:51:26] <nmatsakis> cmr: I ... think so? I am trying to figure out if #3696 can lead to a soundness problem
[00:51:34] <nmatsakis> I was in the middle of editing the meta bug #2202 to identify remaining work on closures
[00:51:41] <nmatsakis> that should be done before 1.0
[00:51:49] <wycats> nmatsakis: thanks for remembering :)
[00:52:18] <nmatsakis> cmr: but I expect #12158 to fix the various open bugs -- I also kind of need to trawl through the issues, I thought there were a lot of "dup issues", but when I looked, I didn't find so many
[00:52:39] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[00:52:50] <nmatsakis> wycats: I've kind of come to the conclusion that we can't have a strict pod/linear dichotomy, but we can have some way to "opt in" to linear that is independent of the types within
[00:53:00] <nmatsakis> s/can/probably should/
[00:53:15] <nmatsakis> just not quite sure what that is
[00:54:27] *** Joins: lpy_ (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[00:54:44] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[00:56:04] <wycats> nmatsakis: the thing worth solving is just that small changes to structs can affect code that uses any upstream type very aggressively
[00:56:12] <wycats> for people who were sad that adding a parameter to a function makes it fail
[00:56:20] <wycats> this is a much worse version of the same thing :P
[00:56:35] <nmatsakis> wycats: interestingly this was discussed in today's Rust mtg
[00:56:36] <wycats> change Time, suddenly Article becomes move
[00:56:37] *** Quits: lpy_ (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[00:56:55] <nmatsakis> I guess I could imagine having a "pod/nopod" declaration
[00:56:56] <wycats> it's also really easy for core types to switch atm
[00:57:07] <wycats> because it's not part of anyone's mental model for the type's "interface"
[00:57:11] <wycats> so if you add a destructor
[00:57:14] <wycats> it will seem fine
[00:57:20] <wycats> but all of the sudden if it's a popular type
[00:57:24] <wycats> many, many apps can break
[00:57:30] <wycats> and I think people are unlikely to think of it
[00:57:34] <nmatsakis> yeah, it needs to be considered part of the interface,
[00:57:42] <wycats> right, which argues for some explicit way to express it
[00:57:45] <wycats> so if you say #[pod]
[00:57:48] <nmatsakis> this is partly why I was thinking of using distinct "class vs struct" kind of keywords
[00:57:51] <wycats> and add a destructor
[00:57:52] *** Joins: dherman (dherman@moz-BBE3ABD.mv.mozilla.com)
[00:57:52] *** ChanServ sets mode: +ao dherman dherman
[00:57:59] <wycats> you get a compile error
[00:58:16] <wycats> yeah I like class vs. struct
[00:58:20] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[00:58:28] <wycats> I also like that you can easily make pod-like structs moveable
[00:58:30] <wycats> by using a keyword
[00:58:35] <nmatsakis> so---
[00:58:44] <nmatsakis> your version of class vs struct may not be mine ;)
[00:58:53] <nmatsakis> I was thinking that class is always linear, struct is same as today
[00:58:58] <nmatsakis> but this doens't quite address your point 100%
[00:59:05] <wycats> I think that's what I had in mind too
[00:59:18] <wycats> "linear" in this context means "always moves, never copies" right?
[00:59:24] <cmr> yes.
[00:59:36] <cgaebel> hey acrichto, can you explain a bit more how I can make my FullIndex/EmptyIndex memory safe with that lifetime parameter?
[00:59:49] <cgaebel> err, just safe in general
[01:00:52] <wycats> nmatsakis: that's roughly what I had in mind
[01:00:56] <nmatsakis> wycats: conceivably we could have a way to assert pod vs linear and have pod throw an error if the type should have a dtor or contain something linear etc, but I don't quite know how to do that. I guess an #[pod] assertion that you can place on any type would be one easy way
[01:01:16] <wycats> nmatsakis: the alternative might be better
[01:01:17] <nmatsakis> it would just not be sometihng you could put on a generic type I guess?
[01:01:18] <wycats> struct is always pod
[01:01:35] <nmatsakis> I think this would mean that e.g. Option<int> is linera
[01:01:36] <wycats> and you have to say class, or #[no_pod] to be ALLOWED to use dtors or other non-pods
[01:01:36] <nmatsakis> *linear
[01:01:45] <nmatsakis> and I just don't think that's right
[01:01:45] <wycats> nmatsakis: this is where we landed last time
[01:01:50] <nmatsakis> yes I know :)
[01:01:53] <wycats> acrichto pointed out that enums are another vector
[01:01:55] <wycats> no pun intended
[01:02:41] <wycats> nmatsakis: I think we discussed enums inheriting their podness from their children
[01:02:45] <wycats> but it didn't work correctly iirc
[01:03:04] <nmatsakis> it's a bit thorny. 
[01:03:32] <nmatsakis> I hestitate to add something else one must decide about your type: is it linear or pod? etc
[01:03:37] <nmatsakis> everybody hates choices
[01:04:02] * nmatsakis says the guy who works on a prog lang with multiple pointer types
[01:04:49] <wycats> nmatsakis: but the choices are there
[01:04:56] <wycats> as we said, they're actually an implicit part of the interface
[01:05:06] <nmatsakis> indeed
[01:05:06] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[01:05:33] <nmatsakis> so I tihnk there is a logical case to be made for declaring linear or having today's rules --
[01:05:59] <nmatsakis> basically today's rules are suitable for data
[01:06:10] <nmatsakis> that is, if I write "struct Wrapper<T> { v: T }"
[01:06:26] <nmatsakis> then Wrapper hasn't *adding anything* linear to v -- it's just some data around v
[01:06:50] <nmatsakis> anyway, idk. I have to do dishes. :)
[01:08:40] <cmr> acrichto: did you look into llvm's plans for compiler-rt?
[01:09:24] <acrichto> cmr: vadimcn mentioned that they're thinking of moving libunwind to compiler-rt, is there news other than that?
[01:09:52] <cmr> oh, I thought it was having some existential doubt.
[01:11:23] <vadimcn> cmr: I've asked, but nobody wants admit to being compiler-rt maintainer :(
[01:11:34] <cmr> vadimcn: within llvm nobody does
[01:11:36] <cmr> ?
[01:11:50] <wycats> nmatsakis: so the problem is -- it's an actual interface which could break a LOT of upstream code, but totally undeclared
[01:12:07] <wycats> given people's squeamishness about having an added parameter create a new local fail, I'd expect this to be not great
[01:12:50] <cmr> I'd be good with a #[require_pod] attribute, which applies to concrete types and generic types, ignoring type parameters.
[01:13:16] <vadimcn> cmr: well, maybe I don't know where to ask.  I posted some patched to llvm-commits and then asked twice on llvm-dev.  <crickets>
[01:13:24] <cmr> eugh
[01:13:47] <nmatsakis> wycats: well, it's the downstream guy that decides on type for T, typically,
[01:13:56] <wycats> nmatsakis: right
[01:14:00] <nmatsakis> wycats: so I'm not sure that quite applies,
[01:14:03] <nmatsakis> but basically what cmr said
[01:14:08] <nmatsakis> there are lots of types that are *not* generic
[01:14:12] <wycats> nmatsakis: #[require_pod] isn't quite right
[01:14:13] <nmatsakis> and for them we might have a sol'n
[01:14:17] <cmr> wycats: why?
[01:14:20] <nmatsakis> I tend to agree not quite right
[01:14:33] <nmatsakis> because it feels like something tacked on somehow
[01:14:55] <nmatsakis> I don't really have a great alternative though
[01:15:22] <nmatsakis> I could imagine it just being an error to have a struct
[01:15:26] <nmatsakis> that is non-genreic and non-pod
[01:15:30] <nmatsakis> in that case you ought to use class
[01:15:32] <nmatsakis> maybe that's good enough
[01:15:35] <ChrisMorgan> Can we really not have `struct Foo: Pod`?
[01:15:56] *** Quits: eibwen (kvirc@moz-95DC2A62.dip0.t-ipconnect.de) (Ping timeout)
[01:16:10] <wycats> nmatsakis: the issue that I have with it is that if you don't make a choice you are still creating an implicit interface
[01:16:12] <wycats> that you can break
[01:16:17] <nmatsakis> ChrisMorgan: I think the problem is that if I write `stuct Foo { ... }`, I'm not really saying anything about whta I intend
[01:16:48] <cmr> wycats: We could require items marked #[stable] to have #[require_pod] or #[maybe_pod]
[01:16:53] <nmatsakis> wycats: so the key question is: do we want to permit types that are either pod or linear at all. if we do, do I have to say "bimodal" or something?
[01:16:58] <wycats> alternatively, saying "struct is always Pod-like, but class is always linear" gives the upstreams the interface they need and lets you know when you break things
[01:17:07] <wycats> nmatsakis: the use-case for that is generics?
[01:17:09] *** Quits: dherman (dherman@moz-BBE3ABD.mv.mozilla.com) (Quit: dherman)
[01:17:11] <nmatsakis> yes
[01:17:24] <nmatsakis> Option<int> vs Option<~int>
[01:17:33] <wycats> nmatsakis: I think at first glance I'd want generics to be linear
[01:17:40] <wycats> but I agree that that isn't right for Option<T>
[01:18:07] <nmatsakis> it would be a simple sol'n but doesn't feel right to me
[01:18:09] <cgaebel> nmatsakis: I don't see how to fix that random transmute in my iterator from that blog post.
[01:18:14] <wycats> for Option<T>, you want the Option part to have to choose, but then to inherit from T
[01:18:19] <wycats> which is tricky
[01:18:21] <cgaebel> what is this copy_mut_lifetime intrinsic?
[01:18:30] <cgaebel> err, "unsafe"
[01:18:31] <wycats> so you want to say "nothing in Option needs to be linear"
[01:18:35] <nmatsakis> cgaebel: you should not need any intrinsics or unsafe things
[01:18:38] <wycats> "however, this is linear if T is linear"
[01:18:46] <nmatsakis> cgaebel: I'm pretty sure they've all been implemented  :)
[01:18:57] <nmatsakis> cgaebel: the key idea is to have mutable slices that get smaller etc, I have to read the code in detail to sya more
[01:19:17] <cgaebel> but won't that allocate a vector for no functional reason?
[01:19:22] <nmatsakis> no.
[01:19:28] <nmatsakis> slices are *borrowed* vectors
[01:19:28] *** Joins: enix (enix@moz-A50569DD.c3-0.slvr-ubr1.lnh-slvr.md.cable.rcn.com)
[01:19:34] <wycats> nmatsakis: I have no idea if ^^ makes sense or can be implemented sensible
[01:19:36] <wycats> sensibly*
[01:19:39] <wycats> or what the syntax would be
[01:19:46] <wycats> but it seems like what people intuit the semantics to be
[01:19:53] <nmatsakis> well that's what it does today :)
[01:19:59] <wycats> right
[01:20:01] <nmatsakis> but yeah without declaring it
[01:20:02] <cgaebel> I don't see any slices in that blog post... :/
[01:20:16] * nmatsakis wonders if I pointed you at the right one :)
[01:20:31] <cgaebel> I see an owned vector...
[01:20:43] <wycats> it's kind of like enum Option: Pod { Some(T: Unknown), None }
[01:20:53] <wycats> enum Option: InheritPod { Some(T: Unknown), None }
[01:20:54] <wycats> :P
[01:21:09] <wycats> no I am not actually making a proposal
[01:21:11] * wycats throws up
[01:21:35] <acrichto> enum Option: Wycats { Some(T: SomethingWycatsSays), None }
[01:21:39] <wycats> lolol
[01:21:59] <wycats> struct IsPoddish_eh<T> { foo: int, bar: T }
[01:22:03] <wycats> this is an analogous case
[01:22:04] <nmatsakis> cgaebel: this one right http://smallcultfollowing.com/babysteps/blog/2013/10/24/iterators-yielding-mutable-references-take-2/
[01:22:09] <wycats> and I think you want to say
[01:22:13] <wycats> "everything but the T is poddish"
[01:22:19] <wycats> "if I add something non-poddish, complain"
[01:22:20] <cgaebel> nmatsakis: OH that's different! :D
[01:22:34] <wycats> "because the user is going to expect that IsPoddish_eh<T> has the poddish value of T"
[01:22:35] <cmr> wycats: that's what I described as #[require_pod]
[01:22:57] <wycats> cmr: #[require_pod] would presumably have blocked T from being linear?
[01:23:00] <cgaebel> nmatsakis: wait no it isn't
[01:23:02] <cmr> no.
[01:23:07] <wycats> cmr: really?
[01:23:09] <cgaebel> nmatsakis: it still has an unsafe block of the same size..
[01:23:14] <cmr> wycats: as I said, it ignores the type parameters..
[01:23:20] <nmatsakis> cgaebel: that function already exists
[01:23:26] <wycats> cmr: sounds good
[01:23:31] <nmatsakis> cgaebel: and the nature of the unsafe block is completely different (if you read the post, it explains)
[01:23:32] <wycats> but probably the wrong name :)
[01:23:39] <cmr> maybe.
[01:23:45] <cmr> #[inherits_pod]
[01:23:48] <wycats> #[require_pod] enum Option<T> { Some(T); None }
[01:23:51] <wycats> cmr: yeah
[01:24:02] <wycats> which would require that the own fields are poddish
[01:24:05] <cgaebel> nmatsakis: oh. I see
[01:25:33] <nmatsakis> cgaebel: sorry, doing dishes right now (or trying to) happy to elaborate more later
[01:25:46] <nmatsakis> wycats: I want to let this stew for a bit in my mind...
[01:25:52] <nmatsakis> wycats: we might be getting somewhere though
[01:26:09] <cmr> It seems identical to freeze in mechanics.
[01:26:11] <nmatsakis> wycats: to bolster your case, larsberg was complaining about literally this problem ins ervo
[01:26:15] <nmatsakis> *in servo
[01:26:19] <cmr> (except using linearity, not mutability)
[01:26:31] <nmatsakis> I mean, it's identical to all our built-in kinds.
[01:26:35] *** Joins: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net)
[01:26:35] *** ChanServ sets mode: +o tjc
[01:26:39] <cmr> oh
[01:26:45] <cmr> yeah, I suppose they all do inherit...
[01:26:46] <nmatsakis> but most of them do't have such a big impact on how you use a value
[01:27:11] <nmatsakis> or rather they control what APIs the value can be used with
[01:27:15] <nmatsakis> but linearity is rather more fundamental
[01:27:30] <nmatsakis> still maybe a more general mechanism might be useful
[01:27:35] <nmatsakis> e.g., struct Message: Send { ... }
[01:28:04] <cmr> yeah.
[01:28:14] <nmatsakis> but I can't see making this distinction mandatory
[01:28:39] <cmr> nmatsakis: I feel like the exact set of kinds should be required for types marked #[stable]
[01:29:01] <cmr> (And #[frozen] to me implies complete ABI stability)
[01:29:16] <nmatsakis> cmr: this is a good idea for us as an internal dev practice, I agree
[01:29:42] <larsberg> nmatsakis, wycats: we've even resorted to horrible things like dummy functions that have a dummy call to a type we want to ensure is :Send.  We'd much rather have an attribute :-)
[01:30:00] *** Joins: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca)
[01:30:17] <nmatsakis> larsberg: so adding assertion attributes (or whatever) is easy and (I think) relatively noncontroversial...
[01:30:18] <larsberg> And I'll reiterate acrichto's mention of telling you why something isn't :Send. I'm debugging such an error right now, as I do our @mut-conversion, and it's buried somewhere N structs deep that I can't find...
[01:30:36] <nmatsakis> ...that also seems like a no-brainer.
[01:30:46] <nmatsakis> larsberg: happy to mentor you in fixing rustc ;)
[01:30:59] <nmatsakis> (let the yak shave begin)
[01:31:01] <larsberg> nmatsakis: ok, fair response :-)
[01:31:17] <nmatsakis> (you know it'd be more fun that tracing that stupid problem through servo)
[01:31:53] <larsberg> It would probably take less time! Except that I'd have to upgrade Rust to get it, and we're now almost 5 weeks behind again...
[01:32:12] <nmatsakis> ah yes a catch 22
[01:32:14] *** Joins: sunfish (chatzilla@moz-C06D9702.mtv1.mozilla.com)
[01:32:34] <nmatsakis> seriously though better error messages seems like a very good idea and shouldn't be too hard
[01:32:39] * nmatsakis remembers he promised to open an issue
[01:33:38] <nmatsakis> larsberg: what's your github name?
[01:34:39] <nmatsakis> larsberg: https://github.com/mozilla/rust/issues/12201
[01:34:50] <larsberg> nmatsakis: larsbergstrom 
[01:34:57] <nmatsakis> oh
[01:35:09] * nmatsakis fixes the cc
[01:35:15] <larsberg> np, my fault for not signing up for github four years ago...
[01:35:25] <nmatsakis> github's autocomplete is frustrating
[01:35:40] <nmatsakis> it seems to select from a rather random set of people to display
[01:35:59] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[01:36:12] <cmr> yeah
[01:36:20] <cmr> it's at least repo contributors
[01:36:27] <cmr> who else gets added seems to be arbitrary..
[01:36:49] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[01:36:49] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/ramh3w
[01:36:49] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[01:38:03] <acrichto> cgaebel: ping
[01:38:20] <cgaebel> acrichto: pong.
[01:38:27] <acrichto> cgaebel: so about the two FullIndex values
[01:38:37] <cgaebel> yeah
[01:38:40] <acrichto> this may not actually end up working, but a safe interface would look like:
[01:38:53] <acrichto> fn peek<'a>(&'a mut self, idx: uint) -> Bucket<'a>
[01:39:00] <acrichto> and then you access the table through the bucket return values
[01:39:17] <acrichto> that means you can only create one Empty/Full at a time
[01:39:43] <cgaebel> so get/put become impls on the Bucket?
[01:39:53] <cgaebel> err, get/put/take
[01:40:21] <acrichto> yeah
[01:40:28] <acrichto> b/c you can't access the map once you have a bucket
[01:40:38] <acrichto> the bucket will basically loan out the value of the map
[01:40:50] <acrichto> it may not work with how it's used in the code, I haven't checked too muh
[01:40:51] <acrichto> much*
[01:40:53] <cgaebel> but I frequently need two buckets to different indexes
[01:41:05] <cgaebel> i.e. to do the "robin hood stealing"
[01:41:11] <acrichto> do you ever need N buckets?
[01:41:16] <acrichto> or is it almost always 2 or 1?
[01:41:19] <cgaebel> uhh I think so.
[01:41:24] <cgaebel> but that question scares me
[01:41:28] <acrichto> lol
[01:41:38] <acrichto> you may be able to make a type that wraps 2 buckets simultaneously
[01:41:49] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[01:41:49] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/scQ74A
[01:41:49] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[01:41:50] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[01:41:50] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/Tbn2rQ
[01:41:50] <ghrust> 13rust/06auto 1447ef200 15Alex Crichton: Shuffle around ownership in concurrent queues...
[01:41:50] <ghrust> 13rust/06auto 140a6b921 15Alex Crichton: Rewrite channels yet again for upgradeability...
[01:41:50] <ghrust> 13rust/06auto 14e2d48e3 15Alex Crichton: Test fixes and rebase conflicts
[01:41:52] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[01:42:15] <cmr> nmatsakis: wycats: https://github.com/mozilla/rust/issues/12202
[01:42:34] <cgaebel> eeeh I'm not so sure about this any more..
[01:43:01] <acrichto> cgaebel: this is where the typesystem may not be able to statically prevent you from messing with the map and you may need dynamic checks
[01:43:19] <cgaebel> acrichto: yeah that's kinda annoying.
[01:43:32] <cgaebel> I'll sleep on it. Maybe I'll think of something tomorrow.
[01:43:52] <cgaebel> I'll re-add the checks (which I still contend should only be enabled in extreme circumstances) if I can't think of anything.
[01:43:53] <acrichto> cgaebel: you could return a pair of buckets
[01:43:59] <acrichto> which would transmute a &mut copy of the map
[01:44:12] <acrichto> but it's safe because a bucket only operates on one cell of the map
[01:44:24] <cgaebel> yeah I know..
[01:44:34] <cgaebel> but it's kinda ugly
[01:44:37] <acrichto> I'm not advocating these assertions are in there forever
[01:44:43] <acrichto> I don't trust unsafe code by default
[01:44:51] <acrichto> speed is not a reason to be unsound
[01:44:54] <cgaebel> probably a good poicy.
[01:44:57] <cgaebel> *policy
[01:45:05] <acrichto> with confidence we can turn off assertions more aggresively
[01:45:21] <cgaebel> I'm just uncomfortable with all these asserts directly inside the inner loop
[01:45:27] <cgaebel> basically anywhere else is fine
[01:45:36] <cgaebel> but on every single access to a hash, peek is called.
[01:45:45] <cgaebel> and that really should just be a load
[01:46:13] <cgaebel> it's not just "once per insert" or "once per pop"
[01:46:18] <cgaebel> it's like.. 8 times on average.
[01:46:23] <cgaebel> for a lookup
[01:46:29] <acrichto> remember, debug mode is not performance sensitive
[01:46:30] *** Quits: benh (ben@moz-4A0366D2.org) (Ping timeout)
[01:46:30] <cgaebel> probably more for insert and pop
[01:46:37] <acrichto> this is not "forever have these assertions"
[01:46:45] <acrichto> this is "have these assertions until we're confident"
[01:47:02] <cgaebel> will they likely be in 1.0? because I can't really advertise this as "well-optimized" with branches like that in my inner loop
[01:47:26] <acrichto> I would guess not
[01:47:31] <cgaebel> like, I don't mind leaving them in for now, then leaving a bug in the bugtracker behind tagged for 1.0
[01:47:31] <acrichto> but we don't have a debug assertion story yet
[01:47:45] <cgaebel> yeah
[01:47:52] <cmr> Why wouldn't they be 1.0?
[01:47:52] <cgaebel> it'd be nice to have an assert! and an ensure!
[01:47:56] <cmr> There's an open PR for it now.
[01:48:15] <acrichto> we just need a story first
[01:48:19] <acrichto> we don't have one at all right now
[01:49:58] *** Joins: benh (ben@moz-4A0366D2.org)
[01:50:47] <cgaebel> hmm I still don't really know how to get rid of that transmute in MutEntries' implementation for RawTable
[01:51:02] <nmatsakis> cgaebel: I'll take a look tomorrow (but it'd help if you remind me)
[01:51:09] <cgaebel> sure.
[01:52:41] <cmr> cgaebel: link to the transmute?
[01:53:09] <cgaebel> https://github.com/mozilla/rust/pull/12081/files#diff-4b6329d238cbb757d5646fc56ecbe267R451
[01:53:14] <cgaebel> hopefully that jumps
[01:53:20] <cgaebel> line 451 if it doesn't
[01:54:35] <cmr> oh this is no fun at all.
[01:55:12] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[01:55:24] <cmr> hm
[01:55:32] <cgaebel> haha nope.
[01:55:32] <cgaebel> nmatsakis linked to a blog post that I didn't quite figure out how to apply to my stuff cleanly
[01:56:10] <nmatsakis> yeah that blog post just covered the simplest case ;)
[01:56:39] <cgaebel> and I much prefer the transmute to a crazy-looking iterator
[01:56:44] <cgaebel> because then at least it "looks" correct
[01:56:53] * cgaebel may be prioritizing the wrong things here
[01:56:59] <Eridius> I just compiled rust-bindgen by passing a long path to -L to make it find libclang inside of Xcode, but it ended up linking against `@rpath/libclang.dylib`. Surely that's not correct?
[01:57:11] <nmatsakis> cgaebel: it may be that the transmute is ok -- that kind of transmute is not safe in general, doesn't mean it's not safe in this instance
[01:57:18] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[01:57:22] <nmatsakis> I mean, I guess it IS safe in this instance,
[01:57:24] <cgaebel> nmatsakis: it's just kinda an antipattern for iterators
[01:57:53] <nmatsakis> but it'd be nice to see how small we can get the unsafe bit
[01:58:29] <nmatsakis> I'm happy to have a well performing hashmap but I am still sad at the thought of it not being implemented in a fully safe way, I must admit. "If not us, who?"
[01:58:44] <nmatsakis> but that said I don't plan to stretch the type system
[01:58:47] <nmatsakis> to understand cuckoo hashing
[01:58:48] <nmatsakis> :)
[01:59:02] <nmatsakis> or robin hood or whichevre :)
[01:59:03] <cgaebel> but you generally can't.. for example, bounds checking
[01:59:12] <nmatsakis> (well...)
[01:59:29] <cgaebel> how would it "safely" access an array which is indexed at (k & (capacity - 1))
[01:59:39] <nmatsakis> you can do a lot of things, as long as you don't mind writing theorems as types :)
[01:59:55] <cgaebel> you can't possibly communicate to the compiler that that's "safe" without some major haskell-level treachery 
[02:00:07] <cgaebel> it'll be unsafe SOMEWHERE
[02:00:16] <cgaebel> the goal is just to get that surface as small as possible
[02:04:04] *** Quits: gimpf (gimpf@moz-B9D88B00.adsl.highway.telekom.at) (Quit: Leaving.)
[02:07:44] <cgaebel> acrichto: okay. asserts added, along with a block comment rationalizing them.
[02:09:02] <acrichto> cgaebel: cool, thanks!
[02:09:11] <cgaebel> acrichto: np!
[02:11:09] *** Joins: zimbabao (rajaram@ACEC38E0.F12708BC.D2D1FAF0.IP)
[02:11:47] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[02:11:47] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 1434b8451 to 14a4a908e: 02http://git.io/N3iJvQ
[02:11:47] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[02:11:49] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[02:11:49] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/9nzo-Q
[02:11:49] <ghrust> 13rust/06auto 14e26f77b 15Flavio Percoco: Replace `crate` usage with `krate`...
[02:11:49] <ghrust> 13rust/06auto 143145a06 15Flavio Percoco: Replace `extern mod` with `extern crate`...
[02:11:50] <ghrust> 13rust/06auto 14e52f427 15Flavio Percoco: Remove obsolete warnings for `extern mod`...
[02:11:52] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[02:13:06] <cmr> wycats: https://github.com/mozilla/rust/issues/12203 too
[02:13:12] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[02:13:12] *** ChanServ sets mode: +ao pcwalton pcwalton
[02:21:49] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[02:21:50] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14f7c7189 to 14a4a908e: 02http://git.io/N3iJvQ
[02:21:50] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[02:21:53] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[02:21:53] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/SgkQ5w
[02:21:53] <ghrust> 13rust/06auto 145d12d84 15Vadim Chugunov: Added compiler-rt submodule.
[02:21:53] <ghrust> 13rust/06auto 14b765132 15Vadim Chugunov: Build compiler-rt and link it to all crates, similarly to morestack.
[02:21:54] <ghrust> 13rust/06auto 14db8a580 15bors: auto merge of #12027 : vadimcn/rust/compiler-rt, r=alexcrichton...
[02:21:56] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[02:23:36] <cmr> vadimcn: oh awesome, I didn't realize you had already been working on integrating compiler-rt
[02:24:37] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[02:24:40] <vadimcn> cmr: yes. It wont build the ASAN modules though
[02:25:01] <cmr> that's fine.
[02:32:04] <nrc> acrichto: ping
[02:35:38] *** Quits: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net) (Quit: Leaving.)
[02:43:52] <nrc> brson: ping?
[02:45:30] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[02:47:54] *** Quits: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP) (Ping timeout)
[02:48:06] *** Joins: vadimcn (chatzilla@FB06B64.76F9E272.DA40C4B3.IP)
[02:48:10] <cgaebel> cgaebel: ping!
[02:48:21] <cgaebel> cgaebel: ooh what's up?
[02:48:27] <cgaebel> cgaebel: nothing much, just talking to myself.
[02:48:32] <cgaebel> :)
[02:49:35] * ChrisMorgan pretends he didn't see that
[02:55:06] <sfackler> uh
[02:55:40] *** Quits: sully (sully@moz-45967CBE.emarhavil.com) (Ping timeout)
[02:55:56] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[02:58:00] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[02:58:41] <brson> nrc: pong
[02:58:59] *** Joins: sully (sully@moz-45967CBE.emarhavil.com)
[03:00:33] <nrc> brson: I'm looking at issue. About what to do if we have items in both type and value namespaces and one is pub and one is not
[03:00:52] <nrc> so, I look at the use to determine which to check, which works well (eventually)
[03:02:12] <nrc> but I am not sure what to do when the import is unused - should we check both (which can lead to duplicate errors if they are both private) or one at random (which gives weird error messages) or neither (which I think is most logical, but means it is legal to import a private item as long as you don't use it whichis weird and breaks the test suite)
[03:02:18] <nrc> brson^
[03:05:39] <brson> nrc: why does checking both need to lead to duplicate errors? can they not be combined into one?
[03:06:33] *** Joins: Axord (xord@moz-C0D5F15A.lsanca.dsl-w.verizon.net)
[03:07:01] <nrc> brson: sorry, that is not the issue, thinking about it (that was another issue, which I fixed). The issue is false negatives - if one namespace turns out to be pub, then we probably want it to be legal - since it would be if it were used
[03:07:26] <nrc> but we can't tell at resolve time which to check
[03:07:26] *** Quits: sunfish (chatzilla@moz-C06D9702.mtv1.mozilla.com) (Ping timeout)
[03:07:46] <nrc> when we have to choose
[03:08:01] <nrc> and at privacy checking we can't tell whether or not the import is actually used
[03:11:37] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[03:12:49] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[03:12:56] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: erickt)
[03:13:22] <brson> nrc: would this be solvable if privacy was part of resolve? or if resolve produced a side table about used imports?
[03:14:13] *** Quits: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP) (Ping timeout)
[03:16:27] <nrc> Half of privacy checking is already part of resolve, I don't think it is possible to combine the privacy pass with the resolve pass though. We could probably do something along the lines of the latter
[03:17:16] <brson> what's the issue #?
[03:17:19] <nrc> In fact I guess that is not super hard, I just need to tweak the info I pass from resolve to privacy
[03:17:22] <nrc> 4110
[03:17:38] *** Quits: sully (sully@moz-45967CBE.emarhavil.com) (Ping timeout)
[03:20:33] *** Joins: sully (sully@moz-45967CBE.emarhavil.com)
[03:20:50] *** Quits: lkuper (lkuper@moz-C0CD33ED.hsd1.in.comcast.net) (Quit: lkuper)
[03:22:58] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Quit: It's a joke, it's all a joke.)
[03:26:23] *** Quits: brson (brson@moz-BBE3ABD.mv.mozilla.com) (Quit: leaving)
[03:27:27] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[03:28:20] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Quit: Read error: Connection reset by peer)
[03:31:49] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[03:31:50] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/SgkQ5w
[03:31:50] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[03:34:18] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Client exited)
[03:36:33] *** Quits: zz_kimundi (kimundi@moz-A91BEDFE.dip0.t-ipconnect.de) (Ping timeout)
[03:36:45] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[03:36:45] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/amnlzA
[03:36:45] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[03:36:46] *** Joins: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net)
[03:36:47] *** ChanServ sets mode: +ao pcwalton pcwalton
[03:40:18] *** Joins: zz_kimundi (kimundi@moz-7F6EAE0B.dip0.t-ipconnect.de)
[03:40:19] *** zz_kimundi is now known as kimundi
[03:44:22] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[03:48:03] *** Joins: jdm (jdm@CA0BC3BB.187B3A7C.7042C455.IP)
[03:50:28] *** Joins: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP)
[03:55:32] *** Quits: pcmattman (pcmattman@moz-D9B7D938.net) (Ping timeout)
[03:56:42] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[03:57:07] <sfackler> dbaupp pls https://github.com/mozilla/rust/blob/master/src/libsyntax/ext/deriving/generic.rs#L222
[03:58:46] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[03:59:38] *** Joins: pcmattman (pcmattman@moz-D9B7D938.net)
[04:02:08] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[04:05:15] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[04:05:15] <ghrust> 01[13rust01] 15alexcrichton 04force-pushed 06try from 14f95f0f2 to 14952a631: 02http://git.io/k471pw
[04:05:15] <ghrust> 13rust/06try 14952a631 15Alex Crichton: Upgrade LLVM...
[04:05:15] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[04:11:46] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[04:16:49] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[04:16:49] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 1446f34e0 to 14db8a580: 02http://git.io/N3iJvQ
[04:16:49] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[04:16:49] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[04:16:49] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/v45ANA
[04:16:49] <ghrust> 13rust/06auto 1447ef200 15Alex Crichton: Shuffle around ownership in concurrent queues...
[04:16:49] <ghrust> 13rust/06auto 140a6b921 15Alex Crichton: Rewrite channels yet again for upgradeability...
[04:16:50] <ghrust> 13rust/06auto 14e633249 15Alex Crichton: Test fixes and rebase conflicts
[04:16:52] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[04:17:30] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[04:19:39] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[04:19:39] <ghrust> 01[13rust01] 15alexcrichton 04force-pushed 06try from 14952a631 to 1418cdb02: 02http://git.io/k471pw
[04:19:39] <ghrust> 13rust/06try 1418cdb02 15Alex Crichton: Upgrade LLVM...
[04:19:39] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[04:22:58] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[04:27:54] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Input/output error)
[04:28:56] *** Quits: jdm (jdm@CA0BC3BB.187B3A7C.7042C455.IP) (Quit: Lost terminal)
[04:33:50] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[04:37:46] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[04:45:53] *** Joins: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net)
[04:45:53] *** ChanServ sets mode: +ao dherman dherman
[04:54:25] *** Joins: Sharp (Sharp@moz-633F3606.hsd1.ca.comcast.net)
[04:54:30] *** Quits: Sharp (Sharp@moz-633F3606.hsd1.ca.comcast.net) (Quit: Sharp)
[04:55:04] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Connection reset by peer)
[04:55:53] <acrichto> pcwalton: using llvm with your patch, I'm still seeing some mempcys of length 7 lying around :(
[04:56:06] <pcwalton> acrichto: yes. there are problems with the ordering of that pass.
[04:56:14] <pcwalton> chandlerc pointed that out
[04:56:17] <pcwalton> it's a known problem in LLVM in general
[04:56:23] <acrichto> ah oh well
[04:56:24] <pcwalton> I don't know how upstream wants to fix it
[04:56:30] <acrichto> can we fix it locally?
[04:56:31] <pcwalton> the problem is that the pass works but later passes create more
[04:56:34] <acrichto> by running the pass multiple times?
[04:56:38] <pcwalton> we could, yes
[04:56:44] <pcwalton> it's fairly easy to do
[04:56:49] <acrichto> it's the memcpyopt pass?
[04:56:53] <pcwalton> yeah
[04:56:56] <pcwalton> just search for the pass manager builder
[04:56:56] *** Quits: zimbabao (rajaram@ACEC38E0.F12708BC.D2D1FAF0.IP) (Ping timeout)
[04:57:00] <pcwalton> it's in there somewhere
[04:57:08] <pcwalton> and just copy it in multiple times
[04:57:22] <acrichto> hm running it at the very end left a few more in still
[04:57:32] <pcwalton> it eliminated some though?
[04:57:45] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Quit: Leaving...)
[04:57:57] <acrichto> lemme check
[04:58:01] <pcwalton> keep in mind it doesn't remove EVERY memcpy of length 7, only those that have a memory dependence on an alloca
[04:58:07] <acrichto> it did not :(
[04:58:09] <pcwalton> others aren't safe to remove
[04:58:16] <pcwalton> hmmmm
[04:58:19] <acrichto> maybe these are legit memcpys of lenght 7
[04:58:23] <pcwalton> maybe we need to rerun memory dependence analysis?
[04:58:24] <acrichto> this is just a giant wad of LTO IR
[04:58:30] <acrichto> they may be legit
[04:58:32] <acrichto> I dunno
[04:58:33] <pcwalton> check to make sure it's a dependency of an alloca
[04:59:10] <pcwalton> if you're just running memcpyopt from the command line make sure that it's got the right analysis data
[04:59:14] <pcwalton> it needs MemoryDependenceAnalysis
[04:59:17] <pcwalton> which may be a separate pass.
[04:59:20] <pcwalton> i'm not sure.
[04:59:25] <acrichto> hm no it's dead
[04:59:30] <pcwalton> -debug-only=memcpyopt
[04:59:31] <acrichto> alloca => bitcast => memcpy
[04:59:34] <pcwalton> will print out debug into
[04:59:34] <pcwalton> info
[04:59:37] <acrichto> did the bitcast break it?
[04:59:41] <pcwalton> it shouldn't
[04:59:52] <pcwalton> I can point you to the code if you want to add debugging info
[05:00:07] <sfackler> what should the ident for an ItemImpl be?
[05:00:36] <acrichto> sfackler: __clownshoes__
[05:00:44] <acrichto> pcwalton: https://gist.github.com/anonymous/8950304
[05:01:12] <pcwalton> yeah, I didn't add any extra debug info
[05:01:23] <pcwalton> but it does need MemoryDependenceAnalysis
[05:01:46] <acrichto> so of 'fn main(){}'
[05:01:50] <pcwalton> acrichto: try this
[05:01:52] <sfackler> acrichto: so token::special_idents::clownshoes_extensions?
[05:01:57] <acrichto> you patch reduced 198 memcpy 7 to 170 memcpy 7
[05:01:58] <pcwalton> opt -memdep -memcpyopt
[05:02:00] <acrichto> sfackler: I think so yeah
[05:02:06] <sfackler> er, that's __extensions__
[05:02:35] <acrichto> sfackler: same 170 memcpys
[05:02:38] <acrichto> pcwalton: ^
[05:02:41] <pcwalton> what
[05:02:46] <pcwalton> I guess you'll have to add some debugging.
[05:02:55] <acrichto> this is in a giant program
[05:02:58] *** Joins: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP)
[05:02:58] <acrichto> just LTO'ing everything
[05:03:08] <acrichto> the good news is that there were memcpys of length like 103
[05:03:15] <acrichto> and now I didn't see any in the function
[05:03:24] <acrichto> I was profiling some scheduler code and the 2nd hottest function was memmove
[05:03:34] <acrichto> and I think it's b/c memcpy on osx punts to memmove if the size is really weird
[05:03:37] <acrichto> like 105 or 95
[05:03:47] <pcwalton> yeah, I see that in servo too :(
[05:03:55] <pcwalton> we have a big issue in rust with too many memcpys
[05:03:56] <acrichto> I think your patch will help that
[05:04:06] <acrichto> I need to put my green patches on top of the llvm patch to test
[05:04:12] <acrichto> the llvm mingw bot went green
[05:04:15] <acrichto> ours is still broken
[05:04:21] <acrichto> I may submit a patch upstream
[05:04:49] <pcwalton> acrichto: can you send me some IR
[05:04:53] <pcwalton> I can add debug
[05:05:06] <acrichto> this is just a whole LTO IR
[05:05:09] <acrichto> do you want the whole thing?
[05:05:48] <pcwalton> hmm
[05:05:57] <pcwalton> I guess I can make my own
[05:06:07] <acrichto> I can try to minimize later
[05:06:10] <acrichto> train arriving brb
[05:06:24] <acrichto> https://gist.github.com/8950339 btw
[05:08:41] <pcwalton> acrichto: hmmm I just lto'd a fn main() with my patch and I see no memcpys of length 7
[05:08:56] <pcwalton> oh wait
[05:08:58] <pcwalton> never mind I do
[05:12:34] <pcwalton> acrichto: I'm looking at the IR. LLVM can't eliminate those because they're on the heap
[05:14:10] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[05:14:58] <pcwalton> I think we may need tbaa.struct for it orâ€¦ something else. maybe sunfish has ideas
[05:21:16] *** Quits: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP) (Ping timeout)
[05:22:39] *** Joins: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP)
[05:23:25] <acrichto> pcwalton: ah ok
[05:23:59] <sfackler> blargh, stupid drop flag
[05:44:12] *** Quits: tjc (tjc@moz-7EE2AFFC.hfc.comcastbusiness.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[05:46:54] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[05:46:54] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/v45ANA
[05:46:54] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[05:49:04] *** Quits: pcwalton (pcwalton@moz-DA87EE4.hsd1.ca.comcast.net) (Quit: pcwalton)
[05:51:49] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[05:51:49] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/SQMxUw
[05:51:49] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[05:53:16] <nrc> can we use struct enums in the compiler?
[05:55:11] <sfackler> I don't see why not
[05:55:42] <sfackler> I wish the compiler used struct variants more often
[05:55:46] <sfackler> especially in the ast
[05:59:33] *** Joins: zimbabao (rajaram@47769425.AE842F9B.81C3DAA1.IP)
[05:59:50] * nrc goes ahead and uses them
[06:02:56] <ChrisMorgan> Why are they gated still?
[06:03:46] <sfackler> there were at one point a couple of weird bugs with them
[06:03:52] <sfackler> not sure if they're all fixed
[06:13:55] *** Quits: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net) (Quit: dherman)
[06:19:26] *** Joins: eddyb (eddy@moz-92B95652.residential.rdsnet.ro)
[06:21:49] *** Joins: tjc (tjc@moz-6EB4E533.dsl.tsoft.com)
[06:21:50] *** ChanServ sets mode: +o tjc
[06:23:08] <eddyb> SimonSapin: it's not that dead of a horse, if you can get an appeal for revival :P
[06:27:25] *** Quits: enix (enix@moz-A50569DD.c3-0.slvr-ubr1.lnh-slvr.md.cable.rcn.com) (Ping timeout)
[06:37:22] *** Quits: tjc (tjc@moz-6EB4E533.dsl.tsoft.com) (Quit: Textual IRC Client: www.textualapp.com)
[06:37:24] <eddyb> nmatsakis: do you happen to know how often type contents are computed? nevermind, I should profile type checking
[06:39:13] *** Quits: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca) (Quit: canhtak)
[06:39:17] <eddyb> r? https://github.com/mozilla/rust/pull/12180
[06:39:32] <eddyb> it's relatively small and I want to be done with it
[06:42:37] <eddyb> cmr: this is silly: env CFG_{VERSION,PREFIX,LIBDIR_RELATIVE,RUSTLIBDIR,COMPILER}= perf record ./x*/stage1/bin/rustc src/librustc/lib.rs -Z time-passes
[06:46:11] <sfackler> this is a bizarre error: https://gist.github.com/sfackler/9848e16f1d1571209871
[06:46:29] <sfackler> I guess it's a node-id mismatch that avoided an ice
[06:50:54] <ChrisMorgan> eddyb: "./x*/stage1/..."â€”eek! (a) misses targets like arm-* (simply use "*/stage1/..."), (b) doesn't work if you ever do any cross-compiling
[06:51:13] <eddyb> I guess...
[06:54:07] <ChrisMorgan> (Well, by cross-compiling I mean building to multiple targets.)
[07:01:47] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[07:01:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/bp8hpg
[07:01:47] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[07:06:44] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[07:06:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/V_1cEg
[07:06:44] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[07:06:45] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[07:06:45] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/FOVLbw
[07:06:45] <ghrust> 13rust/06auto 14d63df5f 15Niko Matsakis: Tweak test name and make it more specific
[07:06:45] <ghrust> 13rust/06auto 14975908d 15bors: auto merge of #12185 : nikomatsakis/rust/issue-12033-tweak-test, r=alexchrichton
[07:06:46] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[07:09:12] *** Joins: lkuper (lkuper@moz-C0CD33ED.hsd1.in.comcast.net)
[07:17:34] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[07:29:26] *** flaper87|afk is now known as flaper87
[07:38:46] *** Joins: jensnockert (jensnocker@moz-4C68E8F4.mobileonline.telia.com)
[07:58:38] *** Joins: enix (enix@moz-A50569DD.c3-0.slvr-ubr1.lnh-slvr.md.cable.rcn.com)
[08:07:04] *** Joins: Zr40 (zr40@EE4BB9F5.926C319A.BE2F4011.IP)
[08:07:43] <flaper87> cmr: could you please r=acrichto https://github.com/mozilla/rust/pull/12017 ? (and perhaps p=1) It's likely to conflict with other patches :(
[08:07:53] <flaper87> if you're around, obviously
[08:07:55] <flaper87> or acrichto ^
[08:07:57] <flaper87> :D
[08:08:04] <acrichto> flaper87: got it
[08:08:10] <flaper87> acrichto: thanks 
[08:08:17] <acrichto> np
[08:09:57] *** Quits: eddyb (eddy@moz-92B95652.residential.rdsnet.ro) (Ping timeout)
[08:11:23] *** Joins: eddyb (eddy@EF91BDF3.921A1753.FCAAE698.IP)
[08:13:27] *** Quits: eddyb (eddy@EF91BDF3.921A1753.FCAAE698.IP) (Ping timeout)
[08:14:38] *** Joins: eddyb (eddy@1BF544DF.9065A63B.FCAAE698.IP)
[08:16:51] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[08:16:51] <eddyb>  16,24%  rustc  libc-2.18.so         [.] memset
[08:16:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/FOVLbw
[08:16:51] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[08:17:38] <eddyb> you must be kidding me, we spend that much time during typeck filling memory?
[08:18:38] *** Quits: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au) (Ping timeout)
[08:19:15] <acrichto> that's scary
[08:19:33] <eddyb> could be one of those dataflow things
[08:20:06] <eddyb>   2,94%  rustc  rustc                [.] middle::ty::mk_t::he9fba13a53f734e3aA::v0.10.pre
[08:20:42] <eddyb> we can possibly speed up hashing used in the type interner
[08:21:01] <acrichto> is that all just a hash table lookup?
[08:21:18] *** Joins: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP)
[08:21:46] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[08:21:46] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/KC1QVQ
[08:21:46] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[08:21:47] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[08:21:47] <ghrust> 01[13rust01] 15bors pushed 5 new commits to 06auto: 02http://git.io/Xwpn8w
[08:21:47] <ghrust> 13rust/06auto 1444317ed 15Alex Crichton: Fix a bug where cached stacks weren't re-used...
[08:21:47] <ghrust> 13rust/06auto 14379c73f 15Alex Crichton: Don't allocate in LocalHeap::new()...
[08:21:48] <ghrust> 13rust/06auto 1476b1755 15Alex Crichton: Don't require an allocation for on_exit messages...
[08:21:50] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[08:21:59] <acrichto> will android lock up
[08:22:02] <acrichto> nobody knows!
[08:22:15] <eddyb> acrichto: that and the union of flags from the types of components in a compound type, which I doubt take that much
[08:24:14] <eddyb> perf is nice, but I don't know how to get inclusive data, like with callgrind
[08:26:59] *** Quits: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:27:06] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[08:28:03] <eddyb>    mem             Profile memory accesses
[08:28:05] <eddyb> hmm
[08:33:10] *** Quits: eddyb (eddy@1BF544DF.9065A63B.FCAAE698.IP) (Ping timeout)
[08:33:37] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[08:34:35] <eddyb> http://stackoverflow.com/questions/12160449/call-stack-in-the-perf-profiler
[08:34:37] <eddyb> ooh, I see
[08:35:38] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[08:38:57] <eddyb> cmr: I think I need DWARF to get any decent call graph
[08:40:15] *** Quits: Kxepal (Miranda@moz-4232FDEF.pppoe.mtu-net.ru) (Quit: Kxepal)
[08:40:29] *** Joins: Kxepal (Miranda@moz-4232FDEF.pppoe.mtu-net.ru)
[08:43:11] *** Joins: rusti (rusti@moz-54F7FD49.cpe.net.cable.rogers.com)
[08:43:15] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[09:00:25] *** Quits: lkuper (lkuper@moz-C0CD33ED.hsd1.in.comcast.net) (Quit: lkuper)
[09:09:17] *** Joins: doener (doener@moz-C68F600D.unity-media.net)
[09:21:46] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[09:21:46] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14ccbb64d to 14975908d: 02http://git.io/N3iJvQ
[09:21:46] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[09:21:47] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[09:21:47] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/R1Cuug
[09:21:47] <ghrust> 13rust/06auto 1411b8941 15Alex Crichton: Expose whether event loops have active I/O...
[09:21:47] <ghrust> 13rust/06auto 148bbde72 15Alex Crichton: Percolate the (Scheduler, GreenTask) pair upwards...
[09:21:47] <ghrust> 13rust/06auto 1463e6854 15Alex Crichton: Don't hit epoll unless a scheduler absolutely must...
[09:21:49] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[09:25:21] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[09:29:56] <eddyb> error: aborting due to 585 previous errors
[09:30:15] <eddyb> nmatsakis: you totally ruined my PNG decoder :P
[09:33:14] *** Quits: nrc (nrc@7BE24E90.A5032A01.3CFC199D.IP) (Ping timeout)
[09:36:49] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[09:36:49] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 144ec2bb7 to 14975908d: 02http://git.io/N3iJvQ
[09:36:49] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[09:36:49] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[09:36:49] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/TFlUtA
[09:36:49] <ghrust> 13rust/06auto 14314b02b 15Alex Crichton: Add ignore-cross-compile directive for compiletest...
[09:36:49] <ghrust> 13rust/06auto 142ca02ea 15bors: auto merge of #12190 : alexcrichton/rust/fix-snap-again, r=brson...
[09:36:50] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[09:44:15] <eddyb> nmatsakis: I have to abuse macros now :/
[09:45:07] *** Joins: rca (rcatolino@moz-124BA3D3.adsl.proxad.net)
[09:47:37] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Client exited)
[09:47:59] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[09:49:49] *** Quits: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp) (Ping timeout)
[09:53:47] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[10:01:51] *** Quits: SimonSapin (simon@moz-9A1FE870.exyr.org) (Ping timeout)
[10:15:11] *** Joins: SimonSapin (simon@moz-9A1FE870.exyr.org)
[10:38:23] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[10:44:02] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[10:46:47] *** Joins: ghrust (ghrust@79968228.6A2AE50.F3114085.IP)
[10:46:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/TFlUtA
[10:46:47] *** Parts: ghrust (ghrust@79968228.6A2AE50.F3114085.IP) ()
[10:51:45] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[10:51:45] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/OihxgA
[10:51:45] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[10:53:42] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[10:56:36] *** Quits: jensnockert (jensnocker@moz-4C68E8F4.mobileonline.telia.com) (Connection reset by peer)
[11:06:41] *** Joins: eibwen (kvirc@moz-222E10E3.dip0.t-ipconnect.de)
[11:11:30] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[11:14:36] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[11:21:45] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[11:21:46] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/JGnuQQ
[11:21:46] <ghrust> 13rust/06auto 14bed34ec 15WebeWizard: Added examples for converting vectors of u8 into strings. Also fixed some styling
[11:21:46] <ghrust> 13rust/06auto 14e192cd9 15bors: auto merge of #12194 : WebeWizard/rust/master, r=cmr
[11:21:46] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[11:38:02] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[11:39:39] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[11:40:24] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[11:43:20] *** Joins: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP)
[11:46:00] *** Quits: rca (rcatolino@moz-124BA3D3.adsl.proxad.net) (Ping timeout)
[11:47:17] <nmatsakis> eddyb: Sorry. :( There were a couple of bits of code that were using closures just to cut out repeated code that ran afoul of the rules,
[11:47:20] <nmatsakis> I don't know a good way to fix that
[11:47:40] <nmatsakis> it's hard for me to characterize when two closures may or may not overlap in time 
[11:47:46] <nmatsakis> and not necessarily desirable to do so either
[11:48:56] <eddyb> macros work even better in my case :)
[11:49:15] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[11:49:49] <eddyb> nmatsakis: did you happen to take a look at the other PR, where I removed ty_type?
[11:50:00] <nmatsakis> eddyb: no, but I was just thinking I should as I went through my e-mail this morning
[11:50:15] * nmatsakis could work full time just reading PRs =)
[11:50:32] <eddyb> with that gone, the only synthetic non-inference type is ty_unboxed_vec
[11:50:48] <eddyb> which we might be able to remove by carefully specializing the constructs where it might occur
[11:50:50] <nmatsakis> this looks like nice cleanup
[11:51:09] <nmatsakis> I've been wanting to clean those things out for a while, happy to see it happen
[11:51:30] <eddyb> strcat's been doing some TyDesc removals of his own :D
[11:52:03] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[11:53:04] <nmatsakis> eddyb: yeah so r+ from me (but needs rebase)
[11:53:12] <eddyb> will do
[11:53:16] <nmatsakis> pnkfelix: so the PR I was thinking of...
[11:53:24] <nmatsakis> I had this branch to cleanup how we do operator overloading
[11:53:44] <nmatsakis> though it does break a lot of existing code that tries to add strings, I got stalled trying to decide what to do about that
[11:53:54] * nmatsakis remembers the details now
[11:54:17] <nmatsakis> pnkfelix: oh, but Daphne is waking up now, so I'll talk to you later 
[11:54:34] <eddyb> scooby doo?
[11:54:34] <pnkfelix> nmatsakis: okay.  Interesting.  We'll discuss.
[11:55:05] <eddyb> nmatsakis: hmm, one optimization for closures is to store a pointer to the alloca of the local as the env, instead of a pointer to the captures array holding the pointers to the local allocas
[11:55:24] <eddyb> nmatsakis: that is, when there is only one capture. that doesn't change the semantics
[11:55:42] *** Quits: zimbabao (rajaram@47769425.AE842F9B.81C3DAA1.IP) (Ping timeout)
[11:56:04] <eddyb> nmatsakis: but, if you capture an immutable local with a type of &'a T, you could produce a closure with a lifetime of 'a by storing the pointer itself as the env ptr
[11:57:15] <eddyb> which is not only an optimization, but an "unboxed" closure restricted to one capture, that can live (much) longer
[11:59:23] <eddyb> even if we don't do that, we can still allow taking x.meth by value, producing a 'a closure containing (x, T::meth) for an x of type &'a T
[12:04:38] *** Joins: cmr (moznet@moz-EC676DFE.members.linode.com)
[12:11:17] <eddyb> CONFLICT (modify/delete): src/test/run-pass/reflect-visit-data.rs deleted in HEAD and modified in Removed ty_type.
[12:11:31] <eddyb> I wonder why that was removed
[12:14:58] *** Joins: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net)
[12:16:53] <eddyb> nmatsakis: oh, that was you!
[12:18:29] *** kimundi is now known as zz_kimundi
[12:18:43] <eddyb> nmatsakis: r?
[12:19:17] <nmatsakis> eddyb: done
[12:19:23] <eddyb> thanks :)
[12:21:16] <pnkfelix> hmm, in a default configure on OS X, does stdtest use libnative or libgreen by default?
[12:23:01] <pnkfelix> or maybe this question does not matter for what I'm looking at
[12:23:57] *** Joins: gimpf (gimpf@moz-3F236853.adsl.highway.telekom.at)
[12:26:22] <eddyb> pnkfelix: cool find in bignum btw :D - where do we stand after that?
[12:26:42] <pnkfelix> eddyb: well, I didn't have the patience to wait for pidigits 10000 to run
[12:26:53] <pnkfelix> on the old version, that is
[12:27:27] <pnkfelix> i let it run for 20min before killing it
[12:27:47] <pnkfelix> but on the new version, pidigits 10000 takes 8.7 seconds
[12:27:51] <pnkfelix> on my machine
[12:27:52] <pnkfelix> eddyb: ^
[12:28:06] <eddyb> pretty serious improvement
[12:28:34] <eddyb> you can write a Pod-bounded custom from_fn_rev, without dealing with destruction, fwiw
[12:28:37] <pnkfelix> eddyb: I'm sure there's other opportunities in there, but there was nothing i found on Sunday that had quite the same bang-for-buck
[12:29:04] <pnkfelix> eddyb: I suspect the from_fn_rev is not necessary in the short term.
[12:29:35] <eddyb> .reverse() does seem like a waste
[12:29:43] <pnkfelix> eddyb: The bigger win, I think, will be adding support for in-place operations (things analogous to `x -= y`) since those can reuse the internal buffer for x.
[12:29:55] <eddyb> I'm surprised we don't have those
[12:30:08] <pnkfelix> eddyb: If we do, we don't use them in the implementation of div.
[12:30:18] <eddyb> though they'd be nastier to use without the overloads
[12:30:25] <pnkfelix> eddyb: right.
[12:30:58] <pnkfelix> eddyb: I'm largely thinking that a lot of them could be just for use internally within the module
[12:31:25] <eddyb> for sure
[12:31:49] *** Joins: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP)
[12:31:49] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/JGnuQQ
[12:31:49] *** Parts: ghrust (ghrust@24260B07.6A2AE50.F3114085.IP) ()
[12:31:52] <eddyb> we can't easily get to the performance of GMP, but this is silly
[12:32:34] <pnkfelix> eddyb: exactly.  I hope it will be easier for everyone to find little wins like this now that bigint is pulled out to num::bigint.
[12:36:44] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[12:36:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/HumEIQ
[12:36:44] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[12:51:40] *** Joins: zimbabao (rajaram@25FB2EA.5B6EDC44.D2D1FAF0.IP)
[13:03:31] *** Joins: aepsil0n (ebopp@moz-EF530DCB.ita.uni-heidelberg.de)
[13:05:33] *** Joins: Hildar (Mibbit@moz-1FA995E0.in-addr.btopenworld.com)
[13:06:25] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[13:21:22] *** Joins: larsberg (larsberg@moz-5D8E4B14.lightspeed.cicril.sbcglobal.net)
[13:24:08] *** Joins: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca)
[13:30:51] *** Quits: benh (ben@moz-4A0366D2.org) (Ping timeout)
[13:33:26] *** Quits: gimpf (gimpf@moz-3F236853.adsl.highway.telekom.at) (Ping timeout)
[13:34:08] *** Joins: benh (ben@moz-4A0366D2.org)
[13:43:38] *** Joins: sanxiyn (tinuviel@B4104EBB.3CC170B1.1E14B209.IP)
[13:46:47] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[13:46:47] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/mxwRag
[13:46:47] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[13:47:17] <eddyb> nmatsakis: that was rather painless :)
[13:51:44] *** Joins: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP)
[13:51:44] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/r9zkEg
[13:51:44] *** Parts: ghrust (ghrust@2EE61FCC.6A2AE50.F3114085.IP) ()
[13:51:47] *** Joins: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP)
[13:51:47] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/bf_HcQ
[13:51:47] <ghrust> 13rust/06auto 148dca9a2 15Kevin Ballard: rustdoc: Strip impls of stripped private types...
[13:51:47] <ghrust> 13rust/06auto 147238bcb 15Kevin Ballard: rustdoc: Strip impls of traits on #[doc(hidden)] types...
[13:51:47] <ghrust> 13rust/06auto 14e36d747 15bors: auto merge of #12195 : kballard/rust/rustdoc-strip-impls-of-stripped, r=cmr...
[13:51:49] *** Parts: ghrust (ghrust@DE823A67.6A2AE50.F3114085.IP) ()
[13:56:45] *** Joins: doomlord_ (servitor@moz-9B2006BF.range109-151.btcentralplus.com)
[14:05:50] *** zz_kimundi is now known as kimundi
[14:07:54] *** Quits: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca) (Quit: canhtak)
[14:09:30] <cmr> TWiR was a big hit on HN this week.
[14:09:39] <cmr> Brought in an extra ~7k views compared to baseline.
[14:09:47] <eddyb> cmr: any interesting discussion?
[14:09:54] <cmr> nope
[14:12:01] <eddyb> nmatsakis: PathElems sound good enough for an iterator?
[14:18:09] <cmr> :( the queue is getting huge again
[14:18:26] <cmr> (total, not approved)
[14:21:46] *** Joins: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP)
[14:21:46] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/uwRBpA
[14:21:46] <ghrust> 13rust/06auto 140465fd7 15Derek Guenther: Fixed fourcc example doc
[14:21:46] <ghrust> 13rust/06auto 14d394a48 15bors: auto merge of #12196 : dguenther/rust/fix-fourcc-example, r=alexcrichton...
[14:21:47] *** Parts: ghrust (ghrust@9C8B94D4.6A2AE50.F3114085.IP) ()
[14:27:56] *** Joins: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca)
[14:28:37] *** Joins: edwardw (edwardw@D286B842.1B2F6624.7F41E82D.IP)
[14:29:34] *** Quits: sokomo (sokomo@8293D4FC.93FF164A.408809BB.IP) (Quit: Read error: Connection reset by peer)
[14:33:14] *** Quits: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca) (Quit: canhtak)
[14:51:55] *** Quits: Blaze- (blaze@moz-9B9AB2F0.dhcp.inet.fi) (Ping timeout)
[14:52:49] <eddyb> rustilite: #[feature(macro_rules)] macro_rules! do_foo (($foo:expr) => (foo)) fn main() {let foo = 5; println!("{}", do_foo!(foo));}
[14:52:52] -rustilite- pastebinned 8 lines of output: http://ix.io/asS
[14:53:12] <eddyb> rustilite: #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn main() {let foo = 5; println!("{}", do_foo!(foo));}
[14:53:12] -rustilite- <anon>:1:108: 1:120 error: unresolved name `foo`.
[14:53:12] -rustilite- <anon>:1 #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn main() {let foo = 5; println!("{}", do_foo!(foo));}
[14:53:12] -rustilite-                                                                                                                     ^~~~~~~~~~~~
[14:53:12] -rustilite- error: aborting due to previous error
[14:53:13] -rustilite- application terminated with error code 101
[14:54:24] <eddyb> rustilite: #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn bar<T>(foo: T) -> T {do_foo!(foo)} fn main() {println!("{}", bar(5));}
[14:54:25] -rustilite- 5
[14:54:29] <eddyb> HAH
[14:54:46] <eddyb> is this macro hygiene failure known?
[14:57:10] *** Joins: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net)
[14:58:25] <nmatsakis> eddyb: yes
[14:58:30] <nmatsakis> eddyb: (re: PathElems)
[14:59:12] <nmatsakis> eddyb: re: closures and the ability to extend their lifetime, yes, that makes sense
[14:59:56] <nmatsakis> eddyb: however, we'd want to think hard about what it means for a closure to do `&x` (where x is an upvar) -- right now it produces a pointer into parent's stack frame, if they do this, then we cannot extend lifetime
[15:00:15] <nmatsakis> eddyb: the current round of patches introduced an analysis looking at how upvars are used within closures,
[15:00:32] <nmatsakis> eddyb: right now closures always *borrow* the things they reference,
[15:00:44] <eddyb> so [&] from C++11
[15:00:45] <nmatsakis> eddyb: but another way to phrase your idea is to say that in some circumstances we might take by value
[15:00:58] <nmatsakis> particularly if there is one free variable and it is not used as an lvalue
[15:01:07] <eddyb> yupp
[15:01:08] <nmatsakis> and in that case, we could naturally extend the closure's lifetime
[15:01:17] <nmatsakis> actually, one free variable of suitable size
[15:01:32] <nmatsakis> yes this would be a reasonable extension
[15:02:14] <eddyb> fn cloner<'a, T: Clone>(x: &'a T) -> 'a || -> T {|| x.clone()}
[15:02:31] <eddyb> can't come up with anything more practical at the moment
[15:02:41] <nmatsakis> eddyb: (it's not entirely clear that is a hygiene failure)
[15:02:47] <nmatsakis> I guess it depends on what you expect from hygiene
[15:02:53] <nmatsakis> I'm still rather unclear on this
[15:02:57] <nmatsakis> admittedly, I would expect an error in that csae :)
[15:03:00] <eddyb> (and I've said before (x.clone) could do the same thing)
[15:03:12] <eddyb> nmatsakis: it makes arguments different from locals
[15:03:28] <nmatsakis> eddyb: so that can only occur with arguments, not locals?
[15:03:42] <eddyb> nmatsakis: it fails with locals, as I would expect
[15:03:51] <nmatsakis> ok
[15:03:54] <nmatsakis> def a bug then ;)
[15:03:57] <eddyb> rustilite: #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn bar<T>((foo, _): (T, T)) -> T {do_foo!(foo)} fn main() {println!("{}", bar((5, 6)));}
[15:03:58] -rustilite- 5
[15:04:10] <eddyb> foo is clearly a binding there, not even an argument
[15:04:19] <eddyb> rustilite: #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn bar<T>((foo, _): (T, T)) -> T {let foo = foo; do_foo!(foo)} fn main() {println!("{}", bar((5, 6)));}
[15:04:21] -rustilite- pastebinned 8 lines of output: http://ix.io/asV
[15:05:06] <eddyb> nmatsakis: haha it resolves to the argument
[15:05:24] <eddyb> rustilite: #[feature(macro_rules)]; macro_rules! do_foo (($foo:expr) => (foo)) fn bar<T>((foo, _): (T, T)) -> T {let foo = 11; do_foo!(foo)} fn main() {println!("{}", bar((5, 6)));}
[15:05:26] -rustilite- pastebinned 4 lines of output: http://ix.io/asW
[15:06:00] <eddyb> nmatsakis: I (re)discovered this (thinking it's probably known) while adjusting a macro and realizing I used foo instead of $foo yet it continued to work
[15:07:27] <eddyb> *sigh* I need a cloneable iterator again
[15:11:00] *** Joins: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP)
[15:14:09] <Hildar> Hmm, how hard would #12201 be to implement for my first time working on the compiler?
[15:16:11] <nmatsakis> Hildar: not entirely trivial ;) but probably not TOO Hard
[15:16:21] <nmatsakis> Hildar: I'm happy to work with you on it
[15:16:41] <eddyb> Hildar: I believe you could take the iteration code from rustc::middle::ty's type contents computation and print a note for each type that has a kind problem
[15:16:56] <nmatsakis> yes, that'd be the basic idea
[15:17:14] <nmatsakis> though I think there is an existing higher-order type we can use
[15:17:19] <nmatsakis> well, maybe not
[15:17:36] <eddyb> it requires some rust experience, to get around the thick compiler guts
[15:18:19] <eddyb> Hildar: but with decent english skills and patience, you can do anything :P
[15:18:55] <sanxiyn> How sad
[15:19:01] <Hildar> eddyb: I think I'm alright with rust (although that's probably just the Dunningâ€“Kruger effect talking :P). It's finding my way around rustc itself.
[15:19:26] <sanxiyn> Indeed "decent English skill" is somewhat necessary which I find deeply unfortunate
[15:19:42] <sanxiyn> (As it acts as large barrier to entry for Korean people to participate in open source)
[15:19:59] <sanxiyn> eddyb: I know you didn't mean it that way :)
[15:20:44] <eddyb> oh, it is unfortunate indeed, for native speakers of languages very different from English
[15:21:35] <eddyb> Russians (there's a lot of them in the reverse engineering communities) tend to have more issues, I've heard (and seen myself), so the alphabet could be playing an important part there
[15:22:40] <Hildar> nmatskis, eddyb: I'll take a look at middle::ty and see wha I can make of it all, thanks.
[15:22:43] <eddyb> that said, I wish my highschool CS classes weren't localized. but that's over and I never cared much for that sad excuse of programming
[15:23:37] <sanxiyn> Heh why do you wish it weren't localized?
[15:23:57] <eddyb> Hildar: I think the function computing "type contents" (i.e. what a type reaches) is called type_contents or something similar (you can search for TC)
[15:24:04] <nmatsakis> Hildar: feel free to ping me, either here or privmsg -- privmsg maybe better so if I'm not around I can write you back later :)
[15:24:52] <eddyb> there's a bunch of matches, recursion, a local cache (and a global one), IIRC. I thought of rewriting it, but I don't know if it matters and if that many types actually need type contents
[15:24:56] <nmatsakis> Hildar: at a high-level, the idea will be to iterate over the the type contents (as eddyb said) looking for the smallest part which violates the kind; you'll have to be a bit careful about infinite recursion; I'm not 100% sure on what's the best way to avoid too much code duplication 
[15:25:10] <nmatsakis> eddyb: it is very widely used. How would you rewrite it?
[15:25:50] <nmatsakis> I know that at one point I had a more naive caching policy and it was a big perf issue
[15:25:56] *** Joins: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca)
[15:26:03] <nmatsakis> afaik now it's not, but I haven't profile recently
[15:26:10] <eddyb> why do I always forget that word... a List<T> which stores it's next pointer inside T...
[15:26:23] <nmatsakis> interior?
[15:26:28] <eddyb> nmatsakis: anyways, I thought it could just go within the t_box itself
[15:26:34] <nmatsakis> what is "it"
[15:26:43] <nmatsakis> the type contents?
[15:26:44] <eddyb> the type contents bitmap
[15:26:44] <Hildar> nmatsakis: Alright. I don't have a dev machine for a couple of hours so I'll ping you later on.
[15:26:57] <nmatsakis> eddyb: I see; yeah, that'd probably be nice
[15:27:09] <eddyb> it fits in an u16, the t_box id can be u32 and the flags in an u8/u16
[15:27:26] <nmatsakis> though I might be more inclined to make types into indices again and just index into an array
[15:27:29] <nmatsakis> but oh that'd be a pain now
[15:27:41] <nmatsakis> since all that code was rewritten to use ty::get() without a tcx
[15:28:07] <nmatsakis> anyway, yeah putting it in the t_box would be ok
[15:28:18] <sanxiyn> eddyb: intrusive?
[15:28:27] <eddyb> making t_box 8 bytes smaller on x64 and storing type contents inside, with the added cost of computing them for every type ever
[15:28:35] <eddyb> sanxiyn: maybe, I can't be sure
[15:28:52] <eddyb> sanxiyn: and to answer your earlier question, it felt very "ghetto"
[15:28:59] <cmr> (yes, intrusive)
[15:29:00] <nmatsakis> eddyb: you don't have to compute them for every type ever.
[15:29:11] <sanxiyn> eddyb: http://c2.com/cgi/wiki?IntrusiveDataStructures
[15:29:12] <nmatsakis> eddyb: you just do it lazilly
[15:29:23] <nmatsakis> eddyb: same as now
[15:29:28] <eddyb> could use a Cell, but then you can't use statics for the simplest types
[15:29:57] <eddyb> (which isn't a problem IMO)
[15:30:00] <nmatsakis> you can't compute them as types are created
[15:30:03] <nmatsakis> it has to be lazy and after the fact
[15:30:21] <nmatsakis> bceause all type definitions must be fully available
[15:30:28] <nmatsakis> for recursive types and so on
[15:31:06] <eddyb> oh, right, mapping AST items to types
[15:31:43] <eddyb> since mk_t can't possibly trigger astconv
[15:31:52] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[15:31:52] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/uwRBpA
[15:31:52] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[15:34:56] <eddyb> nmatsakis: ty::get and all the unsafety is completely unnecessary. I guess I can try to remove it now, getting bored of struggling with inflate and being few times slower than zlib
[15:36:45] *** Joins: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP)
[15:36:46] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/SWyLnw
[15:36:46] <ghrust> 13rust/06auto 14a102aef 15Liigo Zhuang: Move base64 and hex from libextra to libserialize
[15:36:46] <ghrust> 13rust/06auto 14c37cc87 15bors: auto merge of #12200 : liigo/rust/base64_hex_out_of_extra, r=alexcrichton...
[15:36:46] *** Parts: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP) ()
[15:36:48] *** Joins: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP)
[15:36:48] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/xQATKw
[15:36:48] *** Parts: ghrust (ghrust@1E8607E8.6A2AE50.F3114085.IP) ()
[15:37:06] *** Parts: sanxiyn (tinuviel@B4104EBB.3CC170B1.1E14B209.IP) (Leaving)
[15:37:42] <nmatsakis> eddyb: how do you plan to remove it?
[15:37:51] <nmatsakis> eddyb: conversion to use lifetimes?
[15:37:51] <eddyb> nmatsakis: do you know what it does :)?
[15:37:56] <nmatsakis> eddyb: yes I know it will
[15:37:57] <nmatsakis> *well
[15:38:57] <eddyb> or do you think it's not a good idea to possibly leak &'static t_box?
[15:39:19] <eddyb> proper lifetimes would be harder, but not impossible
[15:39:28] <nmatsakis> I think it's a bad idea to leak, yes.
[15:39:34] <nmatsakis> I'd be in favor of proper lifetimes, but not now.
[15:39:40] <nmatsakis> Seems like a lot of churn for 0 gain
[15:39:47] <nmatsakis> vs focusing on 1.0 tasks
[15:39:54] <eddyb> (not that ty::get prevents leaking)
[15:39:59] <nmatsakis> ?
[15:40:11] <eddyb> ty::get returns &'static t_box
[15:40:19] <nmatsakis> ty::get is not *safe*, but it doesn't leak...
[15:40:37] <eddyb> you can take its result and make it leak
[15:40:46] <nmatsakis> are we using leak to mean the same thing?
[15:40:53] <nmatsakis> I mean memory leak -- as in, malloc that never gets freed.
[15:41:15] <eddyb> oh, I was referring to use-after-free
[15:41:40] <eddyb> leaking a type "handle" to a scope that can outlive tcx
[15:42:03] *** Quits: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca) (Quit: canhtak)
[15:42:33] <nmatsakis> oh
[15:42:39] <nmatsakis> that's the unsafety with which I was concerned
[15:42:48] <nmatsakis> but I see only two ways to fix this:
[15:42:54] <nmatsakis> (1) leak the allocation (unacceptable)
[15:42:57] <nmatsakis> (2) use lifetimes
[15:43:16] <nmatsakis> well I guess (3) use indices [only sort of fixes it, naturally]
[15:43:28] <eddyb> (4) ty::get(&'a tcx, t) -> &'a t_box
[15:43:30] <nmatsakis> both (2) and (3) require significant edits that don't seem worth the trouble at this time
[15:44:25] <nmatsakis> eddyb: that's basically what I meant by "use lifetimes"... I guess I don't know how much pain it'll be
[15:44:32] <nmatsakis> though there would be multiple ways
[15:44:50] <eddyb> yeah, t_box could have a lifetime
[15:44:58] <nmatsakis> right, the other way is basically:
[15:45:02] <eddyb> and (5) remove the ty:;get interface and just use &'static t_box but that might coincide with (1)
[15:45:06] <nmatsakis> struct Tcx<'a> { ... }
[15:45:12] <nmatsakis> struct Ty<'a> { ... }
[15:45:18] <nmatsakis> well however,
[15:45:25] <nmatsakis> point is that Tcx is paired with an arena and a lifetime,
[15:45:31] <nmatsakis> and types are pointers allocated in that arena
[15:45:39] <eddyb> like FunctionContext
[15:45:42] <nmatsakis> right
[15:45:55] <nmatsakis> in genreal I tihnk we should move memory management in this direction,
[15:46:03] <nmatsakis> compilers tend to be a great fit for arenas and so on
[15:46:35] <nmatsakis> eddyb: so I'm trying to draw up a DST task list right now... maybe we can discuss this
[15:46:43] <nmatsakis> are you interestd in index / deref 
[15:46:47] <nmatsakis> overloadable
[15:47:43] <eddyb> yeah, unless someone can do it faster :)
[15:48:09] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[15:48:38] <eddyb> nmatsakis: any idea if we can clean up the callee_id & method handling?
[15:48:51] <eddyb> I don't like it very much
[15:48:53] <nmatsakis> eddyb: at the moment there is nobody really doing it, wycats did some initial work on indexing, but I don't think he has the time to clean it up and carry it all the way through
[15:49:24] <nmatsakis> eddyb: what part of it are you referring to? there are many things I think should be cleaned up... 
[15:50:16] <eddyb> all of it, I guess :P
[15:50:24] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[15:50:55] <nmatsakis> so, I guess I would distinguish:
[15:51:06] <nmatsakis> - the data structures that use to store the results and communicate between trans etc
[15:51:12] <nmatsakis> - the actual code that does method lookup
[15:51:16] *** Joins: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net)
[15:51:16] *** ChanServ sets mode: +ao dherman dherman
[15:51:35] <nmatsakis> - the code that does trait resolution (which is related conceptually and ought to be better integrated)
[15:51:44] <eddyb> the method maps only contains the method origin now, I wanted to maybe rename it to "method origin map"
[15:58:18] *** Quits: erickt (Adium@49C4075F.3AC15C18.2321E71E.IP) (Quit: Leaving.)
[15:58:46] *** Quits: Zr40 (zr40@EE4BB9F5.926C319A.BE2F4011.IP) (Quit: leaving)
[15:58:54] <Hildar> nmatsakis: Hmm, so I can kind of see how to iterate over a type and warn every time I find something NoSend or NoFreeze or whatnot. But then you'd end up with a horrible mess like: "Foo contains bar, which is not sendable. Foo contains baz, which contains quux, which is not sendable" and it would mean duplicating half of the type checking code... yeesh.
[15:59:21] <eddyb> nmatsakis: do you have more design details (like, a list of trait definitions) than the blogposts themselves?
[15:59:23] <nmatsakis> Hildar: the kind of message I envisioned was to accumulate a path,
[15:59:47] <nmatsakis> eddyb: I am working on that as we speak, and trying to enumerate the trickiest parts, I think the work will have to be done in bits, the first of which are relatively easy but getting progressively harder :)
[16:00:08] <nmatsakis> Hildar: something like "the type Foo is not Send because x.y.z is an owned pointer" (or whatever) 
[16:00:14] <nmatsakis> Hildar: where x.y.z are fields
[16:03:00] <eddyb> nmatsakis: that's how I thought of variadic generics when I wrote the RFC the first time, 4 steps: tuply type expansion, tuply value expansion, variadic capture in tuples and only then variadic type definitions
[16:03:27] <eddyb> hmm, mem_categorization can do nice field paths, I think, even for unnamed fields in tuple strucs and enum variants
[16:03:50] <nmatsakis> yes there is some code for making those kinds of paths
[16:03:58] <Hildar> nmatsakis: Hmm, so something like ty::type_contents(), but instead of producing a TypeContents, I build up a collection of (Path, Reason) to complain about?
[16:04:00] <eddyb> maybe that can be extracted into a common TypeInnerPath?
[16:04:36] <nmatsakis> Hildar: right.
[16:04:50] <nmatsakis> Hildar: probably we just need two paths, since TypeContents is too perf sensitive to do that computation all the time
[16:05:04] <nmatsakis> Hildar: otherwise you could imagine tracking not only the contents but the "reason" for those results
[16:05:32] <nmatsakis> eddyb: so let me try to write something up covering the details -- also, I know we have some unfinished discussion of variadics :)
[16:06:04] <nmatsakis> eddyb: should have something done-ish in an hour or two
[16:06:41] <Hildar> nmatsakis: So no completely overhauling TypeContents to do this stuff every time then. ;P
[16:06:48] <nmatsakis> this is definitely an area that merits an RFC
[16:07:00] <nmatsakis> Hildar: right. That was my first temptation but I think it's the wrong approach...
[16:07:23] <Hildar> nmatsakis: It would be a lot of memory being thrown around for the general case.
[16:07:23] <eddyb> I am currently manually typing in a long static array of bit lengths because I cba to write my own custom iterators again just to get over the current lifetime issues
[16:07:28] <nmatsakis> Hildar: exactly.
[16:07:54] <eddyb> anyone adding significant memory usage to the compiler gets an r- from me
[16:07:57] <flaper87> acrichto: around? I think the PR ignored your r+ :( https://github.com/mozilla/rust/pull/12017
[16:08:02] <eddyb> not that it matters much :P
[16:08:08] <flaper87> could you p=1 it? :D
[16:08:24] <eddyb> flaper87: bors orders PRs by priority and then number
[16:08:49] <Hildar> Only thing is that I can't see any way to reuse the current TypeContents, I'd have to copy it. Which feels wrong... Hmm... I'll have a think.
[16:08:55] <flaper87> eddyb: yup
[16:09:26] <eddyb> Hildar: you can refactor it into a visitor
[16:10:02] <Hildar> eddyb: Forgive my newbieness... Visitor?
[16:10:18] <eddyb> and then use that visitor to produce the type contents used today, and to compute the faulty paths for errors
[16:10:48] <eddyb> Hildar: it's a (relatively common in syntax/rustc) pattern 
[16:11:23] <flaper87> nmatsakis: maybe you can r=acrichto  https://github.com/mozilla/rust/pull/12017 ? :D :D :D :D
[16:11:33] <nmatsakis> flaper87: k
[16:11:38] <eddyb> flaper87: hmm, it's not at all in the queue
[16:11:47] *** Joins: ghrust (ghrust@C82447D.6A2AE50.F3114085.IP)
[16:11:47] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14c37cc87 to 14d394a48: 02http://git.io/N3iJvQ
[16:11:47] *** Parts: ghrust (ghrust@C82447D.6A2AE50.F3114085.IP) ()
[16:11:49] *** Joins: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP)
[16:11:49] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/IwyU5w
[16:11:49] <ghrust> 13rust/06auto 141b6a1e9 15Alex Crichton: Finalize the Seek API...
[16:11:49] <ghrust> 13rust/06auto 141d5c52d 15bors: auto merge of #12204 : alexcrichton/rust/seek, r=pcwalton...
[16:11:50] *** Parts: ghrust (ghrust@F6EE6DE3.6A2AE50.F3114085.IP) ()
[16:12:13] <eddyb> Hildar: a trait with default methods, some of which can be overwritten to handle the different "nodes" that you may want to have special actions for
[16:12:30] <flaper87> eddyb: that's what I meant with bors ignoring the r+
[16:12:32] <flaper87> :D
[16:12:38] <eddyb> flaper87: right, s/PR/bors/
[16:12:54] <flaper87> eddyb: LOOOOOOOOOOOOOOOOOL
[16:12:59] <flaper87> EPICFAIL
[16:13:07] <flaper87> damn, I should read the things I write
[16:13:08] <flaper87> :P
[16:13:13] <flaper87> (before sending them)
[16:13:56] <nmatsakis> flaper87: if that doesn't work, you may have to close and reopen the PR
[16:14:04] <eddyb> Hildar: or a folder, since you're recursively constructing a value
[16:14:05] <nmatsakis> flaper87: sometimes bors gets confused for unknown reasons
[16:14:38] <eddyb> nmatsakis: smells of sentience, someone should wipe its RAM once in a while
[16:14:51] <flaper87> nmatsakis: gotcha, thanks for the heads up
[16:18:39] *** Quits: dherman (dherman@moz-6CA476B1.hsd1.ca.comcast.net) (Ping timeout)
[16:20:26] *** Joins: Blaze_ (tuomino2@moz-785A3407.org.aalto.fi)
[16:22:31] *** Joins: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca)
[16:24:22] *** Joins: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu)
[16:25:15] *** Quits: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com) (Client exited)
[16:28:00] <eddyb> nmatsakis: I'll have to leave a few functions generic over Iterator<PathElem>, I hope it's not a problem
[16:30:52] <nmatsakis> eddyb: because they use mapped iterators or something?
[16:31:08] <eddyb> because there's chaining
[16:32:27] <nmatsakis> yeah ok
[16:32:52] <eddyb> but I hope it's only link::mangle and maybe encoder::encode_path, which don't use generics related to those iterators
[16:34:42] * flaper87 gets back to the static items PR
[16:39:58] *** Quits: canhtak (canhtak@moz-71C1AFFE.wl.t.ulaval.ca) (Quit: canhtak)
[16:40:25] *** Quits: Kxepal (Miranda@moz-4232FDEF.pppoe.mtu-net.ru) (Ping timeout)
[16:40:40] *** Joins: dherman (dherman@moz-B31C6965.dsl.pltn13.sbcglobal.net)
[16:40:40] *** ChanServ sets mode: +ao dherman dherman
[16:43:06] *** Quits: Hildar (Mibbit@moz-1FA995E0.in-addr.btopenworld.com) (Quit: http://www.mibbit.com ajax IRC Client)
[16:45:38] <cmr> hm
[16:46:01] <cmr> acrichto: do you remember which PR it was that made it so that stack locals could be reused?
[16:46:03] <eddyb> cmr: could your setup (easily) compile stage1 librustc with -g and then compile stage2 librustc with that stage1 rustc under perf record -g dwarf?
[16:46:13] <eddyb> cmr: the lifetime one?
[16:46:17] <cmr> maybe.
[16:46:29] <eddyb> the one I know is doener's, IIRC
[16:46:30] <acrichto> cmr: https://github.com/mozilla/rust/pull/12004
[16:46:35] <cmr> acrichto: thanks
[16:46:43] <cmr> eddyb: sure, I just compile it manually.
[16:46:59] <eddyb> because there's no other decent way to get callgraphs
[16:47:11] <eddyb> restricting it to one pass would be an amazing feature
[16:47:17] <cmr> "LLVM can't put two
[16:47:20] <cmr> allocas into the same stack space
[16:47:22] <cmr> Eugh that was what I was afraid of.
[16:47:38] <doener> cmr: I've got a better version by now, time/mem usage is up by only ~1-2%, and it can emit more/better lifetimes
[16:47:48] <eddyb> sweet :D
[16:47:56] *** Quits: edwardw (edwardw@D286B842.1B2F6624.7F41E82D.IP) (Ping timeout)
[16:48:16] <cmr> doener: Does the lifetime annotations affect pre-codegen optimization, or is it only post-codegen?
[16:48:28] <cmr> That is, are the affects on allocas observable with just IR...
[16:48:52] <eddyb> there are LLVM passes that introduce lifetimes
[16:48:56] <doener> cmr: only codegen cares about lifetimes
[16:49:00] <cmr> damn
[16:49:03] <eddyb> ahh, a bit sad
[16:49:43] <doener> cmr: is there a specific reason why you're asking?
[16:49:57] <eddyb> I'm guessing we move all locals to the first block to avoid having a lot of phis?
[16:50:16] <cmr> doener: yeah. I planned on doing stack size analysis by summing up allocas, but if codegen collapses some of them, that makes it an overestimate.
[16:50:28] <cmr> (as recommended by someone in #llvm)
[16:51:29] *** Joins: edwardw_ (edwardw@4112974A.B4358688.30F15291.IP)
[16:52:46] *** edwardw_ is now known as edwardw
[16:57:37] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[16:58:42] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[17:06:58] *** Joins: Kxepal (Miranda@moz-9E323D1A.pppoe.mtu-net.ru)
[17:17:49] <eddyb> nmatsakis: the ast_map PR should be (more) ready
[17:18:12] <eddyb> I guess someone could send it to try for a spin
[17:18:59] <cmr> eddyb: sure.
[17:19:12] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[17:19:32] *** Joins: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP)
[17:19:32] <ghrust> 01[13rust01] 15cmr 04force-pushed 06try from 1418cdb02 to 14e6e2e92: 02http://git.io/k471pw
[17:19:32] <ghrust> 13rust/06try 14e6e2e92 15Eduard Burtescu: Refactored ast_map and friends, mainly to have Paths without storing them.
[17:19:32] *** Parts: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP) ()
[17:20:22] <eddyb> cmr: thanks :)
[17:20:26] <cmr> np
[17:21:03] <eddyb> I wonder if I can do git checkout parent/master instead of checking out master and updating it, to skip rebuilds, or attempts at rebuilds
[17:21:53] *** Joins: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP)
[17:21:53] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/IwyU5w
[17:21:53] *** Parts: ghrust (ghrust@88C0CBA2.6A2AE50.F3114085.IP) ()
[17:25:50] <eddyb> looking at an abandoned branch, I tried making t_box smaller but noticed no significant memory reduction
[17:26:07] <doener> eddyb: what do you mean by "git checkout parent/master"?
[17:26:14] *** Joins: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com)
[17:26:14] *** ChanServ sets mode: +qo brson brson
[17:26:45] <eddyb> doener: parent is the name I give to the remote that corresponds to the parent of a github fork
[17:26:50] *** Joins: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP)
[17:26:50] <ghrust> 01[13rust01] 15bors pushed 4 new commits to 06auto: 02http://git.io/0we-kQ
[17:26:50] <ghrust> 13rust/06auto 14a750002 15Flavio Percoco: Replace `crate` usage with `krate`...
[17:26:50] <ghrust> 13rust/06auto 14bc3ce9b 15Flavio Percoco: Replace `extern mod` with `extern crate`...
[17:26:51] <ghrust> 13rust/06auto 144e49487 15Flavio Percoco: Remove obsolete warnings for `extern mod`...
[17:26:53] *** Parts: ghrust (ghrust@2DCF43EA.6A2AE50.F3114085.IP) ()
[17:28:19] <doener> eddyb: ah, ok
[17:28:43] <eddyb> now that we have a crate keyword...
[17:28:47] <eddyb> #much(attr) #such crate "wow#1.3.37"; // pls
[17:28:49] *** Quits: japaric (japaric@B95EF77B.8C2993CE.5C7588CA.IP) (Ping timeout)
[17:29:02] <eddyb> bstrie: ^^ more examples
[17:29:08] <cmr> eugh
[17:29:15] <cmr> now I'm against the attribute syntax changes
[17:29:18] <cmr> just on principle
[17:29:52] <eddyb> cmr: I take it you are #not(amused)
[17:30:18] <cmr> (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»
[17:31:58] <cmr> Where in back::link do we actually run the CodeGen passes.
[17:34:36] <eddyb> hah, you're lucky you found back::link
[17:34:47] <cmr> like, 8 months ago :p
[17:34:57] <cmr> is it a secret?
[17:34:58] <eddyb> I almost went nuts trying to find where I've seen LLVM pass configuration and I couldn't
[17:35:03] <cmr> heh
[17:35:17] <eddyb> back::link is kind of a weird place to have LLVM optimization passes, don't you think
[17:35:23] <eddyb> back::link::write, even
[17:35:37] <cmr> yeah.
[17:36:30] <cmr> I see with_codegen etc
[17:36:34] <cmr> but by the time we get there
[17:36:37] <cmr> codegen has to have already run
[17:36:37] <eddyb> I was just looking at that
[17:36:41] <cmr> because we're writing its output
[17:36:58] <cmr> so I'm super confused as to what is even going on
[17:37:30] <eddyb> cmr: WriteOutputFile does the codegen itself
[17:37:32] <cmr> I think what rustc thinks codegen is and what llvm thinks codegen is are very incompatible.
[17:38:06] <eddyb> with_codegen only has analysis passes to help WriteOutputFile
[17:38:22] <eddyb> LLVMRustWriteOutputFile probably has all the logic
[17:38:32] <cmr> it's not doing much if anything...
[17:38:36] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[17:39:54] <eddyb> cmr: pretty sure   unwrap(Target)->addPassesToEmitFile(*PM, FOS, FileType, false); PM->run(*unwrap(M)); is enough to do the codegen and write the file
[17:40:24] <cmr> ah yes it is.
[17:40:30] <cmr> TargetMachine is part of CodeGen
[17:40:34] * cmr gets some solid footing
[17:42:23] *** Joins: canhtak (canhtak@moz-5ED861D3.wl.t.ulaval.ca)
[17:42:49] <acrichto> cmr: was going to answer your question, appears you have already answered it!
[17:42:59] <acrichto> it's mostly C++ glue (as you've probably already found)
[17:44:55] <cmr> yeah
[17:48:22] <cmr> acrichto: I'm trying to get at each function's MachineFrameInfo to get the stack sizes...
[17:48:36] <acrichto> ah I see
[17:48:43] <acrichto> you may need a custom codegen pass to do that
[17:48:44] <cmr> I think it needs to go after (or sometime during) CodeGen because the stack size is only accurate after prologue insertion
[17:48:44] <acrichto> (maybe)
[17:48:59] * cmr has no idea
[17:49:01] <acrichto> the prologue definitely knows about the stack size
[17:49:05] <cmr> yep :P
[17:49:33] <cmr> it looks like the SelectionDAG is the central piece of information I need access to?
[17:49:40] <cmr> It has a getMachineFunction method that looks promising...
[17:50:28] <cmr> acrichto: what information do codegen passes have access to? Is there an example of a simple one?
[17:50:36] <acrichto> sadly I dunno
[17:50:37] <cmr> this is the first time I've really dug into llvm's codegen
[17:50:42] <acrichto> I haven't written a codegen pass before
[17:50:51] <acrichto> there's probably an example somewhere on the internet though
[17:50:51] <cmr> where's sunfish at...
[17:50:59] <acrichto> hehe
[17:51:03] <cmr> http://llvm.org/docs/WritingAnLLVMPass.html
[17:51:08] <cmr> Documentation!
[17:51:14] * cmr is pleasantly surprised
[17:51:17] <acrichto> that's amazing!
[17:51:22] *** Quits: SiegeLord (sl@moz-CAF07B4C.hsd1.ma.comcast.net) (Quit: It's a joke, it's all a joke.)
[17:51:34] <acrichto> go llvm
[17:54:03] *** Quits: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu) (Ping timeout)
[17:55:50] <cmr> " This pass type is used for passes that do not have to be run, do not change state, and never need to be updated."
[17:55:57] <cmr> "ImmutablePasses never invalidate other transformations, are never invalidated, and are never â€œrunâ€."
[17:56:03] <cmr> so clear!
[17:56:11] *** Joins: lkuper (lkuper@A37A1456.14CD977C.51B6877.IP)
[17:57:29] <brson> what is () called?
[17:57:30] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[17:57:34] <cmr> brson: unit
[17:57:43] <cmr> (or the unit type, if it's not the value)
[17:57:44] <acrichto> I use unit/nil interchangeably
[17:57:51] <acrichto> oh that's a good point
[17:57:57] <acrichto> I call the type unit but sometimes call the value nil
[17:57:58] <cmr> I don't like using nil because other language to use nil to mean null
[17:58:01] <acrichto> I never say "the nil type"
[17:58:10] <cmr> wow that sentence
[17:58:11] <eddyb> unit tuple, but that might be confused with 1-tuples
[17:58:23] <eddyb> cmr: much clear words
[17:58:26] <cmr> sometimes I'm not even sure if I'm a native speaker
[17:58:44] <acrichto> irc-ese
[17:59:01] <brson> pnkfelix nmatsakis do you agree () is called 'unit'?
[17:59:02] * eddyb looks at his collection of stolen english nativities
[17:59:09] <eddyb> my precioussss
[17:59:11] <brson> i'd like this type to stop changing names
[17:59:23] <cmr> brson: it's been unit for as long as I remember
[17:59:33] <brson> cmr: no, it has always been nil
[17:59:38] <cmr> gasp!
[17:59:39] <pnkfelix> brson: I'm happy with unit.  (Can it be coerced to a null *T ?)
[17:59:47] <cmr> pnkfelix: no.
[17:59:48] <eddyb> (no)
[17:59:52] <pnkfelix> brson: but I'd be fine with `nil` to.
[17:59:55] <pnkfelix> too
[18:00:32] <eddyb> don't we call "struct Foo;" unit structs?
[18:00:35] <acrichto> rusti: 0 as *() 
[18:00:37] -rusti- (0x0 as *())
[18:00:46] <eddyb> acrichto: that holds for all types
[18:00:49] <cmr> rusti: () as *()
[18:00:50] -rusti- <anon>:10:9: 10:18 error: cast from nil: `()` as `*()`
[18:00:51] -rusti- <anon>:10         () as *()
[18:00:52] <acrichto> true, I was just kinda curious
[18:00:53] -rusti-                   ^~~~~~~~~
[18:00:55] -rusti- error: aborting due to previous error
[18:00:57] -rusti- application terminated with error code 101
[18:00:58] <cmr> hey the compiler calls it nil
[18:01:02] *** Quits: pcmattman (pcmattman@moz-D9B7D938.net) (Ping timeout)
[18:01:07] <cmr> the manual usually doesn't afaict.
[18:01:08] <eddyb> the compiler code has "ty_nil"
[18:01:14] <cmr> yeah
[18:01:27] <eddyb> so naive edits would assume that name is right :(
[18:01:30] *** Joins: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP)
[18:01:30] <ghrust> 01[13rust01] 15alexcrichton merged 06master into 06snap-stage3: 02http://git.io/FVLgWg
[18:01:30] *** Parts: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP) ()
[18:01:34] <pnkfelix> brson: the theoretician in me likes `unit`.  But that's not a good reason.
[18:01:51] <eddyb> () being unit would be consistent with "struct Foo;" being named "unit struct"
[18:01:54] <pnkfelix> brson: The best reason I have to change it is that I think `nil` is too easily confused with `null`, while `unit` won't be.
[18:02:47] <eddyb> and there's enum List<T> {Cons(T, ~List<T>), Nil}
[18:03:31] <cmr> brson: I notice that the ancient git log uses your gmail address. How did you get involved with rust?
[18:04:22] <eddyb> interesting archeology, cmr
[18:04:25] <cmr> indeed it was the nil type... I don't think I've seen it called that before though.
[18:04:38] *** Parts: aepsil0n (ebopp@moz-EF530DCB.ita.uni-heidelberg.de) ()
[18:04:39] <cmr> (excluding ty_nil)
[18:05:07] <cmr> heh, 76a752e7a473c556773653aa505715a5042ae86b
[18:05:42] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Client exited)
[18:06:42] *** Joins: pcmattman (pcmattman@moz-D9B7D938.net)
[18:06:44] *** Joins: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP)
[18:06:44] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 144d1f84f to 141d5c52d: 02http://git.io/N3iJvQ
[18:06:44] *** Parts: ghrust (ghrust@94BD74B8.6A2AE50.F3114085.IP) ()
[18:06:46] *** Joins: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP)
[18:06:46] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/ivsfpw
[18:06:46] <ghrust> 13rust/06auto 147355904 15Alex Crichton: Tweak how preference factors into linkage...
[18:06:46] <ghrust> 13rust/06auto 14b4e5ee3 15Alex Crichton: Re-work loading crates with nicer errors...
[18:06:47] <ghrust> 13rust/06auto 14d3c98e9 15bors: auto merge of #12164 : alexcrichton/rust/rlibs-and-dylibs, r=cmr...
[18:06:49] *** Parts: ghrust (ghrust@C8693FCB.6A2AE50.F3114085.IP) ()
[18:08:20] *** Joins: tjc (tjc@moz-6EB4E533.dsl.tsoft.com)
[18:08:20] *** ChanServ sets mode: +o tjc
[18:10:17] <doener> hrm, binding lifetimes to scopes is easy but can't handle a few cases where I'd like to have shorter lifetimes than what the scopes offer *sigh*
[18:10:45] <tjc> doener: If I'm understanding you correctly, you can use a block to create a shorter lifetime
[18:10:57] <tjc> as in, you can wrap any sequence of statements (possibly with an expression in tail position) in {}
[18:11:14] <cmr> tjc: unfortunately he's talking about lifetimes in the LLVM IR
[18:11:19] <doener> tjc: I'm adding support for the llvm lifetime intrinsics
[18:11:25] <tjc> cmr: oh, ignore me
[18:11:36] <tjc> that'll learn me to reply to something when I just joined the channel :-)
[18:11:43] * cmr does it too
[18:12:23] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Connection reset by peer)
[18:12:33] <eddyb> am I not doing anything?
[18:12:36] *** Joins: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP)
[18:13:52] <eddyb> cmr: when I asked "how easy it is to do that perf callgraph thing" I was implying that you might be able to run it for me (or at least produce the stage1 binaries with DWARF information)
[18:14:01] <cmr> eddyb: oh, what do you need?
[18:14:08] <cmr> I can do that.
[18:14:16] <eddyb> that is, if you want to maybe identify some performance problem
[18:15:15] <eddyb> cmr: perf record -g fp works well (I stop rustc right after type checking, which takes like 70s here), but not well enough
[18:15:34] <cmr> acrichto: eugh this is a huge PITA
[18:15:44] <cmr> acrichto: we need to be using cmake to have out of tree LLVM passes!?
[18:15:46] <eddyb> cmr: for proper call graphs, the rustc executable should include DWARF information and perf record can then be ran with -g dwarf
[18:16:06] <acrichto> cmr: you can't register them at runtime?
[18:16:14] <acrichto> surely we can build it without cmake...
[18:16:29] <cmr> you can, but their documentation says to build it you need to use their cmake build system...
[18:16:30] <eddyb> cmr: I also wonder if samples could be correlated with pass timings to produce per-pass callgraphs
[18:16:46] <cmr> eddyb: so what exactly do you want? just the perf data?
[18:17:20] <eddyb> yeah, but running an entire stage2 librustc compilation under perf will concentrate on LLVM
[18:17:23] <doener> cmr: you can add them in src/llvm/lib/... -- just remember that "configure" will reset submodules, I lost my passes 3-4 times that way
[18:17:27] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[18:17:39] <eddyb> cmr: if there's a way to make it stop after lints, that would be great
[18:17:44] <cmr> doener: is that kosher?
[18:17:49] <cmr> eddyb: --no-trans?
[18:17:55] <eddyb> oh, cool
[18:18:05] <cmr> doener: that is, is adding third-party passes into src/llvm/lib acceptable?
[18:18:10] <eddyb> (since borrow checking, lints and whatever else after type checking should have minimal impact)
[18:18:59] <cmr> eddyb: do you want it on a regular rustc or on the rustc from your branch/
[18:19:00] <doener> cmr: there's no other way unless you use cmake AFAIK. But honestly, I didn't really think about it, I just wanted it to work
[18:19:27] <cmr> doener: good enough for me. super knarly though
[18:19:29] <eddyb> cmr: there's no trans, it shouldn't matter
[18:19:35] <cmr> eddyb: k
[18:20:06] <eddyb> like, there's a lot of memsetting and I would like to know where it comes from
[18:20:28] <cmr> I do `git checkout master` and https://gist.github.com/cmr/34f98a3c9b8a6b411007 happens sometimes
[18:20:33] <cmr> does anyone know why?
[18:20:35] <brson> i guess we've been converging on 'unit' for a while
[18:24:38] <Eridius> cmr: did you fetch upstream into local master directly via some command, bypassing the remote-tracking branches?
[18:24:58] <cmr> Eridius: uhh I don't know.
[18:25:07] <cmr> I did a `git fetch` in another one of my workdirs
[18:25:15] <cmr> I've only experienced it when using git-new-workdir
[18:25:19] <Eridius> ahh, workdirs
[18:25:25] *** Quits: summerlight (summerligh@327FC32B.2C956A45.501EFF44.IP) (Ping timeout)
[18:25:27] <Eridius> although, remote-tracking branches should be shared..
[18:25:29] <Eridius> hmmmm
[18:25:37] <Eridius> anyway, workdirs can do some interesting things
[18:25:58] <doener> cmr: do you use "git pull origin master"?
[18:25:59] *** Joins: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com)
[18:25:59] *** ChanServ sets mode: +ao pcwalton pcwalton
[18:26:10] <cmr> doener: sometimes, yes.
[18:26:35] <cmr> the thing that gave that status was just a `git checkout master`
[18:27:27] <brson> cmr: i got involved with rust in my free time because i wanted to learn how to write a compiler
[18:27:36] <doener> cmr: ok, that doesn't update the remote tracking branch and would explain the "is ahead of" part.
[18:27:53] <doener> cmr: where does "git checkout -" take you (i.e. what was your previous branch)?
[18:28:12] <Eridius> doener: `git checkout` never updates remote-tracking branches, period
[18:28:39] <cmr> doener: well, I've already done a subsequent pull etc, so I've trashed whatever state was there :9
[18:28:40] <doener> Eridius: I've been talking about the "git pull origin master" usage of "git pull" that I asked about
[18:28:43] <cmr> * :(
[18:28:46] <Eridius> ah
[18:29:08] <cmr> I know how to get out of the corner I sometimes get myself in, I just don't always know how I got into said corner..
[18:29:13] <Eridius> cmr: I typically just do `git pull` if I have master checked out already, which does update remote-tracking, or I do `git remote update` if I'm on another branch, to update all my remotes
[18:29:53] <Eridius> cmr: I believe `git pull <remote> <branch>` is typically used for merging other branches, rather than merging your upstream, which is why it doesn't bother updating refspecs (e.g. you may add a temporary remote, merge a branch from it, then delete that remote)
[18:30:45] <nmatsakis> brson: I'm fine with () being "unit"
[18:30:49] <nmatsakis> brson: or nil.
[18:31:02] <Eridius> 'unit' is what Haskell calls it, no?
[18:31:16] <nmatsakis> I don't recall, both have precedent so far as I know
[18:31:33] <nmatsakis> but I think unit is the more...algebraic name
[18:31:35] <doener> cmr: well, anyway, you probably had the same branch head checked out in two different working dirs, and then updated it (e.g. by using "git pull") in one of them. That made your working tree and index in the other one go out of sync with the branch head
[18:31:37] <Eridius> also apparently the generic name for this concept is the "unit type": http://en.wikipedia.org/wiki/Unit_type
[18:31:42] <Eridius> so "unit" makes sense
[18:32:02] <Eridius> doener: working tree and index in the other are irrelevant
[18:32:02] <doener> cmr: git then sees that as changes and does its usual thing, i.e. keeping the changes
[18:32:12] <Eridius> doener: because he's talking about what happens after he ran `git checkout` which, guess what, updates working tree and index!
[18:32:34] <Eridius> I believe the `git pull origin master` is why this happened, and cmr just didn't notice until he ran a checkout
[18:32:40] <Eridius> cmr: you should put git status in your shell prompt
[18:32:47] <cmr> O_o
[18:33:22] <Eridius> your shell PS1 can show you the checked-out branch and some symbols that indicate if it's in sync with upstream, has dirty changes, etc
[18:34:31] *** Joins: sigma (sigma@moz-B2E77065.range86-184.btcentralplus.com)
[18:35:41] <doener> Eridius: that doesn't usually mess up the working tree like that. See the second half of my answer. From the point that the branch head was changed remotely, but the index and working tree were not, git treated things as staged changes. https://gist.github.com/dotdash/3b201186bb3cb47dd1a5 -- maybe that explains it better
[18:36:01] <Eridius> oh I forgot about the modified lines
[18:36:09] <Eridius> yeah he probably checked out the same branch in two workdirs
[18:36:13] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[18:36:16] <Eridius> that causes the index to get out of sync with the branch head if you update it in one workdir
[18:36:34] <eddyb> cmr: oh wow http://buildbot.rust-lang.org/builders/try-bsd/builds/733/steps/compile/logs/stdio/text
[18:37:10] <cmr> eddyb: that's how you know you're winning!
[18:37:19] <Eridius> eddyb: what are you doing?
[18:37:32] <Eridius> ah found the commit
[18:37:48] <eddyb> an unused import...
[18:38:00] *** Joins: lpy_ (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[18:38:07] <eddyb> at least I know there's nothing else wrong with librustdoc
[18:38:22] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[18:40:03] *** Quits: lpy_ (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[18:40:12] *** Joins: sunfish (chatzilla@moz-8DE7F965.dsl.dynamic.sonic.net)
[18:42:39] *** Quits: edwardw (edwardw@4112974A.B4358688.30F15291.IP) (Ping timeout)
[18:42:45] *** Joins: edwardw (edwardw@BF6575DE.1B2F6624.7F41E82D.IP)
[18:43:01] <eddyb> if nobody needs try for anything, I've fixed that one lint in https://github.com/mozilla/rust/pull/12162
[18:43:17] <acrichto> eddyb: want it pushed to try?
[18:43:24] <eddyb> acrichto: sure :)
[18:43:36] *** Joins: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP)
[18:43:36] <ghrust> 01[13rust01] 15cmr 04force-pushed 06try from 14e6e2e92 to 1423c9050: 02http://git.io/k471pw
[18:43:36] <ghrust> 13rust/06try 1423c9050 15Eduard Burtescu: Refactored ast_map and friends, mainly to have Paths without storing them.
[18:43:36] *** Parts: ghrust (ghrust@49477F7E.6A2AE50.F3114085.IP) ()
[18:43:40] <acrichto> aww
[18:43:47] <cmr> :)
[18:43:52] <cmr> (sorry)
[18:43:57] <eddyb> thanks, both of you :P
[18:44:17] <eddyb> nmatsakis: sorry to bug you, but it's getting late here, should I expect something for tomorrow?
[18:45:46] *** Quits: canhtak (canhtak@moz-5ED861D3.wl.t.ulaval.ca) (Quit: canhtak)
[18:50:06] <nmatsakis> eddyb: yeah ;) few hours was probably overoptimistic
[18:50:20] <nmatsakis> eddyb: but I made progress, just got stuck in calls for a bit, planning to get back to it later
[18:54:43] *** Quits: zimbabao (rajaram@25FB2EA.5B6EDC44.D2D1FAF0.IP) (Ping timeout)
[19:07:20] *** Quits: doener (doener@moz-C68F600D.unity-media.net) (Quit: leaving)
[19:11:02] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[19:16:33] *** Quits: edwardw (edwardw@BF6575DE.1B2F6624.7F41E82D.IP) (Quit: Leaving...)
[19:22:50] <eddyb> the ast_map PR gets into testing, yay :)
[19:24:46] *** Joins: edwardw (Mibbit@BF6575DE.1B2F6624.7F41E82D.IP)
[19:25:21] <cmr> Hey all, here's a perf trace of stage1 rustc compiling stage2 librustc, --no-trans, at http://octayn.net/benches/perf-1392232977.data.xz
[19:25:32] <cmr> with full callgraphs.
[19:25:40] <cmr> it's like ~600MB decompressed
[19:25:42] <cmr> be warned.
[19:27:30] *** Joins: japaric (japaric@61A78F7A.839FBF92.95AFB88D.IP)
[19:27:44] <acrichto> cmr: hm, all I see is 80.04%  rustc  rustc                [.] 0x000000000010ef45
[19:28:03] <cmr> feh that's unfortunate.
[19:28:08] <cmr> I wonder if you need the libraries...
[19:28:14] * cmr doesn't know how perf stores its things
[19:28:22] <acrichto> me neither :P
[19:28:31] <acrichto> lemem update rust just in case
[19:28:54] <acrichto> no luck
[19:29:09] <acrichto> it looks like ~15% of compile time is malloc traffic though
[19:29:11] <acrichto> which is quite high
[19:29:19] <acrichto> 2% in memcpy is absurd
[19:29:36] <acrichto> the llvm upgrade should fix a good chunk of htat
[19:30:02] <acrichto> cmr: perhaps a screenshot of just the first page?
[19:30:15] <cmr> sure.
[19:30:18] <cmr> sec
[19:30:31] <cmr> or actually
[19:30:33] <cmr> why not flamegraph!
[19:30:44] <acrichto> :D
[19:30:48] * cmr loves flamegraphs
[19:33:48] <eddyb> cmr: forget to tell you perf report loads the DWARF data from the binaries themselves :/
[19:34:36] <eddyb> +1 for a visual representation that we can share
[19:34:59] <eddyb> "HN, here's a bunch of reasons why the rust compiler is slow"
[19:35:46] <cmr> http://octayn.net/benches/rustc.svg
[19:35:50] <cmr> warn: large
[19:36:01] <cmr> well
[19:36:02] <cmr> under a meg
[19:36:06] <cmr> but your browser might not like it.
[19:36:10] <brson> we should have a cross-compile bot. the snapshot breakage is becoming a regular occurance
[19:36:24] <acrichto> brson: yeah I agree
[19:36:46] <eddyb> cmr: I was crashing dot years ago. also producing 32k-wide PNGs
[19:37:08] <acrichto> can you zoom in on a section of a flame graph?
[19:37:20] <cmr> unsure.
[19:37:30] <cmr> browser zoom seems... futile.
[19:37:48] <acrichto> we spend like 10% of our time just hashing things
[19:38:10] <acrichto> oh jeez 2% is just dropping the ty::ctxt
[19:38:45] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[19:39:05] <eddyb> erickt_ and cgaebel should fix (some of) the hash problem
[19:39:09] <acrichto> we decode struct fields a lot...
[19:39:17] <acrichto> the hash speedup looks like it'll help the most
[19:39:39] <eddyb> most of dropping ty::ctxt is actually _int_free
[19:39:59] <eddyb> we're allocating enough memory that it becomes a hassle to unmap it
[19:40:02] <acrichto> lots of things are in the ty::ctxt
[19:40:03] <sfackler> wow, a _lot_ of time is spent hashing
[19:40:18] <eddyb> sfackler: we kinda knew/guessed that already
[19:40:23] <eddyb> there are cases where it's worse
[19:40:25] <cmr> eddyb: I don't think glibc unmaps anythin.
[19:40:53] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[19:41:10] <eddyb> cmr: it does unmap large allocations that didn't fit in anywhere
[19:41:29] <cmr> ok
[19:41:41] <cmr> hm
[19:41:45] <cmr> http://code.google.com/p/jrfonseca/wiki/Gprof2Dot looks promising.
[19:41:48] <eddyb> it uses something different than mmap/munmap for regular (small) allocations
[19:43:11] *** Quits: sunfish (chatzilla@moz-8DE7F965.dsl.dynamic.sonic.net) (Ping timeout)
[19:44:34] <cmr> http://i.imgur.com/o6sFuws.png
[19:44:38] <cmr> much large
[19:44:48] <cmr> still only 700K though!
[19:45:10] <acrichto> what in the world is going on
[19:45:27] <acrichto> shouldn't there be one root node?
[19:45:48] <eddyb> who needs roots?
[19:45:58] <eddyb> we ain't makin' rootbeer
[19:46:55] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[19:47:18] <eddyb> cmr: chrome is being silly now
[19:47:31] * eddyb wishes he had servo
[19:47:35] <cmr> I think it's only showing the largest functions or something.
[19:47:44] <cmr> I honestly don't know.
[19:47:45] <eddyb> I guess I can download it and use the image viewer
[19:51:08] *** Quits: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com) (Ping timeout)
[19:51:14] *** Quits: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP) (Connection reset by peer)
[19:51:47] *** Quits: edwardw (Mibbit@BF6575DE.1B2F6624.7F41E82D.IP) (Quit: http://www.mibbit.com ajax IRC Client)
[19:51:50] *** Joins: ghrust (ghrust@7BEB6F9D.6A2AE50.F3114085.IP)
[19:51:50] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/age3bg
[19:51:50] <ghrust> 13rust/06auto 14064281c 15Alex Crichton: Ignore another fourcc test on cross compiles
[19:51:50] <ghrust> 13rust/06auto 14c62f6ce 15bors: auto merge of #12216 : alexcrichton/rust/another-snap-fix, r=brson...
[19:51:51] *** Parts: ghrust (ghrust@7BEB6F9D.6A2AE50.F3114085.IP) ()
[19:55:05] *** Joins: bjz (bjz@B398BE78.F804C29E.D35A31DF.IP)
[19:56:01] *** Quits: bytbox (s@moz-54E13927.washdc.fios.verizon.net) (Ping timeout)
[19:57:14] *** Joins: nrc (nrc@7BE24E90.A5032A01.3CFC199D.IP)
[19:57:18] *** Joins: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com)
[19:57:18] *** ChanServ sets mode: +qo brson brson
[19:57:28] *** Quits: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com) (Quit: leaving)
[19:57:43] *** Quits: tjc (tjc@moz-6EB4E533.dsl.tsoft.com) (Ping timeout)
[20:02:12] *** Joins: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com)
[20:02:12] *** ChanServ sets mode: +qo brson brson
[20:02:30] <eddyb> http://buildbot.rust-lang.org/console?branch=try&refresh=15 what is this?
[20:02:37] <eddyb> green, empty, empty, yellow
[20:02:56] <cmr> not empty
[20:02:57] <cmr> gray
[20:03:02] <cmr> as in
[20:03:03] <cmr> continued-failing.
[20:03:30] <eddyb>     [compile-fail] compile-fail/ambig_impl_unify.rs
[20:03:42] <eddyb> on only two architectures, this is weird
[20:04:06] <eddyb> error: expected note on line 16 not found: candidate #1 is `foo$$UP$$VEC$uint::foo`
[20:04:13] <eddyb> OMG do we actually output that?
[20:04:38] <eddyb> (I thought I ran tests, maybe only run-pass)
[20:04:40] *** Quits: Leo` (Leo@moz-83832FE2.placeholder.fr) (Ping timeout)
[20:04:41] <eddyb> note: candidate #1 is `~[uint].foo::foo`
[20:04:52] <eddyb> that does look better, don't you think?
[20:05:37] *** Joins: Leo` (Leo@moz-83832FE2.placeholder.fr)
[20:07:07] *** Joins: bytbox (s@moz-54E13927.washdc.fios.verizon.net)
[20:07:45] *** Joins: sunfish (chatzilla@moz-8DE7F965.dsl.dynamic.sonic.net)
[20:15:16] <cmr> eddyb: whoa that's awesome.
[20:16:08] <eddyb> it should be technically foo<for ~[uint]>::foo, but that's messy to mangle with the current scheme
[20:16:52] <eddyb> T.Trait::method is close enough
[20:17:22] *** Joins: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[20:17:51] *** Quits: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com) (Ping timeout)
[20:18:34] *** Quits: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com) (Quit: pcwalton)
[20:19:36] *** Quits: erickt_ (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[20:19:37] *** Joins: mawuli (mawuli@moz-5ADAB167.com.gh)
[20:22:16] *** Joins: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca)
[20:23:50] <eddyb> nmatsakis: oooh, I can see type_contents::tc_ty on the graph :D
[20:23:54] <eddyb> 0.59%
[20:24:49] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[20:27:32] <eddyb> nmatsakis: next_ty_var_id has 0.73% o_O. SmallIntMap seems to be costly there. not sure why it would have to call memcpy in that case
[20:28:19] <eddyb> cmr: wish we could group by module instead of binary
[20:28:44] <eddyb> region inference might be taking a lot of the type-checking time
[20:28:54] <erickt> eddyb / sfackler: getting so very close to finishing my hash stuff. I'm now just shaking out the few remaining bugs with migrating from #[deriving(IterBytes)] to #[deriving(Hash)]
[20:30:05] <eddyb> erickt: are you checking with cgaebel so there's no bad interactions between both of your PRs?
[20:30:18] <eddyb> double hash win :D
[20:31:32] <erickt> eddyb: I haven't been, only with Jurily and his xxHash implementation. Wow, 213 comments? I thought mine was big with 31 comments :)
[20:32:00] <eddyb> oh, right, three improvements :D
[20:33:33] <erickt> I love how we've gotten this sponteneous convergence of work on hashing. Here I thought I wouldn't stomp on anyone's toes because no one has really done anything with hashes for months now
[20:33:59] <eddyb> starts are aligning obv
[20:35:05] <eddyb> *stars
[20:36:15] <Eridius> hrm, why did std::comm::Select change? cc acrichto 
[20:38:37] <erickt> eddyb: I just poked through cgaebel's #12081, and while there will be some overlap, it shouldn't result in *that* many merge conflicts. My changes are relatively simple https://github.com/erickt/rust/commit/0c7cf628c84e42f8b0162b3d37e881e75a5d2d6f#diff-4b6329d238cbb757d5646fc56ecbe267L56
[20:38:42] <erickt> brb
[20:39:31] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[20:39:55] <eddyb> I expect both PRs to land in immediate succession and then a snapshot to be produced :P
[20:40:43] *** Quits: sunfish (chatzilla@moz-8DE7F965.dsl.dynamic.sonic.net) (Ping timeout)
[20:41:05] *** Joins: ktt3ja (ktt3ja@moz-85E2770C.hsd1.va.comcast.net)
[20:41:33] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[20:42:03] <Eridius> whoa, why does Handle no longer expose .try_recv()?
[20:42:05] <eddyb> erickt: I wonder why this isn't generic over its Hasher https://github.com/erickt/rust/commit/0c7cf628c84e42f8b0162b3d37e881e75a5d2d6f#diff-4b6329d238cbb757d5646fc56ecbe267R473
[20:42:20] <Eridius> that's a showstopping change for me
[20:42:22] <Eridius> acrichto: ^
[20:47:13] <sfackler> hurray!
[20:47:15] *** Joins: rca_ (rcatolino@moz-CFD59DD6.adsl.proxad.net)
[20:47:52] *** Quits: rca (rcatolino@moz-124BA3D3.adsl.proxad.net) (Ping timeout)
[20:49:45] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Ping timeout)
[20:52:18] <erickt> eddyb: It will be, that's another thing I'll need to do before I'm ready to land this PR
[20:52:55] *** Joins: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net)
[20:53:15] <eddyb> erickt: bug cmr to graph it when it's ready, I'm curious of its impact
[20:55:20] <erickt> what do you mean by graph it? the performance?
[20:55:25] <eddyb> yeah
[20:56:40] <erickt> eddyb: added it to my todo :)
[21:01:51] *** Joins: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP)
[21:01:51] <ghrust> 01[13rust01] 15bors merged 06auto into 06master: 02http://git.io/age3bg
[21:01:51] *** Parts: ghrust (ghrust@511FAEBD.6A2AE50.F3114085.IP) ()
[21:05:30] <eddyb> nmatsakis: so https://github.com/mozilla/rust/pull/12162 should merge, r?
[21:06:35] <nmatsakis> eddyb: k
[21:06:45] *** Joins: Jesse (jruderman@moz-9754CB0.hsd1.ca.comcast.net)
[21:06:51] *** Joins: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP)
[21:06:51] <ghrust> 01[13rust01] 15bors pushed 0 new commits to 06auto: 02http://git.io/88ehiQ
[21:06:51] *** Parts: ghrust (ghrust@2E45E35D.6A2AE50.F3114085.IP) ()
[21:06:52] *** Joins: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP)
[21:06:53] <ghrust> 01[13rust01] 15bors pushed 3 new commits to 06auto: 02http://git.io/JEOrLg
[21:06:53] <ghrust> 13rust/06auto 147355904 15Alex Crichton: Tweak how preference factors into linkage...
[21:06:53] <ghrust> 13rust/06auto 14b4e5ee3 15Alex Crichton: Re-work loading crates with nicer errors...
[21:06:53] <ghrust> 13rust/06auto 14974ec37 15bors: auto merge of #12164 : alexcrichton/rust/rlibs-and-dylibs, r=cmr...
[21:06:55] *** Parts: ghrust (ghrust@B750D19A.6A2AE50.F3114085.IP) ()
[21:09:42] *** Joins: pcwalton (pcwalton@moz-C07D5168.p2p.sfo1.mozilla.com)
[21:09:42] *** ChanServ sets mode: +ao pcwalton pcwalton
[21:10:26] <acrichto> Eridius: select() is very very volatile
[21:10:50] *** Quits: eddyb (eddy@688E9026.F7C96DA2.FCAAE698.IP) (Ping timeout)
[21:11:19] *** kimundi is now known as zz_kimundi
[21:11:53] *** Quits: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com) (Ping timeout)
[21:12:36] *** Joins: rustilite (rustilite@moz-54F7FD49.cpe.net.cable.rogers.com)
[21:22:37] <Eridius> acrichto: I understand that, but I'm still trying to use it
[21:22:51] <Eridius> also, I submitted a PR to reintroduce .try_recv() at the same time as you commented on my comment, so do with that what you will
[21:23:17] <acrichto> I'd have to think about the implications of it, I removed it because it doesn't make much sense to select over a try_recv()
[21:23:33] <Eridius> acrichto: in my case I'm doing a select on 3 ports, then running try_recv() on all 3 instead of using the result of the select
[21:23:48] <Eridius> and the reason is because I want to ensure all 3 ports are serviced regularly rather than relying on whatever undocumented behavior select uses when multiple ports are ready
[21:24:08] *** Joins: brson (brson@moz-DFAA4E15.p2p.sfo1.mozilla.com)
[21:24:08] *** ChanServ sets mode: +qo brson brson
[21:25:24] <Eridius> acrichto: btw, I don't know how feasible it is, but I would love some way to destruct a Port and return all queued messages at the same time (instead of dropping the queued messages)
[21:25:36] *** Quits: b (b@moz-55CA322E.org) (Quit: !)
[21:26:17] <Eridius> acrichto: the reason being when my task hits an error, I need to shut down, but I still want to process all already-sent messages on one of my ports first. Right now I pull all the messages off, destruct the port, then process the messages, but there's still a race between the final .try_recv() and the destruction where the sender could queue up another message
[21:27:25] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[21:27:26] *** Joins: b (b@moz-55CA322E.org)
[21:27:46] *** Joins: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au)
[21:27:54] <acrichto> Eridius: that's impossible to do without races
[21:28:04] <acrichto> unless you drain the port until the chan has dropped
[21:28:48] <Eridius> acrichto: I don't know how Port is implemented internally, or how it queues up sent messages. What I want is some way to close a port without throwing away the queued messages
[21:28:52] <Eridius> then I can drain the queued messages
[21:28:54] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[21:29:09] <acrichto> that's the exact same as try_recv until none
[21:29:12] *** Joins: jensnockert (jensnocker@moz-4C68E8F4.mobileonline.telia.com)
[21:29:14] <acrichto> it's no less racy
[21:29:15] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[21:29:17] <Eridius> acrichto: I want to close the Port, not close the Chan
[21:29:38] <Eridius> I want to try_recv until Empty, close the port, and know that no messages got sent successfully by the Chan in between the last try_recv and the close
[21:29:56] <acrichto> that doesn't make sense to do in the destructor as well
[21:30:02] <acrichto> when a port drops it destroys all pending messages
[21:30:05] *** Quits: ChristopherBurg (Christophe@moz-2C03E71B.hfc.comcastbusiness.net) (Ping timeout)
[21:30:08] <flaper87> damn, the crate patch failed :(
[21:30:15] <Eridius> acrichto: right, which is why I'm asking for some way to consume a Port and not destroy the pending messages
[21:30:16] <acrichto> and if you "flag destruction and then drain" it's the same thing as just sending after you finished try_recv()
[21:30:32] <acrichto> "flag and drain" is the same thing as "try until none and then drop"
[21:30:44] <acrichto> neither has an advantage over the other in terms of messaging guarantees
[21:31:17] <Eridius> acrichto: my goal is for Chan.try_send() to return false after I've drained the Port
[21:33:52] *** Joins: sunfish (chatzilla@moz-C06D9702.mtv1.mozilla.com)
[21:35:41] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[21:36:00] <Eridius> acrichto: basically, looking at the drop_port method in stream.rs, I want exactly what it's doing except I want to capture the queue contents instead of dropping it
[21:40:04] *** Quits: rca_ (rcatolino@moz-CFD59DD6.adsl.proxad.net) (Ping timeout)
[21:40:16] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[21:41:57] *** Quits: Leo` (Leo@moz-83832FE2.placeholder.fr) (Ping timeout)
[21:42:18] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[21:44:16] <vadimcn> acrichto: in link.rs, the order of libraries on the command line is: add_local_native_libraries, add_upstream_rust_crates, add_upstream_native_libraries.  Is there a reason for this specific order?
[21:45:45] *** Joins: Leo` (Leo@moz-83832FE2.placeholder.fr)
[21:46:15] *** zz_kimundi is now known as kimundi
[21:53:05] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[21:53:16] *** Quits: dherman (dherman@moz-B31C6965.dsl.pltn13.sbcglobal.net) (Quit: dherman)
[21:53:38] *** Quits: lkuper (lkuper@A37A1456.14CD977C.51B6877.IP) (Quit: lkuper)
[21:53:40] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[21:53:57] <nrc> I'm getting an ICE and the path to the file is /home/rustbuild/src/rust-buildbot.... what is this rustbuild stuff?
[21:54:45] <Eridius> nrc: that's the path where the source is for the stage0 compiler
[21:54:58] <Eridius> nrc: I take it your ICE happens when the stage0 rustc is attempting to build a stage1 library
[21:55:36] <nrc> I guess so
[21:56:09] <nrc> Well, probably not actually
[21:56:24] <nrc> I've only changed rustc, so it is probably building that which causes the error
[21:56:35] <Eridius> ok sure, but it's the stage0 compiler building something
[21:56:41] <Eridius> in this case I guess building the stage1 rustc
[21:56:47] <nrc> right
[21:57:05] <nrc> that would explain why the source line numbers don't line up
[21:57:29] <nrc> and the assert looks impossible to trip from the code :-s
[21:58:46] *** Quits: pcmattman (pcmattman@moz-D9B7D938.net) (Ping timeout)
[21:58:52] <nrc> thanks Eridius
[21:59:05] *** kimundi is now known as zz_kimundi
[22:02:38] <acrichto> vadimcn: there are weird orderings on command lines for some linux distros I think, something about the right hand things depending on the left hand things (I think)
[22:02:50] <acrichto> Eridius: perhaps, but as implemented this won't work for shared streams at all
[22:03:14] *** Joins: pcmattman (pcmattman@moz-D9B7D938.net)
[22:03:44] <Eridius> acrichto: :/
[22:03:46] <vadimcn> acrichto: yes, that.   I've discovered that very few symbols are getting pulled from compiler-rt, because it's too early on the command line
[22:04:03] <acrichto> vadimcn: hm interesting, perhaps that's why it worked the first time!
[22:04:32] <vadimcn> I was worried mostly about compiling it
[22:04:34] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[22:04:34] <acrichto> I personally don't know the rules about orderings that well, things are the way they are right now mainly by coincidence
[22:04:58] *** Quits: pcmattman (pcmattman@moz-D9B7D938.net) (Ping timeout)
[22:06:09] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[22:06:14] *** Joins: pcmattman (pcmattman@moz-D9B7D938.net)
[22:06:26] <vadimcn> Well, the rule is simple: any undefined symbols that appear in a library or an object file must be resolved by libraries or objs to the right of it on the command line
[22:06:30] *** Joins: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu)
[22:07:00] <acrichto> ah, so morestack/compiler-rt should be last
[22:07:38] <vadimcn> acrichto: not so simple.  compiler-rt must be before libgcc, otherwise libgcc still picks up all those symbols
[22:08:01] <acrichto> we don't specify libgcc though, so wouldn't it implicitly come at the end of everything?
[22:08:45] <vadimcn> but upstream crates could have declared dependency on libgcc via #[link()] attribute
[22:09:13] <acrichto> they opt in to that though
[22:09:22] <acrichto> if you've opted into that then sure you resolve that before compiler-rt
[22:09:56] <vadimcn> but that affects the <current crate>.o file as well
[22:10:10] <acrichto> ?
[22:11:01] *** Joins: ghrust (ghrust@C82447D.6A2AE50.F3114085.IP)
[22:11:01] <ghrust> 01[13rust01] 15alexcrichton merged 06master into 06snap-stage3: 02http://git.io/age3bg
[22:11:01] *** Parts: ghrust (ghrust@C82447D.6A2AE50.F3114085.IP) ()
[22:11:06] <vadimcn> I'd be ok if only undefined symbols from upstream crates were resolved against libgcc, but it will affect everything "to the left"
[22:12:12] <acrichto> if you're opting-in to linking against libgcc you're already generating lots of weirdness
[22:12:22] <acrichto> is this expected to be a normal occurrence?
[22:13:37] <vadimcn> I dunno...
[22:16:14] <vadimcn> Your -nodefaultlibs patch, for example, adds an explicit dependency on libgcc_s to the std crate
[22:17:14] <acrichto> does it matter whether the symbols are resolved in libgcc or compiler-rt though?
[22:17:20] <acrichto> they all in theory do the same thing 
[22:17:28] <acrichto> we just ran into problems where libgcc didn't have some symbols that compiler-rt had
[22:18:59] <vadimcn> well, if we are trying to squeeze out libgcc dependencies, I'd say yes
[22:19:21] <acrichto> we don't depend on libgcc though
[22:19:29] <acrichto> it's just unfortunate that we're picking it up because of libgcc_s
[22:19:37] <acrichto> we should be able to fix that once we have libunwind as a separate lib (if ever)
[22:20:12] <vadimcn> working on it...
[22:20:36] <vadimcn> ok, maybe we can defer it till then
[22:21:06] *** Quits: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au) (Ping timeout)
[22:21:25] *** Joins: ChrisMorgan (chris@moz-6AC741CA.static.tpgi.com.au)
[22:26:10] *** Quits: jensnockert (jensnocker@moz-4C68E8F4.mobileonline.telia.com) (Connection reset by peer)
[22:27:05] <flaper87> acrichto: https://github.com/mozilla/rust/pull/12017 r? Not sure why that test failed :/ I just tested it locally and it worked. 
[22:27:46] <acrichto> flaper87: did you run 'make check-fast"?
[22:28:34] <flaper87> acrichto: make check-stage2 TESTNAME=...
[22:28:45] <acrichto> flaper87: that's different from the check-fast suite
[22:28:51] <acrichto> the check-fast suite concatenates tests together
[22:29:08] <flaper87> acrichto: mmh, ok, let me give check-fast a try
[22:34:50] *** Joins: tjc (tjc@moz-25A51B8D.hsd1.ca.comcast.net)
[22:34:51] *** ChanServ sets mode: +o tjc
[22:37:12] <cmr> well, looks like I have a bunch of yak shaving to do before doing accurate stack analysis is going to be a thing.
[22:38:48] <cmr> I'm not going to patch our LLVM to do it, I want to be able to do it outside of a source tree.
[22:38:59] <cmr> so it seems I need to add dynamically loading machine passes..
[22:41:01] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[22:43:03] <bjz> acrichto: r? https://github.com/mozilla/rust/pull/12218
[22:43:06] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[22:43:26] <bjz> acrichto: would be nice to have one more once-over
[22:45:10] *** Joins: ssira (ssira@moz-F6206352.kanagawa.ocn.ne.jp)
[22:51:50] *** Joins: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP)
[22:51:50] <ghrust> 01[13rust01] 15bors 04force-pushed 06auto from 14974ec37 to 14c62f6ce: 02http://git.io/N3iJvQ
[22:51:50] *** Parts: ghrust (ghrust@38D6F008.6A2AE50.F3114085.IP) ()
[22:51:51] *** Joins: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP)
[22:51:51] <ghrust> 01[13rust01] 15bors pushed 2 new commits to 06auto: 02http://git.io/SGUJrA
[22:51:51] <ghrust> 13rust/06auto 14195d8fd 15Florian Hahn: Reenable some ignored test cases...
[22:51:51] <ghrust> 13rust/06auto 1458eeb07 15bors: auto merge of #12165 : fhahn/rust/change-some-tests, r=alexcrichton...
[22:51:52] *** Parts: ghrust (ghrust@4BC7FFDD.6A2AE50.F3114085.IP) ()
[22:54:35] <Eridius> bjz: I wonder if it would have been better to just define a struct Arguments(~[clean::Argument]) and implement Show on that
[22:54:40] <Eridius> instead of defining arguments_to_str()
[22:54:50] <bjz> Eridius: yeah :/
[22:54:55] <Eridius> but I suppose the pre-existing fmt() impl already constructed a ~str instead of writing to the buf directly
[22:55:01] <Eridius> which seems odd to me
[22:55:10] <bjz> I can do that
[22:55:18] <Eridius> fwiw, your version will actually behave subtly differently, if the format had any formatting flags
[22:55:33] <Eridius> because the original version used f.buf.write() which skips those, but yours uses basically str.fmt()
[22:55:49] <Eridius> bjz: ok, I'll comment to that effect on the PR as well
[22:56:16] <bjz> sure, I'll fix it then
[22:58:07] <Eridius> bjz: did you actually run the tests? I don't see any changes to the HashMap's test_show()
[22:58:10] <Eridius> bjz: the one where you used s2/s4
[22:58:25] <Eridius> ooh I see you implemented Show
[22:58:28] <bjz> Eridius: I implemented fmt::Show
[22:58:29] <bjz> yeah
[22:58:39] <bjz> I copied it from the ToStr thing
[22:58:44] <Eridius> ah
[22:58:45] <bjz> I ran all the tests
[22:58:59] <bjz> thanks for piking that up
[22:59:08] <bjz> * picking
[22:59:17] <bjz> bit sleepy this morning
[22:59:29] <Eridius> bjz: np. Thanks for implementing these. I've always wanted Show for &[]
[23:00:28] *** Quits: NiccosSystem (NiccosSyst@AB1AFDE.FC7B0C35.A7597CB6.IP) (Ping timeout)
[23:02:58] *** Quits: pnkfelix (pnkfelix@moz-43495417.fbx.proxad.net) (Quit: rcirc on GNU Emacs 24.3.50.1)
[23:12:17] *** Quits: lkuper (lkuper@moz-AD4C50F5.dhcp-bl.indiana.edu) (Quit: lkuper)
[23:15:21] <flaper87> acrichto: ran it, it seems to pass now 
[23:15:42] * flaper87 steps out
[23:15:48] <flaper87> acrichto: p=1 ? :D
[23:16:20] *** flaper87 is now known as flaper87|afk
[23:16:45] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[23:17:36] *** zz_kimundi is now known as kimundi
[23:18:29] *** Quits: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP) (Ping timeout)
[23:18:46] <wycats> such priority
[23:18:51] <wycats> many high
[23:18:53] <wycats> so soon
[23:27:47] *** Joins: erickt (etryzelaar@8C9ECD8F.3A598286.F12515B4.IP)
[23:32:09] <erickt> brson: if you're still looking for a good resource for rustpkg v3, I just found out that Ian Bicking, who made Python's Pip package manager, now works at Mozilla
[23:32:20] *** Quits: tjc (tjc@moz-25A51B8D.hsd1.ca.comcast.net) (Quit: My MacBook Pro has gone to sleep. ZZZzzzâ€¦)
[23:32:55] <cmr> erickt: what do you want me to plot?
[23:34:04] <erickt> cmr: eddyb was asking to make sure we get a before and after times for compiling rust after my hash PR lands: https://github.com/mozilla/rust/pull/11863
[23:34:40] <erickt> cmr: do you keep logs of that somewhere?
[23:34:45] <cmr> erickt: logs of what?
[23:34:46] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[23:35:01] <cmr> http://huonw.github.io/isrustfastyet/mem/ has them.
[23:35:02] <erickt> benchmarks of some sort
[23:35:19] <erickt> ok
[23:35:32] <cmr> but I can do it per-PR too, manually.
[23:37:00] <cmr> right now hashing is roughly 10% of rustc's pre-trans time.
[23:37:27] <erickt> fun. I wonder how much is SipHash and how much is it things not inlining correctly
[23:37:42] <cmr> http://octayn.net/benches/rustc.svg
[23:37:48] <cmr> a flame graph from master as of a few hours ago.
[23:37:55] <brson> erickt: thanks. i've talked to ian bicking briefly, though I didn't think to ask him about this topic. would probably be good to pick his brain
[23:38:13] <cmr> seems it's mostly siphash
[23:38:20] <cmr> not really sure
[23:41:18] <aatch> Siphash isn't particularly fast, but it is secure.
[23:41:28] <aatch> However, we probably don't need that in the compiler
[23:41:38] <cmr> certainly not
[23:41:45] *** Joins: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP)
[23:42:08] <aatch> I imagine that it's almost all string hashing?
[23:43:21] <cmr> no, mostly hashing stuff like nodeids etc..
[23:43:34] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Ping timeout)
[23:43:48] *** Quits: lpy (lpy@54B459A1.4439B922.7CEBAF5A.IP) (Ping timeout)
[23:44:08] <aatch> cmr, aren't nodeids ints?
[23:44:16] <cmr> yep
[23:44:45] <aatch> So we could probably get away with using the identity as the hashing function in that case
[23:44:45] <cmr> dbaupp got a sizable win just by using SmallIntMap for cases where the ids were (mostly) contiguous
[23:47:48] *** Joins: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP)
[23:48:14] *** Quits: canhtak (canhtak@moz-4D8F0D46.wl.t.ulaval.ca) (Quit: canhtak)
[23:51:26] *** Quits: cgaebel (clark@ADA4DDE2.290DF317.EE6E63A5.IP) (Client exited)
[23:53:36] *** Joins: Diamond (dick@moz-80556682.ks.ks.cox.net)
